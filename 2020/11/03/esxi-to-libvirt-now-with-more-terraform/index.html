<!DOCTYPE html>
<html lang="en-US" itemscope itemtype="http://schema.org/WebPage"><head><meta charset="UTF-8"><title>ESXi to Libvirt, now with more Terraform. – blog.kroy.io</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="dns-prefetch" href="//s.w.org"><script type="text/javascript" data-cfasync="false">
    (window.gaDevIds=window.gaDevIds||[]).push("dNDMyYj");
	var em_version         = '6.3.0';
	var em_track_user      = true;
	var em_no_track_reason = '';
	
	var disableStr = 'ga-disable-UA-89722449-1';

	/* Function to detect opted out users */
	function __gaTrackerIsOptedOut() {
		return document.cookie.indexOf(disableStr + '=true') > -1;
	}

	/* Disable tracking if the opt-out cookie exists. */
	if ( __gaTrackerIsOptedOut() ) {
		window[disableStr] = true;
	}

	/* Opt-out function */
	function __gaTrackerOptout() {
	  document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
	  window[disableStr] = true;
	}

	if ( 'undefined' === typeof gaOptout ) {
		function gaOptout() {
			__gaTrackerOptout();
		}
	}
	
	if ( em_track_user ) {
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

window.ga = __gaTracker;		__gaTracker('create', 'UA-89722449-1', 'auto');
		__gaTracker('set', 'forceSSL', true);
		__gaTracker('send','pageview');
		__gaTracker( function() { window.ga = __gaTracker; } );
	} else {
		console.log( "" );
		(function() {
			/* https://developers.google.com/analytics/devguides/collection/analyticsjs/ */
			var noopfn = function() {
				return null;
			};
			var noopnullfn = function() {
				return null;
			};
			var Tracker = function() {
				return null;
			};
			var p = Tracker.prototype;
			p.get = noopfn;
			p.set = noopfn;
			p.send = noopfn;
			var __gaTracker = function() {
				var len = arguments.length;
				if ( len === 0 ) {
					return;
				}
				var f = arguments[len-1];
				if ( typeof f !== 'object' || f === null || typeof f.hitCallback !== 'function' ) {
					console.log( 'Not running function __gaTracker(' + arguments[0] + " ....) because you are not being tracked. " + em_no_track_reason );
					return;
				}
				try {
					f.hitCallback();
				} catch (ex) {

				}
			};
			__gaTracker.create = function() {
				return new Tracker();
			};
			__gaTracker.getByName = noopnullfn;
			__gaTracker.getAll = function() {
				return [];
			};
			__gaTracker.remove = noopfn;
			window['__gaTracker'] = __gaTracker;
			window.ga = __gaTracker;		})();
		}
</script><style type="text/css" media="all">
.wpautoterms-footer{background-color:#ffffff;text-align:center;}
.wpautoterms-footer a{color:#000000;font-family:Arial, sans-serif;font-size:14px;}
.wpautoterms-footer .separator{color:#cccccc;font-family:Arial, sans-serif;font-size:14px;}</style><link rel="stylesheet" id="wp-block-library-css" href="https://blog.kroy.io/wp-includes/css/dist/block-library/style.min.css" media="all"><style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style><link rel="stylesheet" id="wp-block-library-theme-css" href="https://blog.kroy.io/wp-includes/css/dist/block-library/theme.min.css" media="all"><link rel="stylesheet" id="wpautoterms_css-css" href="https://blog.kroy.io/wp-content/plugins/auto-terms-of-service-and-privacy-policy/css/wpautoterms.css" media="all"><link rel="stylesheet" id="SFSImainCss-css" href="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/css/sfsi-style.css" media="all"><link rel="stylesheet" id="disable_sfsi-css" href="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/css/disable_sfsi.css" media="all"><link rel="stylesheet" id="exactmetrics-popular-posts-style-css" href="https://blog.kroy.io/wp-content/plugins/google-analytics-dashboard-for-wp/assets/css/frontend.min.css" media="all"><link rel="stylesheet" id="sinatra-styles-css" href="https://blog.kroy.io/wp-content/themes/sinatra/assets/css/style.min.css" media="all"><link rel="stylesheet" id="sinatra-dynamic-styles-css" href="https://blog.kroy.io/wp-content/uploads/sinatra/dynamic-styles.css" media="all"><link rel="stylesheet" id="jetpack_css-css" href="https://blog.kroy.io/wp-content/plugins/jetpack/css/jetpack.css" media="all"><script src="https://blog.kroy.io/wp-includes/js/jquery/jquery.js" id="jquery-core-js"></script><script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill.min.js" id="wp-polyfill-js"></script><script id="wp-polyfill-js-after">
( 'fetch' in window ) || document.write( '<script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill-fetch.min.js?ver=3.0.0">' + 'ipt>' );( document.contains ) || document.write( '<script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill-node-contains.min.js?ver=3.42.0">' + 'ipt>' );( window.DOMRect ) || document.write( '<script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill-dom-rect.min.js?ver=3.42.0">' + 'ipt>' );( window.URL && window.URL.prototype && window.URLSearchParams ) || document.write( '<script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill-url.min.js?ver=3.6.4">' + 'ipt>' );( window.FormData && window.FormData.prototype.keys ) || document.write( '<script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill-formdata.min.js?ver=3.0.12">' + 'ipt>' );( Element.prototype.matches && Element.prototype.closest ) || document.write( '<script src="https://blog.kroy.io/wp-includes/js/dist/vendor/wp-polyfill-element-closest.min.js?ver=2.0.2">' + 'ipt>' );
</script><script src="https://blog.kroy.io/wp-includes/js/dist/dom-ready.min.js" id="wp-dom-ready-js"></script><script src="https://blog.kroy.io/wp-content/plugins/auto-terms-of-service-and-privacy-policy/js/base.js" id="wpautoterms_base-js"></script><script id="exactmetrics-frontend-script-js-extra">
var exactmetrics_frontend = {"js_events_tracking":"true","download_extensions":"zip,mp3,mpeg,pdf,docx,pptx,xlsx,rar","inbound_paths":"[{\"path\":\"\\\/go\\\/\",\"label\":\"affiliate\"},{\"path\":\"\\\/recommend\\\/\",\"label\":\"affiliate\"}]","home_url":"https:\/\/PLACEHOLDER.wpsho","hash_tracking":"false"};
</script><script src="https://blog.kroy.io/wp-content/plugins/google-analytics-dashboard-for-wp/assets/js/frontend.min.js" id="exactmetrics-frontend-script-js"></script><script src="https://blog.kroy.io/wp-includes/js/jquery/jquery-migrate.min.js" id="jquery-migrate-js"></script><meta name="follow.it-verification-code-SERxZVdXbkRiWE9LYThHK2pmY09ydUlMSkF3cm9ERmJpV2JlS3p0Z1locmlNWjBFeGZtaFBCMEF4Q1hRblVqN0JUbGFXRXg4Y25yUnpVcFN0TUVQeTdIVUtkT1JVRXg2SXJvYndWbEJhRi9ZenJWdk1XSlc1VWQwQVIvNVY3dWJ8YnBDU2RZbGZvSzFjVlBLVDRjWGYwellwelNqT2ZCQzFzbmp6V24vN0FQOD0=" content="JYtCEsckN2zSqxbf9XAX"><meta name="viewport" content="width=device-width, initial-scale=1"><meta property="og:image:secure_url" content="https://blog.kroy.io/wp-content/uploads/2020/11/1280px-Libvirt_logo.svg_.png" data-id="sfsi"><meta property="og:image:type" content="" data-id="sfsi"><meta property="og:image:width" content="1280" data-id="sfsi"><meta property="og:image:height" content="571" data-id="sfsi"><meta property="og:url" content="https://blog.kroy.io/2020/11/03/esxi-to-libvirt-now-with-more-terraform/" data-id="sfsi"><meta property="og:description" content="
Over the years, my homelab has expanded and contracted multiple times.  As I am heavy into automation now and downsizing a bit, it was time to fully ditch VMWare.









Introduction



For some reason, it seems I am never happy with my lab.  For years now, I've constantly tore it up, started from scratch, migrated, migrated back, and more.  Up until recently, I had ESXi, Proxmox, libvirt, and even some HyperV in another VM for testing.  All these systems played different roles, even if they are just for learning.



By far, I've been running ESXi+vCenter the longest, and it would be considered my primary cluster.  When you have multiple hosts, heavy networking with stuff like vDS, want HA (high availability), it's hard to argue that the vSphere suite doesn't automate it and make it somewhat painless. 



But now things have changed. I'm looking to combine and contract my lab, and more tightly integrate LXD/C and automation. I decided it was time to complete the migration completely away from VMWare products, especially since I've already sold/powered down/eliminated 3 out of the original 5 hosts in my cluster.   



Don't get me wrong, with VMUG, VMWare is great and affordable, but I'm more interested in automation now than I am with HA, so a single host or two with a ton of CPU and RAM is a better fit.



The fat host



Automation



Automation has always been something that has been near and dear to my heart.  Put quite frankly, manually installing VMs, configuring to my liking, realizing I messed something up and starting over, is absolutely not fun.  



I've also focused heavily on making all my VMs pure compute.  This means something like Ansible or Docker, with all data stored on an NFS share or iSCSI export. The end result is being able completely nuke a VM, hit a button, and have it back up and running exactly where it left off within a few minutes.  It also means you don't need to back up individual VMs, just a few basic text files, the main NAS, etc.  I've talked about some pieces of how I accomplish this in an older post here.  I just now deploy a similar config with Ansible.



Prior Automation



I've actually done a lot of automation in the past. Chef, Salt, but my first serious implementation was Foreman + Puppet.



Does Foreman work?  Absolutely.  It gives you the ability to automatically create and deploy fresh VMs with PXE and Puppet.  Is Foreman nice to use?  Absolutely not.   It's just an absolute disaster to set up and maintain.  And forget trying to upgrade even minor versions.  I was religious about regularly snapshotting and backing up that Foreman virtual machine because usually an upgrade would require me to completely start from scratch.



Current Automation



For at least a year now, my main automation has been a combination of Terraform and Ansible.  Terraform talked to the vCenter API and cloned gold master VMs, and Ansible configured them to my liking.  I also have MAAS integrated for deploying the bare metal hosts, but that's beyond the scope of this post.



This really has been a great solution, but I dislike needing to use gold master VMs, since they are something that I have to go back and renew and update every once in a while.  And like mentioned, I'm really wanting to get away from VMWare completely.



So I killed one of my ESXi hosts, and fired up Ubuntu.



The Hypervisor



Since this post will probably end up getting pretty long and with lots of code examples, I don't want to waste too much time on describing the host setup. But I'll try and give the important pieces:



Ubuntu 20.04 Server.  Why Ubuntu?  Mostly because the driver support isn't horrible.  At the time of this writing, I tried 20.10, but the communication between 20.10 virtio guest tools and Terraform is broken.Setting up SSH key auth.  If you are using virsh, virt-manager remotely, it's easiest to use SSH to communicate with libvirt.  Also, I store all my terraform configs on my workstation and terraform and ansible communicates via SSH.Installing libvirt and other important stuff .



sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils



Installing Network Manager.  On my hypervisors, I trunk everything, so nmcli is just a WAAAAY easier method of configuring a bunch of bridges.  I've provided working examples of my configuration of the /etc/NetworkManager/system-connections directory in a github repo.Note that the main interface (the slave), the main bridge (vmbr0), and the VLAN5 bridge all have the MTU set to 9000.  I use VLAN5  as my storage network, and this setup allows me to easily pass a 9000 MTU link into a VM.Installing Network Manager requires you to change netplan and re-configure your networking.  The changing of Netplan involves removing the existing yaml file, creating a new one that looks like this example from github, and doing a sudo netplan apply.Both my central ISO storage and main VM storage happen via NFS.  So with Ubuntu, first I need to  sudo apt install nfs-common, and then add them as storage pools.  Even on systems without selinux, libvirt enforces it.  So if you add a new storage pool and get weird errors like permission denied, adding security_driver = none to your /etc/libvirt/qemu.conf file and restarting libvirt is a quick fix, though probably not the best fix from a security perspective.This is easiest done with virt-manager on your local PC, and then connecting via SSH to the libvirt host.  Then just add pools



















Terraform/Grunt



The two main tools I want to talk about here are terraform and terragrunt.  A layperson's definition of terraform is to define infrastructure as code.  That means, instead of clicking buttons to make a VM, choosing the amount of RAM, etc, you define it in the terraform domain specific language or DSL outlined here.  With terraform, you create a directory and put text files in it that define resources.  



Of course that's a pretty dry definition, so all the examples that follow will outline how all this fits together.



terragrunt is just a minor wrapper to terraform that extends it in a few nice ways.  You can drop different projects in different folders and apply changes to all or none, plus have pre/post hooks to run things.  I'll have examples of this as well.  



It's very important to note that ALLLL terraform is concerned with is state.  If something is out of state, it does its best to non-destructively move it, but that depends on the module you are using.  Most of the time it's just as happy to just delete everything and start over.   Plans and applies will inform/warn you, but it's really easy to get cocky and purge some data.Keep that in mind as you begin your terraform journey.



All of this is just happening on my local Linux workstation.  As terragrunt and terraform are both just Go programs, that means to install them you just download and run.  



Install Terraform



With terraform, there were some MAJOR changes in the .13 version, and that's the version I'll be using.  Something like this can be used to install it on Linux:



wget https://releases.hashicorp.com/terraform/0.13.5/terraform_0.13.5_linux_amd64.zip | unzip terraform_0.13.5_linux_amd64.zip  && sudo mv terraform /usr/local/bin && rm terraform_0.13.5_linux_amd64.zip 



terraform install



Similar methodology can be used to install terragrunt



Basic Layout



As mentioned, I'm doing all this on my Linux workstation.  This will later allow me to easily shove this all into a git repo, make available from anywhere, etc.



Note that I'm not trying to make a comprehensive terraform guide here.So I probably won't be touching much on stuff like .tfvars files, which act sort of like env files, and things will be overly verbose so as to demonstrate what I'm doing. There are plenty of opportunities for code reuse and further templating. Also, you can lay things out however you like. There's not really any specific rules on how things need to be mapped out







Lets look at the basic layout for my infra:



❯ terraformroot                               
├── diskimages
│   └── focal-server-cloudimg-amd64.img
├── terragrunt.hcl
└── vms
    └── terragrunt.hcl

3 directories, 3 files



This layout leverages the best of terraform and terragrunt.  It allows me to separate out different types of resources (VMs, and in the future LXC and networking), and access them separately (with normal terraform), or globally (with terragrunt).



The base directory terragrunt.hcl file is just empty.  It's just a placeholder to allow you to use terragrunt from that level, meaning everything below it, like in vms would work on a terragrunt apply-all.



I also have a diskimages directory with the Ubuntu 20.04 cloud-init enabled image, found at this link. You can download this from Ubuntu every time, but it's much quicker to store a copy locally and just use that, plus you are being a better netizen.    



The vmsdirectory terragrunt.hcl contains a post hook.  This updates my DNS via a script whenever VMs are added, updated, or deleted.  This is a file that you may or may not need and may want to remove or skip creating.







Setting up a VM



Let's start by creating a simple VM.



The first layout we are working on ends up looking like this:



vms
├── terragrunt.hcl
└── testvm.lan.kroy.io
    ├── cloud_init.cfg
    ├── global.tf
    ├── network_config.cfg
    ├── terragrunt.hcl
    └── vm.tf

1 directory, 6 files



Here I've created a directory named after the destination VM for organization, and put the files main.tf and terragrunt.hcl in it.



You can name the actual terraform files whatever you want as long as it ends with .tf, but they are processed in alphabetical order.  Usually this won't make too much of a difference, but in some scenarios it can.







The Config Files



The first file is the global.tf.  This defines some of the basic pieces of our resource.



 terraform {
    required_version = >= 0.13
    required_providers {
        libvirt = {
            source  = dmacvicar/libvirt
            version = 0.6.2
        }
        mikrotik = {
          source = ddelnano/mikrotik
          version = 0.3.6
        }
    }
}

# instance the providers

provider libvirt {
    uri = qemu+ssh://kroy@jack.lan.kroy.io/system
}

provider mikrotik {
    host = crs354.lan.kroy.io:8728
    username = admin
    password = 
}

resource libvirt_volume os_tmpl {
  name = focal_os_tmpl
  pool = VM
  source = file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img
  format = qcow2
}




Breaking this down:



The terraform section describes the module versions I want to pull.  In this case, I'm pulling the libvirt and mikrotik modules.   The mikrotik module is used to automatically set a static DHCP lease on my CRS.  This versioning is a the major change in terraform .13 I mentioned earlier. The libvirt provider section sets up the connection via ssh to the host running libvirt.  User kroy is in the libvirt group on the host.The mikrotik provider section connects via the Mikrotik API to my switch that runs my DHCP.The final block set up a template disk image using the cloud-init enabled image that was downloaded earlier.







The next file is the cloud_init.cfg.  This file runs some initial setup tasks in the new VM.



#cloud-config
hostname: ${hostname}
fqdn: ${fqdn}
manage_etc_hosts: true
users:
  - name: root
    ssh-authorized-keys:
      - ${file(/home/kroy/.ssh/id_ed25519.pub)}
      - ${file(/home/kroy/Documents/infra/terraform/keys/id_ansible.pub)}
  - name: kroy
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/kroy
    shell: /bin/bash
    lock_passwd: false
    ssh-authorized-keys:
      - ${file(/home/kroy/.ssh/id_ed25519.pub)}
      - ${file(/home/kroy/Documents/infra/terraform/keys/id_ansible.pub)}
# only cert auth via ssh (console access can still login)
ssh_pwauth: false
disable_root: false
chpasswd:
  list: |
     kroy:test
  expire: False
packages:
  - qemu-guest-agent

growpart:
  mode: auto
  devices: ['/']
  ignore_growroot_disabled: false

runcmd:
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, qemu-guest-agent.service ]
  - [ systemctl, start, --no-block, qemu-guest-agent.service ]




If you've got any sort of familiarity with Linux, most of what happens in this file should be somewhat self-explanatory, even if you are unfamiliar with the layout and formatting. 



Set up hostname, fqdn from variables that will be set from vm.tf.Make the /etc/hosts file match the proper config.Setup ssh keys and a separate user.  Set the ssh keys to my local ssh keys and ansible keys on my workstationChange the password on the kroy userInstall the QEMU Guest Agent.  This is what allows the host and the VM to communicate.Grow the partition to the max size possible.  This makes it so you can easily create a 5GB or 500GB VM from your vm.tf.Make sure the guest agent is running.  I was having an issue with it not autostarting, but this series of runcmd allows it to work.







The network_config.cfg file.  Somewhat self-documenting. There are other ways to do this, but I've found this is easiest for my setup:



version: 2
ethernets:
  ens3:
     dhcp4: true



This is just a standard netplan config that gets dropped on the new VM.







The final piece is the vm.tf. As my naming here suggests, this is the actual config for the VM.



# variables that can be overriden
variable hostname { default = bgp }
variable domain { default = lan.kroy.io }
variable memoryGB { default = 2 }
variable cpu { default = 2 }
variable network { default = vibr20 }
variable disksizeGB { default = 20 }



resource libvirt_volume os_image {
  name = ${var.hostname}-os_image
  pool   = VM
  base_volume_id = libvirt_volume.os_tmpl.id
  size = var.disksize * 1024 * 1024 * 1024
}

# Use CloudInit ISO to add ssh-key to the instance
resource libvirt_cloudinit_disk commoninit {
  name = ${var.hostname}-commoninit.iso
  pool = VM
  user_data = data.template_file.user_data.rendered
  network_config = data.template_file.network_config.rendered
}


data template_file user_data {
  template = file(${path.module}/cloud_init.cfg)
  vars = {
    hostname = var.hostname
    fqdn = ${var.hostname}.${var.domain}
  }
}

data template_file network_config {
  template = file(${path.module}/network_config.cfg)
}


# Create the machine
resource libvirt_domain domain-vm {
  qemu_agent = true
  name = ${var.hostname}.${var.domain}
  memory = var.memoryGB * 1024
  vcpu = var.cpu
  cloudinit = libvirt_cloudinit_disk.commoninit.id

  disk {
       volume_id = libvirt_volume.os_image.id
  }
  network_interface {
       wait_for_lease = true
       bridge = var.network
  }

  graphics {
    type = spice
    listen_type = address
    autoport = true
  }
  provisioner local-exec {
    environment = {
        IP = join(,slice([for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == 10.20.20],0,1))
    }
    command = ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i $IP, --key-file=~/Documents/infra/terraform/keys/id_ansible -u root ~/Documents/infra/terraform/ansible/docker/deploy-docker_ubuntu.yml

  }

}


resource mikrotik_dhcp_lease dhcp {
  address = join(,slice([for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == 10.20.20],0,1))
  macaddress = upper(join(,libvirt_domain.domain-vm.*.network_interface.0.mac))
  comment = ${var.hostname}.${var.domain}
  hostname = var.hostname
}





There's obviously a lot going on here, but the short of it is I'll be creating multiple resources.  A cloud-init boot disk, some templates for passing into the cloud-init disk, the actual VM, and the DHCP record on my Mikrotik, which will read the IP of the created VM, and turn it into a static DHCP lease.



The first part of this config is just some variables.  As I create a new VM, assuming I just want a fairly basic VM, all I need to do is change some things here.  To create a new VM, this is all that needs to be changed.  Note that these can be stored in a .tfvars file too for further separation.The first resource is the actual VM disk.  Note that the size is multipled by 1024*1024*1024 to translate the size from bytes to gigabytes, for ease of use.The next resource and following templates resources pulls in the cloud-init and network configs to build a cloud init image for initial booting and setup. The next resource defines the VM.  Most of it should be self-explanatory.  Things like making sure the guest agent is enabled, setting up the hostname and fqdn from the variables, vcpus, memory, disk.  When you want to use data from a different resource, the format is resource_type.resource_name.id.  So to later refer to this VM, you'd used libvirt_domain.domain-vm.id.We set up a spice console, important for connecting to it via something like virt-manager.The network_interface resource here tells it to wait for a lease.  This is necessary since I want my Mikrotik resource below to be have access to the IP that the VM was issued via DHCP.  This saves me from having to hard-code IPs.I have a local-exec provisioner here.  This is how I call Ansible to configure the VM.  In this case I'll be setting this host up as one of my Docker VMs.  Note that I'm doing some severe hacky stuff to make sure I only grab the IP in the subnet that I want.  Finally, the Mikrotik resource. As mentioned a few times, this sets a static DHCP lease on my main DHCP server, using the same hacky IP pulling code as above.







Terraforming the Virtual Machine



Now that all the resources and config are declared, it's time to actually create the VM.



The first step is to initialize the terraform repo here.  This causes it to pull the required modules and prepare for deployment.



❯ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/template...
- Finding dmacvicar/libvirt versions matching 0.6.2...
- Finding ddelnano/mikrotik versions matching 0.3.6...
- Installing hashicorp/template v2.2.0...
- Installed hashicorp/template v2.2.0 (signed by HashiCorp)
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)
- Installing ddelnano/mikrotik v0.3.6...
- Installed ddelnano/mikrotik v0.3.6 (self-signed, key ID DDBA1674AA3EA0EE)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/plugins/signing.html

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, we recommend adding version constraints in a required_providers block
in your configuration, with the constraint strings suggested below.

* hashicorp/template: version = ~> 2.2.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running terraform plan to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.❯ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding dmacvicar/libvirt versions matching 0.6.2...
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running terraform plan to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.



Assuming you get a success message there and some green text, you can proceed to plan or even apply.



plan shows you want it's going to do.  apply will do it (with confirmation by default, but it can be overridden).



❯ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.network_config: Refreshing state...
data.template_file.user_data: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # libvirt_cloudinit_disk.commoninit will be created
  + resource libvirt_cloudinit_disk commoninit {
      + id             = (known after apply)
      + name           = testvm-commoninit.iso
      + network_config = <<~EOT
            version: 2
            ethernets:
              ens3:
                 dhcp4: true
        EOT
      + pool           = VM
      + user_data      = <<~EOT
            #cloud-config
            hostname: testvm
            fqdn: testvm.lan.kroy.io
            manage_etc_hosts: true
            users:
              - name: root
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
              - name: kroy
                sudo: ALL=(ALL) NOPASSWD:ALL
                groups: users, admin
                home: /home/kroy
                shell: /bin/bash
                lock_passwd: false
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
            # only cert auth via ssh (console access can still login)
            ssh_pwauth: false
            disable_root: false
            chpasswd:
              list: |
                 kroy:test
              expire: False
            packages:
              - qemu-guest-agent
            
            growpart:
              mode: auto
              devices: ['/']
              ignore_growroot_disabled: false
            
            runcmd:
              - [ systemctl, daemon-reload ]
              - [ systemctl, enable, qemu-guest-agent.service ]
              - [ systemctl, start, --no-block, qemu-guest-agent.service ]
        EOT
    }

  # libvirt_domain.domain-vm will be created
  + resource libvirt_domain domain-vm {
      + arch        = (known after apply)
      + cloudinit   = (known after apply)
      + disk        = [
          + {
              + block_device = null
              + file         = null
              + scsi         = null
              + url          = null
              + volume_id    = (known after apply)
              + wwn          = null
            },
        ]
      + emulator    = (known after apply)
      + fw_cfg_name = opt/com.coreos/config
      + id          = (known after apply)
      + machine     = (known after apply)
      + memory      = 2048
      + name        = testvm.lan.kroy.io
      + qemu_agent  = true
      + running     = true
      + vcpu        = 2

      + graphics {
          + autoport       = true
          + listen_address = 127.0.0.1
          + listen_type    = address
          + type           = spice
        }

      + network_interface {
          + addresses      = (known after apply)
          + bridge         = vibr20
          + hostname       = (known after apply)
          + mac            = (known after apply)
          + network_id     = (known after apply)
          + network_name   = (known after apply)
          + wait_for_lease = true
        }
    }

  # libvirt_volume.os_image will be created
  + resource libvirt_volume os_image {
      + base_volume_id = (known after apply)
      + format         = (known after apply)
      + id             = (known after apply)
      + name           = testvm-os_image
      + pool           = VM
      + size           = 21474836480
    }

  # libvirt_volume.os_tmpl will be created
  + resource libvirt_volume os_tmpl {
      + format = qcow2
      + id     = (known after apply)
      + name   = focal_os_tmpl
      + pool   = VM
      + size   = (known after apply)
      + source = file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img
    }

  # mikrotik_dhcp_lease.dhcp will be created
  + resource mikrotik_dhcp_lease dhcp {
      + address    = (known after apply)
      + blocked    = false
      + comment    = testvm.lan.kroy.io
      + dynamic    = false
      + hostname   = testvm
      + id         = (known after apply)
      + macaddress = (known after apply)
    }

Plan: 5 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an -out parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
terraform apply is subsequently run.




Note the bottom line where is says it's going to add 5, change 0, destroy 0.  



Keep remembering that all terraform is concerned with is state.  So it will happily delete and nuke everything to get it to make the state that you want.  So if a plan or apply says it's going to delete a bunch of stuff and that's not what you wanted, escape now!



Finally, terraform apply looks much like the plan above, and adds a few extra lines to confirm the operation (if you haven't passed the option to skip it).



Plan: 5 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

...

Apply complete! Resources: 5 added, 0 changed, 0 destroyed




This should hopefully complete without error, and if you do a virsh list on the libvirt host, you'll see something like:



# virsh list 
 Id   Name                 State
------------------------------------
 1    testvm.lan.kroy.io   running




In my terraform apply output, I have libvirt_domain.domain-vm (local-exec): ok: [10.20.20.79], which means I should be able to ssh there



❯ ssh kroy@10.20.20.79
Warning: Permanently added '10.20.20.79' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-51-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Nov  2 17:55:54 UTC 2020

  System load:              0.0
  Usage of /:               11.0% of 19.21GB
  Memory usage:             15%
  Swap usage:               0%
  Processes:                121
  Users logged in:          0
  IPv4 address for docker0: 172.17.0.1
  IPv4 address for ens3:    10.20.20.79
 

41 updates can be installed immediately.
15 of these updates are security updates.
To see these additional updates run: apt list --upgradable



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user root), use sudo <command>.
See man sudo_root for details.

kroy@testvm:~$



SUCCESS!







Terragrunt



Even though we've only got a single resource so far, I want to touch on what terragrunt accomplishes for you.  



Terraform only works on single directories.  So say I wanted to add a second VM.  



I would do something like:



cd terraformroot
cp -pr vms/testvm.lan.kroy.io vms/doubletest.lan.kroy.io
rm vms/doubletest.lan.kroy.io/terraform.tfstate*
sed -i -e 's/testvm/doubletest/' vms/doubletest.lan.kroy.io/vm.tf



Hopefully that is mostly self-explanatory:



Change into our terraform directory.Copying the existing config to a new VM directory.Remove all the old terraform state files.  This is VERY important if you are going to be using terraform like this.  This is basically the main database for terraform and if you want to create a new resource, you don't want the old database in the new resource directory.A not-so-fancy one-liner to change the hostname of the new VM.



Now you would have a few options to determine how you want to apply this configuration:



Switch to terraformroot/vms/doubletest.lan.kroy.io, do a terraform apply.   This would only apply the state for this VM.Switch to terraformroot/vms, do a terragrunt apply-all.  This would apply the state for testvm.lan.kroy.io  and doubletest.lan.kroy.io.Switch to terraformroot, and again, terragrunt apply-all.  This would apply the state for all resources under vms, and any future projects, like networking configs, LXC, etc.



In all that, you can also do plan-all on terragrunt to see what it's going to change.



In the directory for these VMs resources, I've got a terragrunt.hcl.  The contents of this are simply:



include {
  path = find_in_parent_folders()
}



This says look in any parent folders, and execute the actions of their terragrunt.hcl.



This is powerful because you can have specific actions for just the vms directory or everything. That's why the content of my terragrunt.hcl in the vms directory contains:



terraform {
  after_hook after_hook {
    commands     = [apply]
    execute      = [/bin/bash,/home/kroy/Documents/infra/terraform/updatedns.sh]
    run_on_error = true
  }
}




As is implied, this runs after you type terragrunt apply or apply-all. 



Being in the vms sub-directory, when would this run?



In the individual VM resource directory due to the find_in_parent_folders when you run terragrunt with apply or apply-all.In the vms sub-directory when running apply all. You can't run apply because that only looks in the current directory.In the main terraformroot directory.    



So running a terragrunt apply-all in the vms directory:



[terragrunt] 2020/11/02 12:13:11 Stack at /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms:
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/doubletest.lan.kroy.io (excluded: false, dependencies: [])
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io (excluded: false, dependencies: [])
[terragrunt] 2020/11/02 12:13:11 [terragrunt]  Are you sure you want to run 'terragrunt apply' in each folder of the stack described above? (y/n) 



The output of this shows that the new VM was created (and the original VM was at least looked at), and my post-hook is run once:



Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Detected 1 Hooks
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Executing hook: after_hook
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Running command: /bin/bash /home/kroy/Documents/infra/terraform/updatedns.sh
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io has finished successfully!







Conclusion



Well, there you have it.   Is this the perfect layout?  Probably not.  Is there room for improvement?  Absolutely.



I have put up a git repo HERE, containing all of the examples from above.



Of course this is far from complete.  With this setup, all you have are fairly blank and basic VMs.  You'd want to hit them with Ansible or something to finish configuring them.  But that's a post for another day.



Enjoy!
" data-id="sfsi"><meta property="og:title" content="ESXi to Libvirt, now with more Terraform." data-id="sfsi"><style type="text/css">img#wpstats{display:none}</style><meta name="theme-color" content="#3857F1"><link rel="icon" href="https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-32x32.png" sizes="32x32"><link rel="icon" href="https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-192x192.png" sizes="192x192"><link rel="apple-touch-icon" href="https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-180x180.png"><meta name="msapplication-TileImage" content="https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-270x270.png"></head><body class="post-template-default single single-post postid-894 single-format-standard wp-embed-responsive sinatra-topbar__separators-regular sinatra-layout__fw-contained sinatra-with-dropdown-indicators sinatra-header-layout-1 sinatra-menu-animation-underline sinatra-header__separators-none si-single-title-in-content si-page-title-align-left si-has-sidebar sinatra-sidebar-style-3 sinatra-sidebar-position__right-sidebar si-sidebar-r__after-content entry-media-hover-style-1 sinatra-copyright-layout-1 si-input-supported validate-comment-form si-menu-accessibility">


<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	
	<header id="masthead" class="site-header" role="banner" itemtype="https://schema.org/WPHeader" itemscope="itemscope"><div id="sinatra-header">
		<div id="sinatra-header-inner">
	
<div class="si-container si-header-container">

	
<div class="sinatra-logo si-header-element" itemtype="https://schema.org/Organization" itemscope="itemscope">
	<div class="logo-inner"><span class="site-title" itemprop="name">
						<a href="https://blog.kroy.io/" rel="home" itemprop="url">
							blog.kroy.io
						</a>
					</span><p class="site-description" itemprop="description">
						computers, tech, and whatever other random stuff crosses my mind.
					</p></div></div>

<nav class="site-navigation main-navigation sinatra-primary-nav sinatra-nav si-header-element" role="navigation" itemtype="https://schema.org/SiteNavigationElement" itemscope="itemscope" aria-label="Site Navigation"><ul class="sinatra-primary-nav"><li><a href="https://blog.kroy.io/"><span>Home</span></a></li></ul></nav><div class="si-header-widgets si-header-element sinatra-widget-location-right"><div class="si-header-widget__search si-header-widget sinatra-hide-mobile-tablet"><div class="si-widget-wrapper">
<div aria-haspopup="true">
	<a href="#" class="si-search">
		<i class="si-icon si-search"></i>
	</a>

	<div class="si-search-simple si-search-container dropdown-item">
		<form role="search" aria-label="Site Search" method="get" class="si-search-form" action="https://blog.kroy.io/">

			<label class="si-form-label">
				<span class="screen-reader-text">Search for:</span>
				<input type="search" class="si-input-search" placeholder="Search" value="" name="s" autocomplete="off"></label>

			
			<button type="submit" class="sinatra-animate-arrow right-arrow" aria-hidden="true" role="button">
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="30px" height="18px" viewbox="0 0 30 18" enable-background="new 0 0 30 18" xml:space="preserve"><path class="arrow-handle" d="M2.511,9.007l7.185-7.221c0.407-0.409,0.407-1.071,0-1.48s-1.068-0.409-1.476,0L0.306,8.259 c-0.408,0.41-0.408,1.072,0,1.481l7.914,7.952c0.407,0.408,1.068,0.408,1.476,0s0.407-1.07,0-1.479L2.511,9.007z"></path><path class="arrow-bar" fill-rule="evenodd" clip-rule="evenodd" d="M1,8h28.001c0.551,0,1,0.448,1,1c0,0.553-0.449,1-1,1H1c-0.553,0-1-0.447-1-1
					                            C0,8.448,0.447,8,1,8z"></path></svg></button>
		</form>
	</div>
</div>
</div></div></div>
	<span class="si-header-element si-mobile-nav">
				<button class="si-hamburger hamburger--spin si-hamburger-sinatra-primary-nav" aria-label="Menu" aria-controls="sinatra-primary-nav" type="button">

			
			<span class="hamburger-box">
				<span class="hamburger-inner"></span>
			</span>

		</button>
			</span>

</div>
	</div>
	</div>
		
<div class="page-header si-has-breadcrumbs">

	
	
	<div class="si-container si-breadcrumbs"><nav role="navigation" aria-label="Breadcrumbs" class="breadcrumb-trail breadcrumbs" itemprop="breadcrumb"><ul class="trail-items" itemscope itemtype="http://schema.org/BreadcrumbList"><meta name="numberOfItems" content="5"><meta name="itemListOrder" content="Ascending"><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" class="trail-item trail-begin"><a href="https://blog.kroy.io/" rel="home" itemprop="item"><span itemprop="name">Home</span></a><meta itemprop="position" content="1"></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" class="trail-item"><a href="https://blog.kroy.io/2020/" itemprop="item"><span itemprop="name">2020</span></a><meta itemprop="position" content="2"></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" class="trail-item"><a href="https://blog.kroy.io/2020/11/" itemprop="item"><span itemprop="name">November</span></a><meta itemprop="position" content="3"></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" class="trail-item"><a href="https://blog.kroy.io/2020/11/03/" itemprop="item"><span itemprop="name">3</span></a><meta itemprop="position" content="4"></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" class="trail-item trail-end"><span><span itemprop="name">ESXi to Libvirt, now with more Terraform.</span></span><meta itemprop="position" content="5"></li></ul></nav></div>
</div>
	</header><div id="main" class="site-main">

		
<div class="si-container">

	<div id="primary" class="content-area">

		
		<main id="content" class="site-content" role="main" itemscope itemtype="http://schema.org/Blog"><article id="post-894" class="sinatra-article post-894 post type-post status-publish format-standard has-post-thumbnail hentry category-automation category-kvm category-terraform category-ubuntu category-virtualization tag-ansible tag-kvm tag-migration tag-terraform tag-vmware" itemscope="" itemtype="https://schema.org/CreativeWork"><div class="post-category">

	<span class="cat-links"><span class="screen-reader-text">Posted in</span><span><a href="https://blog.kroy.io/category/automation/" rel="category tag">Automation</a> <a href="https://blog.kroy.io/category/virtualization/kvm/" rel="category tag">KVM</a> <a href="https://blog.kroy.io/category/automation/terraform/" rel="category tag">Terraform</a> <a href="https://blog.kroy.io/category/ubuntu/" rel="category tag">Ubuntu</a> <a href="https://blog.kroy.io/category/virtualization/" rel="category tag">Virtualization</a></span></span>
</div>

<header class="entry-header"><h1 class="entry-title" itemprop="headline">
		ESXi to Libvirt, now with more Terraform.	</h1>

</header><div class="entry-meta"><div class="entry-meta-elements">		<span class="post-author">
			<span class="posted-by vcard author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
				<span class="screen-reader-text">Posted by</span>

				
				<span>
										By 					<a class="url fn n" title="View all posts by Kroy" href="https://blog.kroy.io/author/kroy3348/" rel="author" itemprop="url">
						<span class="author-name" itemprop="name">Kroy</span>
					</a>
				</span>
			</span>
		</span>
		<span class="posted-on">November 3, 2020</span></div></div><div class="post-thumb entry-media thumbnail"><img width="1024" height="457" src="https://blog.kroy.io/wp-content/uploads/2020/11/1280px-Libvirt_logo.svg_-1024x457.png" class="attachment-large size-large wp-post-image" alt="libvirt" loading="lazy"></div>
<div class="entry-content si-entry" itemprop="text">
	
<p>Over the years, my homelab has expanded and contracted multiple times.  As I am heavy into automation now and downsizing a bit, it was time to fully ditch VMWare.</p>



<hr class="wp-block-separator"><div class="lwptoc lwptoc-autoWidth lwptoc-baseItems lwptoc-light lwptoc-notInherit" data-smooth-scroll="1" data-smooth-scroll-offset="24"><div class="lwptoc_i">    <div class="lwptoc_header">
        <b class="lwptoc_title">Contents</b>                    <span class="lwptoc_toggle">
                <a href="#" class="lwptoc_toggle_label" data-label="show">hide</a>
            </span>
            </div>
<div class="lwptoc_items lwptoc_items-visible">
    <div class="lwptoc_itemWrap"><div class="lwptoc_item">    <a href="#Introduction">
                    <span class="lwptoc_item_number">1</span>
                <span class="lwptoc_item_label">Introduction</span>
    </a>
    </div><div class="lwptoc_item">    <a href="#Automation">
                    <span class="lwptoc_item_number">2</span>
                <span class="lwptoc_item_label">Automation</span>
    </a>
    <div class="lwptoc_itemWrap"><div class="lwptoc_item">    <a href="#Prior_Automation">
                    <span class="lwptoc_item_number">2.1</span>
                <span class="lwptoc_item_label">Prior Automation</span>
    </a>
    </div><div class="lwptoc_item">    <a href="#Current_Automation">
                    <span class="lwptoc_item_number">2.2</span>
                <span class="lwptoc_item_label">Current Automation</span>
    </a>
    </div></div></div><div class="lwptoc_item">    <a href="#The_Hypervisor">
                    <span class="lwptoc_item_number">3</span>
                <span class="lwptoc_item_label">The Hypervisor</span>
    </a>
    </div><div class="lwptoc_item">    <a href="#TerraformGrunt">
                    <span class="lwptoc_item_number">4</span>
                <span class="lwptoc_item_label">Terraform/Grunt</span>
    </a>
    <div class="lwptoc_itemWrap"><div class="lwptoc_item">    <a href="#Install_Terraform">
                    <span class="lwptoc_item_number">4.1</span>
                <span class="lwptoc_item_label">Install Terraform</span>
    </a>
    </div><div class="lwptoc_item">    <a href="#Basic_Layout">
                    <span class="lwptoc_item_number">4.2</span>
                <span class="lwptoc_item_label">Basic Layout</span>
    </a>
    </div><div class="lwptoc_item">    <a href="#Setting_up_a_VM">
                    <span class="lwptoc_item_number">4.3</span>
                <span class="lwptoc_item_label">Setting up a VM</span>
    </a>
    <div class="lwptoc_itemWrap"><div class="lwptoc_item">    <a href="#The_Config_Files">
                    <span class="lwptoc_item_number">4.3.1</span>
                <span class="lwptoc_item_label">The Config Files</span>
    </a>
    </div><div class="lwptoc_item">    <a href="#Terraforming_the_Virtual_Machine">
                    <span class="lwptoc_item_number">4.3.2</span>
                <span class="lwptoc_item_label">Terraforming the Virtual Machine</span>
    </a>
    </div></div></div><div class="lwptoc_item">    <a href="#Terragrunt">
                    <span class="lwptoc_item_number">4.4</span>
                <span class="lwptoc_item_label">Terragrunt</span>
    </a>
    </div></div></div><div class="lwptoc_item">    <a href="#Conclusion">
                    <span class="lwptoc_item_number">5</span>
                <span class="lwptoc_item_label">Conclusion</span>
    </a>
    <div class="lwptoc_itemWrap"><div class="lwptoc_item">    <a href="#60">
                    <span class="lwptoc_item_number">5.1</span>
                <span class="lwptoc_item_label">60</span>
    </a>
    <div class="lwptoc_itemWrap"><div class="lwptoc_item">    <a href="#SHARES">
                    <span class="lwptoc_item_number">5.1.1</span>
                <span class="lwptoc_item_label">SHARES</span>
    </a>
    </div></div></div></div></div></div></div>
</div></div><h2><span id="Introduction">Introduction</span></h2>



<p>For some reason, it seems I am never happy with my lab.  For years now, I’ve constantly tore it up, started from scratch, migrated, <a rel="noreferrer noopener" href="https://blog.kroy.io/2017/06/30/migrating-the-lab-back-to-esxi-after-a-proxmox-experiment/" data-type="post" data-id="23" target="_blank">migrated back</a>, and more.  Up until recently, I had ESXi, Proxmox, libvirt, and even some HyperV in another VM for testing.  All these systems played different roles, even if they are just for learning.</p>



<p>By far, I’ve been running ESXi+vCenter the longest, and it would be considered my “primary” cluster.  When you have multiple hosts, heavy networking with stuff like vDS, want HA (high availability), it’s hard to argue that the vSphere suite doesn’t automate it and make it somewhat painless. </p>



<p>But now things have changed. I’m looking to combine and contract my lab, and more tightly integrate LXD/C and automation. I decided it was time to complete the migration completely away from VMWare products, especially since I’ve already sold/powered down/eliminated 3 out of the original 5 hosts in my cluster.   </p>



<p>Don’t get me wrong, with VMUG, VMWare is great and affordable, but I’m more interested in automation now than I am with HA, so a single host or two with a ton of CPU and RAM is a better fit.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="169" src="https://blog.kroy.io/wp-content/uploads/2020/10/image-1024x169.png" alt="" class="wp-image-896" srcset="https://blog.kroy.io/wp-content/uploads/2020/10/image-1024x169.png 1024w,https://blog.kroy.io/wp-content/uploads/2020/10/image-300x49.png 300w,https://blog.kroy.io/wp-content/uploads/2020/10/image-768x127.png 768w,https://blog.kroy.io/wp-content/uploads/2020/10/image-1536x253.png 1536w,https://blog.kroy.io/wp-content/uploads/2020/10/image-2048x337.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>The fat host</figcaption></figure><h2><span id="Automation">Automation</span></h2>



<p>Automation has always been something that has been near and dear to my heart.  Put quite frankly, manually installing VMs, configuring to my liking, realizing I messed something up and starting over, is absolutely not fun.  </p>



<p>I’ve also focused heavily on making all my VMs “pure compute”.  This means something like Ansible or Docker, with all data stored on an NFS share or iSCSI export. The end result is being able completely nuke a VM, hit a button, and have it back up and running exactly where it left off within a few minutes.  It also means you don’t need to back up individual VMs, just a few basic text files, the main NAS, etc.  I’ve talked about some pieces of how I accomplish this in an older post <a rel="noreferrer noopener" href="https://blog.kroy.io/2017/08/14/fully-embracing-docker/" data-type="post" data-id="25" target="_blank">here</a>.  I just now deploy a similar config with Ansible.</p>



<h3><span id="Prior_Automation">Prior Automation</span></h3>



<p>I’ve actually done a lot of automation in the past. Chef, Salt, but my first serious implementation was Foreman + Puppet.</p>



<p>Does Foreman work?  Absolutely.  It gives you the ability to automatically create and deploy fresh VMs with PXE and Puppet.  Is Foreman nice to use?  Absolutely not.   It’s just an absolute disaster to set up and maintain.  And forget trying to upgrade even minor versions.  I was religious about regularly snapshotting and backing up that Foreman virtual machine because usually an upgrade would require me to completely start from scratch.</p>



<h3><span id="Current_Automation">Current Automation</span></h3>



<p>For at least a year now, my main automation has been a combination of Terraform and Ansible.  Terraform talked to the vCenter API and cloned “gold master” VMs, and Ansible configured them to my liking.  I also have MAAS integrated for deploying the bare metal hosts, but that’s beyond the scope of this post.</p>



<p>This really has been a great solution, but I dislike needing to use “gold master” VMs, since they are something that I have to go back and renew and update every once in a while.  And like mentioned, I’m really wanting to get away from VMWare completely.</p>



<p>So I killed one of my ESXi hosts, and fired up Ubuntu.</p>



<h2><span id="The_Hypervisor">The Hypervisor</span></h2>



<p>Since this post will probably end up getting pretty long and with lots of code examples, I don’t want to waste too much time on describing the host setup. But I’ll try and give the important pieces:</p>



<ul><li>Ubuntu 20.04 Server.  Why Ubuntu?  Mostly because the driver support isn’t horrible.  At the time of this writing, I tried 20.10, but the communication between 20.10 virtio guest tools and Terraform is broken.</li><li>Setting up SSH key auth.  If you are using virsh, virt-manager remotely, it’s easiest to use SSH to communicate with libvirt.  Also, I store all my terraform configs on my workstation and terraform and ansible communicates via SSH.</li><li>Installing libvirt and other important stuff .</li></ul><pre class="wp-block-code"><code>sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils</code></pre>



<ul><li>Installing Network Manager.  On my hypervisors, I trunk everything, so nmcli is just a WAAAAY easier method of configuring a bunch of bridges.  I’ve provided working examples of my configuration of the <code>/etc/NetworkManager/system-connections</code> directory in a <a rel="noreferrer noopener" href="https://github.com/kroy-the-rabbit/esxitolibvirt-blog/tree/master/nmcli-examples/system-connections" target="_blank">github repo</a>.<ul><li>Note that the main interface (the slave), the main bridge (vmbr0), and the VLAN5 bridge all have the MTU set to 9000.  I use VLAN5  as my storage network, and this setup allows me to easily pass a 9000 MTU link into a VM.</li><li>Installing Network Manager requires you to change netplan and re-configure your networking.  The changing of Netplan involves removing the existing <code>yaml</code> file, creating a new one that looks like<a rel="noreferrer noopener" href="https://raw.githubusercontent.com/kroy-the-rabbit/esxitolibvirt-blog/master/nmcli-examples/netplan.yml" target="_blank"> this example from github</a>, and doing a <code>sudo netplan apply</code>.</li></ul></li><li>Both my central ISO storage and main VM storage happen via NFS.  So with Ubuntu, first I need to  <code>sudo apt install nfs-common</code>, and then add them as storage pools.  <ul><li>Even on systems without selinux, libvirt enforces it.  So if you add a new storage pool and get weird errors like “permission denied”, adding <code>security_driver = "none"</code> to your <code>/etc/libvirt/qemu.conf</code> file and restarting libvirt is a quick fix, though probably not the best fix from a security perspective.</li></ul><ul><li>This is easiest done with <code>virt-manager</code> on your local PC, and then connecting via SSH to the libvirt host.  Then just add pools</li></ul></li></ul><div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/11/image.png" alt="" class="wp-image-902" width="373" height="323" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image.png 373w,https://blog.kroy.io/wp-content/uploads/2020/11/image-300x260.png 300w" sizes="(max-width: 373px) 100vw, 373px"></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="489" height="493" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-1.png" alt="" class="wp-image-903" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-1.png 489w,https://blog.kroy.io/wp-content/uploads/2020/11/image-1-298x300.png 298w,https://blog.kroy.io/wp-content/uploads/2020/11/image-1-150x150.png 150w" sizes="(max-width: 489px) 100vw, 489px"></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="470" height="477" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-2.png" alt="" class="wp-image-904" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-2.png 470w,https://blog.kroy.io/wp-content/uploads/2020/11/image-2-296x300.png 296w" sizes="(max-width: 470px) 100vw, 470px"></figure></div>



<hr class="wp-block-separator"><h2><span id="TerraformGrunt">Terraform/Grunt</span></h2>



<p>The two main tools I want to talk about here are <code>terraform</code> and <code>terragrunt</code>.  A layperson’s definition of <code>terraform</code> is to define “infrastructure as code”.  That means, instead of clicking buttons to make a VM, choosing the amount of RAM, etc, you define it in the terraform domain specific language or DSL outlined <a rel="noreferrer noopener" href="https://www.terraform.io/docs/configuration/syntax.html" target="_blank">here</a>.  With <code>terraform</code>, you create a directory and put text files in it that define resources.  </p>



<p>Of course that’s a pretty dry definition, so all the examples that follow will outline how all this fits together.</p>



<p><code>terragrunt</code> is just a minor wrapper to <code>terraform</code> that extends it in a few nice ways.  You can drop different projects in different folders and apply changes to all or none, plus have pre/post hooks to run things.  I’ll have examples of this as well.  </p>



<blockquote class="wp-block-quote"><p>It’s very important to note that ALLLL terraform is concerned with is state.  If something is out of state, it does its best to non-destructively move it, but that depends on the module you are using.  </p><p>Most of the time it’s just as happy to just delete everything and start over.   Plans and applies will inform/warn you, but it’s really easy to get cocky and purge some data.</p><p>Keep that in mind as you begin your terraform journey.</p></blockquote>



<p>All of this is just happening on my local Linux workstation.  As <code>terragrunt</code> and <code>terraform</code> are both just <code>Go</code> programs, that means to install them you just download and run.  </p>



<h3><span id="Install_Terraform">Install Terraform</span></h3>



<p>With <code>terraform</code>, there were some MAJOR changes in the <code>.13</code> version, and that’s the version I’ll be using.  Something like this can be used to install it on Linux:</p>



<pre class="wp-block-code"><code>wget https://releases.hashicorp.com/terraform/0.13.5/terraform_0.13.5_linux_amd64.zip | unzip terraform_0.13.5_linux_amd64.zip  && sudo mv terraform /usr/local/bin && rm terraform_0.13.5_linux_amd64.zip </code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="184" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1024x184.png" alt="" class="wp-image-909" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1024x184.png 1024w,https://blog.kroy.io/wp-content/uploads/2020/11/image-3-300x54.png 300w,https://blog.kroy.io/wp-content/uploads/2020/11/image-3-768x138.png 768w,https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1536x276.png 1536w,https://blog.kroy.io/wp-content/uploads/2020/11/image-3.png 1593w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>terraform install</figcaption></figure><p>Similar methodology can be used to install <code>terragrunt</code></p>



<h3><span id="Basic_Layout">Basic Layout</span></h3>



<p>As mentioned, I’m doing all this on my Linux workstation.  This will later allow me to easily shove this all into a git repo, make available from anywhere, etc.</p>



<figure class="wp-block-pullquote alignleft"><blockquote><p>Note that I’m not trying to make a comprehensive terraform guide here.</p><p>So I probably won’t be touching much on stuff like .tfvars files, which act sort of like env files, and things will be overly verbose so as to demonstrate what I’m doing. </p><p>There are plenty of opportunities for code reuse and further templating. Also, you can lay things out however you like. There’s not really any specific rules on how things need to be mapped out</p></blockquote></figure><p></p>



<p>Lets look at the basic layout for my infra:</p>



<pre class="wp-block-code"><code>❯ terraformroot                               
├── diskimages
│   └── focal-server-cloudimg-amd64.img
├── terragrunt.hcl
└── vms
    └── terragrunt.hcl

3 directories, 3 files</code></pre>



<p>This layout leverages the best of terraform and terragrunt.  It allows me to separate out different types of resources (VMs, and in the future LXC and networking), and access them separately (with normal terraform), or globally (with terragrunt).</p>



<p>The base directory <code>terragrunt.hcl</code> file is just empty.  It’s just a placeholder to allow you to use terragrunt from that level, meaning everything below it, like in <code>vms</code> would work on a <code>terragrunt apply-all</code>.</p>



<p>I also have a <code>diskimages</code> directory with the Ubuntu 20.04 cloud-init enabled image, found <a href="https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img" data-type="URL" data-id="https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img">at this link</a>. You can download this from Ubuntu every time, but it’s much quicker to store a copy locally and just use that, plus you are being a better netizen.    </p>



<p>The <code>vms</code>directory <code>terragrunt.hcl</code> contains a “post hook”.  This updates my DNS via a script whenever VMs are added, updated, or deleted.  This is a file that you may or may not need and may want to remove or skip creating.</p>



<hr class="wp-block-separator"><h3><span id="Setting_up_a_VM">Setting up a VM</span></h3>



<p>Let’s start by creating a simple VM.</p>



<p>The first layout we are working on ends up looking like this:</p>



<pre class="wp-block-code"><code>vms
├── terragrunt.hcl
└── testvm.lan.kroy.io
    ├── cloud_init.cfg
    ├── global.tf
    ├── network_config.cfg
    ├── terragrunt.hcl
    └── vm.tf

1 directory, 6 files</code></pre>



<p>Here I’ve created a directory named after the destination VM for organization, and put the files <code>main.tf</code> and <code>terragrunt.hcl</code> in it.</p>



<p>You can name the actual terraform files whatever you want as long as it ends with <code>.tf</code>, but they are processed in alphabetical order.  Usually this won’t make too much of a difference, but in some scenarios it can.</p>



<hr class="wp-block-separator"><h4><span id="The_Config_Files">The Config Files</span></h4>



<ul><li>The first file is the <code>global.tf</code>.  This defines some of the basic pieces of our resource.</li></ul><pre class="wp-block-code"><code> terraform {
    required_version = ">= 0.13"
    required_providers {
        libvirt = {
            source  = "dmacvicar/libvirt"
            version = "0.6.2"
        }
        mikrotik = {
          source = "ddelnano/mikrotik"
          version = "0.3.6"
        }
    }
}

# instance the providers

provider "libvirt" {
    uri = "qemu+ssh://<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="214a534e58614b40424a0f4d404f0f4a534e580f484e">[email protected]</a>/system"
}

provider "mikrotik" {
    host = "crs354.lan.kroy.io:8728"
    username = "admin"
    password = ""
}

resource "libvirt_volume" "os_tmpl" {
  name = "focal_os_tmpl"
  pool = "VM"
  source = "file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img"
  format = "qcow2"
}
</code></pre>



<p>Breaking this down:</p>



<ol><li>The <code>terraform</code> section describes the module versions I want to pull.  In this case, I’m pulling the <code>libvirt</code> and <code>mikrotik</code> modules.   The <code>mikrotik</code> module is used to automatically set a static DHCP lease on my CRS.  This versioning is a the major change in terraform .13 I mentioned earlier. </li><li>The <code>libvirt</code> “provider” section sets up the connection via ssh to the host running libvirt.  User <code>kroy</code> is in the libvirt group on the host.</li><li>The <code>mikrotik</code> provider section connects via the Mikrotik API to my switch that runs my DHCP.</li><li>The final block set up a template disk image using the cloud-init enabled image that was downloaded earlier.</li></ol><hr class="wp-block-separator"><ul><li>The next file is the <code>cloud_init.cfg</code>.  This file runs some “initial setup” tasks in the new VM.</li></ul><pre class="wp-block-code"><code>#cloud-config
hostname: ${hostname}
fqdn: ${fqdn}
manage_etc_hosts: true
users:
  - name: root
    ssh-authorized-keys:
      - ${file("/home/kroy/.ssh/id_ed25519.pub")}
      - ${file("/home/kroy/Documents/infra/terraform/keys/id_ansible.pub")}
  - name: kroy
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/kroy
    shell: /bin/bash
    lock_passwd: false
    ssh-authorized-keys:
      - ${file("/home/kroy/.ssh/id_ed25519.pub")}
      - ${file("/home/kroy/Documents/infra/terraform/keys/id_ansible.pub")}
# only cert auth via ssh (console access can still login)
ssh_pwauth: false
disable_root: false
chpasswd:
  list: |
     kroy:test
  expire: False
packages:
  - qemu-guest-agent

growpart:
  mode: auto
  devices: ['/']
  ignore_growroot_disabled: false

runcmd:
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, qemu-guest-agent.service ]
  - [ systemctl, start, --no-block, qemu-guest-agent.service ]
</code></pre>



<p>If you’ve got any sort of familiarity with Linux, most of what happens in this file should be somewhat self-explanatory, even if you are unfamiliar with the layout and formatting. </p>



<ul><li>Set up hostname, fqdn from variables that will be set from <code>vm.tf</code>.</li><li>Make the <code>/etc/hosts</code> file match the proper config.</li><li>Setup ssh keys and a separate user.  Set the ssh keys to my local ssh keys and ansible keys on my workstation</li><li>Change the password on the <code>kroy</code> user</li><li>Install the QEMU Guest Agent.  This is what allows the host and the VM to communicate.</li><li>Grow the partition to the max size possible.  This makes it so you can easily create a 5GB or 500GB VM from your <code>vm.tf</code>.</li><li>Make sure the guest agent is running.  I was having an issue with it not autostarting, but this series of <code>runcmd</code> allows it to work.</li></ul><hr class="wp-block-separator"><ul><li>The <code>network_config.cfg</code> file.  Somewhat self-documenting. There are other ways to do this, but I’ve found this is easiest for my setup:</li></ul><pre class="wp-block-code"><code>version: 2
ethernets:
  ens3:
     dhcp4: true</code></pre>



<p>This is just a standard <code>netplan</code> config that gets dropped on the new VM.</p>



<hr class="wp-block-separator"><ul><li>The final piece is the <code>vm.tf</code>. As my naming here suggests, this is the actual config for the VM.</li></ul><pre class="wp-block-code"><code># variables that can be overriden
variable "hostname" { default = "bgp" }
variable "domain" { default = "lan.kroy.io" }
variable "memoryGB" { default = 2 }
variable "cpu" { default = 2 }
variable "network" { default = "vibr20" }
variable "disksizeGB" { default = 20 }



resource "libvirt_volume" "os_image" {
  name = "${var.hostname}-os_image"
  pool   = "VM"
  base_volume_id = libvirt_volume.os_tmpl.id
  size = var.disksize * 1024 * 1024 * 1024
}

# Use CloudInit ISO to add ssh-key to the instance
resource "libvirt_cloudinit_disk" "commoninit" {
  name = "${var.hostname}-commoninit.iso"
  pool = "VM"
  user_data = data.template_file.user_data.rendered
  network_config = data.template_file.network_config.rendered
}


data "template_file" "user_data" {
  template = file("${path.module}/cloud_init.cfg")
  vars = {
    hostname = var.hostname
    fqdn = "${var.hostname}.${var.domain}"
  }
}

data "template_file" "network_config" {
  template = file("${path.module}/network_config.cfg")
}


# Create the machine
resource "libvirt_domain" "domain-vm" {
  qemu_agent = true
  name = "${var.hostname}.${var.domain}"
  memory = var.memoryGB * 1024
  vcpu = var.cpu
  cloudinit = libvirt_cloudinit_disk.commoninit.id

  disk {
       volume_id = libvirt_volume.os_image.id
  }
  network_interface {
       wait_for_lease = true
       bridge = var.network
  }

  graphics {
    type = "spice"
    listen_type = "address"
    autoport = "true"
  }
  provisioner "local-exec" {
    environment = {
        IP = join("",slice([for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == "10.20.20"],0,1))
    }
    command = "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i $IP, --key-file=~/Documents/infra/terraform/keys/id_ansible -u root ~/Documents/infra/terraform/ansible/docker/deploy-docker_ubuntu.yml"

  }

}


resource "mikrotik_dhcp_lease" "dhcp" {
  address = join("",slice([for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == "10.20.20"],0,1))
  macaddress = upper(join("",libvirt_domain.domain-vm.*.network_interface.0.mac))
  comment = "${var.hostname}.${var.domain}"
  hostname = var.hostname
}

</code></pre>



<p>There’s obviously a lot going on here, but the short of it is I’ll be creating multiple resources.  A cloud-init “boot disk”, some templates for passing into the cloud-init disk, the actual VM, and the DHCP record on my Mikrotik, which will read the IP of the created VM, and turn it into a static DHCP lease.</p>



<ol><li>The first part of this config is just some variables.  As I create a new VM, assuming I just want a fairly basic VM, all I need to do is change some things here.  To create a new VM, this is all that needs to be changed.  Note that these can be stored in a <code>.tfvars</code> file too for further separation.</li><li>The first resource is the actual VM disk.  Note that the size is multipled by 1024*1024*1024 to translate the size from bytes to gigabytes, for ease of use.</li><li>The next resource and following templates resources pulls in the cloud-init and network configs to build a cloud init image for initial booting and setup. </li><li>The next resource defines the VM.  Most of it should be self-explanatory.  Things like making sure the guest agent is enabled, setting up the hostname and fqdn from the variables, vcpus, memory, disk.  When you want to use data from a different resource, the format is “resource_type.resource_name.id”.  So to later refer to this VM, you’d used <code>libvirt_domain.domain-vm.id</code>.<ol><li>We set up a spice console, important for connecting to it via something like <code>virt-manager</code>.</li><li>The <code>network_interface</code> resource here tells it to wait for a lease.  This is necessary since I want my Mikrotik resource below to be have access to the IP that the VM was issued via DHCP.  This saves me from having to hard-code IPs.</li><li>I have a <code>local-exec</code> provisioner here.  This is how I call Ansible to configure the VM.  In this case I’ll be setting this host up as one of my Docker VMs.  Note that I’m doing some severe hacky stuff to make sure I only grab the IP in the subnet that I want.  </li></ol></li><li>Finally, the Mikrotik resource. As mentioned a few times, this sets a static DHCP lease on my main DHCP server, using the same hacky IP pulling code as above.</li></ol><hr class="wp-block-separator"><h4><span id="Terraforming_the_Virtual_Machine">Terraforming the Virtual Machine</span></h4>



<p>Now that all the resources and config are declared, it’s time to actually create the VM.</p>



<p>The first step is to <code>initialize</code> the terraform repo here.  This causes it to pull the required modules and prepare for deployment.</p>



<pre class="wp-block-code"><code>❯ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/template...
- Finding dmacvicar/libvirt versions matching "0.6.2"...
- Finding ddelnano/mikrotik versions matching "0.3.6"...
- Installing hashicorp/template v2.2.0...
- Installed hashicorp/template v2.2.0 (signed by HashiCorp)
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)
- Installing ddelnano/mikrotik v0.3.6...
- Installed ddelnano/mikrotik v0.3.6 (self-signed, key ID DDBA1674AA3EA0EE)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/plugins/signing.html

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, we recommend adding version constraints in a required_providers block
in your configuration, with the constraint strings suggested below.

* hashicorp/template: version = "~> 2.2.0"

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.❯ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding dmacvicar/libvirt versions matching "0.6.2"...
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre>



<p>Assuming you get a success message there and some green text, you can proceed to <code>plan</code> or even <code>apply</code>.</p>



<p><code>plan</code> shows you want it’s going to do.  <code>apply</code> will do it (with confirmation by default, but it can be overridden).</p>



<pre class="wp-block-code"><code>❯ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.network_config: Refreshing state...
data.template_file.user_data: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # libvirt_cloudinit_disk.commoninit will be created
  + resource "libvirt_cloudinit_disk" "commoninit" {
      + id             = (known after apply)
      + name           = "testvm-commoninit.iso"
      + network_config = <<~EOT
            version: 2
            ethernets:
              ens3:
                 dhcp4: true
        EOT
      + pool           = "VM"
      + user_data      = <<~EOT
            #cloud-config
            hostname: testvm
            fqdn: testvm.lan.kroy.io
            manage_etc_hosts: true
            users:
              - name: root
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
              - name: kroy
                sudo: ALL=(ALL) NOPASSWD:ALL
                groups: users, admin
                home: /home/kroy
                shell: /bin/bash
                lock_passwd: false
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
            # only cert auth via ssh (console access can still login)
            ssh_pwauth: false
            disable_root: false
            chpasswd:
              list: |
                 kroy:test
              expire: False
            packages:
              - qemu-guest-agent
            
            growpart:
              mode: auto
              devices: ['/']
              ignore_growroot_disabled: false
            
            runcmd:
              - [ systemctl, daemon-reload ]
              - [ systemctl, enable, qemu-guest-agent.service ]
              - [ systemctl, start, --no-block, qemu-guest-agent.service ]
        EOT
    }

  # libvirt_domain.domain-vm will be created
  + resource "libvirt_domain" "domain-vm" {
      + arch        = (known after apply)
      + cloudinit   = (known after apply)
      + disk        = [
          + {
              + block_device = null
              + file         = null
              + scsi         = null
              + url          = null
              + volume_id    = (known after apply)
              + wwn          = null
            },
        ]
      + emulator    = (known after apply)
      + fw_cfg_name = "opt/com.coreos/config"
      + id          = (known after apply)
      + machine     = (known after apply)
      + memory      = 2048
      + name        = "testvm.lan.kroy.io"
      + qemu_agent  = true
      + running     = true
      + vcpu        = 2

      + graphics {
          + autoport       = true
          + listen_address = "127.0.0.1"
          + listen_type    = "address"
          + type           = "spice"
        }

      + network_interface {
          + addresses      = (known after apply)
          + bridge         = "vibr20"
          + hostname       = (known after apply)
          + mac            = (known after apply)
          + network_id     = (known after apply)
          + network_name   = (known after apply)
          + wait_for_lease = true
        }
    }

  # libvirt_volume.os_image will be created
  + resource "libvirt_volume" "os_image" {
      + base_volume_id = (known after apply)
      + format         = (known after apply)
      + id             = (known after apply)
      + name           = "testvm-os_image"
      + pool           = "VM"
      + size           = 21474836480
    }

  # libvirt_volume.os_tmpl will be created
  + resource "libvirt_volume" "os_tmpl" {
      + format = "qcow2"
      + id     = (known after apply)
      + name   = "focal_os_tmpl"
      + pool   = "VM"
      + size   = (known after apply)
      + source = "file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img"
    }

  # mikrotik_dhcp_lease.dhcp will be created
  + resource "mikrotik_dhcp_lease" "dhcp" {
      + address    = (known after apply)
      + blocked    = "false"
      + comment    = "testvm.lan.kroy.io"
      + dynamic    = false
      + hostname   = "testvm"
      + id         = (known after apply)
      + macaddress = (known after apply)
    }

Plan: 5 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an "-out" parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
"terraform apply" is subsequently run.
</code></pre>



<p>Note the bottom line where is says it’s going to add 5, change 0, destroy 0.  </p>



<p>Keep remembering that all terraform is concerned with is state.  So it will happily delete and nuke everything to get it to make the state that you want.  So if a <code>plan</code> or <code>apply</code> says it’s going to delete a bunch of stuff and that’s not what you wanted, escape now!</p>



<p>Finally, <code>terraform apply</code> looks much like the plan above, and adds a few extra lines to confirm the operation (if you haven’t passed the option to skip it).</p>



<pre class="wp-block-code"><code>Plan: 5 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

...

Apply complete! Resources: 5 added, 0 changed, 0 destroyed
</code></pre>



<p>This should hopefully complete without error, and if you do a <code>virsh list</code> on the libvirt host, you’ll see something like:</p>



<pre class="wp-block-code"><code># virsh list 
 Id   Name                 State
------------------------------------
 1    testvm.lan.kroy.io   running
</code></pre>



<p>In my <code>terraform apply</code> output, I have <code>libvirt_domain.domain-vm (local-exec): ok: [10.20.20.79]</code>, which means I should be able to ssh there</p>



<pre class="wp-block-code"><code>❯ ssh <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cfa4bda0b68ffeffe1fdffe1fdffe1f8f6">[email protected]</a>
Warning: Permanently added '10.20.20.79' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-51-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Nov  2 17:55:54 UTC 2020

  System load:              0.0
  Usage of /:               11.0% of 19.21GB
  Memory usage:             15%
  Swap usage:               0%
  Processes:                121
  Users logged in:          0
  IPv4 address for docker0: 172.17.0.1
  IPv4 address for ens3:    10.20.20.79
 

41 updates can be installed immediately.
15 of these updates are security updates.
To see these additional updates run: apt list --upgradable



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0d667f62744d79687e797b60">[email protected]</a>:~$</code></pre>



<p>SUCCESS!</p>



<hr class="wp-block-separator"><h3><span id="Terragrunt">Terragrunt</span></h3>



<p>Even though we’ve only got a single resource so far, I want to touch on what <code>terragrunt</code> accomplishes for you.  </p>



<p>Terraform only works on single directories.  So say I wanted to add a second VM.  </p>



<p>I would do something like:</p>



<pre class="wp-block-code"><code>cd terraformroot
cp -pr vms/testvm.lan.kroy.io vms/doubletest.lan.kroy.io
rm vms/doubletest.lan.kroy.io/terraform.tfstate*
sed -i -e 's/testvm/doubletest/' vms/doubletest.lan.kroy.io/vm.tf</code></pre>



<p>Hopefully that is mostly self-explanatory:</p>



<ul><li>Change into our terraform directory.</li><li>Copying the existing config to a new VM directory.</li><li>Remove all the old terraform state files.  This is <em>VERY</em> important if you are going to be using terraform like this.  This is basically the main “database” for terraform and if you want to create a new resource, you don’t want the old database in the new resource directory.</li><li>A not-so-fancy one-liner to change the hostname of the new VM.</li></ul><p>Now you would have a few options to determine how you want to apply this configuration:</p>



<ol><li>Switch to <code>terraformroot/vms/doubletest.lan.kroy.io</code>, do a <code>terraform apply</code>.   This would only apply the state for this VM.</li><li>Switch to <code>terraformroot/vms</code>, do a <code>terragrunt apply-all</code>.  This would apply the state for <code>testvm.lan.kroy.io </code> and <code>doubletest.lan.kroy.io</code>.</li><li>Switch to <code>terraformroot</code>, and again, <code>terragrunt apply-all</code>.  This would apply the state for all resources under <code>vms</code>, and any future projects, like networking configs, LXC, etc.</li></ol><p>In all that, you can also do <code>plan-all</code> on terragrunt to see what it’s going to change.</p>



<p>In the directory for these VMs resources, I’ve got a <code>terragrunt.hcl</code>.  The contents of this are simply:</p>



<pre class="wp-block-code"><code>include {
  path = find_in_parent_folders()
}</code></pre>



<p>This says “look in any parent folders, and execute the actions of their <code>terragrunt.hcl</code>.”</p>



<p>This is powerful because you can have specific actions for just the <code>vms</code> directory or everything. That’s why the content of my <code>terragrunt.hcl</code> in the <code>vms</code> directory contains:</p>



<pre class="wp-block-code"><code>terraform {
  after_hook "after_hook" {
    commands     = ["apply"]
    execute      = ["/bin/bash","/home/kroy/Documents/infra/terraform/updatedns.sh"]
    run_on_error = true
  }
}
</code></pre>



<p>As is implied, this runs after you type <code>terragrunt apply</code> or <code>apply-all</code>. </p>



<p>Being in the <code>vms</code> sub-directory, when would this run?</p>



<ol><li>In the individual VM resource directory due to the <code>find_in_parent_folders</code> when you run terragrunt with apply or apply-all.</li><li>In the <code>vms</code> sub-directory when running apply all. You can’t run apply because that only looks in the current directory.</li><li>In the main <code>terraformroot</code> directory.    </li></ol><p>So running a <code>terragrunt apply-all</code> in the <code>vms</code> directory:</p>



<pre class="wp-block-code"><code>[terragrunt] 2020/11/02 12:13:11 Stack at /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms:
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/doubletest.lan.kroy.io (excluded: false, dependencies: [])
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io (excluded: false, dependencies: [])
[terragrunt] 2020/11/02 12:13:11 [terragrunt]  Are you sure you want to run 'terragrunt apply' in each folder of the stack described above? (y/n) </code></pre>



<p>The output of this shows that the new VM was created (and the original VM was at least looked at), and my post-hook is run once:</p>



<pre class="wp-block-code"><code>Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Detected 1 Hooks
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Executing hook: after_hook
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Running command: /bin/bash /home/kroy/Documents/infra/terraform/updatedns.sh
[terragrunt] [/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io has finished successfully!</code></pre>



<hr class="wp-block-separator"><h2><span id="Conclusion">Conclusion</span></h2>



<p>Well, there you have it.   Is this the perfect layout?  Probably not.  Is there room for improvement?  Absolutely.</p>



<p>I have put up a git repo <a rel="noreferrer noopener" href="https://github.com/kroy-the-rabbit/esxitolibvirt-blog" data-type="URL" data-id="https://github.com/kroy-the-rabbit/esxitolibvirt-blog" target="_blank">HERE</a>, containing all of the examples from above.</p>



<p>Of course this is far from complete.  With this setup, all you have are fairly blank and basic VMs.  You’d want to hit them with Ansible or something to finish configuring them.  But that’s a post for another day.</p>



<p>Enjoy!</p>
<div class="sfsi_responsive_icons" style="display:inline-block;margin-top:0px; margin-bottom: 0px; width:100%" data-icon-width-type="Fully responsive" data-icon-width-size="240" data-edge-type="Round" data-edge-radius="5">		<div class="sfsi_responsive_icons_count sfsi_responsive_count_container sfsi_medium_button" style="display:none;text-align:center; background-color:#fff;color:#aaaaaa;  border-radius:5px; ;">
			<h3 style="color:#aaaaaa; "><span id="60">60</span></h3>
			<h6 style="color:#aaaaaa;"><span id="SHARES">SHARES</span></h6>
		</div>
		<div class="sfsi_icons_container sfsi_responsive_without_counter_icons sfsi_medium_button_container sfsi_icons_container_box_fully_container " style="width:100%;display:flex; ; text-align:center;">		<a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.kroy.io%2F2020%2F11%2F03%2Fesxi-to-libvirt-now-with-more-terraform%2F" style="display:block;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_icon_facebook_container sfsi_medium_button sfsi_responsive_icon_gradient sfsi_centered_icon" style=" border-radius:5px;  width:100%; ">
				<img style="max-height: 25px;display:unset;margin:0" class="sfsi_wicon" alt="facebook" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/responsive-icon/facebook.svg"><span style="color:#fff">Share on Facebook</span>
			</div>
		</a>

		<a target="_blank" href="https://twitter.com/intent/tweet?text=Hey%2C+check+out+this+cool+site+I+found%3A+www.yourname.com+%23Topic+via%40my_twitter_name&url=https%3A%2F%2Fblog.kroy.io%2F2020%2F11%2F03%2Fesxi-to-libvirt-now-with-more-terraform%2F" style="display:block;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_icon_twitter_container sfsi_medium_button sfsi_responsive_icon_gradient sfsi_centered_icon" style=" border-radius:5px;  width:100%; ">
				<img style="max-height: 25px;display:unset;margin:0" class="sfsi_wicon" alt="Twitter" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/responsive-icon/Twitter.svg"><span style="color:#fff">Tweet</span>
			</div>
		</a>

		<a target="_blank" href="https://api.follow.it/widgets/icon/SERxZVdXbkRiWE9LYThHK2pmY09ydUlMSkF3cm9ERmJpV2JlS3p0Z1locmlNWjBFeGZtaFBCMEF4Q1hRblVqN0JUbGFXRXg4Y25yUnpVcFN0TUVQeTdIVUtkT1JVRXg2SXJvYndWbEJhRi9ZenJWdk1XSlc1VWQwQVIvNVY3dWJ8YnBDU2RZbGZvSzFjVlBLVDRjWGYwellwelNqT2ZCQzFzbmp6V24vN0FQOD0=/OA==/" style="display:block;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_icon_follow_container sfsi_medium_button sfsi_responsive_icon_gradient sfsi_centered_icon" style=" border-radius:5px;  width:100%; ">
				<img style="max-height: 25px;display:unset;margin:0" class="sfsi_wicon" alt="Follow" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/responsive-icon/Follow.png"><span style="color:#fff">Follow us</span>
			</div>
		</a>

		<a target="_blank" href="" style="display:none;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_custom_icon sfsi_responsive_icon_0_container sfsi_medium_button sfsi_centered_icon sfsi_responsive_icon_gradient" style=" border-radius:5px;  width:100%; background-color:#729fcf">
				<img style="max-height: 25px" alt="custom" src=""><span style="color:#fff">Share</span>
			</div>
		</a>

		<a target="_blank" href="" style="display:none;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_custom_icon sfsi_responsive_icon_1_container sfsi_medium_button sfsi_centered_icon sfsi_responsive_icon_gradient" style=" border-radius:5px;  width:100%; background-color:#729fcf">
				<img style="max-height: 25px" alt="custom" src=""><span style="color:#fff">Share</span>
			</div>
		</a>

		<a target="_blank" href="" style="display:none;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_custom_icon sfsi_responsive_icon_2_container sfsi_medium_button sfsi_centered_icon sfsi_responsive_icon_gradient" style=" border-radius:5px;  width:100%; background-color:#729fcf">
				<img style="max-height: 25px" alt="custom" src=""><span style="color:#fff">Share</span>
			</div>
		</a>

		<a target="_blank" href="" style="display:none;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_custom_icon sfsi_responsive_icon_3_container sfsi_medium_button sfsi_centered_icon sfsi_responsive_icon_gradient" style=" border-radius:5px;  width:100%; background-color:#729fcf">
				<img style="max-height: 25px" alt="custom" src=""><span style="color:#fff">Share</span>
			</div>
		</a>

		<a target="_blank" href="" style="display:none;text-align:center;margin-left:10px;  flex-basis:100%;" class="sfsi_responsive_fluid">
			<div class="sfsi_responsive_icon_item_container sfsi_responsive_custom_icon sfsi_responsive_icon_4_container sfsi_medium_button sfsi_centered_icon sfsi_responsive_icon_gradient" style=" border-radius:5px;  width:100%; background-color:#729fcf">
				<img style="max-height: 25px" alt="custom" src=""><span style="color:#fff">Share</span>
			</div>
		</a>

</div></div></div>




<div class="entry-footer">

	<span class="screen-reader-text">Tags: </span><div class="post-tags"><span class="cat-links"><a href="https://blog.kroy.io/tag/ansible/" rel="tag">ansible</a><a href="https://blog.kroy.io/tag/kvm/" rel="tag">kvm</a><a href="https://blog.kroy.io/tag/migration/" rel="tag">migration</a><a href="https://blog.kroy.io/tag/terraform/" rel="tag">terraform</a><a href="https://blog.kroy.io/tag/vmware/" rel="tag">vmware</a></span></div><span class="last-updated">Last updated on November 3, 2020</span>
</div>


<section class="author-box" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><div class="author-box-avatar">
		<img alt="" src="https://secure.gravatar.com/avatar/347d9cf482cfe91444ae0d59550ad83c?s=75&d=mm&r=g" srcset="https://secure.gravatar.com/avatar/347d9cf482cfe91444ae0d59550ad83c?s=150&d=mm&r=g 2x" class="avatar avatar-75 photo" height="75" width="75" loading="lazy"></div>

	<div class="author-box-meta">
		<h4 class="author-box-title">
							<a href="https://blog.kroy.io/author/kroy3348/" class="url fn n" rel="author" itemprop="url">
				Kroy	
				</a>
						</h4>

		
		
		<div class="author-box-content" itemprop="description">
			sometimes hacker of things and other things...		</div>

		
<div class="more-posts-button">
	<a href="https://blog.kroy.io/author/kroy3348/" class="si-btn btn-text-1" role="button"><span>View All Posts</span></a>
</div>
	</div>

</section><section class="post-nav" role="navigation"><h2 class="screen-reader-text">Post navigation</h2>

	<div class="nav-previous"><h6 class="nav-title">Previous Post</h6><a href="https://blog.kroy.io/2020/05/04/vyos-from-scratch-edition-1/" rel="prev"><div class="nav-content"><img width="75" height="68" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-5-150x135.png" class="attachment-75x75 size-75x75 wp-post-image" alt="VyOS from Scratch – Edition 1" loading="lazy" itemprop="image"><span>VyOS from Scratch – Edition 1</span></div></a></div>
</section></article></main></div>

	
<aside id="secondary" class="widget-area si-sidebar-container" itemtype="http://schema.org/WPSideBar" itemscope="itemscope" role="complementary"><div class="si-sidebar-inner">
		
		
		<div id="recent-posts-2" class="si-sidebar-widget si-widget si-entry widget widget_recent_entries">
		<h4 class="widget-title">Recent Posts</h4>
		<ul><li>
					<a href="https://blog.kroy.io/2020/11/03/esxi-to-libvirt-now-with-more-terraform/" aria-current="page">ESXi to Libvirt, now with more Terraform.</a>
									</li>
											<li>
					<a href="https://blog.kroy.io/2020/05/04/vyos-from-scratch-edition-1/">VyOS from Scratch – Edition 1</a>
									</li>
											<li>
					<a href="https://blog.kroy.io/2020/01/17/the-baby-wyse-the-dell-3040/">A Baby WYSE, the 3040</a>
									</li>
											<li>
					<a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/">The WYSE 5070, a perfect little VyOS device</a>
									</li>
											<li>
					<a href="https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/">Battle of the Bare Metal Routers</a>
									</li>
					</ul></div><div id="archives-2" class="si-sidebar-widget si-widget si-entry widget widget_archive"><h4 class="widget-title">Archives</h4>
			<ul><li><a href="https://blog.kroy.io/2020/11/">November 2020</a></li>
	<li><a href="https://blog.kroy.io/2020/05/">May 2020</a></li>
	<li><a href="https://blog.kroy.io/2020/01/">January 2020</a></li>
	<li><a href="https://blog.kroy.io/2019/12/">December 2019</a></li>
	<li><a href="https://blog.kroy.io/2019/11/">November 2019</a></li>
	<li><a href="https://blog.kroy.io/2019/10/">October 2019</a></li>
	<li><a href="https://blog.kroy.io/2019/09/">September 2019</a></li>
	<li><a href="https://blog.kroy.io/2019/08/">August 2019</a></li>
	<li><a href="https://blog.kroy.io/2019/01/">January 2019</a></li>
	<li><a href="https://blog.kroy.io/2018/11/">November 2018</a></li>
	<li><a href="https://blog.kroy.io/2018/07/">July 2018</a></li>
	<li><a href="https://blog.kroy.io/2018/05/">May 2018</a></li>
	<li><a href="https://blog.kroy.io/2017/12/">December 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/08/">August 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/07/">July 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/06/">June 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/05/">May 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/04/">April 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/03/">March 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/02/">February 2017</a></li>
	<li><a href="https://blog.kroy.io/2017/01/">January 2017</a></li>
			</ul></div><div id="categories-2" class="si-sidebar-widget si-widget si-entry widget widget_categories"><h4 class="widget-title">Categories</h4>
			<ul><li class="cat-item cat-item-39"><a href="https://blog.kroy.io/category/automation/">Automation</a>
</li>
	<li class="cat-item cat-item-12"><a href="https://blog.kroy.io/category/ceph/">ceph</a>
</li>
	<li class="cat-item cat-item-19"><a href="https://blog.kroy.io/category/debian/">Debian</a>
</li>
	<li class="cat-item cat-item-22"><a href="https://blog.kroy.io/category/docker/">Docker</a>
</li>
	<li class="cat-item cat-item-24"><a href="https://blog.kroy.io/category/virtualization/esxi/">ESXi</a>
</li>
	<li class="cat-item cat-item-7"><a href="https://blog.kroy.io/category/freenas/">freenas</a>
</li>
	<li class="cat-item cat-item-26"><a href="https://blog.kroy.io/category/hardware/">Hardware</a>
</li>
	<li class="cat-item cat-item-29"><a href="https://blog.kroy.io/category/hardware-hacks/">Hardware Hacks</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://blog.kroy.io/category/homelab/">HomeLab</a>
</li>
	<li class="cat-item cat-item-38"><a href="https://blog.kroy.io/category/virtualization/kvm/">KVM</a>
</li>
	<li class="cat-item cat-item-2"><a href="https://blog.kroy.io/category/mediaserver/">mediaserver</a>
</li>
	<li class="cat-item cat-item-15"><a href="https://blog.kroy.io/category/mikrotik/">mikrotik</a>
</li>
	<li class="cat-item cat-item-20"><a href="https://blog.kroy.io/category/networking/">Networking</a>
</li>
	<li class="cat-item cat-item-8"><a href="https://blog.kroy.io/category/nucnucnuc/">nucnucnuc</a>
</li>
	<li class="cat-item cat-item-9"><a href="https://blog.kroy.io/category/pfsense/">pfsense</a>
</li>
	<li class="cat-item cat-item-11"><a href="https://blog.kroy.io/category/proxmox/">proxmox</a>
</li>
	<li class="cat-item cat-item-25"><a href="https://blog.kroy.io/category/virtualization/proxmox-virtualization/">Proxmox</a>
</li>
	<li class="cat-item cat-item-13"><a href="https://blog.kroy.io/category/qnap/">QNAP</a>
</li>
	<li class="cat-item cat-item-31"><a href="https://blog.kroy.io/category/homelab/rack-migration/">Rack Migration</a>
</li>
	<li class="cat-item cat-item-14"><a href="https://blog.kroy.io/category/routeros/">RouterOS</a>
</li>
	<li class="cat-item cat-item-18"><a href="https://blog.kroy.io/category/routing/" title="Stuff about routing">Routing</a>
</li>
	<li class="cat-item cat-item-21"><a href="https://blog.kroy.io/category/rtlsdr/">RTLSDR</a>
</li>
	<li class="cat-item cat-item-30"><a href="https://blog.kroy.io/category/storage/">Storage</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://blog.kroy.io/category/sysadmin/">SysAdmin</a>
</li>
	<li class="cat-item cat-item-40"><a href="https://blog.kroy.io/category/automation/terraform/">Terraform</a>
</li>
	<li class="cat-item cat-item-46"><a href="https://blog.kroy.io/category/ubuntu/">Ubuntu</a>
</li>
	<li class="cat-item cat-item-23"><a href="https://blog.kroy.io/category/virtualization/">Virtualization</a>
</li>
	<li class="cat-item cat-item-16"><a href="https://blog.kroy.io/category/vyos/">VyOS</a>
</li>
	<li class="cat-item cat-item-5"><a href="https://blog.kroy.io/category/zfs/">ZFS</a>
</li>
			</ul></div><div id="meta-2" class="si-sidebar-widget si-widget si-entry widget widget_meta"><h4 class="widget-title">Meta</h4>
		<ul><li><a href="https://blog.kroy.io/wp-login.php">Log in</a></li>
			<li><a href="https://blog.kroy.io/feed/">Entries feed</a></li>
			<li><a href="https://blog.kroy.io/comments/feed/">Comments feed</a></li>

			<li><a href="https://wordpress.org/">WordPress.org</a></li>
		</ul></div><div id="custom_html-2" class="widget_text si-sidebar-widget si-widget si-entry widget widget_custom_html"><div class="textwidget custom-html-widget"><div id="amzn-assoc-ad-96eac8be-1743-4b44-98e2-f274484e1cac"></div><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=96eac8be-1743-4b44-98e2-f274484e1cac"></script></div></div>
			</div>

</aside></div>

		
	</div>
	
	
			<footer id="colophon" class="site-footer" role="contentinfo" itemtype="http://schema.org/WPFooter" itemscope="itemscope"><div id="sinatra-copyright" class="contained-separator">
	<div class="si-container">
		<div class="si-flex-row">

			<div class="col-xs-12 center-xs col-md flex-basis-auto start-md"><div class="si-copyright-widget__text si-copyright-widget sinatra-all"><span>Copyright 2020 — blog.kroy.io. All rights reserved. <a href="https://wordpress.org/themes/sinatra/" class="imprint" target="_blank" rel="noopener noreferrer">Sinatra WordPress Theme</a></span></div></div>
			<div class="col-xs-12 center-xs col-md flex-basis-auto end-md"></div>

		</div>
	</div>
</div>

		</footer></div>

<a href="#" id="si-scroll-top" class="si-smooth-scroll" title="Scroll to Top">
	<span class="si-scroll-icon" aria-hidden="true">
		<i class="si-icon si-chevron-up top-icon"></i>
		<i class="si-icon si-chevron-up"></i>
	</span>
	<span class="screen-reader-text">Scroll to Top</span>
</a>
			
			<div id="fb-root"></div>
			<script>
				(function(d, s, id) {
					var js, fjs = d.getElementsByTagName(s)[0];
					if (d.getElementById(id)) return;
					js = d.createElement(s);
					js.id = id;
					js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
					fjs.parentNode.insertBefore(js, fjs);
				}(document, 'script', 'facebook-jssdk'));
			</script><script>
window.addEventListener('sfsi_functions_loaded', function() {
    if (typeof sfsi_responsive_toggle == 'function') {
        sfsi_responsive_toggle(0);
        // console.log('sfsi_responsive_toggle');

    }
})
</script><style type="text/css">#sfsi_floater { margin-right:0px; }</style><div class="norm_row sfsi_wDiv" id="sfsi_floater" style="z-index: 9999;width:225px;text-align:left;position:absolute;position:absolute;right:30px;top:50%"><div style="width:40px; height:40px;margin-left:5px;margin-bottom:5px; " class="sfsi_wicons shuffeldiv "><div class="inerCnt"><a class=" sficn" data-effect="" target="_blank" href="https://blog.kroy.io/feed/" id="sfsiid_rss" style="opacity:1"><img data-pin-nopin="true" alt="RSS" title="RSS" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/icons_theme/default/default_rss.png" width="40" height="40" style="" class="sfcm sfsi_wicon " data-effect=""></a></div></div><div style="width:40px; height:40px;margin-left:5px;margin-bottom:5px; " class="sfsi_wicons shuffeldiv "><div class="inerCnt"><a class=" sficn" data-effect="" target="_blank" href="https://api.follow.it/widgets/icon/SERxZVdXbkRiWE9LYThHK2pmY09ydUlMSkF3cm9ERmJpV2JlS3p0Z1locmlNWjBFeGZtaFBCMEF4Q1hRblVqN0JUbGFXRXg4Y25yUnpVcFN0TUVQeTdIVUtkT1JVRXg2SXJvYndWbEJhRi9ZenJWdk1XSlc1VWQwQVIvNVY3dWJ8YnBDU2RZbGZvSzFjVlBLVDRjWGYwellwelNqT2ZCQzFzbmp6V24vN0FQOD0=/OA==/" id="sfsiid_email" style="opacity:1"><img data-pin-nopin="true" alt="Follow by Email" title="Follow by Email" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/icons_theme/default/default_email.png" width="40" height="40" style="" class="sfcm sfsi_wicon " data-effect=""></a></div></div><div style="width:40px; height:40px;margin-left:5px;margin-bottom:5px; " class="sfsi_wicons shuffeldiv "><div class="inerCnt"><a class=" sficn" data-effect="" target="_blank" href="" id="sfsiid_facebook" style="opacity:1"><img data-pin-nopin="true" alt="Facebook" title="Facebook" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/icons_theme/default/default_facebook.png" width="40" height="40" style="" class="sfcm sfsi_wicon " data-effect=""></a><div class="sfsi_tool_tip_2 fb_tool_bdr sfsiTlleft" style="width:62px ;opacity:0;z-index:-1;margin-left:-47.5px;" id="sfsiid_facebook"><span class="bot_arow bot_fb_arow"></span><div class="sfsi_inside"><div class="icon2"><div class="fb-like" data-href="https://blog.kroy.io/2020/11/03/esxi-to-libvirt-now-with-more-terraform" data-layout="button" data-action="like" data-show-faces="false" data-share="true"></div></div><div class="icon3"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.kroy.io%2F2020%2F11%2F03%2Fesxi-to-libvirt-now-with-more-terraform" style="display:inline-block;"> <img class="sfsi_wicon" data-pin-nopin="true" width="auto" height="auto" alt="fb-share-icon" title="Facebook Share" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/visit_icons/fbshare_bck.png"></a></div></div></div></div></div><div style="width:40px; height:40px;margin-left:5px;margin-bottom:5px; " class="sfsi_wicons shuffeldiv "><div class="inerCnt"><a class=" sficn" data-effect="" target="_blank" href="" id="sfsiid_twitter" style="opacity:1"><img data-pin-nopin="true" alt="Twitter" title="Twitter" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/icons_theme/default/default_twitter.png" width="40" height="40" style="" class="sfcm sfsi_wicon " data-effect=""></a><div class="sfsi_tool_tip_2 twt_tool_bdr sfsiTlleft" style="width:59px ;opacity:0;z-index:-1;margin-left:-46px;" id="sfsiid_twitter"><span class="bot_arow bot_twt_arow"></span><div class="sfsi_inside"><div class="icon2"><div class="sf_twiter" style="display: inline-block;vertical-align: middle;width: auto;">
						<a target="_blank" href="https://twitter.com/intent/tweet?text=Hey%2C+check+out+this+cool+site+I+found%3A+www.yourname.com+%23Topic+via%40my_twitter_name+https://blog.kroy.io/2020/11/03/esxi-to-libvirt-now-with-more-terraform" style="display:inline-block">
							<img data-pin-nopin="true" width="auto" class="sfsi_wicon" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/visit_icons/en_US_Tweet.svg" alt="Tweet" title="Tweet"></a>
					</div></div></div></div></div></div><div style="width:40px; height:40px;margin-left:5px;margin-bottom:5px; " class="sfsi_wicons shuffeldiv "><div class="inerCnt"><a class=" sficn" data-effect="" target="_blank" href="" id="sfsiid_linkedin" style="opacity:1"><img data-pin-nopin="true" alt="LinkedIn" title="LinkedIn" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/icons_theme/default/default_linkedin.png" width="40" height="40" style="" class="sfcm sfsi_wicon " data-effect=""></a><div class="sfsi_tool_tip_2 linkedin_tool_bdr sfsiTlleft" style="width:85px ;opacity:0;z-index:-1;margin-left:-45px;" id="sfsiid_linkedin"><span class="bot_arow bot_linkedin_arow"></span><div class="sfsi_inside"><div class="icon2"><a target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fblog.kroy.io%2F2020%2F11%2F03%2Fesxi-to-libvirt-now-with-more-terraform"><img class="sfsi_wicon" data-pin-nopin="true" alt="Share" title="Share" src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/images/visit_icons/lnkdin_share_bck.png"></a></div></div></div></div></div></div><input type="hidden" id="sfsi_floater_sec" value="center-right"><script>window.addEventListener("sfsi_functions_loaded", function() 
			{
				if (typeof sfsi_widget_set == "function") {
					sfsi_widget_set();
				}
			}); window.addEventListener('sfsi_functions_loaded',function()
					  {
						var topalign = ( jQuery(window).height() - jQuery('#sfsi_floater').height() ) / 2;
						jQuery('#sfsi_floater').css('top',topalign);
					  	sfsi_float_widget('center');
					  });</script><script>
        window.addEventListener('sfsi_functions_loaded', function() {
            if (typeof sfsi_plugin_version == 'function') {
                sfsi_plugin_version(2.60);
            }
        });

        function sfsi_processfurther(ref) {
            var feed_id = 'SERxZVdXbkRiWE9LYThHK2pmY09ydUlMSkF3cm9ERmJpV2JlS3p0Z1locmlNWjBFeGZtaFBCMEF4Q1hRblVqN0JUbGFXRXg4Y25yUnpVcFN0TUVQeTdIVUtkT1JVRXg2SXJvYndWbEJhRi9ZenJWdk1XSlc1VWQwQVIvNVY3dWJ8YnBDU2RZbGZvSzFjVlBLVDRjWGYwellwelNqT2ZCQzFzbmp6V24vN0FQOD0=';
            var feedtype = 8;
            var email = jQuery(ref).find('input[name="email"]').val();
            var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            if ((email != "Enter your email") && (filter.test(email))) {
                if (feedtype == "8") {
                    var url = "https://api.follow.it/subscription-form/" + feed_id + "/" + feedtype;
                    window.open(url, "popupwindow", "scrollbars=yes,width=1080,height=760");
                    return true;
                }
            } else {
                alert("Please enter email address");
                jQuery(ref).find('input[name="email"]').focus();
                return false;
            }
        }
    </script><style type="text/css" aria-selected="true">
        .sfsi_subscribe_Popinner {
            width: 100% !important;

            height: auto !important;

            padding: 18px 0px !important;

            background-color: #ffffff !important;

        }

        .sfsi_subscribe_Popinner form {

            margin: 0 20px !important;

        }

        .sfsi_subscribe_Popinner h5 {

            font-family: Helvetica,Arial,sans-serif !important;

            font-weight: bold !important;

            color: #000000 !important;

            font-size: 16px !important;

            text-align: center !important;

            margin: 0 0 10px !important;

            padding: 0 !important;

        }

        .sfsi_subscription_form_field {

            margin: 5px 0 !important;

            width: 100% !important;

            display: inline-flex;

            display: -webkit-inline-flex;

        }

        .sfsi_subscription_form_field input {

            width: 100% !important;

            padding: 10px 0px !important;

        }

        .sfsi_subscribe_Popinner input[type=email] {

            font-family: Helvetica,Arial,sans-serif !important;

            font-style: normal !important;

            color: #000000 !important;

            font-size: 14px !important;

            text-align: center !important;

        }

        .sfsi_subscribe_Popinner input[type=email]::-webkit-input-placeholder {

            font-family: Helvetica,Arial,sans-serif !important;

            font-style: normal !important;

            color: #000000 !important;

            font-size: 14px !important;

            text-align: center !important;

        }

        .sfsi_subscribe_Popinner input[type=email]:-moz-placeholder {
            /* Firefox 18- */

            font-family: Helvetica,Arial,sans-serif !important;

            font-style: normal !important;

            color: #000000 !important;

            font-size: 14px !important;

            text-align: center !important;

        }

        .sfsi_subscribe_Popinner input[type=email]::-moz-placeholder {
            /* Firefox 19+ */

            font-family: Helvetica,Arial,sans-serif !important;

            font-style: normal !important;

            color: #000000 !important;

            font-size: 14px !important;

            text-align: center !important;

        }

        .sfsi_subscribe_Popinner input[type=email]:-ms-input-placeholder {

            font-family: Helvetica,Arial,sans-serif !important;

            font-style: normal !important;

            color: #000000 !important;

            font-size: 14px !important;

            text-align: center !important;

        }

        .sfsi_subscribe_Popinner input[type=submit] {

            font-family: Helvetica,Arial,sans-serif !important;

            font-weight: bold !important;

            color: #000000 !important;

            font-size: 16px !important;

            text-align: center !important;

            background-color: #dedede !important;

        }

        .sfsi_shortcode_container {
            float: left;
        }

        .sfsi_shortcode_container .norm_row .sfsi_wDiv {
            position: relative !important;
        }

        .sfsi_shortcode_container .sfsi_holders {
            display: none;
        }

            </style><link rel="stylesheet" id="lwptoc-main-css" href="https://blog.kroy.io/wp-content/plugins/luckywp-table-of-contents/front/assets/main.min.css" media="all"><script src="https://blog.kroy.io/wp-includes/js/jquery/ui/core.min.js" id="jquery-ui-core-js"></script><script src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/js/shuffle/modernizr.custom.min.js" id="SFSIjqueryModernizr-js"></script><script src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/js/shuffle/jquery.shuffle.min.js" id="SFSIjqueryShuffle-js"></script><script src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/js/shuffle/random-shuffle-min.js" id="SFSIjqueryrandom-shuffle-js"></script><script id="SFSICustomJs-js-extra">
var sfsi_icon_ajax_object = {"ajax_url":"https:\/\/blog.kroy.io\/wp-admin\/admin-ajax.php"};
var sfsi_icon_ajax_object = {"ajax_url":"https:\/\/blog.kroy.io\/wp-admin\/admin-ajax.php","plugin_url":"https:\/\/blog.kroy.io\/wp-content\/plugins\/ultimate-social-media-icons\/"};
</script><script src="https://blog.kroy.io/wp-content/plugins/ultimate-social-media-icons/js/custom.js" id="SFSICustomJs-js"></script><script src="https://blog.kroy.io/wp-content/plugins/wplegalpages/admin/js/jquery.cookie.min.js" id="wp-legal-pages-jquery-cookie-js"></script><script id="sinatra-js-js-extra">
var sinatra_vars = {"ajaxurl":"https:\/\/blog.kroy.io\/wp-admin\/admin-ajax.php","nonce":"00b8b3d7c4","responsive-breakpoint":"960","sticky-header":"","strings":{"comments_toggle_show":"Leave a Comment","comments_toggle_hide":"Hide Comments"}};
</script><script src="https://blog.kroy.io/wp-content/themes/sinatra/assets/js/sinatra.min.js" id="sinatra-js-js"></script><script src="https://blog.kroy.io/wp-content/plugins/luckywp-table-of-contents/front/assets/main.min.js" id="lwptoc-main-js"></script><script>
	!function(){var e=-1<navigator.userAgent.toLowerCase().indexOf("webkit"),t=-1<navigator.userAgent.toLowerCase().indexOf("opera"),n=-1<navigator.userAgent.toLowerCase().indexOf("msie");(e||t||n)&&document.getElementById&&window.addEventListener&&window.addEventListener("hashchange",function(){var e,t=location.hash.substring(1);/^[A-z0-9_-]+$/.test(t)&&(e=document.getElementById(t))&&(/^(?:a|select|input|button|textarea)$/i.test(e.tagName)||(e.tabIndex=-1),e.focus())},!1)}();
	</script><script type="text/javascript" src="https://stats.wp.com/e-202045.js" async="async" defer></script><script type="text/javascript">
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:9.0.2',blog:'166765678',post:'894',tz:'-6',srv:'blog.kroy.io'} ]);
	_stq.push([ 'clickTrackerInit', '166765678', '894' ]);
</script><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><symbol id="icon-chat" viewbox="0 0 576 512"><path d="M512 160h-96V64c0-35.3-28.7-64-64-64H64C28.7 0 0 28.7 0 64v160c0 35.3 28.7 64 64 64h32v52c0 7.1 5.8 12 12 12 2.4 0 4.9-.7 7.1-2.4L224 288h128c35.3 0 64-28.7 64-64v-32h96c17.6 0 32 14.4 32 32v160c0 17.6-14.4 32-32 32h-64v49.6l-80.2-45.4-7.3-4.2H256c-17.6 0-32-14.4-32-32v-96l-32 18.1V384c0 35.3 28.7 64 64 64h96l108.9 61.6c2.2 1.6 4.7 2.4 7.1 2.4 6.2 0 12-4.9 12-12v-52h32c35.3 0 64-28.7 64-64V224c0-35.3-28.7-64-64-64zm-128 64c0 17.6-14.4 32-32 32H215.6l-7.3 4.2-80.3 45.4V256H64c-17.6 0-32-14.4-32-32V64c0-17.6 14.4-32 32-32h288c17.6 0 32 14.4 32 32v160z"></path></symbol><symbol id="icon-quote" viewbox="0 0 123.961 123.961"><path d="M49.8 29.032c3.1-1.3 4.4-5 3-8l-4.9-10.3c-1.4-2.899-4.8-4.2-7.8-2.899-8.5 3.6-15.8 8.3-21.6 14C11.4 28.532 6.6 36.232 4 44.732c-2.6 8.601-4 20.3-4 35.2v30.7c0 3.3 2.7 6 6 6h39.3c3.3 0 6-2.7 6-6v-39.3c0-3.301-2.7-6-6-6H26.5c.2-10.101 2.6-18.2 7-24.301 3.6-4.898 9-8.898 16.3-11.999zM120.4 29.032c3.1-1.3 4.399-5 3-8l-4.9-10.199c-1.4-2.9-4.8-4.2-7.8-2.9-8.4 3.6-15.601 8.3-21.5 13.9-7.101 6.8-12 14.5-14.601 23-2.6 8.399-3.899 20.1-3.899 35.1v30.7c0 3.3 2.7 6 6 6H116c3.3 0 6-2.7 6-6v-39.3c0-3.301-2.7-6-6-6H97.1c.2-10.101 2.601-18.2 7-24.301 3.6-4.899 9-8.899 16.3-12z"></path></symbol></svg><div class="wpautoterms-footer"><p>
		<a href="https://blog.kroy.io/wpautoterms/privacy-policy/">Privacy Policy</a><span class="separator"> - </span><a href="https://blog.kroy.io/wpautoterms/terms-and-conditions/">Terms and Conditions</a></p>
</div>
</body></html>
