<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>vyos &#8211; blog.kroy.io</title>
	<atom:link href="https://blog.kroy.io/tag/vyos/feed/" rel="self" type="application/rss+xml" />
	<link>https://blog.kroy.io/</link>
	<description>computers, tech, and whatever other random stuff crosses my mind.</description>
	<lastBuildDate>Mon, 07 Dec 2020 15:36:38 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.5.3</generator>

<image>
	<url>https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-32x32.png</url>
	<title>vyos &#8211; blog.kroy.io</title>
	<link>https://blog.kroy.io/</link>
	<width>32</width>
	<height>32</height>
</image> 
<site xmlns="com-wordpress:feed-additions:1">166765678</site>	<item>
		<title>VyOS from Scratch &#8211; Edition 1</title>
		<link>https://blog.kroy.io/2020/05/04/vyos-from-scratch-edition-1/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=vyos-from-scratch-edition-1</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 04 May 2020 05:28:47 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[vyos]]></category>
		<category><![CDATA[vyosfromscratch]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=593</guid>

					<description><![CDATA[As a VyOS evangelist, maintainer, and more, I&#8217;ve been meaning to write a simple series of &#8220;how-to&#8221; guides for VyOS for a while. Sure, there are plenty of guides out&#8230;]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>As a VyOS evangelist, maintainer, and more, I&#8217;ve been meaning to write a simple series of &#8220;how-to&#8221; guides for VyOS for a while.  Sure, there are plenty of guides out there, but I think a lot of them fall short in demonstrating WHY you are entering specific commands.  </p>



<p>VyOS is capable, but it&#8217;s much more helpful if you can fully understand what it&#8217;s doing.  </p>



<p>This initial guide will walk through the basic setup steps in replacing something like pfSense or some other consumer router with a simple and secure system running VyOS.  </p>



<p>This is also going to be a very very long post, so buckle in!</p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Who is this For</h2>



<p>Anybody that wants to use VyOS of course!  </p>



<p>The nice thing about running VyOS is that if you set up it, and understand <strong><em>WHAT</em></strong> it&#8217;s doing, then you&#8217;ve actually learned something about networking.  </p>



<p>Does something like pfSense work?  </p>



<p>Sure, but it also doesn&#8217;t teach you much about what&#8217;s actually going on.  And the knowledge learned in VyOS will easily translate to almost any other vendor like Cisco, Arista, and more.  At that point, the concepts are the same, you are just learning the different dialects. </p>



<hr class="wp-block-separator"/>



<h2>Environment</h2>



<p>VyOS really doesn&#8217;t take much in resources.  </p>



<p>8GB of storage and 2-4GB of RAM will be overkill for most basic setups.  </p>



<p>CPU-wise, even small Pentium Silver CPUs can handle gigabit and beyond, even over VPN .  Anything like an i3/i5 or a Xeon won&#8217;t break a sweat except in all but the most demanding scenarios.</p>



<p>If you virtualize, it can be helpful to set up a test environment.  This could consist of a simple:</p>



<ul><li>WAN Network.  For testing this could be your existing LAN network.</li><li>A new &#8220;LAN&#8221; Network. For testing this could just be a separate port group or bridge, and it wouldn&#8217;t even need an uplink.</li><li>A simple VM with a GUI (or without), to run some testing. </li></ul>



<p>If virtualization isn&#8217;t an option, VyOS can run on almost any device that is x86_64.  I&#8217;ve run it on everything from:</p>



<ul><li>NUCs with single NICs and USB/USB-C NICs.</li><li><a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/" target="_blank" rel="noreferrer noopener">WYSE 5070/3040 Thin Clients</a>.</li><li>A variety of Dells, including R710s/R620s/R630s.</li><li>Anything Supermicro from 1U to 4U devices.</li></ul>



<p>Finally, for this guide, I&#8217;ll be working with two NICs.  </p>



<p>One is a WAN, connected to my current LAN.  I&#8217;ll be creating a &#8220;network inside a network&#8221;.  The second will be our new &#8220;LAN&#8221;.  This is separate from my existing LAN so I can pretend like it&#8217;s a second private network.  These interfaces can be anything:</p>



<ul><li>Physical NICs.</li><li>VLANs.</li><li>Virtual NICs from ESXi, Proxmox, etc.</li></ul>



<hr class="wp-block-separator"/>



<h1>Install</h1>



<p>The first step is to grab yourself a copy of the installer ISO.  </p>



<p>Most people will want the <a href="https://www.vyos.io/rolling-release/" target="_blank" rel="noreferrer noopener">Rolling Release</a>.  You can also build it yourself, via the <a href="https://docs.vyos.io/en/latest/contributing/build-vyos.html" target="_blank" rel="noreferrer noopener">Docker image</a>, which is helpful if there are some extra packages you want to add.</p>



<p>If you want access to the LTS version, it requires self-building (an easy process), contributing, or a subscription. I <a href="https://blog.vyos.io/vyos-access-subscriptions-for-documentation" target="_blank" rel="noreferrer noopener">highly recommend contributing</a>, as even writing or cleaning up some documentation will get you access to the LTS prebuilt versions.  </p>



<p>You can also support and get access via <a href="https://www.patreon.com/vyos" target="_blank" rel="noreferrer noopener">Patreon</a> or <a href="https://www.buymeacoffee.com/kUa78LT" target="_blank" rel="noreferrer noopener">BuyMeACoffee</a>.</p>



<hr class="wp-block-separator"/>



<p>Note that for these guides, I will be using a recent version of rolling.  This is important as some configuration nodes have changed locations and format between 1.3+ and the existing LTS versions (DHCP and IPv6 RAs are two things that come to mind).</p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Rolling Stability</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
It&#8217;s important to note that the rolling releases are generally completely stable.  I would say 95% of them or more are functional without any major bugs.</p>
<p>Every once in a while, some broken functionality is pushed, but it is almost always fixed quickly. A broken upgrade is not a show-stopper and it is trivial to boot back into the working version with the built-in <a href="https://docs.vyos.io/en/latest/image-mgmt.html" target="_blank" rel="noopener noreferrer">Image Management</a>.</p>
<p>I have no issues running rolling releases in many production locations.<br />
</div></div>



<h2>Install Steps</h2>



<p>Installation is trivial:</p>



<ul><li>Burn ISO to CD/DVD/USB stick, or boot ISO via remote management (iDrac, iLo, IPMI)</li><li>Login with <code><em>vyos</em></code>/<code><em>vyos</em></code></li><li>Type <code><em>install image</em></code></li><li>Answer the install steps</li><li>Reboot and remove installation media</li></ul>


<div class="su-box su-box-style-default" id="" style="border-color:#cc8700;border-radius:3px"><div class="su-box-title" style="background-color:#ffba00;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Installation Gotchas</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<ul>
<li> The installer ISO is a fully functional VyOS image.  That means if you skip the <em>install image</em> step, you can configure the system, and it will work as intended&#8230; until you reboot.  Don&#8217;t be me.  Make sure to install if you want a permanent installation.
<li> Some systems that lack a serial port get stuck on a black screen on the installer ISO.  The simple fix is to edit the grub boot option line and remove the <em>console=ttyS0,115200</em> option from the kernel boot arguments.  Then just boot with <em>CTRL-X</em> as directed.
</ul>
</div></div>



<figure class="wp-block-image size-large"><img loading="lazy" width="720" height="404" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-2.png" alt="" class="wp-image-609" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-2.png 720w, https://blog.kroy.io/wp-content/uploads/2020/04/image-2-300x168.png 300w" sizes="(max-width: 720px) 100vw, 720px" /></figure>



<figure class="wp-block-image size-large"><img loading="lazy" width="726" height="400" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-1.png" alt="" class="wp-image-608" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-1.png 726w, https://blog.kroy.io/wp-content/uploads/2020/04/image-1-300x165.png 300w" sizes="(max-width: 726px) 100vw, 726px" /></figure>



<hr class="wp-block-separator"/>



<h1>Basic Configuration</h1>



<p>Once installed, you&#8217;ll be staring at the login screen.  Login with <code>vyos</code> and the password you set up during install:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="723" height="408" src="https://blog.kroy.io/wp-content/uploads/2020/04/image.png" alt="" class="wp-image-607" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image.png 723w, https://blog.kroy.io/wp-content/uploads/2020/04/image-300x169.png 300w" sizes="(max-width: 723px) 100vw, 723px" /></figure>



<hr class="wp-block-separator"/>



<h3>Decision Time!</h3>



<p>Before you go any further, you need to make a decision.  You need to pick out the subnet (or later subnets) where your network will live.  Or, if you are converting over your existing network, just reuse it.</p>



<p>These should be <a href="https://en.wikipedia.org/wiki/Private_network">RFC1918 addresses</a>.  You generally want a /24, which is 254 usable addresses.</p>



<p>So, there are three main groups of these private addresses you can choose from:</p>



<ul><li><code>10.X.Y.1-254</code>, where <code>X</code> and <code>Y</code> are any number between 0 and 255.  For the last number, 0 would be your &#8220;network&#8221; address, and 255 would be your broadcast address.  You could then assign all your hosts to 1-254.</li><li><code>172.X.Y.1-254</code>, in this case <code>X</code> would be between 16 and 31, and <code>Y</code> could be 0 to 255. </li><li><code>192.168.X.1-254</code>, where <code>X</code> is between 0 and 255.  </li></ul>



<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Subnetting Pro-tips</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>Many routers around the world off-the-shelf use a subnet like 10.0.0.0/24 or 192.168.0.0/24.</p>
<p>
While you can use these subnets, future-you will hate yourself if you ever want to access your network remotely or access other networks when both sides are using the same subnet.
</p>
<p>
I would highly recommend:
<ul>
 	<li>Choose a subnet away from the norm.  For example, 10.32.47.0/24.</li>
 	<li>If you want to plan ahead and are planning to break things out on VLANs, use a subnet like 10.32.X.0/24.  That way, in the future, X can represent your VLAN number, and you can do a summary route like 10.32.0.0/16.  I&#8217;ll be showing some examples of where this can be used later on in this post.</ul>
</p>
</div></div>



<hr class="wp-block-separator"/>



<h3>Configuring the LAN and Remote access</h3>



<p>After the subnet is chosen, the first step is to get the router on the LAN and accessible via SSH.  This makes it much easier to configure, as you are no longer tethered to a keyboard/monitor, VM console, can copy/paste, etc.  </p>



<h4>LAN IP</h4>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configure mode</li><li>Add address to the correct interface</li><li>Commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>The first step is to enter configure mode.  This allows you to make changes to the system configuration.  Type <code>configure</code>.  VyOS also supports shortcuts and tab completion, so typing <code>conf</code> or <code>conf&lt;TAB&gt;</code> will do the same thing.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="336" height="135" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-5.png" alt="" class="wp-image-626" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-5.png 336w, https://blog.kroy.io/wp-content/uploads/2020/04/image-5-300x121.png 300w" sizes="(max-width: 336px) 100vw, 336px" /></figure>



<p>The prompt will change to include <code>#</code>, and the <code>[edit]</code> line will appear to designate that you are in configure mode.</p>



<p>Next, you need to add your LAN IP.  You can check your interfaces by typing <code>run show interfaces</code>.  This tells VyOS to show all the interfaces in operational mode (the mode you were in before you typed <code>conf</code>).</p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-4.png" alt="" class="wp-image-625" width="580" height="98" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-4.png 600w, https://blog.kroy.io/wp-content/uploads/2020/04/image-4-300x51.png 300w" sizes="(max-width: 580px) 100vw, 580px" /></figure>



<p>In my case, <code>eth1</code> is attached to my LAN here.  I&#8217;m going to use the subnet from above, <code>10.32.0.0/24</code>.  I prefer to use <code>.1</code> for my routers, but you can use any IP in that range.</p>



<p>There are two methods to assign it once in <code>conf</code> mode.  Either with the full path, or by drilling-down.</p>



<p>Full path:</p>



<pre class="wp-block-code"><code>configure
set interfaces ethernet eth1 address 10.32.0.1/24
set interfaces ethernet eth1 description LAN
commit
save</code></pre>



<p>Drill down:</p>



<pre class="wp-block-code"><code>configure
edit interfaces ethernet eth1
set address 10.32.0.1/24
set description LAN
commit
save</code></pre>



<p>Committing makes the configuration active, and saving saves it to disk so it will persist on a reboot.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="225" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1024x225.png" alt="" class="wp-image-657" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1024x225.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-300x66.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-768x169.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1536x337.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-2048x450.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Or:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="293" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1024x293.png" alt="" class="wp-image-658" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1024x293.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-300x86.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-768x220.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1536x439.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19.png 1994w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>You can show your work with <code>show interfaces</code> and <code>run show interfaces</code></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="693" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-20-1024x693.png" alt="" class="wp-image-659" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-20-1024x693.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20-300x203.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20-768x520.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20.png 1034w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h4>Set up DHCP</h4>



<p>Now that that router has a LAN IP, it&#8217;s time to connect your laptop/desktop/etc up to it.  </p>



<p>You can assign it a static IP in the chosen subnet (<code>10.32.0.10/24</code> for example), but I imagine you are also going to want to assign a DHCP range for automatic configuration of clients.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configure mode</li><li>Set up DHCP ranges</li><li>commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>Let&#8217;s talk about the following config.  </p>



<p>We are going to make two DHCP ranges, and leave some holes.  This would allow us to assign the IP addresses between <code>.2</code> and <code>.49</code> for static or other uses, as well as <code>.126-199</code> and <code>.251-254</code>.</p>



<p>While this is a non-standard usage, it demonstrates the capabilities. Many people would just have a single range. </p>



<pre class="wp-block-code"><code>set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 0 start 10.32.0.50
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 0 stop 10.32.0.125
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 1 start 10.32.0.200
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 1 stop 10.32.0.250</code></pre>



<p>Some other important config options follow.   </p>



<p>You want to tell the DHCP server to hand out the router&#8217;s IP address as the default gateway and DNS.  This will make it so (eventually), your LAN devices will have DNS and routing to the Internet:</p>



<pre class="wp-block-code"><code>set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 dns-server 10.32.0.1
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 default-router 10.32.0.1</code></pre>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">DNS Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>This would also be the place to insert something like your pi-hole or active directory DNS server.  In the above example, your pi-hole/ADDNS address or addresses would be where the dns-server option is. </p>
</div></div>



<p></p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-8.png" alt="" class="wp-image-630" width="580" height="230" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-8.png 781w, https://blog.kroy.io/wp-content/uploads/2020/04/image-8-300x119.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-8-768x305.png 768w" sizes="(max-width: 580px) 100vw, 580px" /></figure>



<figure class="wp-block-image size-large"><img loading="lazy" width="760" height="208" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-10.png" alt="" class="wp-image-632" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-10.png 760w, https://blog.kroy.io/wp-content/uploads/2020/04/image-10-300x82.png 300w" sizes="(max-width: 760px) 100vw, 760px" /></figure>



<hr class="wp-block-separator"/>



<h4>SSH</h4>



<p>The final step before we can access the router over SSH is to actually enable SSH:</p>



<pre class="wp-block-code"><code>set service ssh port 22
commit
save</code></pre>



<p>At this point you ought to be able to hook up a LAN client, and verify that you have an IP, gateway, and DNS.  </p>



<p>This is a fairly stock Debian VM I set up.  As you can see, my IP is in one of my DHCP ranges, and my DNS and default route are the router&#8217;s IP. </p>



<p>This is on Linux, but the same thing could be confirmed on Windows or MacOS:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="736" height="472" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-16.png" alt="" class="wp-image-640" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-16.png 736w, https://blog.kroy.io/wp-content/uploads/2020/04/image-16-300x192.png 300w" sizes="(max-width: 736px) 100vw, 736px" /></figure>



<p>From there, you should be able to ssh into the router with the username <code>vyos</code> and password you set up during install:<br></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="541" height="191" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-13.png" alt="" class="wp-image-637" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-13.png 541w, https://blog.kroy.io/wp-content/uploads/2020/04/image-13-300x106.png 300w" sizes="(max-width: 541px) 100vw, 541px" /></figure>



<p>And typing <code>show configuration</code> (in op mode), should show you the work done so far.  VyOS also comes with a few defaults, like NTP servers configured.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="414" height="990" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-14.png" alt="" class="wp-image-638" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-14.png 414w, https://blog.kroy.io/wp-content/uploads/2020/04/image-14-125x300.png 125w" sizes="(max-width: 414px) 100vw, 414px" /></figure>



<hr class="wp-block-separator"/>



<h1>NAT &amp; DNS</h1>



<h3>NAT</h3>



<p>The next important duty for a router and firewall is to be able to NAT.  NAT allows all your private LAN devices to access the Internet.  </p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Information Dump</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Back when the Internet started, every device had a unique IP address. </p>
<p>Unfortunately, because of the numbering scheme used, there are only 4.2 billion of these address, at least in IPv4, and the transition to IPv6 is far from complete.</p>
<p>Because of this, every device on your network needs to be able to &#8220;pretend&#8221; that it is your router to access the Internet.  Your router keeps track of which requests belong to which device.  </p>
<p>Source NAT is what allows you to do this.</p>
<p>This is also where the above mentioned &#8220;summary route&#8221; can come into play.  Instead of creating three separate NAT rules for 10.32.1.0/24, 10.32.2.0/24, and 10.32.3.0/24, you can create a single rule for 10.32.0.0/16.<br />
</div></div>



<p>For this setup, it&#8217;s important to identify which network interface will eventually be your WAN interface, even though it&#8217;s not configured yet.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>As before, enter configuration mode.</li><li>Set up a source NAT rule to target our LAN or LAN subnets.</li><li>Define the outgoing WAN interface on the rule.</li><li>Set the translation type of the rule to <code>masquerade</code>. </li></ul>



<hr class="wp-block-separator"/>



<p>The type of NAT we will be using is called <code>SOURCE NAT</code>.  This type of NAT is going to have three components:</p>



<ul><li>Target all traffic from our LAN or LANs&#8230;</li><li>&#8230; when the traffic is going out to the Internet through this outgoing interface&#8230;</li><li>&#8230; Change the IP address from the LAN IP to the WAN IP</li></ul>



<p>To do this:</p>



<pre class="wp-block-code"><code>set nat source rule 100 source address '10.32.0.0/24'
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 translation address masquerade
commit
save</code></pre>



<p>In the above example, the <code>100</code> is an arbitrary number (between 1-9999).  The <code>eth0</code> is my eventual WAN interface.  <code>masquerade</code> translates the internal LAN IP to your public WAN IP.  </p>



<p></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="962" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-21.png" alt="" class="wp-image-660" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-21.png 962w, https://blog.kroy.io/wp-content/uploads/2020/04/image-21-300x240.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-21-768x613.png 768w" sizes="(max-width: 962px) 100vw, 962px" /></figure>



<p>Once we set up our WAN interface, we&#8217;ll be able to type <code>show nat source rules</code> in op mode, or <code>run show nat source rules</code> in conf mode to run the op mode command, it will be clear what&#8217;s happening.</p>



<hr class="wp-block-separator"/>



<h3>DNS</h3>



<p>The next step is to set up our VyOS instance as for DNS.  This will allow you to use local DNS and caching instead of your ISP&#8217;s, but also eventually will allow you run custom DNS and hosts. </p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter config mode</li><li>Set the DNS Listen Address</li><li>Set the subnets we are allowing from</li><li>Set the cache size to 0</li><li>commit and save</li></ul>



<hr class="wp-block-separator"/>



<pre class="wp-block-code"><code>set service dns forwarding listen-address '10.32.0.1'
set service dns forwarding allow-from '10.32.0.0/24'
set service dns forwarding cache-size '0'
commit
save</code></pre>



<p>As mentioned, this accomplishes three things.  </p>



<ul><li>It tells VyOS to listen for DNS requests on its LAN IP, <code>10.32.0.1</code>.  </li><li>It limits requests from your LAN subnet.  </li><li>Finally, it sets the cache size to 0.  This is good to start out with to make sure everything is working, but later you can bump it up to speed up multiple requests for the same sites. </li></ul>



<hr class="wp-block-separator"/>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Opportunity Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
This is another opportunity to use the &#8220;summary&#8221; route that I&#8217;ve mentioned a few times.  </p>
<p>Instead of allowing &#8220;10.32.0.0/24&#8221;, you would allow &#8220;10.32.0.0/16&#8221;.  This would ensure that as you add VLANs and subnets, your DNS will just work without adding a long list of /24s.<br />
</div></div>



<hr class="wp-block-separator"/>



<figure class="wp-block-image size-large"><img loading="lazy" width="508" height="212" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-22.png" alt="" class="wp-image-678" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-22.png 508w, https://blog.kroy.io/wp-content/uploads/2020/04/image-22-300x125.png 300w" sizes="(max-width: 508px) 100vw, 508px" /></figure>



<hr class="wp-block-separator"/>



<h4>DNS Forwarding</h4>



<p>There is one more consideration to be made.  As configured, your DNS server will run in &#8220;recursor&#8221; mode.  This means it will take responsibility for fully resolving DNS on its own.  This may be a bad thing for a number of reasons:</p>



<ul><li>It leaks your IP to potential undesirables.  </li><li>It&#8217;s almost always slower, as you don&#8217;t get to benefit from the caches of a large service like CloudFlare or Google.  </li></ul>



<p>It&#8217;s quite simple to set up in forwarding mode, meaning when you make a DNS request, you end up asking an upstream resolver.  </p>



<p>In the following example, we&#8217;ll be using CloudFlare and Google:</p>



<pre class="wp-block-code"><code>set service dns forwarding name-server 1.1.1.1
set service dns forwarding name-server 1.0.0.1
set service dns forwarding name-server 8.8.8.8
set service dns forwarding name-server 8.8.4.4
commit
save</code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="564" height="399" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-23.png" alt="" class="wp-image-680" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-23.png 564w, https://blog.kroy.io/wp-content/uploads/2020/04/image-23-300x212.png 300w" sizes="(max-width: 564px) 100vw, 564px" /></figure>



<hr class="wp-block-separator"/>



<h4>System DNS</h4>



<p>One final step is to set the DNS for VyOS itself.  Everything we&#8217;ve done so far has just set up VyOS to be a DNS server for your clients.</p>



<p>This will be the DNS that is used, for example, when you do a VyOS update, ping or traceroute from VyOS, etc.</p>



<p>The easiest thing to do if you&#8217;ve been following this guide, is just to use the DNS server you set up above:</p>



<pre class="wp-block-code"><code>set system name-server 10.32.0.1
commit
save</code></pre>



<p>This is also another spot where if you wanted to use Google, CloudFlare, or AD-DNS, you could plug in that IP:</p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-13.png" alt="" class="wp-image-779" width="760" height="276" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-13.png 760w, https://blog.kroy.io/wp-content/uploads/2020/05/image-13-300x109.png 300w" sizes="(max-width: 760px) 100vw, 760px" /></figure>



<p>Alternatively, you call tell VyOS to use the DNS servers that it received from your WAN DHCP server with:</p>



<pre class="wp-block-code"><code>set system name-servers-dhcp eth0</code></pre>



<p></p>



<hr class="wp-block-separator"/>



<h1>Firewall</h1>



<p>If you&#8217;ve made it this far, congrats!  We are almost there! </p>



<p>This section will cover the creation of a zone-based firewall, which is far superior to the default method of attaching firewalls to interfaces.  </p>



<p>The reason it is superior is simple.  It&#8217;s a bit more hassle to set up, but it&#8217;s far easier to manage on an ongoing basis, plus, you start thinking about firewalling as flows of information from interface to interface.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configuration mode</li><li>Create a firewall to allow all LAN traffic.</li><li>Create firewall to allow all LAN traffic to access VyOS itself.</li><li>Create a firewall to protect the router itself from WAN.</li><li>Create a firewall to protect LAN devices from WAN.</li><li>Commit</li><li>Create LOCAL/LAN zones.</li><li>Assign appropriate interfaces to zones.</li><li>Commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>For as complex as firewalling seems, it&#8217;s actually pretty simple when you break it down.  </p>



<p>A firewall tracks connection &#8220;states&#8221; to determine what is and is not allowed.  This is where packets are originating and going to, ports involved, types of traffic like TCP/UDP/ICMP, and more.  </p>



<p>We are going to build a very simple firewall that assumes that we want to block everything externally, and allow everything from LAN.</p>



<p>So let&#8217;s dig right into it.</p>



<hr class="wp-block-separator"/>



<h2>LAN</h2>



<p>First, create a firewall that will allow our LAN to access everything. This is a setup that would mimic what most consumer routers do:</p>



<pre class="wp-block-code"><code>conf
set firewall name LAN-WAN default-action accept
set firewall name LAN-LOCAL default-action accept
commit
save</code></pre>



<p>The <code>LAN-WAN</code> and the <code>LAN-LOCAL</code> can be arbitrarily named anything.  I use this naming scheme because as mentioned above, it&#8217;s better to think about firewalls as controlling the flow of information through the router, and these names are self-documenting.</p>



<p><code>LOCAL</code> is a specific VyOS designation that means &#8220;this router&#8221;.  When you are attaching the firewall in the zones, LOCAL will be what you use to control traffic destined to the firewall itself.  </p>



<p>As should be obvious, we are just allowing everything.  But you can set whatever rules you wanted.  <code>LAN-WAN</code> would generally remain pretty open as it would be uncommon to block your own access to the Internet, but <code>LAN-LOCAL</code> might contain rules to maybe allow only specific devices access to manage the VyOS router.</p>



<p>Also note that we are just creating the firewalls here.  They don&#8217;t become active until you attach them to the zones.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="894" height="376" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-24.png" alt="" class="wp-image-740" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-24.png 894w, https://blog.kroy.io/wp-content/uploads/2020/04/image-24-300x126.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-24-768x323.png 768w" sizes="(max-width: 894px) 100vw, 894px" /></figure>



<hr class="wp-block-separator"/>



<h2>LOCAL</h2>



<p>As mentioned, the <code>LOCAL</code> zone is traffic destined for the VyOS router itself.  </p>



<p>In most cases, it will have a similar ruleset to the LAN one above, as most people want their router to have full access to the Internet and their LAN devices:</p>



<pre class="wp-block-code"><code>conf
set firewall name LOCAL-WAN default-action accept
set firewall name LOCAL-LAN default-action accept
commit
save</code></pre>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Food for Thought</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>While I might be getting a little ahead of myself here, it&#8217;s important to note that you could use the same firewall instead of creating four different firewalls as we&#8217;ve done here.  The firewalls are just attached to interfaces or zones by names, so there&#8217;s nothing really stopping you from creating a single firewall and attaching it to four different places.</p>
<p>As a bit of a pro-tip though, I would recommend not doing this.  Eventually you&#8217;ll want them broken out, and it&#8217;s far more of a hassle to do it later than to just do it during initial setup.<br />
</div></div>



<figure class="wp-block-image size-large"><img loading="lazy" width="988" height="280" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-26.png" alt="" class="wp-image-743" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-26.png 988w, https://blog.kroy.io/wp-content/uploads/2020/04/image-26-300x85.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-26-768x218.png 768w" sizes="(max-width: 988px) 100vw, 988px" /></figure>



<hr class="wp-block-separator"/>



<h2>WAN</h2>



<p>The <code>WAN</code> zone is where we are actually going to do most of our work.  </p>



<p>The basic goal here will be two things.  To block all access to the router itself, and to provide basic setup and template for future things like port forwarding to our LAN.  </p>



<p>When you start moving data to and from the Internet, that&#8217;s when you need to start worrying about the state tracking I mentioned before.  </p>



<p>For both LOCAL and LAN traffic, we&#8217;ll be setting up what&#8217;s known as a &#8220;stateful firewall&#8221;.  </p>



<p>In stateful firewalling, there are three main states to worry about:</p>



<ul><li>New &#8211; Traffic in a <code>NEW</code> state is the first packet from a destination to a source.  Allowing or denying this packet ultimately determines whether the traffic will be allowed.</li><li>Established &#8211; Once traffic from <code>NEW</code> has been allowed, the subsequent packets are marked as <code>ESTABLISHED</code>.  This is essentially traffic that has already been allowed by other rules.  This is another basic requirement for a working stateful firewall.</li><li>Related &#8211; This means that this is traffic that is somehow related to already allowed traffic.  Also required.</li></ul>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">A note about rule numbers</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
As with the NAT rule numbers, the rule numbers you use for firewall are arbitrary.</p>
<p>With that said, it doesn&#8217;t mean you shouldn&#8217;t plan ahead a bit:</p>
<ul>
<li>Rules are processed numerically, so for fastest firewalling and routing, you definitely want your ESTABLISHED/RELATED rule at the top.  That ensures that existing traffic, which is going to be the bulk of the traffic your firewall processes, only has to look at a single rule.</li>
<li>Leave yourself some gaps for future rules.  You&#8217;ll appreciate it later if you want to insert a new rule before an existing one, though you can always rename and move around.</li>
</div></div>



<hr class="wp-block-separator"/>



<h3>WAN-LOCAL</h3>



<p>As mentioned, the <code>WAN-LOCAL</code> firewall is traffic destined for the VyOS router itself.  In the future, this will be where you allow traffic, say to your WireGuard port for VPN.</p>



<p>The first rule we want to build is to allow all <code>ESTABLISHED</code> and <code>RELATED</code> traffic.  So we&#8217;ll:</p>



<ul><li>Create the WAN-LOCAL firewall.  </li><li>Set the default policy on the firewall to drop everything.  </li><li>Create a rule to accept specific traffic for rule.</li><li>Set the match for the rule to our established and related states.</li><li>Set a description for ease of use later.</li></ul>



<p></p>



<pre class="wp-block-code"><code>set firewall name WAN-LOCAL default-action drop
set firewall name WAN-LOCAL rule 5 action accept
set firewall name WAN-LOCAL rule 5 state established enable
set firewall name WAN-LOCAL rule 5 state related enable
set firewall name WAN-LOCAL rule 5 description "Allow EST/Related Traffic"
commit
save</code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="660" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-1024x660.png" alt="" class="wp-image-753" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-1024x660.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-300x193.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-768x495.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image.png 1232w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>The next rule we want on is to allow ICMP.  Many people like to block this, but not me.  I&#8217;ll defer to <a href="http://shouldiblockicmp.com/">ShouldIBlockICMP.com</a> on this.</p>



<ul><li>Create a new rule matching ICMP</li><li>Match the state of <code>NEW</code>. This is what actually matches the unknown traffic to allow</li><li>Allow the traffic</li><li>Commit and save</li></ul>



<pre class="wp-block-code"><code>set firewall name WAN-LOCAL rule 20 protocol icmp
set firewall name WAN-LOCAL rule 20 state new enable
set firewall name WAN-LOCAL rule 20 action accept
commit
save</code></pre>



<p>And you can see that the firewall is created (but still not attached to any interfaces), by doing the <code>op mode</code> command <code>show interfaces</code>.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="900" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-1-1024x900.png" alt="" class="wp-image-759" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-1-1024x900.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1-300x264.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1-768x675.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1.png 1176w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h3>WAN-LAN</h3>



<p>For now, the <code>WAN-LAN</code> firewall is identical to the <code>WAN-LOCAL</code>.  In the future, this is where you will allow your port forward rules, or other traffic you want to send to your LAN devices, so it&#8217;s helpful to break it out beforehand.</p>



<p>As before, we create the firewall, set it to drop by default, allowed EST/RELATED, and allow ICMP, which won&#8217;t do anything now, but could be helpful in the future:</p>



<pre class="wp-block-code"><code>set firewall name WAN-LAN default-action drop
set firewall name WAN-LAN rule 5 action accept
set firewall name WAN-LAN rule 5 state established enable
set firewall name WAN-LAN rule 5 state related enable
set firewall name WAN-LAN rule 5 description "Allow EST/Related Traffic"
set firewall name WAN-LAN rule 20 protocol icmp
set firewall name WAN-LAN rule 20 state new enable
set firewall name WAN-LAN rule 20 action accept</code></pre>



<p>Don&#8217;t forget you can dive down into levels as in the following example:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1002" height="672" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-2.png" alt="" class="wp-image-760" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-2.png 1002w, https://blog.kroy.io/wp-content/uploads/2020/05/image-2-300x201.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-2-768x515.png 768w" sizes="(max-width: 1002px) 100vw, 1002px" /></figure>



<hr class="wp-block-separator"/>



<p>Finally!  We have our firewalls set up and ready to deploy.  </p>



<hr class="wp-block-separator"/>



<h1>WAN and Zones</h1>



<p>If you&#8217;ve been paying attention, we still don&#8217;t have one <em>VERY</em> important piece to this puzzle. We still don&#8217;t have WAN access!</p>



<p>Of course I did this to protect your router during the initial setup phase.  Until you have firewalls ready to deploy, you probably don&#8217;t want to be kicking your brand new VyOS install out on the open Internet.  </p>



<hr class="wp-block-separator"/>



<h2>Zones</h2>



<p>Zones are easily one of my favorite parts of VyOS, and something that in my opinion, puts it lightyears ahead of other firewall solutions.</p>



<p>Especially as your firewalling needs grow, zones just make it so <em>EASY</em>.  As I sort of touched on, zones are a bit more work initially, but save you <em>MUCH</em> more time in the future.</p>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Lockout Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Be careful and pay attention here.  </p>
<p>If you mistype something and are still configuring VyOS over SSH, you can potentially lock yourself out.<br />
</div></div>



<p>The naming scheme as I&#8217;ve outlined above should be helpful here when creating our firewall zones.  It basically says <code>FROMZONE-&gt;TOZONE</code></p>



<p>So let&#8217;s run through the whole thing.  </p>



<p>Goals:</p>



<ul><li>Set the default action for the zone.  This should always be drop to cover yourself in case you miss something.</li><li>Apply the &#8220;For traffic from X zone to current zone, attach Y firewall&#8221;</li><li>Add the interfaces that are part of this zone</li><li>Repeat for all zones</li><li>commit</li><li>save</li></ul>



<hr class="wp-block-separator"/>



<p>So what does this look like for the LAN:</p>



<ul><li>In this example we are working on the LAN zone</li><li>We drop everything by default</li><li>We assign the <code>WAN-LAN</code> firewall to traffic from any interface in the below <code>WAN</code> zone</li><li>Similarly for the <code>LOCAL-LAN</code>.  This is traffic from the VyOS instance itself to LAN hosts.</li><li>We put <code>eth1</code> in our LAN zone.</li></ul>



<pre class="wp-block-code"><code>set zone-policy zone LAN default-action drop
set zone-policy zone LAN from WAN firewall name WAN-LAN
set zone-policy zone LAN from LOCAL firewall name LOCAL-LAN
set zone-policy zone LAN interface eth1


</code></pre>



<hr class="wp-block-separator"/>



<p>Repeat all steps for the <code>LOCAL</code> zone.  The major difference here is the <code>local-zone</code> designation.  As I&#8217;ve mentioned a few times, <code>LOCAL</code> is a special designation that means &#8220;this firewall&#8221;, so you don&#8217;t attach interfaces:</p>



<pre class="wp-block-code"><code>set zone-policy zone LOCAL local-zone
set zone-policy zone LOCAL from LAN firewall name LAN-LOCAL
set zone-policy zone LOCAL from WAN firewall name WAN-LOCAL
set zone-policy zone LOCAL default-action drop
</code></pre>



<hr class="wp-block-separator"/>



<p>Finally, the WAN zone is basically the same as the LAN zone. The only major change you should notice is that I just changed the firewall names and interface name:</p>



<pre class="wp-block-code"><code>set zone-policy zone WAN from LAN firewall name LAN-WAN
set zone-policy zone WAN from LOCAL firewall name LOCAL-WAN
set zone-policy zone WAN interface eth0
set zone-policy zone WAN default-action drop</code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="676" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-4-1024x676.png" alt="" class="wp-image-766" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-4-1024x676.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4-300x198.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4-768x507.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4.png 1176w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>If you were like me, you might have tried committing between steps.  Unfortunately, if you don&#8217;t set up everything at once, you&#8217;ll quickly discover that zones are interdependent on one another.  This happens because I&#8217;ve created the LAN zone, but the referenced WAN and LOCAL zones don&#8217;t exist yet.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="528" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-3-1024x528.png" alt="" class="wp-image-765" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-3-1024x528.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3-300x155.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3-768x396.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3.png 1168w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h3>Show your work</h3>



<p>Hopefully, if you&#8217;ve done everything correctly, you should see all your zone policies set up under the <code>op mode</code> command <code>run show zone-policy</code>.  This view should make it obvious which traffic is flowing through what firewall:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="838" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-6-838x1024.png" alt="" class="wp-image-768" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-6-838x1024.png 838w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6-245x300.png 245w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6-768x939.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6.png 872w" sizes="(max-width: 838px) 100vw, 838px" /></figure>



<hr class="wp-block-separator"/>



<h2>WAN Setup</h2>



<p>Finally, here we are.  </p>



<p>Setting up your WAN. If you&#8217;ve made it this far, congrats.  You are basically 1 or 2 commands away from having a working router and firewall!</p>



<p>There are multiple ways to get a WAN address.  For simplicity&#8217;s sake, I&#8217;ll just cover two of them here, static and DHCP assignment.  For something like PPPoE, you&#8217;ll need a few more steps.</p>



<h3>DHCP Assignment</h3>



<p>DHCP is when your router asks your ISP&#8217;s servers for what it should use for its IP address and routing information.  This is accomplished with one simple command (well, four if you add a description to the interface, and commit and save):</p>



<pre class="wp-block-code"><code>set interfaces ethernet eth0 address dhcp
set interfaces ethernet eth0 description WAN
commit
save</code></pre>



<p>You can verify that the setup is complete with the <code>op mode</code> commands <code>run show interfaces</code> and <code>run show ip route</code>.  (I have some debug variables set, so ignore the extra output:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="988" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-8-988x1024.png" alt="" class="wp-image-773" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-8-988x1024.png 988w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-290x300.png 290w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-768x796.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-1482x1536.png 1482w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8.png 1490w" sizes="(max-width: 988px) 100vw, 988px" /></figure>



<p>In the above output, <code>10.21.21.57</code> is the IP address I was assigned via DHCP.  The <code>show ip route</code> verifies that I have a default route.</p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Information Dump</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Your &#8220;gateway&#8221; or default route, is the router your devices ask when they encounter an IP address that they don&#8217;t know how to get to.</p>
<p>In the networking world, this is represented by <em>0.0.0.0/0</em>, which is a shortcut for <strong><em>the entire Internet</em></strong></p>
<p>So in the above example, this VyOS knows how to talk directly to anything in the 10.21.21.0/24 or 10.32.0.0/24 subnets because they are directly connected.  Anything outside of that, it needs to ask 10.21.21.1 for a route to it.<br />
</div></div>



<h3>Static IP</h3>



<p>Static IPs just skip the automatic configuration.  It&#8217;s up to your ISP how this is configured, but usually it&#8217;s an extra step, manually applying your default route.</p>



<p>So to duplicate my above DHCP configuration:</p>



<pre class="wp-block-code"><code>set interfaces ethernet eth0 address 10.21.21.57/24
set protocols static route 0.0.0.0/0 next-hop 10.21.21.1
commit
save</code></pre>



<p>As you can see in the following screenshot, I forgot the exact format, so I hit my <code>&lt;TAB&gt;</code> button to get hints:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="881" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-12-881x1024.png" alt="" class="wp-image-778" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-12-881x1024.png 881w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12-258x300.png 258w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12-768x893.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12.png 1106w" sizes="(max-width: 881px) 100vw, 881px" /></figure>



<h3>Check your work</h3>



<p>Assuming nothing has gone wrong, you should be able to verify everything with the <code>op mode</code> command <code>ping</code>.  So let&#8217;s hit Google with 4 pings:</p>



<p><code>run ping www.google.com count 4</code></p>



<p>If all goes well, you should see a response:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="264" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-9-1024x264.png" alt="" class="wp-image-774" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-9-1024x264.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9-300x77.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9-768x198.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9.png 1290w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h1>Conclusion</h1>



<p>So wow, this post turned into a bit of a novel.  Hopefully if you&#8217;ve made it this far, your LAN clients now have accessible Internet. From a client, you should be able to ping google:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="402" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-14-1024x402.png" alt="" class="wp-image-783" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-14-1024x402.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14-300x118.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14-768x302.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14.png 1416w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>Obviously there are a lot of basic topics I haven&#8217;t covered yet.  But I wanted to lay out and explain the basic setup first.  </p>



<p>Future editions will feature:</p>



<ul><li>Port Forwarding.</li><li>Hairpin NAT (this goes hand-in-hand with the first).</li><li>VPNs, especially WireGuard</li><li>How routing works when you have VPNs.</li><li>Some potential hardening tactics.</li><li>Other advanced topics like BGP/OSPF.</li></ul>



<p>Cheers!</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">593</post-id>	</item>
	</channel>
</rss>
