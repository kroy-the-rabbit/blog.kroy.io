<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>pfsense &#8211; blog.kroy.io</title>
	<atom:link href="https://blog.kroy.io/category/pfsense/feed/" rel="self" type="application/rss+xml" />
	<link>https://blog.kroy.io/</link>
	<description>computers, tech, and whatever other random stuff crosses my mind.</description>
	<lastBuildDate>Sun, 12 Jan 2020 17:38:22 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.5.3</generator>

<image>
	<url>https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-32x32.png</url>
	<title>pfsense &#8211; blog.kroy.io</title>
	<link>https://blog.kroy.io/</link>
	<width>32</width>
	<height>32</height>
</image> 
<site xmlns="com-wordpress:feed-additions:1">166765678</site>	<item>
		<title>Battle of the Bare Metal Routers</title>
		<link>https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=battle-of-the-bare-metal-routers</link>
					<comments>https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Thu, 21 Nov 2019 20:32:30 +0000</pubDate>
				<category><![CDATA[Hardware]]></category>
		<category><![CDATA[pfsense]]></category>
		<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=449</guid>

					<description><![CDATA[Continuing from my previous post, I wanted to see how a variety of software routing and firewall platforms performed when put to the test on an equal playing field. As&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Continuing from my <a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/">previous post</a>, I wanted to see how a variety of software routing and firewall platforms performed when put to the test on an equal playing field.</p>



<hr class="wp-block-separator"/>



<p>As before, these tests were all run on my <a href="https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1521/">Xeon D-1521</a>. This server is running 10Gb links to the rest of my network via the onboard Intel X550/552 chipset, 32GB of RAM, and an SSD boot drive.</p>



<p>The final results are <a href="#finalresults">HERE</a> if this is all TLDR.</p>



<p>Here is the server dangling halfway out of the rack while I was doing these tests:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-1024x768.jpg" alt="" class="wp-image-359" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h4>Network Layout</h4>



<p>The network layout is identical to virtual routing tests, though in this case, I just used DHCP to get the &#8220;WAN&#8221; address, since I wanted to test NAT performance too.</p>



<figure class="wp-block-image"><img loading="lazy" width="812" height="788" src="https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram.png" alt="" class="wp-image-37" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram.png 812w, https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram-300x291.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram-768x745.png 768w" sizes="(max-width: 812px) 100vw, 812px" /></figure>



<hr class="wp-block-separator"/>



<h2>The Victims</h2>



<p>For these tests, I wanted to avoid wasting time on duplicated results.  So for example, I&#8217;ll just be testing pfSense instead of pfSense and OPNSense.  Similarly just VyOS instead of Debian.  Also, based on feedback on my prior post, there were people that felt like I missed a few platforms.  So for these tests, the platforms will be:</p>



<ul><li>VyOS 1.2.3</li><li>pfSense 2.4.4-p3</li><li>Sophos XG SFOS v17.5.8&nbsp;(not fully sure how the versioning works, but that was the ISO)</li><li>Untangle 14.2.2</li></ul>



<p>The goal of these tests is to show how these platforms perform when installed bare metal to this D-1521.  So they will be configured mostly out of box in a basic WAN/LAN Firewall/Router setup.</p>



<hr class="wp-block-separator"/>



<h3>VyOS</h3>



<p>I use a lot of VyOS, and I&#8217;m pretty familiar with how it performs.  It&#8217;s worth mentioning that I&#8217;m also a VyOS maintainer now. </p>



<p>Basic Config:</p>



<pre class="wp-block-code"><code>firewall {
    name OUTSIDE-IN {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
    }
    name OUTSIDE-LOCAL {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
        rule 20 {
            action accept
            icmp {
                type-name echo-request
            }
            protocol icmp
            state {
                new enable
            }
        }
        rule 31 {
            action accept
            destination {
                port 22
            }
            protocol tcp
            state {
                new enable
            }
        }
    }
}
interfaces {
    ethernet eth0 {
        address dhcp
        firewall {
            in {
                name OUTSIDE-IN
            }
            local {
                name OUTSIDE-LOCAL
            }
        }
    }
    ethernet eth1 {
        vif 2222 {
            address 10.222.222.1/24
        }
        vif 2223 {
            address 10.223.223.1/24
        }
    }
    loopback lo {
    }
}
nat {
    source {
        rule 10 {
            outbound-interface eth0
            source {
                address 10.0.0.0/8
            }
            translation {
                address masquerade
            }
        }
    }
}
service {
    dhcp-server {
        shared-network-name vlan2222 {
            authoritative
            subnet 10.222.222.0/24 {
                default-router 10.222.222.1
                dns-server 10.53.53.53
                lease 1200
                range 0 {
                    start 10.222.222.10
                    stop 10.222.222.100
                }
            }
        }
        shared-network-name vlan2223 {
            authoritative
            subnet 10.223.223.0/24 {
                default-router 10.223.223.1
                dns-server 10.53.53.53
                lease 1200
                range 0 {
                    start 10.223.223.10
                    stop 10.223.223.100
                }
            }
        }
    }
    ssh {
        port 22
    }
}

</code></pre>



<h4>Results</h4>



<p>In this setup, the results were &#8220;basically 10Gb&#8221;, whether for inter-vlan or LAN-&gt;WAN with NAT.</p>



<p><strong>Inter-vlan (9.19 Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="593" height="42" src="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-intervlan-simple.png" alt="" class="wp-image-450" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-intervlan-simple.png 593w, https://blog.kroy.io/wp-content/uploads/2019/11/vyos-intervlan-simple-300x21.png 300w" sizes="(max-width: 593px) 100vw, 593px" /></figure>



<p><strong>NAT (9.17 Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="591" height="43" src="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-simple.png" alt="" class="wp-image-451" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-simple.png 591w, https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-simple-300x22.png 300w" sizes="(max-width: 591px) 100vw, 591px" /></figure>



<p>While I was testing it, I was curious to see if using a simple firewall was any different than using zone-based firewalls.  </p>



<p>So adding the zone config:</p>



<pre class="wp-block-code"><code>zone LAN {
    default-action drop
    from LOCAL {
        firewall {
            name LOCAL-LAN
        }
    }
    from WAN {
        firewall {
            name WAN-LAN
        }
    }
    interface eth1.2222
    interface eth1.2223
}
zone LOCAL {
    from LAN {
        firewall {
            name LAN-LOCAL
        }
    }
    from WAN {
        firewall {
            name WAN-LOCAL
        }
    }
    local-zone
}
zone WAN {
    from LAN {
        firewall {
            name LAN-WAN
        }
    }
    from LOCAL {
        firewall {
            name LOCAL-WAN
        }
    }
    interface eth0
}

zone LAN {
    default-action drop
    from LOCAL {
        firewall {
            name LOCAL-LAN
        }
    }
    from WAN {
        firewall {
            name WAN-LAN
        }
    }
    interface eth1.2222
    interface eth1.2223
}
zone LOCAL {
    from LAN {
        firewall {
            name LAN-LOCAL
        }
    }
    from WAN {
        firewall {
            name WAN-LOCAL
        }
    }
    local-zone
}
zone WAN {
    from LAN {
        firewall {
            name LAN-WAN
        }
    }
    from LOCAL {
        firewall {
            name LOCAL-WAN
        }
    }
    interface eth0
}
</code></pre>



<p>The results were pretty much identical.</p>



<p><strong>NAT zone firewall (9.12Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="593" height="50" src="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-zone.png" alt="" class="wp-image-452" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-zone.png 593w, https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-zone-300x25.png 300w" sizes="(max-width: 593px) 100vw, 593px" /></figure>



<hr class="wp-block-separator"/>



<h3>pfSense</h3>



<p>In my <a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/">previous post</a>, I caught a surprising amount of flak saying that my review of pfSense was somehow unfair and biased, despite feeling like I was <em>OVERLY</em> fair.  Hopefully the results here will vindicate me. </p>



<p>With pfSense, I didn&#8217;t really make any changes beyond the stock install.  I added an <code>OPT</code> interface for the second LAN, and opened up the firewall rules for that interface.</p>



<h4>Results</h4>



<p>First, I tested some inter-vlan routing with all hardware offload disabled.  This is a common troubleshooting step as virtual pfSense and a lot of network cards don&#8217;t properly support the functionality under FreeBSD.</p>



<p><strong>Inter-vlan, disabled hardware offload (7.58Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="56" src="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-1024x56.png" alt="" class="wp-image-454" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-1024x56.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-300x16.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-768x42.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-850x47.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload.png 1202w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>But guess what.  All those hardware offloading checkboxes exist for a reason, and enabling it can have some dramatic results if the NICs actually support it (and the drivers aren&#8217;t broken).</p>



<p><strong>Inter-vlan, hardware offload (9.19Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="71" src="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-1024x71.png" alt="" class="wp-image-455" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-1024x71.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-300x21.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-768x53.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-850x59.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload.png 1208w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>pfSense does slightly less better when it is NATing, though still pretty close to 10Gb.</p>



<p><strong>NAT, hardware offload (8.71Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="57" src="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-1024x57.png" alt="" class="wp-image-456" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-1024x57.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-300x17.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-768x42.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-850x47.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT.png 1266w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Now this is where I need to eat some crow.  </p>



<p>For literally <em>YEARS</em> I&#8217;ve been preaching that pfSense won&#8217;t go 10 gigabit.  As these results show, that was way wrong. Though in my defense, this was also a sentiment echoed by the pfSense devs themselves. But Iâ€™ll take my medicine and admit that I was wrong. <br></p>



<p>I think are a few reasons that in my all extensive testing, I never saw 10Gb. </p>



<ul><li>When I was running pfSense on bare metal (2.3.x and 2.4.0 beta days), the Xeon Ds were <em>REALLY</em> new.  To make a long story short, they were not very stable and I don&#8217;t think the drivers were fully compatible.  As the results show, enabling the hardware offload features can make a fairly large difference.</li><li>Ever since, every pfSense install I&#8217;ve done has generally been virtualized, either on KVM or ESXi.  As my prior post shows, it just doesn&#8217;t do well virtualized. </li></ul>



<p>So yes, pfSense will do 10Gb assuming you have NICs that support hardware offload correctly.  </p>



<hr class="wp-block-separator"/>



<h3>Sophos XG</h3>



<p>After my last post, a few people specifically mentioned that I should have done tests with Sophos XG.  </p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="736" src="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-1024x736.png" alt="" class="wp-image-457" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-1024x736.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-300x216.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-768x552.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-850x611.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard.png 1173w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>I&#8217;m not going to lie.  Sophos XG is actually quite fancy looking.  It was enough with all the options and lack of familiarity, my head spun a bit trying to set it up.  </p>



<p>My first impression wasn&#8217;t very good.  Sophos makes it VERY difficult to position the WAN/LAN where I wanted it. It wanted the first NIC port to be LAN or something like that.  I think I eventually had to just swap the VLANs on the switch the server is plugged into.  </p>



<h4>Results</h4>



<p>I imagine if I used Sophos more, I would become more comfortable with it.  But for the few hours I had it spun up for testing, I felt a little like:</p>



<figure class="wp-block-image"><img loading="lazy" width="1004" height="565" src="https://blog.kroy.io/wp-content/uploads/2019/11/ihave.jpg" alt="" class="wp-image-458" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/ihave.jpg 1004w, https://blog.kroy.io/wp-content/uploads/2019/11/ihave-300x169.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/11/ihave-768x432.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/11/ihave-850x478.jpg 850w" sizes="(max-width: 1004px) 100vw, 1004px" /><figcaption><a href="https://knowyourmeme.com/photos/234739-i-have-no-idea-what-im-doing">https://knowyourmeme.com/photos/234739-i-have-no-idea-what-im-doing</a></figcaption></figure>



<p>I&#8217;m pretty sure I got all the security and stuff configured, and the results were pretty straightforward, full 10 gigabit.</p>



<p><strong>Inter-vlan (9.27Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="625" height="57" src="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-intervlan.png" alt="" class="wp-image-459" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-intervlan.png 625w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-intervlan-300x27.png 300w" sizes="(max-width: 625px) 100vw, 625px" /></figure>



<p><strong>NAT (9.24Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="622" height="51" src="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-nat.png" alt="" class="wp-image-460" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-nat.png 622w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-nat-300x25.png 300w" sizes="(max-width: 622px) 100vw, 622px" /></figure>



<p>Outwardly, the results were marginally better than pfSense or VyOS, but I&#8217;m not sure I would want to use Sophos on a regular basis.  It was just confusing and non-intuitive.</p>



<hr class="wp-block-separator"/>



<h3>Untangle</h3>



<p>This was another suggestion in response to my last post.  As with Sophos, it&#8217;s another platform that I have basically no familiarity with.  </p>



<p>It didn&#8217;t take much to get installed, and unlike Sophos, the initial interface configuration  was a breeze.</p>



<figure class="wp-block-image"><img loading="lazy" width="1002" height="665" src="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard.png" alt="" class="wp-image-461" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard.png 1002w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard-300x199.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard-768x510.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard-850x564.png 850w" sizes="(max-width: 1002px) 100vw, 1002px" /></figure>



<p>I&#8217;m not going to lie, even though I&#8217;m completely a CLI junkie, using Untangle is <em>NICE</em>.  Everything was intuitive, and the various graphs and reporting make complete sense from the perspective of a new user.</p>



<figure class="wp-block-image"><img loading="lazy" width="1016" height="684" src="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces.png" alt="" class="wp-image-462" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces.png 1016w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces-300x202.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces-768x517.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces-850x572.png 850w" sizes="(max-width: 1016px) 100vw, 1016px" /></figure>



<h4>Results</h4>



<p>Unfortunately, the performance was comparatively abysmal compared to the other platforms here.  NAT and inter-vlan results were identical.</p>



<p>NAT/inter-vlan (2.7Gbps):</p>



<figure class="wp-block-image"><img loading="lazy" width="595" height="45" src="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-nat.png" alt="" class="wp-image-463" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-nat.png 595w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-nat-300x23.png 300w" sizes="(max-width: 595px) 100vw, 595px" /></figure>



<p>I have to believe there was some performance tuning I could do to get better performance, but I wasn&#8217;t able to track down anything specific.  </p>



<p>Despite the lackluster performance, I really enjoyed setting up and playing with Untangle and it&#8217;s a platform I might use again in the future.</p>



<hr class="wp-block-separator"/>



<a name="finalresults"></a>



<h3>Final Results</h3>



<p>In conclusion, most platforms came out fairly even.  The outlier was Untangle, but I suspect with some tuning it could be brought up to the level of the other platforms.</p>



<table class="wp-block-table is-style-regular"><tbody><tr><th><strong>Router</strong></th><th><strong>Inter-vlan</strong></th><th><strong>NAT</strong></th></tr><tr><td>VyOS</td><td>9.19 Gbps</td><td>9.17 Gbps regular firewall<br>9.12 Gbps zone firewall</td></tr><tr><td>pfSense</td><td>9.19 Gbps hardware offload<br>7.58 Gbps no hardware offload</td><td>8.71 Gbps</td></tr><tr><td>Sophos XG</td><td>9.27 Gbps</td><td>9.24 Gbps</td></tr><tr><td>Untangle</td><td>2.70 Gbps</td><td>2.70 Gbps</td></tr></tbody></table>



<p>The takeaway here is that almost any platform can be an extremely performant firewall and router.  I think with pfSense, the right hardware selection could potentially impact results if you are interested higher speeds.  Whereas with VyOS and probably the other two, the hardware selection would matter a bit less due to better driver support.</p>



<p>As far as Untangle is concerned, it&#8217;s a platform I might be taking another crack at and see if I can figure out why the performance was so low.  Given that the tests were <em>IDENTICAL</em>, there was almost certainly some artificial limitation occurring somewhere.  </p>



<p></p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">449</post-id>	</item>
		<item>
		<title>Battle of the Virtual Routers</title>
		<link>https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=battle-of-the-virtual-routers</link>
					<comments>https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Fri, 23 Aug 2019 19:23:31 +0000</pubDate>
				<category><![CDATA[Debian]]></category>
		<category><![CDATA[Networking]]></category>
		<category><![CDATA[pfsense]]></category>
		<category><![CDATA[RouterOS]]></category>
		<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<guid isPermaLink="false">https://blog2.kroy.io/2019/08/23/battle-of-the-virtual-routers/</guid>

					<description><![CDATA[This is going to be a bit of a long post, so I&#8217;ll be brief in the intro. &#160; Over the last few years, I&#8217;ve become enamored with routing. &#160;As&#8230;]]></description>
										<content:encoded><![CDATA[
<p>This is going to be a bit of a long post, so I&#8217;ll be brief in the intro. &nbsp;</p>





<p>Over the last few years, I&#8217;ve become enamored with routing. &nbsp;As part of that, I&#8217;ve spent a lot of time exploring the various virtual routing platforms, trying to eek out the best performance possible. &nbsp;So I decided to put them all head-to-head in a virtual setting and see how they fare. &nbsp;</p>



<p>The victims:</p>



<ul><li>pfSense 2.4.4-p3</li><li>OPNSense 19.7</li><li>VyOS 1.2.2</li><li>Mikrotik Cloud Hosted Router 6.45.3, unlimited license (CHR)</li><li>Just basic Debian Buster running FRR</li><li>All tests were done with <code>iperf3 -c IP -P2</code>. &nbsp;I tried a number of different combinations of window sizes, number of streams, etc, and everything was pretty close to equal. &nbsp;UDP obviously gave much bigger numbers, but I&#8217;m interested in TCP for right now. &nbsp;</li></ul>



<p>For the purpose of testing and to make all things equal, pfSense and OPNSense will be running with NAT disabled and <code>pfctl -d</code>, to remove the potential slow-downs from packet inspection. &nbsp;The CHR, Debian, VyOS installs won&#8217;t have firewalls running.</p>



<p>If you are just interested in the final results, they are <a href="/battle-of-the-virtual-routers/#finalresults_kvm">HERE</a>. &nbsp;Or maybe you&#8217;d like the results when I ran the test on ESXi <a href="/battle-of-the-virtual-routers/#finalresults_esxi">HERE</a>.</p>



<hr class="wp-block-separator"/>



<h2 id="the-layout">The Layout</h2>



<p>They say a picture tells a thousand words, so I think a simple network diagram should illustrate the setup:</p>



<figure class="wp-block-image"><img loading="lazy" width="812" height="788" src="https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram.png" alt="" class="wp-image-37" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram.png 812w, https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram-300x291.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram-768x745.png 768w" sizes="(max-width: 812px) 100vw, 812px" /></figure>



<p>I&#8217;ll be replacing the firewall image in this picture with the various victims.</p>



<p>I&#8217;ve got a <em>LOT</em> of routing going on in my network. &nbsp;At last count, I think I have at least 8 hops from one end of my network to the other, so OSPF simplifies adding new subnets behind various routers. &nbsp;In most cases, I don&#8217;t even bother to add default routes to new hosts as OSPF floods the default route from my edge device. &nbsp;</p>



<hr class="wp-block-separator"/>



<h2 id="the-hardware">The Hardware</h2>



<p>For these tests, I wanted to use KVM. &nbsp;The network stack on ESXi has been driving me crazy lately, so I was hoping KVM would give me some decent results. &nbsp;Proxmox makes this pretty trivial, so that&#8217;s what I set up.</p>



<ul><li>Proxmox 6</li><li>rootonzfs on an SSD</li><li>64GB of RAM</li><li>D-1521, with Dual X550/552 10G-BaseT ports</li></ul>



<p>This is a more-than-capable machine for these tests, though I will say I&#8217;ve gotten better results on my Broadwell E5.</p>



<p>The networking config on the host is pretty simple. To further isolate things, I have two different ports running as Trunks. &nbsp;Proxmox networking goes over one, and the networking for this test lab goes out of the other.</p>



<p>I did try using OVS, just to see if the results were any different, but they weren&#8217;t. &nbsp;So on Proxmox, the network config is pretty simple:</p>



<pre class="wp-block-code"><code>auto lo
    iface lo inet loopback

    iface eno4 inet manual

    auto ens2
    iface eno2 inet manual

    auto eno3
    iface eno3 inet manual

    auto vmbr0.3
    iface vmbr0.3 inet static
       address 10.3.1.84/24
       gateway 10.3.1.1


    auto vmbr0
    iface vmbr0 inet manual
        bridge_ports eno3
        bridge_stp off
        bridge_fd 0
        bridge_vlan_aware yes

    auto vmbr1
    iface vmbr1 inet manual
        bridge_ports ens2
        bridge_stp off
        bridge_fd 0
        bridge_vlan_aware yes</code></pre>



<p>All &nbsp;VMs are connected to <code>vmbr1</code>.</p>



<p>The VMs should be fairly equal. &nbsp;CPU-wise, I&#8217;ve gone with 2c2t. &nbsp;RAM is 2GB, which is overkill for basically any of these</p>



<hr class="wp-block-separator"/>



<h2 id="the-linux-crowd">The Linux crowd</h2>



<p>The first batch of routers are all based on Linux. &nbsp;The VyOS version I used (1.2.2), is based on Debian Jessie with a modern 4.19 kernel and runs FRR. &nbsp;The CHR is based on an ancient 3.x Linux kernel. &nbsp;The plain Linux install will be the latest Debian Buster, with the repo version of FRR, 6.0.1.</p>



<hr class="wp-block-separator"/>



<h3 id="vyos">VyOS</h3>



<p>As a contributor, I have access to the current VyOS <code>crux</code> version, 1.2.2. &nbsp;For routing, it uses FRR 7.0.1.</p>



<h4 id="config">config</h4>



<p>The config is painfully simple. &nbsp;Three interfaces, WAN/LAN/LAN2, OSPF, DHCP on the LAN interfaces (for ease of use) and enabling SSH.</p>



<p>As initially mentioned, there&#8217;s been no firewall configured here. &nbsp;I&#8217;m only interested in pure routing performance.</p>



<pre class="wp-block-code"><code>interfaces {
         ethernet eth0 {
             duplex auto
             smp-affinity auto
             speed auto
             vif 500 {
                 address 10.253.253.2/30
             }
             vif 2222 {
                 address 10.222.222.1/24
             }
             vif 2223 {
                 address 10.223.223.1/24
             }
         }
         loopback lo {
         }
     }
     protocols {
         ospf {
             area 0.0.0.0 {
                 network 10.253.253.0/30
             }
             redistribute {
                 connected {
                     metric-type 2
                 }
             }
         }
     }
     service {
         dhcp-server {
             shared-network-name VLAN2222 {
                 subnet 10.222.222.0/24 {
                     default-router 10.222.222.1
                     dns-server 10.53.53.53
                     range 0 {
                         start 10.222.222.10
                         stop 10.222.222.200
                     }
              }
              shared-network-name VLAN2223 {
                 subnet 10.223.223.0/24 {
                     default-router 10.223.223.1
                     dns-server 10.53.53.53
                     range 0 {
                         start 10.223.223.10
                         stop 10.223.223.200
                     }
                 }
             }
         }
         ssh {
             port 22
         }
     }</code></pre>



<h4 id="boottime">boot time</h4>



<p>VyOS generally boots pretty quickly, at least with a simple config. &nbsp;37 seconds from starting the VM to routing packets. &nbsp;That&#8217;s also with the bootloader timeout. &nbsp;</p>



<h4 id="iperf3results">iperf3 results</h4>



<p>Here are the results of a simple iperf3 test. &nbsp;From <code>10.223.223.11</code> to <code>10.222.222.12</code> &nbsp;:</p>



<pre class="wp-block-code"><code>     [ ID] Interval           Transfer     Bitrate
     [  5]   0.00-10.04  sec  7.17 GBytes  6.14 Gbits/sec                  receiver
     [  8]   0.00-10.04  sec  7.22 GBytes  6.18 Gbits/sec                  receiver
     [SUM]   0.00-10.04  sec  14.4 GBytes  12.3 Gbits/sec                  receiver</code></pre>



<p>I would be lying if I said I wasn&#8217;t at least a little bit disappointed with those results. &nbsp;Especially since the direct VM-&gt;VM on the same layer2 test shows quite a bit more performance:</p>



<pre class="wp-block-code"><code>    [ ID] Interval           Transfer     Bitrate
    [  5]   0.00-10.04  sec  11.8 GBytes  10.1 Gbits/sec                  receiver
    [  8]   0.00-10.04  sec  11.7 GBytes  10.0 Gbits/sec                  receiver
    [SUM]   0.00-10.04  sec  23.5 GBytes  20.1 Gbits/sec                  receiver</code></pre>



<p>I guess it&#8217;s just the hardware. &nbsp;</p>



<p>I have a few VyOS VMs on ESXi as my main intervlan routing devices on bigger hardware, and those are capable of 15-30Gbps routing between VMs on the same host depending on how busy the host is.</p>



<h4 id="speedtest">speedtest</h4>



<p>I have gigabit Internet, so I wanted to make sure results are at least close to what I would get natively. &nbsp;</p>



<p>Given that this lab is behind a few routers, and my network is fairly busy at any point in time, these results are close enough to gigabit to count. &nbsp;</p>



<figure class="wp-block-image"><img loading="lazy" width="830" height="170" src="https://blog.kroy.io/wp-content/uploads/2019/08/vyos-speedtest.png" alt="" class="wp-image-38" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/vyos-speedtest.png 830w, https://blog.kroy.io/wp-content/uploads/2019/08/vyos-speedtest-300x61.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/vyos-speedtest-768x157.png 768w" sizes="(max-width: 830px) 100vw, 830px" /></figure>



<h4 id="cpuusage">CPU usage</h4>



<p>I was curious what kind of CPU usage there would be under max routing load. &nbsp;Obviously adding a firewall would add to this a bit:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="596" src="https://blog.kroy.io/wp-content/uploads/2019/08/vyos-cpuusage-speedtest-1024x596.png" alt="" class="wp-image-39" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/vyos-cpuusage-speedtest-1024x596.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/08/vyos-cpuusage-speedtest-300x175.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/vyos-cpuusage-speedtest-768x447.png 768w, https://blog.kroy.io/wp-content/uploads/2019/08/vyos-cpuusage-speedtest-850x495.png 850w, https://blog.kroy.io/wp-content/uploads/2019/08/vyos-cpuusage-speedtest.png 1142w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h3 id="debian-frr">Debian/FRR</h3>



<p>The was just a plain Debian Buster install with FRR installed. &nbsp;Honestly, most of the results are throwaway, since they are largely identical to VyOS.</p>



<h4 id="config">config</h4>



<p>There isn&#8217;t much in the way of special config here. &nbsp;Enabling <code>net.ipv4.ip_forward = 1</code> in <code>/etc/sysctl.conf</code> is a must.</p>



<p>Networking ( <code>/etc/network/interfaces</code> ):<br></p>



<pre class="wp-block-code"><code># The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto ens18
iface ens18


auto vlan500
iface vlan500
  bridge-ports ens18.500
  bridge-stp on
  address 10.253.253.2/30
  gateway 10.253.253.1
  dns-nameservers 10.53.53.53


auto vlan2222
iface vlan2222
  bridge-ports ens18.2222
  bridge-stp on
    address 10.222.222.1/24

auto vlan2223
iface vlan2223
  bridge-ports ens18.2223
  bridge-stp on
    address 10.223.223.1/24</code></pre>



<p>FRR ( <code>/etc/frr/frr.conf</code> ):</p>



<pre class="wp-block-code"><code>frr version 6.0.2
frr defaults traditional
hostname ovs
log syslog informational
service integrated-vtysh-config
!
router ospf
 redistribute connected
 network 10.253.253.0/30 area 0
!
line vty</code></pre>



<p>isc-dhcpd ( <code>/etc/dhcpd.conf</code> ):</p>



<pre class="wp-block-code"><code>option domain-name-servers 10.53.53.53;

default-lease-time 600;
max-lease-time 7200;

subnet 10.222.222.0 netmask 255.255.255.0 {
    range 10.222.222.10 10.222.222.200;
    option routers 10.222.222.1;
}

subnet 10.223.223.0 netmask 255.255.255.0 {
    range 10.223.223.10 10.223.223.200;
    option routers 10.223.223.1;
}</code></pre>



<h4 id="boottime">boot time</h4>



<p>This is the one metric that isn&#8217;t throwaway compared to VyOS. &nbsp;19 seconds from power-on to routing is FAST, and that&#8217;s with 5 seconds of grub time. &nbsp;This means if you are interested in super fast boot times, it&#8217;s probably worth your time learning how to set up a router/firewall on unadulterated Linux.</p>



<h4 id="iperf3results">iperf3 results</h4>



<p>As hinted at, the results are very similar to the VyOS results. &nbsp;Not surprising considering same kernel versions, both are FRR, etc.</p>



<pre class="wp-block-code"><code> [ ID] Interval           Transfer     Bitrate
 [  5]   0.00-10.04  sec  7.14 GBytes  6.11 Gbits/sec                  receiver
 [  8]   0.00-10.04  sec  7.08 GBytes  6.06 Gbits/sec                  receiver
 [SUM]   0.00-10.04  sec  14.2 GBytes  12.2 Gbits/sec                  receiver</code></pre>



<h4 id="speedtest">speedtest</h4>



<p>With these speedtest results, I must have found a rare moment when the rest of my network was mostly idle:</p>



<figure class="wp-block-image"><img loading="lazy" width="456" height="113" src="https://blog.kroy.io/wp-content/uploads/2019/08/frr-speedtest.png" alt="" class="wp-image-40" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/frr-speedtest.png 456w, https://blog.kroy.io/wp-content/uploads/2019/08/frr-speedtest-300x74.png 300w" sizes="(max-width: 456px) 100vw, 456px" /></figure>



<h4 id="cpuusageduringheavyrouting">CPU usage during heavy routing</h4>



<p>Again, similar and expected results:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="625" src="https://blog.kroy.io/wp-content/uploads/2019/08/frr-cpuusage-speedtest-1024x625.png" alt="" class="wp-image-41" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/frr-cpuusage-speedtest-1024x625.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/08/frr-cpuusage-speedtest-300x183.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/frr-cpuusage-speedtest-768x469.png 768w, https://blog.kroy.io/wp-content/uploads/2019/08/frr-cpuusage-speedtest-850x519.png 850w, https://blog.kroy.io/wp-content/uploads/2019/08/frr-cpuusage-speedtest.png 1128w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>All in all, the differences between FRR and VyOS were pretty minimal. &nbsp;Despite the longer boot times, I would probably just &nbsp;use VyOS, for the CLI and ease of configuration.</p>



<hr class="wp-block-separator"/>



<h3 id="chr">CHR</h3>



<p>I&#8217;m a heavy Mikrotik user otherwise (multiple RB4011s, CRS317, 326, hex, haps, etc), and CHRs are something I feel like should really perform well.</p>



<p>This is where things started to get a bit funky. &nbsp;I&#8217;ll be honest here, the CHR results were the ones I was most interested in. &nbsp;I have <em>NEVER </em>been able to get decent routing results out of a CHR, I was hoping the proverbial &#8220;blank slate&#8221; would allow me to get the real picture.</p>



<p>The VM was a freshly installed (via systemrescuecd), 6.45.3 CHR, unlocked with a purchased unlimited license. &nbsp;</p>



<h4 id="config">config</h4>



<p>The config here was painfully simple again. &nbsp;A few interfaces and DHCP servers.</p>



<pre class="wp-block-code"><code>/interface ethernet 
set [ find default-name=ether1 ] disable-running-check=no name=Trunk
/interface vlan
add interface=Trunk name=LAN vlan-id=2222
add interface=Trunk name=LAN2 vlan-id=2223
add interface=Trunk name=WAN vlan-id=500
/interface wireless security-profiles
set [ find default=yes ] supplicant-identity=MikroTik
/ip pool
add name=dhcp_pool0 ranges=10.222.222.2-10.222.222.254
add name=dhcp_pool1 ranges=10.223.223.2-10.223.223.254
/ip dhcp-server
add address-pool=dhcp_pool0 disabled=no interface=LAN name=dhcp1
add address-pool=dhcp_pool1 disabled=no interface=LAN2 name=dhcp2
/routing ospf instance
set [ find default=yes ] redistribute-connected=as-type-2 router-id=10.253.253.2
/ip address
add address=10.253.253.2/30 interface=WAN network=10.253.253.0
add address=10.222.222.1/24 interface=LAN network=10.222.222.0
add address=10.223.223.1/24 interface=LAN2 network=10.223.223.0
/ip dhcp-server network
add address=10.222.222.0/24 gateway=10.222.222.1
add address=10.223.223.0/24 gateway=10.223.223.1
/ip dns
set servers=10.53.53.53
/routing ospf network
add area=backbone network=10.253.253.0/30
/system clock
set time-zone-name=America/Chicago</code></pre>



<h4 id="boottime">boot time</h4>



<p>Frankly, the boot time was really about the only decent thing about my CHR tests. &nbsp;12 seconds, which is in-line with the other Linux results, there&#8217;s just no 5 second timeout in grub to contend with here.</p>



<h4 id="iperf3results">iperf3 results</h4>



<p>These results really made me question my testing methodology. &nbsp;Abysmal is about all I can say about it:</p>



<pre class="wp-block-code"><code>[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.04  sec  1.84 GBytes  1.58 Gbits/sec                  receiver
[  8]   0.00-10.04  sec  1.67 GBytes  1.43 Gbits/sec                  receiver
[SUM]   0.00-10.04  sec  3.51 GBytes  3.01 Gbits/sec                  receiver</code></pre>



<p>I really spent a lot of time fighting these results. &nbsp;They felt way off. &nbsp;Some of the troubleshooting:</p>



<ul><li>Messing with offload settings, both in the host and in the VM. &nbsp;</li><li>Using different NIC types. &nbsp;Maybe the CHR didn&#8217;t like virtio.</li><li>Using a Mellanox vs an Intel NIC. &nbsp;The results were the same whether between the same bridge on Proxmox, to another physical host over the 10Gb Trunk link, etc.</li><li>Changing around all the VM&#8217;s involved CPU cores, RAM, NIC types, anything else I could think of.</li></ul>



<p>In the end, I couldn&#8217;t do anything to really change the results. &nbsp;They held pretty steady at 3Gbps.</p>



<h4 id="speedtest">speedtest</h4>



<p>As mentioned above, probably a throwaway test. &nbsp;I just happened to run this test when my network was a little bit busier.</p>



<figure class="wp-block-image"><img loading="lazy" width="804" height="170" src="https://blog.kroy.io/wp-content/uploads/2019/08/chr-speedtest.png" alt="" class="wp-image-42" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/chr-speedtest.png 804w, https://blog.kroy.io/wp-content/uploads/2019/08/chr-speedtest-300x63.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/chr-speedtest-768x162.png 768w" sizes="(max-width: 804px) 100vw, 804px" /></figure>



<h4 id="cpuusage">cpu usage</h4>



<p>Interestingly enough, the CPU usage on the CHR is quite a bit higher, despite also Linux. &nbsp;I&#8217;m guessing this is attributed to the fact that quite a few networking enhancements and optimizations have occurred in later Linux kernel versions + FRR.</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="477" src="https://blog.kroy.io/wp-content/uploads/2019/08/chr-cpuusage-speedtest-1024x477.png" alt="" class="wp-image-43" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/chr-cpuusage-speedtest-1024x477.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/08/chr-cpuusage-speedtest-300x140.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/chr-cpuusage-speedtest-768x358.png 768w, https://blog.kroy.io/wp-content/uploads/2019/08/chr-cpuusage-speedtest-850x396.png 850w, https://blog.kroy.io/wp-content/uploads/2019/08/chr-cpuusage-speedtest.png 2000w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>I was <em>REALLY </em>disappointed with the Mikrotik results here. &nbsp;I know RouterOS is more than capable of going faster than those speeds, but I&#8217;m not sure what kind of tweaking it takes to get it. &nbsp;Maybe you need lots of sources and destinations. &nbsp;</p>



<p>I know my RB4011 can do almost full 10Gb (unless you are on IPv6 grumble grumble), CCRs can do way more, so I don&#8217;t know why this thing is so slow. &nbsp;And it&#8217;s been like that every time I&#8217;ve tested it, whether on KVM or ESXi. &nbsp;</p>



<hr class="wp-block-separator"/>



<h2 id="freebsd">FreeBSD</h2>



<p>It definitely wouldn&#8217;t be a complete test without also testing two popular players in the FreeBSD world. &nbsp;OPNSense and pfSense.</p>



<p>For these tests, a number of important configuration options were applied:</p>



<ul><li>All hardware offload stuff disabled in the VMs.</li><li>Three VLAN interfaces, WAN/LAN/LAN2 as mapped out above.</li><li>FRR plugin installed.</li><li>NAT completely disabled.</li><li><code>pfctl -d</code> . &nbsp;While it didn&#8217;t really impact these tests, I wanted to make sure it was a level playing field.</li></ul>



<hr class="wp-block-separator"/>



<h3 id="pfsense">pfSense</h3>



<p>I&#8217;ll be honest. &nbsp;I think these *Sense platforms aren&#8217;t really great routers. &nbsp;Can they route intervlan? &nbsp;Sure, but even with FRR somewhat native now, it&#8217;s just a pain and very clunky.</p>



<p>With pfSense, I never actually did get FRR running. &nbsp;It starts, but it just doesn&#8217;t do anything. &nbsp;Not to mention the GUI for it absolutely sucks and is just a confusing mess. &nbsp;It doesn&#8217;t actually impact these tests, but I annoyingly had to create some static routes on my other routers to get everything working. &nbsp;</p>



<h4 id="boottime">boot time</h4>



<p>Not fast, 37 seconds with a few seconds at the bootloader. I&#8217;m also positive I&#8217;ve seen this take considerably longer when it&#8217;s not a basic config.</p>



<h4 id="iperf3results">iperf3 results</h4>



<p>Again these results made me question my testing methodogy a bit:</p>



<pre class="wp-block-code"><code>[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.04  sec  1.04 GBytes   891 Mbits/sec                  receiver
[  8]   0.00-10.04  sec  1.97 GBytes  1.68 Gbits/sec                  receiver
[SUM]   0.00-10.04  sec  3.01 GBytes  2.57 Gbits/sec                  receiver  </code></pre>



<p>It&#8217;s worth noting that I&#8217;ve personally seen about 6Gbps on decent hardware, with <code>pf</code> enabled, so I know some of this is due to to the hardware. &nbsp;But I also did try some troubleshooting:</p>



<ul><li>A variety of tweaks on both the host and in the VM with hardware offloading</li><li>Using E1000 NICs. &nbsp;Yeah, that didn&#8217;t turn out too well</li></ul>



<figure class="wp-block-image"><img loading="lazy" width="535" height="101" src="https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-speedtest-e1000.png" alt="" class="wp-image-44" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-speedtest-e1000.png 535w, https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-speedtest-e1000-300x57.png 300w" sizes="(max-width: 535px) 100vw, 535px" /></figure>



<ul><li>Breaking out the VLANs on the host instead of in the VM, and passing in three individual NICs.</li></ul>



<p>Nothing really made too much of a difference.</p>



<h4 id="speedtest">speedtest</h4>



<p>Welcome back to the land of <em>probably-not-very-useful-benchmarks</em>. &nbsp;As before, this easily represents gigabit; my network was just busy.</p>



<figure class="wp-block-image"><img loading="lazy" width="522" height="111" src="https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-speedtest.png" alt="" class="wp-image-45" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-speedtest.png 522w, https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-speedtest-300x64.png 300w" sizes="(max-width: 522px) 100vw, 522px" /></figure>



<h4 id="cpuusageduringrouting">cpu usage during routing</h4>



<p>These CPU results are more within line of the CHR results above. &nbsp;Meaning resource-wise, pfSense takes a bit more to route at high-ish (crappy) speeds. &nbsp;</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="522" src="https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-cpuusage-speedtest-1024x522.png" alt="" class="wp-image-46" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-cpuusage-speedtest-1024x522.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-cpuusage-speedtest-300x153.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-cpuusage-speedtest-768x392.png 768w, https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-cpuusage-speedtest-850x433.png 850w, https://blog.kroy.io/wp-content/uploads/2019/08/pfsense-cpuusage-speedtest.png 1310w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h3 id="opnsense">OPNSense</h3>



<p>For the most part, OPNSense and pfSense performed mostly identically, to the point where it&#8217;s almost not worth the posting the results. &nbsp;But I will.</p>



<p>I will point out that I was able to get FRR going in about 20 seconds on OPNSense. &nbsp;Whereas on pfSense after hacking around with it for 20 minutes I still couldn&#8217;t get it running.</p>



<p>I&#8217;ll also say that I like some things about the OPNSense UI and absolutely hate others. &nbsp;There are definitely some things buried in weird and unintuitive places. &nbsp;</p>



<h4 id="boottime">boot time</h4>



<p>At 34 seconds with 2 seconds of bootloader, this is a few seconds quicker than pfSense.</p>



<h4 id="iperf3results">iperf3 results</h4>



<p>Within the same range as pfSense, similarly disappointing:</p>



<pre class="wp-block-code"><code>[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.03  sec  1.29 GBytes  1.10 Gbits/sec                  receiver
[  8]   0.00-10.03  sec  1.80 GBytes  1.54 Gbits/sec                  receiver
[SUM]   0.00-10.03  sec  3.09 GBytes  2.65 Gbits/sec                  receiver</code></pre>



<h4 id="speedtest">speedtest</h4>



<p>Yet another <em>basically-gigabit</em> screenshot:</p>



<figure class="wp-block-image"><img loading="lazy" width="752" height="150" src="https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-speedtest.png" alt="" class="wp-image-47" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-speedtest.png 752w, https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-speedtest-300x60.png 300w" sizes="(max-width: 752px) 100vw, 752px" /></figure>



<h4 id="cpuduringrouting">cpu during routing</h4>



<p>As with pfSense, the CPU definitely spikes and stays a bit higher during heavy routing. &nbsp;</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="467" src="https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-cpuusage-speedtest-1024x467.png" alt="" class="wp-image-48" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-cpuusage-speedtest-1024x467.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-cpuusage-speedtest-300x137.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-cpuusage-speedtest-768x350.png 768w, https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-cpuusage-speedtest-850x388.png 850w, https://blog.kroy.io/wp-content/uploads/2019/08/opnsense-cpuusage-speedtest.png 2000w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p><a name="finalresults_kvm"></a></p>



<h2 id="final-results">Final Results</h2>



<p>After all these tests, it appears I&#8217;ll probably be sticking to VyOS or Debian for my routing needs. &nbsp;Mostly just for pure routing tasks, which is a lot of what I end up labbing up, &nbsp;Linux seems to do it a bit better.</p>



<figure class="wp-block-table"><table class="has-fixed-layout"><tbody><tr><th>Router</th><th>Boot Time<sup>*</sup></th><th>Intervlan iperf3</th><th>WAN Speedtest<sup>**</sup></th></tr><tr><td>VyOS</td><td>37 seconds<sup>***</sup></td><td>12.3 Gbps</td><td>878Mbps down/918Mbps up</td></tr><tr><td>Debian/FRR</td><td>19 seconds</td><td>12.2 Gbps</td><td>957Mbps down/932Mbps up</td></tr><tr><td>CHR</td><td>12 seconds</td><td>3.01 Gbps</td><td>845Mbps down/868Mbps up</td></tr><tr><td>OPNSense</td><td>34 seconds</td><td>2.65 Gbps</td><td>888Mbps down/930Mbps up</td></tr><tr><td>pfSense</td><td>37 seconds</td><td>2.57 Gbps</td><td>874Mbps down/896Mbps up</td></tr></tbody></table></figure>



<ul><li>* boot times all include bootloader waits. &nbsp;Linux-based was usually about 5 seconds (except CHR). &nbsp;FreeBSD-based is 2 seconds.</li><li>** All results are within a margin of error that says &#8220;<em>gigabit-capable</em>&#8220;. &nbsp;My network was somewhat busy at the time I ran the speedtests, not to mention this lab is buried behind two other different routers.</li><li>*** I&#8217;ve seen VyOS take considerably longer once more complex configurations are applied. Upwards of a minute or more. &nbsp;</li></ul>



<p>As mentioned, I&#8217;ve seen pfSense run up to 6-7Gbps. &nbsp;So the slow speeds on pfSense and OPNSense here are almost certainly due to the host. &nbsp;Along the same line, my VyOS routers that run on my E5-2540v4 can route at 30Gbps or faster, so the 12Gbps observed here is slow. &nbsp;</p>



<p>As far as the CHR is concerned, I&#8217;m not sure. &nbsp;I&#8217;ve done extensive testing with them, and even with the unlimited license, I&#8217;ve never see very good performance out of them, at least not without 100 hosts behind them. &nbsp;</p>



<hr class="wp-block-separator"/>



<h2 id="the-esxi-mutation">The ESXi Mutation</h2>



<p>So before I close this up, I decided to spin up one more set of tests on ESXi. &nbsp;The painfully low pfSense and CHR numbers made me really believe that there was an incompatibility somewhere. &nbsp;Maybe &nbsp;CHR and pfSense just really don&#8217;t like the virtio drivers.</p>



<p>I also only tested VyOS, CHR, and pfSense, since the Debian and OPNSense numbers were largely duplicative.</p>



<p><!--kg-card-begin: html--><a name="finalresults_esxi"></a><!--kg-card-end: html--><!--kg-card-begin: html--></p>



<figure class="wp-block-table"><table class=""><tbody><tr><th>Router</th><th>Boot Time</th><th>Intervlan iperf3</th></tr><tr><td>VyOS</td><td>32 seconds</td><td>17.3 Gbps</td></tr><tr><td>CHR</td><td>17 seconds</td><td>7.63 Gbps</td></tr><tr><td>pfSense</td><td>33 seconds</td><td>5.61 Gbps</td></tr></tbody></table></figure>



<p>As far as boot times are concerned, the shorter times are caused by being on faster storage, though I don&#8217;t know why the CHR decided to be an outlier. &nbsp;</p>



<p>For VyOS, the slightly increased number tracks with my expectations due to CPU and memory bandwidth. &nbsp;My ESXi server is an E5-2640v4, which runs circles around a D-1521. &nbsp;</p>



<p>For the CHR and pfSense, I wouldn&#8217;t expect the numbers to be over double just due to the platform change, so I have to believe it&#8217;s mostly due to some driver situation.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">33</post-id>	</item>
	</channel>
</rss>
