<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>blog.kroy.io</title>
	<atom:link href="https://blog.kroy.io/feed/" rel="self" type="application/rss+xml" />
	<link>https://blog.kroy.io/</link>
	<description>computers, tech, and whatever other random stuff crosses my mind.</description>
	<lastBuildDate>Tue, 29 Jun 2021 22:53:09 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.8</generator>

<image>
	<url>https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-32x32.png</url>
	<title>blog.kroy.io</title>
	<link>https://blog.kroy.io/</link>
	<width>32</width>
	<height>32</height>
</image> 
<site xmlns="com-wordpress:feed-additions:1">166765678</site>	<item>
		<title>VyOS and Mikrotik &#8211; VLAN-a-rama</title>
		<link>https://blog.kroy.io/2021/06/29/vyos-and-mikrotik-vlan-a-rama/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=vyos-and-mikrotik-vlan-a-rama</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Tue, 29 Jun 2021 19:12:19 +0000</pubDate>
				<category><![CDATA[mikrotik]]></category>
		<category><![CDATA[Networking]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[VLAN]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=1169</guid>

					<description><![CDATA[For the novice networker, VLANs are easily one of the most misunderstood concepts. In this post, I&#8217;ll go over some basics and demonstrate how to make the jump from separate&#8230;]]></description>
										<content:encoded><![CDATA[
<p>For the novice networker, VLANs are easily one of the most misunderstood concepts.  In this post, I&#8217;ll go over some basics and demonstrate how to make the jump from separate interfaces and switches to VLANs. </p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Introduction</h2>



<p>Virtual LANs, or VLANs, are one of the most useful features in all of networking.  To put it simply, they allow a logical separation of broadcast domains.  In layperson&#8217;s terms, &#8220;I took a switch and put it in your switch!&#8221;.  </p>



<p>I think it&#8217;s best to start with a traditional physical setup that would represent how most people start their networking adventures.</p>



<hr class="wp-block-separator"/>



<h2>Physical Setup</h2>



<p>For this adventure, I&#8217;ll be using be using:</p>



<ul><li>The <a rel="noreferrer noopener" href="https://blog.kroy.io/2020/01/17/the-baby-wyse-the-dell-3040/" data-type="post" data-id="539" target="_blank">WYSE 3040</a> from a previous blog post.</li><li>An array of small Mikrotiks (<a rel="noreferrer noopener" href="https://amzn.to/35XStKu" target="_blank">hex</a>, <a href="https://amzn.to/3AefB5h" data-type="URL" data-id="https://amzn.to/3AefB5h">hap</a>, <a rel="noreferrer noopener" href="https://amzn.to/2UR3I5h" target="_blank">hex lite</a>) since they are painfully easy to set up as both simple switches and managed switches supporting VLANs.</li><li>A few Virtual Machines to act as end devices, also from a<a href="https://blog.kroy.io/2021/06/23/vyos-from-scratch-routing-and-vps-edition/" data-type="post" data-id="1104"> prior blog post.</a></li></ul>



<p>Let&#8217;s start with this simple network diagram.  </p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="651" height="902" src="https://blog.kroy.io/wp-content/uploads/2021/06/vlanaram1-1.png" alt="" class="wp-image-1221" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/vlanaram1-1.png 651w, https://blog.kroy.io/wp-content/uploads/2021/06/vlanaram1-1-217x300.png 217w, https://blog.kroy.io/wp-content/uploads/2021/06/vlanaram1-1-217x300@2x.png 434w" sizes="(max-width: 651px) 100vw, 651px" /><figcaption>physical layout</figcaption></figure></div>



<p>and how does this setup look when it&#8217;s all wired up?</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0491-1024x768.jpg" alt="" class="wp-image-1232" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0491-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0491-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0491-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0491.jpg 1920w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0491-300x225@2x.jpg 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>messy</figcaption></figure></div>



<hr class="wp-block-separator"/>



<h3>Networking Config</h3>



<p>This is the basic config for all three of the switches.  I don&#8217;t want to get too bogged down with the Mikrotik config, but I should explain some of it.</p>



<p>In the Linux world, and subsequently in Mikrotik-land, a switch would be called a &#8220;bridge&#8221;.  So in this case, I&#8217;ve created a bridge and added all the ports to it.  And then I&#8217;ve told the switches to pull an IP address from the bridge for management.</p>



<pre class="wp-block-code"><code>&#091;admin@MikroTik] &gt; /export 
# jun/28/2021 21:03:30 by RouterOS 6.48.3
# software id = IMPN-EEMU
#
# model = RB750Gr3

/interface bridge
add admin-mac=B8:69:F4:AB:2E:7A auto-mac=no comment=defconf name=bridgeLocal
/interface bridge port
add bridge=bridgeLocal comment=defconf interface=ether1
add bridge=bridgeLocal comment=defconf interface=ether2
add bridge=bridgeLocal comment=defconf interface=ether3
add bridge=bridgeLocal comment=defconf interface=ether4
add bridge=bridgeLocal comment=defconf interface=ether5
/ip dhcp-client
add comment=defconf disabled=no interface=bridgeLocal
</code></pre>



<p>This configuration essentially turns these Mikrotik devices into a dumb switch, with an IP address to manage them.  They are also plugged into my existing network:</p>



<ul><li>HEX into my &#8220;WAN&#8221; network (random VLAN on my existing network that has internet access)</li><li>HAP into a VLAN connected to the &#8220;enduser1&#8221; VM </li><li>HEX LITE into a VLAN connected to the &#8220;enduser2&#8221; VM.</li></ul>



<p> </p>



<hr class="wp-block-separator"/>



<h3>VyOS Config</h3>



<p>The VyOS config here on the WYSE 3040 is very simple:</p>



<ul><li>Onboard NIC is eth0, connected to WAN/HEX switch, pulling an IP from my existing infrastructure.</li><li>USB NIC1 is eth1, connected to HAP switch</li><li>USB NIC2 is eth2, connected to HEX switch</li><li>Some NAT, so my test clients can get on the Internet</li><li>Some DHCP, so my test clients can auto-configure themselves</li></ul>



<pre class="wp-block-code"><code>interfaces {
    ethernet eth0 {
        address dhcp
        description WAN
        hw-id 8c:ec:4b:6d:dc:d6
    }
    ethernet eth1 {
        address 172.21.39.1/24
        description HAPLAN
        hw-id 8c:ae:4c:f5:e5:8f
    }
    ethernet eth2 {
        address 192.168.39.1/24
        description HEXLITELAN
        hw-id 8c:ae:4c:f5:e5:94
    }
    loopback lo {
    }
}
nat {
    source {
        rule 10 {
            outbound-interface eth0
            source {
                address 172.21.39.0/24
            }
            translation {
                address masquerade
            }
        }
        rule 11 {
            outbound-interface eth0
            source {
                address 192.168.39.0/24
            }
            translation {
                address masquerade
            }
        }
    }
}
service {
    dhcp-server {
        shared-network-name HAPDHCP {
            subnet 172.21.39.0/24 {
                default-router 172.21.39.1
                dns-server 10.53.53.53
                range 0 {
                    start 172.21.39.100
                    stop 172.21.39.200
                }
            }
        }
        shared-network-name HEXLITEDHCP {
            subnet 192.168.39.0/24 {
                default-router 192.168.39.1
                dns-server 10.53.53.53
                range 0 {
                    start 192.168.39.100
                    stop 192.168.39.200
                }
            }
        }
    }
    ssh {
        port 22
    }
}</code></pre>



<p>And once it&#8217;s all set up, the two &#8220;enduser&#8221; VMs both have appropriate IP addresses and Internet access as served out by the VyOS-3040:</p>



<figure class="wp-block-image size-large"><img width="1024" height="328" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-47-1024x328.png" alt="" class="wp-image-1216" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-47-1024x328.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-47-300x96.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-47-1536x493.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-47-2048x657.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-47-300x96@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>VMs working</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>VLANs</h2>



<p>Of course we aren&#8217;t here to just make a simple multi-network setup.  We want some VLANs.  So let&#8217;s rewrite some things, and eliminate two of the switches. </p>



<p>First off, let&#8217;s talk about the physical setup we had before.  Before, each of the different switches were connected to &#8220;raw&#8221; ports connecting to existing VLANs on my network:</p>



<ul><li>HEX: VAN9.  This is an existing client network in my homelab.  You plug something in here, it gets a 10.9.1.0/24 address, and instantly has Internet access. This is what the &#8220;WAN&#8221; port of VyOS connects to.</li><li>HAP: VLAN41.  This was a new VLAN I created to connect between eth1 on VyOS and the &#8220;enduser1&#8221; VM.</li><li>HEX LITE: VLAN42. Similarly, a new VLAN I created to connect between eth2 on VyOS and the &#8220;enduser2&#8221; VM.</li></ul>



<p>Physically, this is how the new setup will look:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0494-768x1024.jpg" alt="" class="wp-image-1234" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0494-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0494-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0494-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0494.jpg 1437w, https://blog.kroy.io/wp-content/uploads/2021/06/IMG_0494-225x300@2x.jpg 450w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>getting cleaner</figcaption></figure></div>



<p>In most networking circles, a &#8220;trunk&#8221; just means a port carrying multiple VLANs.  Since we removed two switches, the remaining switch, the HEX, will need to have its uplink port changed into a trunk:</p>



<ul><li>Remove HAP and HEX LITE switches</li><li>On the HEX, change the port that was previously connected to a raw VLAN9 port on my existing network to a trunk.</li><li>Plug eth1 from VyOS into port 4 on HEX, change the VLAN of that port to 41</li><li>Plug eth2 from VyOS into port 3 on HEX, change the VLAN of the port to 42</li><li>Change the VLAN on port 5 on the HEX to 9.  This will change the PVID, or the raw VLAN that&#8217;s use when whatever is plugged in on the other end isn&#8217;t speaking VLANs.</li><li>Due to the prior step, the nothing on VyOS will change</li></ul>



<p>The characteristics of our trunk ports will be simple:</p>



<ul><li>VLAN1 == PVID/untagged.  This is the VLAN traffic will land on if the traffic has no VLAN tags</li><li>VLAN9 == Tagged. </li><li>VLAN41 == Tagged</li><li>VLAN42 == Tagged</li></ul>



<p>I&#8217;ve highlighted the important changes on the remaining switch below:</p>



<ol><li>Add an Switched Virtual Interface or SVI.  This is saying &#8220;Give this switch an interface on this VLAN&#8221;.  This is important because VLAN9 is no longer the default &#8220;untagged&#8221; for the uplink port (ether1)</li><li>Change the PVIDs/default VLANs of the appropriate ports on the bridge.  We are doing this to make the VyOS-3040 think nothing has changed in our physical setup.</li><li>Handle VLAN filtering.  This is going to control what VLANs are allowed on these ports. This is how you create a trunk port in Mikrotik <ol><li><code>ether1</code> is the Trunk to the rest of the network.  It is untagged on VLAN1 (which is a throwaway VLAN for security).  It is tagged on the other two VLANs we are using, 41 and 42.</li><li><code>bridgeLocal</code> is Mikrotik itself. It is untagged on VLAN1 for similar reasons as above.  It it tagged on VLAN9 as this is what allows our newly created <code>VLAN9_SVI</code> so we can create a management address for it.</li><li><code>ether3/4/5</code> are all untagged on the VLANs that match the PVIDs.</li></ol></li><li>Finally, we tell the Mikrotik to pull its address via DHCP on the newly created <code>VLAN9_SVI</code></li></ol>



<pre class="wp-block-code"><code># jun/29/2021 10:27:41 by RouterOS 6.48.3
# software id = IMPN-EEMU
#
# model = RB750Gr3

/interface bridge
add admin-mac=B8:69:F4:AB:2E:7A auto-mac=no comment=defconf name=bridgeLocal vlan-filtering=yes
<strong>/interface vlan
add interface=bridgeLocal name=VLAN9_SVI vlan-id=9</strong>
/interface bridge port
add bridge=bridgeLocal comment=defconf interface=ether1
add bridge=bridgeLocal comment=defconf interface=ether2
<strong>add bridge=bridgeLocal comment=defconf interface=ether3 pvid=42
add bridge=bridgeLocal comment=defconf interface=ether4 pvid=41
add bridge=bridgeLocal comment=defconf interface=ether5 pvid=9</strong>
/interface bridge vlan
<strong>add bridge=bridgeLocal untagged=bridgeLocal,ether1 vlan-ids=1</strong>
<strong>add bridge=bridgeLocal tagged=bridgeLocal,ether1 untagged=ether5 vlan-ids=9
add bridge=bridgeLocal tagged=ether1 untagged=ether4 vlan-ids=41
add bridge=bridgeLocal tagged=ether1 untagged=ether3 vlan-ids=42</strong>
/ip dhcp-client
<strong>add comment=defconf disabled=no interface=VLAN9_SVI</strong></code></pre>



<p>As mentioned above, everything just works as before.  As far as the VyOS-3040 is concerned, it is still connected to three separate switches:</p>



<figure class="wp-block-image size-large"><img width="1024" height="327" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-48-1024x327.png" alt="" class="wp-image-1217" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-48-1024x327.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-48-300x96.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-48-1536x491.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-48-2048x655.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-48-300x96@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>as before, working perfect</figcaption></figure>



<h2>VLANs &#8211; Going Deeper</h2>



<p>Of course, we haven&#8217;t even touched VLANs on VyOS yet, so let&#8217;s dig into that.  </p>



<p>The basic goals will be:</p>



<ul><li>Remove all the dongles</li><li>Move the cable that goes to VyOS-3040 from port 5 to port 2.</li><li>Trunk VLANs 41 and 42 into VyOS</li><li>Change the config in VyOS to use VLAN interfaces instead of physical interfaces.</li></ul>



<p>Physically, this is starting to look super clean.  We only have two cables plugged into the switch, the trunk from the existing networking and the trunk to the VyOS-3040. </p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="659" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-50-659x1024.png" alt="" class="wp-image-1223" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-50-659x1024.png 659w, https://blog.kroy.io/wp-content/uploads/2021/06/image-50-193x300.png 193w, https://blog.kroy.io/wp-content/uploads/2021/06/image-50-988x1536.png 988w, https://blog.kroy.io/wp-content/uploads/2021/06/image-50.png 1097w, https://blog.kroy.io/wp-content/uploads/2021/06/image-50-193x300@2x.png 386w" sizes="(max-width: 659px) 100vw, 659px" /><figcaption>cleaner still</figcaption></figure></div>



<p>I&#8217;ve highlighted the changes to the switch, but basically we are turning port 2 into another trunk, BUUUUT, a trunk with the PVID of 9:</p>



<ul><li>Change the PVID of ether2 to 9.  This is to make it so VyOS-3040 still is &#8220;on&#8221; VLAN9 on its raw port</li><li>Add ether2 as untagged on VLAN9</li><li>Add ether2 as tagged on VLANs 41/42</li></ul>



<pre class="wp-block-code"><code># jun/29/2021 10:49:20 by RouterOS 6.48.3
# software id = IMPN-EEMU
#
# model = RB750Gr3
# serial number = 8AFF09A3F98D
/interface bridge
add admin-mac=B8:69:F4:AB:2E:7A auto-mac=no comment=defconf name=bridgeLocal vlan-filtering=yes
/interface vlan
add interface=bridgeLocal name=VLAN9_SVI vlan-id=9
/interface bridge port
add bridge=bridgeLocal comment=defconf interface=ether1
<strong>add bridge=bridgeLocal comment=defconf interface=ether2 pvid=9</strong>
add bridge=bridgeLocal comment=defconf interface=ether3 pvid=42
add bridge=bridgeLocal comment=defconf interface=ether4 pvid=41
add bridge=bridgeLocal comment=defconf interface=ether5 pvid=9
/ip neighbor discovery-settings
set discover-interface-list=!dynamic
/interface bridge vlan
add bridge=bridgeLocal untagged=bridgeLocal,ether1 vlan-ids=1
<strong>add bridge=bridgeLocal tagged=bridgeLocal,ether1 untagged=ether5,ether2 vlan-ids=9</strong>
<strong>add bridge=bridgeLocal tagged=ether1,ether2 untagged=ether4 vlan-ids=41
add bridge=bridgeLocal tagged=ether1,ether2 untagged=ether3 vlan-ids=42</strong>
/ip dhcp-client
add comment=defconf disabled=no interface=VLAN9_SVI</code></pre>



<p>And in VyOS, the only change is removing eth1/eth2, and moving the config under the appropriate vif:</p>



<pre class="wp-block-code"><code>interfaces {
    ethernet eth0 {
        address dhcp
        description WAN
        hw-id 8c:ec:4b:6d:dc:d6
        <strong>vif 41 {
            address 172.21.39.1/24
            description HAPLAN
        }
        vif 42 {
            address 192.168.39.1/24
            description HEXLITELAN
        }</strong>
    }
    loopback lo {
    }
}
</code></pre>



<p>which we can now access everywhere via <code>eth0.41</code>/<code>eth0.42</code>.</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ show interfaces 
Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down
Interface        IP Address                        S/L  Description
---------        ----------                        ---  -----------
eth0             10.9.1.73/24                      u/u  WAN   
eth0.41          172.21.39.1/24                    u/u  HAPLAN
eth0.42          192.168.39.1/24                   u/u  HEXLITELAN
</code></pre>



<hr class="wp-block-separator"/>



<h2>VLANs &#8211; Gotta Find the Bottom!</h2>



<p>Of course, if you are like me, you turn everything into a trunk to routers.</p>



<p>So we are going to remove VLAN as the PVID from our VyOS-3040 facing port, and just tag it:</p>



<pre class="wp-block-code"><code>&#091;admin@MikroTik] &gt; export           
# jun/29/2021 10:52:50 by RouterOS 6.48.3
# software id = IMPN-EEMU
#
# model = RB750Gr3
/interface bridge
add admin-mac=B8:69:F4:AB:2E:7A auto-mac=no comment=defconf name=bridgeLocal vlan-filtering=yes
/interface vlan
add interface=bridgeLocal name=VLAN9_SVI vlan-id=9
/interface bridge port
add bridge=bridgeLocal comment=defconf interface=ether1
<strong>add bridge=bridgeLocal comment=defconf interface=ether2</strong>
add bridge=bridgeLocal comment=defconf interface=ether3 pvid=42
add bridge=bridgeLocal comment=defconf interface=ether4 pvid=41
add bridge=bridgeLocal comment=defconf interface=ether5 pvid=9
/interface bridge vlan
add bridge=bridgeLocal untagged=bridgeLocal,ether1,ether2 vlan-ids=1
<strong>add bridge=bridgeLocal tagged=bridgeLocal,ether1,ether2 untagged=ether5 vlan-ids=9</strong>
add bridge=bridgeLocal tagged=ether1,ether2 untagged=ether4 vlan-ids=41
add bridge=bridgeLocal tagged=ether1,ether2 untagged=ether3 vlan-ids=42
/ip dhcp-client
add comment=defconf disabled=no interface=VLAN9_SVI
</code></pre>



<p>and a few small changes to VyOS. We move the &#8220;WAN&#8221; dhcp to a VLAN, and change the outbound-interface for the NAT:</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ show configuration 
interfaces {
    ethernet eth0 {
        hw-id 8c:ec:4b:6d:dc:d6
       <strong> vif 9 {
            address dhcp
            description WAN
        }</strong>
        vif 41 {
            address 172.21.39.1/24
            description HAPLAN
        }
        vif 42 {
            address 192.168.39.1/24
            description HEXLITELAN
        }
    }
    loopback lo {
    }
}
nat {
    source {
        rule 10 {
            <strong>outbound-interface eth0.9</strong>
            source {
                address 172.21.39.0/24
            }
            translation {
                address masquerade
            }
        }
        rule 11 {
            <strong>outbound-interface eth0.9</strong>
            source {
                address 192.168.39.0/24
            }
            translation {
                address masquerade
            }
        }
    }
}
service {
    dhcp-server {
        shared-network-name HAPDHCP {
            subnet 172.21.39.0/24 {
                default-router 172.21.39.1
                dns-server 10.53.53.53
                range 0 {
                    start 172.21.39.100
                    stop 172.21.39.200
                }
            }
        }
        shared-network-name HEXLITEDHCP {
            subnet 192.168.39.0/24 {
                default-router 192.168.39.1
                dns-server 10.53.53.53
                range 0 {
                    start 192.168.39.100
                    stop 192.168.39.200
                }
            }
        }
    }
    ssh {
        port 22
    }
}</code></pre>



<p>And if we show our interfaces:</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ show interfaces 
Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down
Interface        IP Address                        S/L  Description
---------        ----------                        ---  -----------
eth0             -                                 u/u  
eth0.9           10.9.1.73/24                      u/u  WAN
eth0.41          172.21.39.1/24                    u/u  HAPLAN
eth0.42          192.168.39.1/24                   u/u  HEXLITELAN
lo               127.0.0.1/8                       u/u  
                 ::1/128                                
</code></pre>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>That&#8217;s it!  I&#8217;ve walked through going from a traditional network with 3 separate interfaces to a single interface carrying the traffic of all three networks.</p>



<p>On to the next!</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">1169</post-id>	</item>
		<item>
		<title>Transylvania &#8211; A Retrospective and Remake</title>
		<link>https://blog.kroy.io/2021/06/28/transylvania-a-retrospective-and-remake/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=transylvania-a-retrospective-and-remake</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 28 Jun 2021 21:03:46 +0000</pubDate>
				<category><![CDATA[gaming]]></category>
		<category><![CDATA[Retrolab]]></category>
		<category><![CDATA[Transylvania]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=1030</guid>

					<description><![CDATA[In the middle of 2021, it&#8217;s hard to imagine that I&#8217;d be writing a blog post about one of the defining games of my youth, Transylvania. But with my recent&#8230;]]></description>
										<content:encoded><![CDATA[
<p>In the middle of 2021, it&#8217;s hard to imagine that I&#8217;d be writing a blog post about one of the defining games of my youth, Transylvania.  But with my recent <a rel="noreferrer noopener" href="https://blog.kroy.io/2020/11/19/scorched-earth-with-the-retro-lab/" data-type="post" data-id="954" target="_blank">retro lab build-out</a>, I really took a long walk down nostalgia lane with this one.</p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Introduction</h2>



<p>To understand the kind of games I reach for when the nostalgia gets huge, you need to understand the mid-80s through the 90s.  </p>



<p>Especially during the early part of this time period, there wasn&#8217;t much.  If you got bored or stuck with a game, you couldn&#8217;t just reach out to the Internet for help or a different game.  You could potentially dial up to BBSs, but even then, often these were absolute deserts of any useful information.</p>



<p>For me, this situation was further complicated by the fact that my household owned solely Macintoshes, which meant I had almost zero resources available to me if I ran into a puzzler.  </p>



<p>I think this early training for troubleshooting has lead me to the person I am today.</p>



<p>In any case, my very first computer was the venerable <a rel="noreferrer noopener" href="https://en.wikipedia.org/wiki/Macintosh_512Ke" target="_blank">Macintosh 512kE</a>.  In the mid-late 80s when we bought this, it was an amazing machine, especially since in the x86 world, Windows was still in its infancy and wouldn&#8217;t gain serious traction until version 3.0/3.1 was released after 1990.  </p>



<p>Recently, I did manage to track down a normal 512k, and with a ROM upgrade, it turned it into a 512kE (essentially)</p>



<figure class="wp-block-image size-large"><img width="756" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/12/image-4-756x1024.png" alt="" class="wp-image-1032" srcset="https://blog.kroy.io/wp-content/uploads/2020/12/image-4-756x1024.png 756w, https://blog.kroy.io/wp-content/uploads/2020/12/image-4-221x300.png 221w, https://blog.kroy.io/wp-content/uploads/2020/12/image-4-1134x1536.png 1134w, https://blog.kroy.io/wp-content/uploads/2020/12/image-4.png 1392w, https://blog.kroy.io/wp-content/uploads/2020/12/image-4-221x300@2x.png 442w" sizes="(max-width: 756px) 100vw, 756px" /><figcaption>Not the original, but a 512k with the ROMs upgraded</figcaption></figure>



<p>Upgrading the ROMs allows it to do new tricks:</p>



<figure class="wp-block-image size-large"><img width="1024" height="895" src="https://blog.kroy.io/wp-content/uploads/2020/12/image-5-1024x895.png" alt="" class="wp-image-1033" srcset="https://blog.kroy.io/wp-content/uploads/2020/12/image-5-1024x895.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/12/image-5-300x262.png 300w, https://blog.kroy.io/wp-content/uploads/2020/12/image-5-1536x1343.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/12/image-5.png 1606w, https://blog.kroy.io/wp-content/uploads/2020/12/image-5-300x262@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption><br>I heard you like dem ROM things</figcaption></figure>



<p>Unfortunately, there was almost NO software for it.  So the games I had were limited to a handful that we could trade between a few of friends, family, and enthusiasts that my pops knew. </p>



<figure class="wp-block-image size-large"><img width="843" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-12-843x1024.png" alt="" class="wp-image-1173" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-12-843x1024.png 843w, https://blog.kroy.io/wp-content/uploads/2021/06/image-12-247x300.png 247w, https://blog.kroy.io/wp-content/uploads/2021/06/image-12-1265x1536.png 1265w, https://blog.kroy.io/wp-content/uploads/2021/06/image-12.png 1357w, https://blog.kroy.io/wp-content/uploads/2021/06/image-12-247x300@2x.png 494w" sizes="(max-width: 843px) 100vw, 843px" /><figcaption>Transylvania</figcaption></figure>



<h2>Transylvania</h2>



<p>An absolute staple of my youth was Transylvania.  Some of my first computing memories were of trying to hack out that game&#8217;s secrets.  And it was a&#8230; slow process.  </p>



<figure class="wp-block-image size-large"><img width="833" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-11-833x1024.png" alt="" class="wp-image-1172" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-11-833x1024.png 833w, https://blog.kroy.io/wp-content/uploads/2021/06/image-11-244x300.png 244w, https://blog.kroy.io/wp-content/uploads/2021/06/image-11-1249x1536.png 1249w, https://blog.kroy.io/wp-content/uploads/2021/06/image-11.png 1400w, https://blog.kroy.io/wp-content/uploads/2021/06/image-11-244x300@2x.png 488w" sizes="(max-width: 833px) 100vw, 833px" /><figcaption>Macintosh Transylvania</figcaption></figure>



<p>A few times a week I would plop down and spend 20 or 30 minutes hammering various commands into the console, usually without much luck.  Funny enough, this is a game that can be conquered in less than 10 minutes if you know what you are doing.  </p>



<p>Every once in a while I would have an epiphany moment, like realizing you could type things like <code>go up</code> or <code>enter house</code>, even though they weren&#8217;t represented as a direction in the text or in the GUI controls.  This would open up a few more possibilities in the game, but ultimately I still was stuck.  </p>



<p>But killing that werewolf the first time was <em>MAGICAL</em>!</p>



<p>And this continued for at least 5+ years, until I eventually got MS-DOS based PCs and started gaming there, at which point I forgot about it for a while.</p>



<hr class="wp-block-separator"/>



<h2>Transylvania DOS</h2>



<p>Sometime in the middle of the 90s, I discovered the Transylvania DOS port, and was committed to conquering the stupid game once more. </p>



<figure class="wp-block-image size-large"><img width="1024" height="985" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-13-1024x985.png" alt="" class="wp-image-1174" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-13-1024x985.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-13-300x289.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-13.png 1438w, https://blog.kroy.io/wp-content/uploads/2021/06/image-13-300x289@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>dos the stump</figcaption></figure>



<p>Unfortunately, it didn&#8217;t take me too long to figure out that things were a bit different.  For one, the cross, which you need to kill the vampire, is nowhere to be found:</p>



<figure class="wp-block-image size-large"><img width="1024" height="410" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-14-1024x410.png" alt="" class="wp-image-1175" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-14-1024x410.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-14-300x120.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-14-1536x616.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-14-2048x821.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-14-300x120@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>no cross</figcaption></figure>



<p>And suddenly there&#8217;s a back to the house, which has a cellar that unless you know exactly what to type, you aren&#8217;t finding what you need:</p>



<figure class="wp-block-image size-large"><img width="1024" height="405" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-16-1024x405.png" alt="" class="wp-image-1177" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-16-1024x405.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-16-300x119.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-16-1536x607.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-16-2048x809.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-16-300x119@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>two houses</figcaption></figure>



<figure class="wp-block-image size-large"><img width="997" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-17-997x1024.png" alt="" class="wp-image-1178" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-17-997x1024.png 997w, https://blog.kroy.io/wp-content/uploads/2021/06/image-17-292x300.png 292w, https://blog.kroy.io/wp-content/uploads/2021/06/image-17.png 1405w, https://blog.kroy.io/wp-content/uploads/2021/06/image-17-292x300@2x.png 584w" sizes="(max-width: 997px) 100vw, 997px" /><figcaption>cellar</figcaption></figure>



<p>And a nailed shut coffin, and inventory limits, which is a ton of fun until you hack out how to kill the werewolf that is constantly harassing you:</p>



<figure class="wp-block-image size-large"><img width="1024" height="456" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-18-1024x456.png" alt="" class="wp-image-1179" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-18-1024x456.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-18-300x134.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-18-1536x684.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-18-2048x912.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-18-300x134@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>nailed shut</figcaption></figure>



<p>And finally, a super obscure command you need to type in the right place, and it&#8217;s something you have no way of knowing if you don&#8217;t have the original packaging:</p>



<figure class="wp-block-image size-large"><img width="1024" height="683" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-19-1024x683.png" alt="" class="wp-image-1180" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-19-1024x683.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-19-300x200.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-19.png 1440w, https://blog.kroy.io/wp-content/uploads/2021/06/image-19-300x200@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>enchanted evening</figcaption></figure>



<p>But I eventually did beat it&#8230; after finding a book with solutions to old video games at the local library, which was sometime close to the year 2000.  </p>



<figure class="wp-block-image size-large"><img width="1024" height="457" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-20-1024x457.png" alt="" class="wp-image-1181" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-20-1024x457.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-20-300x134.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-20-1536x685.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-20-2048x913.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-20-300x134@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>beat the dos version</figcaption></figure>



<p>And then finally this year, went back and beat the Macintosh version, which is a bit less exciting than the DOS version:</p>



<figure class="wp-block-image size-large"><img width="908" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-21-908x1024.png" alt="" class="wp-image-1182" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-21-908x1024.png 908w, https://blog.kroy.io/wp-content/uploads/2021/06/image-21-266x300.png 266w, https://blog.kroy.io/wp-content/uploads/2021/06/image-21-1363x1536.png 1363w, https://blog.kroy.io/wp-content/uploads/2021/06/image-21.png 1400w, https://blog.kroy.io/wp-content/uploads/2021/06/image-21-266x300@2x.png 532w" sizes="(max-width: 908px) 100vw, 908px" /><figcaption>beat the Macintosh version</figcaption></figure>



<p>Of course, the Macintosh version has an advantage because you can carry the princess:</p>



<figure class="wp-block-image size-large"><img width="1024" height="456" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-22-1024x456.png" alt="" class="wp-image-1183" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-22-1024x456.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-22-300x134.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-22-1536x684.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-22-2048x912.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-22-300x134@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption> carrying the princess</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Remake 2010</h2>



<p>Of course, what retrospective would be complete if I hadn&#8217;t actually remade the game in 2010 for iOS?</p>



<figure class="wp-block-image size-large"><img width="1024" height="398" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-23-1024x398.png" alt="" class="wp-image-1184" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-23-1024x398.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-23-300x117.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-23-1536x598.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-23-2048x797.png 2048w, https://blog.kroy.io/wp-content/uploads/2021/06/image-23-300x117@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>iOS assets</figcaption></figure>



<p>It&#8217;s not in the AppStore anymore, and I only ever sold a few dozen copies of it, but this game was my parody remake.  I wanted to keep the spirit and feature some familiar locations, while coming up with something that was dramatically different. </p>



<p>The goal was to find your &#8220;beloved penguin&#8221; and then escape on the boat:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="268" height="257" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-26.png" alt="" class="wp-image-1187"/><figcaption>penguin</figcaption></figure></div>



<p>Your inventory became a fanny pack:</p>



<figure class="wp-block-image size-large"><img width="1024" height="153" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-25-1024x153.png" alt="" class="wp-image-1186" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-25-1024x153.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-25-300x45.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-25.png 1361w, https://blog.kroy.io/wp-content/uploads/2021/06/image-25-300x45@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>fanny pack</figcaption></figure>



<p>The cross existed and was in the same place, but not to kill the vampire. </p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="301" height="157" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-37.png" alt="" class="wp-image-1198"/><figcaption>graveyard</figcaption></figure></div>



<p></p>



<p>It was to get out of the cell that locked behind you in the castle:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="304" height="146" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-38.png" alt="" class="wp-image-1199" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-38.png 304w, https://blog.kroy.io/wp-content/uploads/2021/06/image-38-300x144.png 300w" sizes="(max-width: 304px) 100vw, 304px" /><figcaption>locked cell</figcaption></figure></div>



<p>It acted like the eagle in the original game:</p>



<pre class="wp-block-code"><code>You wave the cross around in the air.  You almost get it moving fast enough to make a pretty picture.  It makes you a little dizzy and you almost pass out.  Suddenly you find yourself someplace different.  The cross disappears in a puff of smoke</code></pre>



<p>Also a cheeky response if you tried to type the stupid &#8220;sing&#8221; stuff that spawned the cross in the DOS version:</p>



<pre class="wp-block-code"><code>Did you seriously just try to sing something?  Did you think that if you just sung some random song, such as 'Some Enchanted Evening', someone would just magically appear and give you the key to saving   your penguin.  I mean seriously, back in my day, we stored our CROSSES out in the open, like in a graveyard.</code></pre>



<hr class="wp-block-separator"/>



<p>The vampire became &#8220;the slightly derpy vampire who wasn&#8217;t bloodthirsty until you touched his things&#8221;.   This meant he would be in every castle room, but only kill you if you tried to pick something up.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="217" height="267" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-24.png" alt="" class="wp-image-1185"/><figcaption>vamp</figcaption></figure></div>



<p>The only way to deal with him was to eat garlic and acid at the same time and burp in his presence, before the counters on the acid and garlic ran out:</p>



<pre class="wp-block-code"><code>You let out a burp of epic proportions.  The combination of acid and your stomach and garlic breath makes for a deadly cloud that turns the derpy vampire to dust.</code></pre>



<p></p>



<p>The werewolf existed in the form of the &#8220;werezombierabbit&#8221;.  And was just as annoying.</p>



<pre class="wp-block-code"><code>A evil looking werezombierabbit jumps out of the bushes and menaces threateningly

and if you didn't move away fast enough:

The furry werezombierabbit eats one of your legs and runs away.  Unfortunately, you are in the middle of a dark forest all alone and you definitely need your legs.  You die a few minutes later from werezombierabbit poisoning (not to mention an amputated leg)
</code></pre>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="212" height="227" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-27.png" alt="" class="wp-image-1188"/><figcaption>werezombierabbit</figcaption></figure></div>



<p>The only way to deal with him was a multi-part solution.  The original game constantly whispered stuff, so in this game, it whispered &#8220;go over there&#8221; every once in a while.  Which if you went &#8220;over there&#8221; from anywhere in the game:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="614" height="173" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-28.png" alt="" class="wp-image-1189" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-28.png 614w, https://blog.kroy.io/wp-content/uploads/2021/06/image-28-300x85.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-28-300x85@2x.png 600w" sizes="(max-width: 614px) 100vw, 614px" /><figcaption>over there</figcaption></figure></div>



<p>You could move the bushes and find the knife.  </p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="179" height="244" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-29.png" alt="" class="wp-image-1190"/></figure></div>



<p>The knife didn&#8217;t exist to kill the werezombierabbit.  It existed to carve out a T-Bone from a loin.  It always annoyed me that you couldn&#8217;t move the rocks in the original game, so I made them movable:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="589" height="169" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-30.png" alt="" class="wp-image-1191" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-30.png 589w, https://blog.kroy.io/wp-content/uploads/2021/06/image-30-300x86.png 300w" sizes="(max-width: 589px) 100vw, 589px" /><figcaption>rocks</figcaption></figure></div>



<p>And when you did this, you got a rock in the your inventory.  Which you would use to throw at the cart:</p>



<pre class="wp-block-code"><code>For no apparent reason, you throw the large rock at the cart.  The rock goes through the cart and punches a hole in the coffin that is in the cart.  A large beef loin falls out</code></pre>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="583" height="141" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-31.png" alt="" class="wp-image-1192" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-31.png 583w, https://blog.kroy.io/wp-content/uploads/2021/06/image-31-300x73.png 300w" sizes="(max-width: 583px) 100vw, 583px" /><figcaption>cart</figcaption></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="139" height="141" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-33.png" alt="" class="wp-image-1194"/><figcaption>loin</figcaption></figure></div>



<p>Which you could then carve:</p>



<pre class="wp-block-code"><code>You carve the loin into a large T-Bone steak. You discard the rest of the loin and stuff the juicy steak into your fanny pack (kinda gross)</code></pre>



<p>and then &#8220;flavor&#8221; with a toadstool:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="152" height="108" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-34.png" alt="" class="wp-image-1195" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-34.png 152w, https://blog.kroy.io/wp-content/uploads/2021/06/image-34-150x108.png 150w" sizes="(max-width: 152px) 100vw, 152px" /><figcaption>toadstool</figcaption></figure></div>



<p>Which was actually a &#8220;magic mushroom&#8221;:</p>



<pre class="wp-block-code"><code>A large steak flavored with a toadstool, otherwise known as a stoolsteak</code></pre>



<p>Which you can eat:</p>



<pre class="wp-block-code"><code>While the raw steak was tasty, it was also flavored with a hallucinogenic toadstool.  You waste a couple of hours chasing a green fairy through the forest</code></pre>



<p>or </p>



<pre class="wp-block-code"><code>You feed the stoolsteak to the werezombierabbit.  From the first lick, it is obvious the animal is seeing strange things.  It runs off into the forest in a frollicky manner chasing imaginary puppies</code></pre>



<hr class="wp-block-separator"/>



<p>The main barrier to actually finding the penguin was getting the shovel.  Which was locked up in the tower where the Princess normally would be.  But you needed the ladder to get there, which was in the basement (why you needed to kill the vampire):</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="917" height="161" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-35.png" alt="" class="wp-image-1196" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-35.png 917w, https://blog.kroy.io/wp-content/uploads/2021/06/image-35-300x53.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-35-300x53@2x.png 600w" sizes="(max-width: 917px) 100vw, 917px" /></figure></div>



<p>For the actual lock, you needed the key, which was in the same place as it was in the original game, but in a bit more of a cheeky manner.  I HATED that stupid goblin, so I went a slightly different route:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="319" height="155" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-36.png" alt="" class="wp-image-1197" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-36.png 319w, https://blog.kroy.io/wp-content/uploads/2021/06/image-36-300x146.png 300w" sizes="(max-width: 319px) 100vw, 319px" /><figcaption>field</figcaption></figure></div>



<p>With bonus LOTR reference:</p>



<pre class="wp-block-code"><code>You are standing in the middle of a sandy field.  Using your incredible skills of deduction and analyzing the footprints, you can tell that a person of short stature, perhaps a hobbit or a goblin, recently stood here twirling a small object, perhaps a 'precious' golden thing.  The only exit is W</code></pre>



<p>And if you searched the field:</p>



<pre class="wp-block-code"><code>You dig around in the sand for a bit.  After a while, you find a small golden key buried in the sand.  You place the key in your fanny pack.</code></pre>



<p>Once the shovel was retrieved, many locations could be dug, but they were all empty save one:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="598" height="174" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-39.png" alt="" class="wp-image-1200" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-39.png 598w, https://blog.kroy.io/wp-content/uploads/2021/06/image-39-300x87.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-39-300x87@2x.png 600w" sizes="(max-width: 598px) 100vw, 598px" /></figure></div>



<p>Inside the cave:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="295" height="168" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-40.png" alt="" class="wp-image-1201"/><figcaption>inside the cave</figcaption></figure></div>



<p>At the house (which was locked in my game):</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="602" height="167" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-41.png" alt="" class="wp-image-1202" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-41.png 602w, https://blog.kroy.io/wp-content/uploads/2021/06/image-41-300x83.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-41-300x83@2x.png 600w" sizes="(max-width: 602px) 100vw, 602px" /><figcaption>at the house</figcaption></figure></div>



<p>This silly junction, which annoyed me in the original game because the exits didn&#8217;t make sense:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="598" height="149" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-42.png" alt="" class="wp-image-1205" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-42.png 598w, https://blog.kroy.io/wp-content/uploads/2021/06/image-42-300x75.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-42-300x75@2x.png 600w" sizes="(max-width: 598px) 100vw, 598px" /><figcaption>silly junction</figcaption></figure></div>



<pre class="wp-block-code"><code>You are in another part of the forest.  This part of the forest seems to serve absolutely no purpose.  Going E or S could take you to some random location, but that doesn't make sense.  Because of this, the only exit is back the way you came, N</code></pre>



<p>And of course where the penguin was actually buried, the screen where the statue and alien stuff happens in the original game:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="597" height="162" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-43.png" alt="" class="wp-image-1206" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-43.png 597w, https://blog.kroy.io/wp-content/uploads/2021/06/image-43-300x81.png 300w" sizes="(max-width: 597px) 100vw, 597px" /><figcaption>field</figcaption></figure></div>



<hr class="wp-block-separator"/>



<p>As in the original game, the way to end the game was to sail away in the boat.  And as in the original game, there was a frog living here:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="557" height="225" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-44.png" alt="" class="wp-image-1207" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-44.png 557w, https://blog.kroy.io/wp-content/uploads/2021/06/image-44-300x121.png 300w" sizes="(max-width: 557px) 100vw, 557px" /><figcaption>lakeside</figcaption></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="264" height="193" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-45.png" alt="" class="wp-image-1208"/><figcaption>frog</figcaption></figure></div>



<p>The lake also had piranhas in it.  And the frog was poisonous:</p>



<pre class="wp-block-code"><code>You now realize that kissing a brightly colored frog was probably a bad idea.  The frog was a poison frog and you die quickly and painfully from the poison on your lips

or

Unfortunately, the frog you have been carrying around was a poison frog.  The poison has been slowly seeping through your fanny pack and into your skin.  You die painfully, rolling around on the ground in the dirt, all alone</code></pre>



<p>The solution was to use the golf club you picked up at some point:</p>



<pre class="wp-block-code"><code>Since it is such a nice night, you take a couple of swings with your golf club.
One of your practice swings clips the frog.  The frog takes an arching motion through the air and lands in the water.  The frog survives, but unfortunately the piranhas die quickly from the poison on the frog.</code></pre>



<p>Once the fish are dead, you can sail away in the boat.  Of course, a cheeky parody game wouldn&#8217;t be complete without an unceremonious ending:</p>



<pre class="wp-block-code"><code>You swim out to the boat with your penguin and sail off into the sunrise.  Once you hit the ocean, an eagle swoops down and steals your stuffed penguin.  Moments later a hurricane comes out of nowhere and sinks  your boat.  You die.  Congratulations!  You win! (I guess)</code></pre>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Anyway, it&#8217;s been fun taking this trip down memory lane, especially the stuff about the parody/remake that I had basically forgotten about. </p>



<p>I&#8217;ve tossed all the resources for the game up in an<a href="https://imgur.com/a/bGhgaR4" target="_blank" rel="noreferrer noopener"> imgur album </a>so you can have a closer look if you want.</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">1030</post-id>	</item>
		<item>
		<title>VyOS from Scratch: Routing and VPS Edition</title>
		<link>https://blog.kroy.io/2021/06/23/vyos-from-scratch-routing-and-vps-edition/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=vyos-from-scratch-routing-and-vps-edition</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Thu, 24 Jun 2021 04:08:33 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[vpn]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[BGeeeeeP]]></category>
		<category><![CDATA[vyos]]></category>
		<category><![CDATA[vyosfromscratch]]></category>
		<category><![CDATA[wireguard]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=1104</guid>

					<description><![CDATA[For a while now I&#8217;ve wanted to document a more complex routing setup with VyOS, and here it is. Routing with BGP, WireGuard to a VPS, and Policy Based Routing?&#8230;]]></description>
										<content:encoded><![CDATA[
<p>For a while now I&#8217;ve wanted to document a more complex routing setup with <a rel="noreferrer noopener" href="https://vyos.io/" target="_blank">VyOS</a>, and here it is.  Routing with BGP, WireGuard to a VPS, and Policy Based Routing?  </p>



<p>This should be a fun one.</p>



<hr class="wp-block-separator"/>



<p>Routing has easily become one of my favorite lab tasks.  Especially since at one point, it was such an incredibly cryptic thing to me.</p>



<p>So fair warning.  This will be long.  </p>



<p>I&#8217;m going to:</p>



<ul><li>Set up a VPS and an internal home router.</li><li>Use WireGuard to connect the VPS and internal home router</li><li>Set up multiple other internal routers and get the traffic flowing.</li><li>Route traffic from a basic desktop through the VPS, all via BGP.</li></ul>





<hr class="wp-block-separator"/>



<h2>Routing</h2>



<p>Routing, put most simply, is: &#8220;Where do I find this IP address I&#8217;m looking for&#8221;.  </p>



<p>So if a host/server/device wants to get to an IP, it needs to know the path to get there.  And it can only talk to devices that it&#8217;s locally connected to, which means a device on a local interface/subnet with it.  </p>



<figure class="wp-block-pullquote"><blockquote><p>There are two main types of routing I&#8217;ll be talking about. </p><p>Static, which is &#8220;hey, I know what subnets are where, and I&#8217;ll map everything manually&#8221;, and dynamic, which is &#8220;I&#8217;m going to set up relationships with other routers and learn stuff automatically&#8221;.</p></blockquote></figure>



<p>BGP, or Border Gateway Protocol, is the type of dynamic routing I&#8217;ll be using here.  </p>



<hr class="wp-block-separator"/>



<p>Let&#8217;s break down the main routing table on one of my primary routers (<code>show ip route</code> in VyOS):</p>



<pre class="wp-block-code"><code>B&gt;* 0.0.0.0/0 &#091;20/0] via 10.245.245.9, eth0.508, weight 1, 00:00:08
C * 10.0.11.0/24 is directly connected, eth0.11, 01w0d22h
C&gt;* 10.0.11.0/24 is directly connected, eth0.11, 01w0d22h
C&gt;* 10.0.35.0/30 is directly connected, eth0.35, 01w0d22h
C * 10.3.1.0/24 is directly connected, eth0.3, 01w0d22h
C&gt;* 10.3.1.0/24 is directly connected, eth0.3, 01w0d22h
C * 10.9.1.0/24 is directly connected, eth0.9, 01w0d22h
C&gt;* 10.9.1.0/24 is directly connected, eth0.9, 01w0d22h
C * 10.10.8.0/24 is directly connected, eth0.8, 01w0d22h
C&gt;* 10.10.8.0/24 is directly connected, eth0.8, 01w0d22h
C * 10.10.51.0/24 is directly connected, eth0.51, 01w0d22h
C&gt;* 10.10.51.0/24 is directly connected, eth0.51, 01w0d22h
C * 10.20.20.0/24 is directly connected, eth0.20, 01w0d22h
C&gt;* 10.20.20.0/24 is directly connected, eth0.20, 01w0d22h
C * 10.21.21.0/24 is directly connected, eth0.21, 01w0d22h
C&gt;* 10.21.21.0/24 is directly connected, eth0.21, 01w0d22h
C * 10.22.22.0/24 is directly connected, eth0.22, 01w0d22h
C&gt;* 10.22.22.0/24 is directly connected, eth0.22, 01w0d22h
B&gt;* 10.53.53.53/32 &#091;20/0] via 10.3.1.252, eth0.3, weight 1, 01w0d22h
  *                       via 10.3.1.254, eth0.3, weight 1, 01w0d22h
B&gt;* 10.53.53.54/32 &#091;20/0] via 10.3.1.252, eth0.3, weight 1, 01w0d22h
  *                       via 10.3.1.254, eth0.3, weight 1, 01w0d22h
C&gt;* 10.245.245.8/30 is directly connected, eth0.508, 01w0d22h</code></pre>



<p>There is lots going on here, but hopefully most of it is pretty straightforward:</p>



<ul><li><code>B&gt;* 0.0.0.0/0</code>: This route is learned from my main edge router via BGP.  This is a <a rel="noreferrer noopener" href="https://www.keycdn.com/support/what-is-cidr#:~:text=CIDR%2C%20which%20stands%20for%20Classless,the%20growth%20of%20routing%20tables." target="_blank">CIDR </a>that represents &#8220;Every address on the Internet&#8221;.  That means any IP or subnet that this server doesn&#8217;t know about, will be forwarded to the device at <code>10.245.245.9</code>.</li><li><code>C&gt; * ...</code> and <code>C *</code> all represent &#8220;directly connected&#8221;.  This means these are all subnets that exist directly on this router.  There are multiple entries here because I&#8217;m using <a rel="noreferrer noopener" href="https://docs.vyos.io/en/equuleus/configuration/highavailability/index.html?highlight=vrrp" target="_blank">VRRP</a> and this router is currently holding the <em>MASTER</em> status for the redundant IP:</li></ul>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="567" height="129" src="https://blog.kroy.io/wp-content/uploads/2021/06/image.png" alt="" class="wp-image-1105" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image.png 567w, https://blog.kroy.io/wp-content/uploads/2021/06/image-300x68.png 300w" sizes="(max-width: 567px) 100vw, 567px" /><figcaption>show interfaces</figcaption></figure></div>



<ul><li>I have two special entries here, <code>10.53.53.53/32</code> and <code>10.53.53.54/32</code>.   These are both learned from my DNS servers via BGP, for a type of &#8220;anycast DNS&#8221;.  Meaning, if the 252 host is down, 10.53.53.53 and 10.53.53.54 will still both respond to DNS queries served from the 254 host.  Vice versa with the 254 host.  I can spin up extra DNS servers with zero effort and they would still respond to my custom DNS IPs.  At one point my DNS range was <code>10.3.1.248-254</code>, which means I had a LOT of DNS servers all responding to the same two IPs. This prevents weirdness in how different operating systems handle primary and backup DNS.</li><li>Finally, another directly connected route.  This is the <code>/30</code> that talks to my main edge router</li></ul>



<hr class="wp-block-separator"/>



<h3>Let&#8217;s talk about CIDRs</h3>



<p>CIDRs are a very important concept in routing.  They represent the <code>/24</code> after the network in the above descriptions.  The smaller the CIDR number, the more IP addresses that network represents.  </p>



<p>Most subnets have a network address and a broadcast address, neither which can be used for hosts in that subnet.</p>



<p>In my opinion, using a tool like <code>sipcalc</code> makes it super clear:</p>



<ul><li>A normal <code>/24</code>.  This is what people normally use for LAN subnets.  A nice range of 254 usable. addresses.  Many people would put their router at <code>10.3.1.1</code> or <code>10.3.1.254</code>, and reserve a DHCP range for somewhere in the middle.  The .0 and .255 addresses are reserved for the network address and broadcast respectively.</li></ul>



<pre class="wp-block-code"><code> sipcalc 10.3.1.0/24    
-&#091;ipv4 : 10.3.1.0/24] - 0

&#091;CIDR]
Host address            - 10.3.1.0
Host address (decimal)  - 167969024
Host address (hex)      - A030100
Network address         - 10.3.1.0
Network mask            - 255.255.255.0
Network mask (bits)     - 24
Network mask (hex)      - FFFFFF00
Broadcast address       - 10.3.1.255
Cisco wildcard          - 0.0.0.255
Addresses in network    - 256
Network range           - 10.3.1.0 - 10.3.1.255
Usable range            - 10.3.1.1 - 10.3.1.254
</code></pre>



<ul><li>A <code>/30</code>.  Often used for point-to-point links.  Four addresses are represented, but only the middle two are available, again due to the network/broadcast addresses.</li></ul>



<pre class="wp-block-code"><code> sipcalc 10.245.245.8/30
-&#091;ipv4 : 10.245.245.8/30] - 0

&#091;CIDR]
Host address            - 10.245.245.8
Host address (decimal)  - 183891208
Host address (hex)      - AF5F508
Network address         - 10.245.245.8
Network mask            - 255.255.255.252
Network mask (bits)     - 30
Network mask (hex)      - FFFFFFFC
Broadcast address       - 10.245.245.11
Cisco wildcard          - 0.0.0.3
Addresses in network    - 4
Network range           - 10.245.245.8 - 10.245.245.11
Usable range            - 10.245.245.9 - 10.245.245.10
</code></pre>



<ul><li>Most people use the larger subnets as &#8220;summary networks&#8221;, such as with this <code>/8</code>.  It would include the <code>10.3.1.0/24</code> and <code>10.245.245.8/30</code> from above.  Meaning if you wanted to target both, and didn&#8217;t want to have two routing entries, you could just use a single route:</li></ul>



<pre class="wp-block-code"><code> sipcalc 10.0.0.0/8     
-&#091;ipv4 : 10.0.0.0/8] - 0

&#091;CIDR]
Host address            - 10.0.0.0
Host address (decimal)  - 167772160
Host address (hex)      - A000000
Network address         - 10.0.0.0
Network mask            - 255.0.0.0
Network mask (bits)     - 8
Network mask (hex)      - FF000000
Broadcast address       - 10.255.255.255
Cisco wildcard          - 0.255.255.255
Addresses in network    - 16777216
Network range           - 10.0.0.0 - 10.255.255.255
Usable range            - 10.0.0.1 - 10.255.255.254
</code></pre>



<ul><li>Finally, a few &#8220;special&#8221; subnets/CIDRs.  We have a <code>/31</code>, which is used for point-to-point links and not waste two addresses, and <code>0.0.0.0/0</code>, which is default route to represent the whole Internet.  Note that the <code>.0</code> address in the <code>/31</code> is actually usable!  Meaning the two usable addresses are <code>10.42.42.0 / 10.42.42.1</code>. This is an oddity if you aren&#8217;t accustomed to it:</li></ul>



<pre class="wp-block-code"><code> sipcalc 10.42.42.0/31
-&#091;ipv4 : 10.42.42.0/31] - 0

&#091;CIDR]
Host address            - 10.42.42.0
Host address (decimal)  - 170535424
Host address (hex)      - A2A2A00
Network address         - 10.42.42.0
Network mask            - 255.255.255.254
Network mask (bits)     - 31
Network mask (hex)      - FFFFFFFE
Broadcast address       - 10.42.42.1
Cisco wildcard          - 0.0.0.1
Addresses in network    - 2
Network range           - 10.42.42.0 - 10.42.42.1
</code></pre>



<pre class="wp-block-code"><code> sipcalc 0.0.0.0/0    
-&#091;ipv4 : 0.0.0.0/0] - 0

&#091;CIDR]
Host address            - 0.0.0.0
Host address (decimal)  - 0
Host address (hex)      - 0
Network address         - 0.0.0.0
Network mask            - 0.0.0.0
Network mask (bits)     - 0
Network mask (hex)      - 0
Broadcast address       - 255.255.255.255
Cisco wildcard          - 255.255.255.255
Addresses in network    - 4294967295
Network range           - 0.0.0.0 - 255.255.255.255
Usable range            - 0.0.0.1 - 255.255.255.254
</code></pre>



<p>So <code>10.53.53.0/24</code> encompasses <code>10.53.53.53/32</code>. And in the routing world, if you were to have routes for both in your routing table, the more specific, <code>/32</code>, would be the one chosen to get to the <code>10.53.53.53</code> host.</p>



<p>I know all that was a bit of an information dump, but hopefully it illustrated a few things.  </p>



<hr class="wp-block-separator"/>



<h2>Home -&gt; VPS Setup</h2>



<p>I don&#8217;t want to get too bogged down with the details of how the Home and VPS routers are configured.  But I&#8217;m using a relatively recent<a rel="noreferrer noopener" href="https://downloads.vyos.io/?dir=rolling/current/amd64" target="_blank"> vyos-rolling </a>build, and have spun up a cheap VPS at Vultr for this blog.</p>



<p>This diagram demonstrates what I am trying to achieve:</p>



<figure class="wp-block-image size-large"><img width="801" height="990" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-7.png" alt="" class="wp-image-1130" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-7.png 801w, https://blog.kroy.io/wp-content/uploads/2021/06/image-7-243x300.png 243w, https://blog.kroy.io/wp-content/uploads/2021/06/image-7-243x300@2x.png 486w" sizes="(max-width: 801px) 100vw, 801px" /><figcaption>the diagram</figcaption></figure>



<h3>Home Setup</h3>



<p>At home, I&#8217;ve buried a brand new VyOS VM deep within my network.  So this is really going to represent the setup of someone that&#8217;s behind multiple layers of NAT, including carrier-grade, meaning they might not be able to port forward.</p>



<p>This is our <code>edge</code> router for this setup. </p>



<p>I&#8217;m assuming some familiarity with VyOS in general, but I&#8217;ll briefly touch over what&#8217;s in the attached config:</p>



<ul><li>Run <code>generate wireguard named-keypairs Vultr</code> in op-mode.  This creates the private key for putting in the following config.</li><li>Run <code>show wireguard keypairs pubkey Vultr</code> to get the pubkey to put in the VPS config.</li><li>Set up the &#8220;WAN&#8221; connection. This is just some random static IP on an existing LAN.</li><li>Set up a pair interfaces that are going to talk to a few other routers.  These <code>10.42.0.0/16</code> or <code>10.42.0-255.0/24</code> addresses are the main subnets that we are going to be playing with. </li><li>Do a little bit of source NAT.  This will make anything behind this router on any subnet inside of <code>10.42.0.0/16</code> be able to get to the Internet.  </li><li>Set up a WireGuard connection to my VPS (this will be deleted before this blog is posted, which is why I&#8217;m keeping the IP).  <ul><li>Set the description and local IP for this tunnel.  I&#8217;m using a <code>/31</code> as mentioned in the above CIDR section.</li><li>Set the <code>allowed-ips</code>.  This is the traffic we want to allow the traverse this tunnel.  We are including both the tunnel <code>/31</code> subnet and the <code>/16</code> subnet.</li><li>Make sure we have the <code>persistent-keepalive 15</code> set here.  Since we aren&#8217;t doing a site-to-site, we need to make sure to have this, so the tunnel doesn&#8217;t timeout.  The tunnel can ONLY be brought up when traffic attempts to go from Home-&gt;VPS and not vice-versa because we are emulating CGNAT here. </li><li>The address and the port of the VPS that WireGuard is configured to listen on</li><li>The public key of the VPS.  From running <code>show wireguard keypairs pubkey Home</code> on the <strong>VPS</strong> after generating it with <code>generate wireguard named-keypairs Home</code></li></ul></li><li>Choosing the local private key to use for this connection.  It should match the &#8220;generate &#8230;&#8221; you ran above.</li><li>My default route for this router so I have Internet access</li><li>turning on SSH and naming this router</li></ul>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show configuration commands
set interfaces ethernet eth0 address '10.21.21.10/24'
set interfaces ethernet eth0 description 'WAN'
set interfaces ethernet eth1 address '10.42.0.1/24'
set interfaces ethernet eth1 description 'LAB1'
set interfaces ethernet eth2 address '10.42.1.1/24'
set interfaces ethernet eth2 description 'LAB2'
set interfaces loopback lo
set nat source rule 10 description 'Outgoing NAT'
set nat source rule 10 outbound-interface 'eth0'
set nat source rule 10 source address '10.42.0.0/16'
set nat source rule 10 translation address 'masquerade'
set interfaces wireguard wg0 address '172.24.32.1/31'
set interfaces wireguard wg0 description 'lab-ptp-vps'
set interfaces wireguard wg0 peer VPS-Lab address '144.202.75.103'
set interfaces wireguard wg0 peer VPS-Lab allowed-ips '172.24.32.0/31'
set interfaces wireguard wg0 peer VPS-Lab allowed-ips '10.42.0.0/16'
set interfaces wireguard wg0 peer VPS-Lab persistent-keepalive '15'
set interfaces wireguard wg0 peer VPS-Lab port '8765'
set interfaces wireguard wg0 peer VPS-Lab pubkey '<strong>lQWPCw1f+B15Au441P2qwue8/YIZ3FLTTW+6N3EzhWM=</strong>'
set interfaces wireguard wg0 private-key 'Vultr'
set protocols static route 0.0.0.0/0 next-hop 10.21.21.1
set service ssh port '22'
set system host-name 'vyoslab-edge'
</code></pre>



<p></p>



<p>Hopefully this should demonstrate where the pubkeys come from:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show wireguard keypairs pubkey Vultr 
<strong>vzJetiL/M5Ujkb5DiwaG1CMAMr1Ib6a4OGdvlIMNWXs=</strong></code></pre>



<h3>VPS Setup</h3>



<p>At Vultr, I&#8217;ve set up a very simple VyOS config with just the basics to get it online, and the complementary WireGuard config.  </p>



<ul><li>This VPS&#8217;s static IP and default route</li><li>Enable SSH</li><li>Set the hostname</li><li>Set up Wireguard<ul><li>Uses the opposite IP address, the .0, in the <code>/31</code> subnet</li><li>Uses the pubkey from above.</li></ul></li></ul>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# run show configuration commands 
set interfaces ethernet eth0 address '144.202.75.103/23'
set interfaces loopback lo
set interfaces wireguard wg0 address '172.24.32.0/31'
set interfaces wireguard wg0 description 'lab-ptp-home'
set interfaces wireguard wg0 peer HomeLab allowed-ips '172.24.32.0/31'
set interfaces wireguard wg0 peer HomeLab allowed-ips '10.42.0.0/16'
set interfaces wireguard wg0 peer HomeLab pubkey '<strong>vzJetiL/M5Ujkb5DiwaG1CMAMr1Ib6a4OGdvlIMNWXs=</strong>'
set interfaces wireguard wg0 port '8765'
set interfaces wireguard wg0 private-key 'Home'
set protocols static route 0.0.0.0/0 next-hop 144.202.74.1
set service ssh port '22'
set system host-name 'vyoslab-vps'
</code></pre>



<p>And the key, which will match the Home pubkey config:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ show wireguard keypairs pubkey  Home 
<strong>lQWPCw1f+B15Au441P2qwue8/YIZ3FLTTW+6N3EzhWM=</strong></code></pre>



<p>If you are paying attention, you&#8217;ll notice that there is no &#8220;endpoint&#8221; directive in the WireGuard config on the VPS side.  </p>



<p>We are running WireGuard here as a server, instead of a site-to-site.</p>



<p>Even though to WireGuard, it doesn&#8217;t care much, it&#8217;s worth noting because it has important implications, as hinted above.  </p>



<p>In this setup, if you are on the VPS and try and bring up the tunnel, nothing will happen.  Because the VPS doesn&#8217;t know how to get to the other end.  So any traffic needs to originate from the home side, and that&#8217;s also why we have the <code>persistent-keepalive</code> on the home side to make sure the tunnel stays up.</p>



<hr class="wp-block-separator"/>



<figure class="wp-block-pullquote"><blockquote><p>So some people may have noticed&#8230; I haven&#8217;t touched ANYTHING security-wise here. </p><p>Honestly, it&#8217;s probably outside of the scope of what I&#8217;m doing. The local &#8220;edge&#8221; router is buried so far in my homelab it doesn&#8217;t matter. And for the VPS router, I&#8217;m sure some people are screaming WHY WHY WHY?</p><p>It&#8217;s because I&#8217;m using Vultr&#8217;s firewall to block all traffic from everywhere that&#8217;s not me. So calm down.</p></blockquote></figure>



<hr class="wp-block-separator"/>



<h2>Tunnels UP!<br></h2>



<p>Assuming you&#8217;ve made it this far, your tunnel should be up. A ping should work to the opposite end of the tunnel (home is .1, so ping .0):</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ ping 172.24.32.0 count 4
PING 172.24.32.0 (172.24.32.0) 56(84) bytes of data.
64 bytes from 172.24.32.0: icmp_seq=1 ttl=64 time=19.9 ms
64 bytes from 172.24.32.0: icmp_seq=2 ttl=64 time=19.3 ms
64 bytes from 172.24.32.0: icmp_seq=3 ttl=64 time=19.3 ms
64 bytes from 172.24.32.0: icmp_seq=4 ttl=64 time=18.8 ms

--- 172.24.32.0 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 8ms
rtt min/avg/max/mdev = 18.768/19.333/19.887/0.419 ms</code></pre>



<p>And a simple op-mode show command:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show interfaces wireguard wg0 
interface: wg0
  description: lab-ptp-vps
  address: 172.24.32.1/31
  public key: vzJetiL/M5Ujkb5DiwaG1CMAMr1Ib6a4OGdvlIMNWXs=
  private key: (hidden)
  listening port: 37175

  peer: VPS-Lab
    public key: lQWPCw1f+B15Au441P2qwue8/YIZ3FLTTW+6N3EzhWM=
    latest handshake: 0:01:16
    status: active
    endpoint: 144.202.75.103:8765
    allowed ips: 172.24.32.0/31, 10.42.0.0/16
    transfer: 54 KB received, 251 KB sent
    persistent keepalive: every 15 seconds

    RX:   bytes  packets  errors  dropped  overrun       mcast
          56008      599       0        0        0           0
    TX:   bytes  packets  errors  dropped  carrier  collisions
         257096     5728       0        1        0           0
</code></pre>



<hr class="wp-block-separator"/>



<h3>Route That!</h3>



<p>But the goal here isn&#8217;t just to set up a tunnel.  We actually want to get to <code>LAB1/2</code> on the home <code>edge</code> router from the VPS.</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show interfaces 
Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down
Interface        IP Address                        S/L  Description
---------        ----------                        ---  -----------
eth0             10.21.21.10/24                    u/u  WAN
eth1             10.42.0.1/24                      u/u  LAB1
eth2             10.42.1.1/24                      u/u  LAB2
lo               127.0.0.1/8                       u/u  
                 ::1/128                                
wg0              172.24.32.1/31                    u/u  lab-ptp-vps
</code></pre>



<p>So let&#8217;s do that.  From the VPS:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ ping 10.42.0.1 count 4
PING 10.42.0.1 (10.42.0.1) 56(84) bytes of data.
^C
--- 10.42.0.1 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 87ms</code></pre>



<p>What&#8217;s the problem here?   Well look at the routing table:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup

S&gt;* 0.0.0.0/0 &#091;1/0] via 144.202.74.1, eth0, weight 1, 1d00h17m
C&gt;* 144.202.74.0/23 is directly connected, eth0, 1d00h17m
C&gt;* 172.24.32.0/31 is directly connected, wg0, 1d00h17m
</code></pre>



<p>Since <code>10.42.0.1</code> doesn&#8217;t match any subnets in the routing table, it will try to go out the default <code>0.0.0.0/0</code> route.  This won&#8217;t work because private IPs can&#8217;t be routed over the public Internet.  </p>



<h4>Static Routing, The Easy Way Out</h4>



<p>There are a few ways around this.  A simple static entry for each of the LAB subnets pointed at the home IP of the tunnel (VPS is .0, home is .1):</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# set protocols static route 10.42.0.0/24 next-hop 172.24.32.1
&#091;edit]
vyos@vyoslab-vps# set protocols static route 10.42.1.0/24 next-hop 172.24.32.1
&#091;edit]
vyos@vyoslab-vps# commit
Done
&#091;edit]
vyos@vyoslab-vps# run show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup

S&gt;* 0.0.0.0/0 &#091;1/0] via 144.202.74.1, eth0, weight 1, 1d00h25m
S&gt;* 10.42.0.0/24 &#091;1/0] via 172.24.32.1, wg0, weight 1, 00:00:05
S&gt;* 10.42.1.0/24 &#091;1/0] via 172.24.32.1, wg0, weight 1, 00:00:05
C&gt;* 144.202.74.0/23 is directly connected, eth0, 1d00h25m
C&gt;* 172.24.32.0/31 is directly connected, wg0, 1d00h25m
&#091;edit]
vyos@vyoslab-vps# 
</code></pre>



<p></p>



<p>Of course, this is ugly, and since I deliberately designed the subnets I&#8217;m using here to be easily &#8220;summarizable&#8221;, there&#8217;s a VERY simple solution:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# delete protocols static route 10.42.0.0/24
&#091;edit]
vyos@vyoslab-vps# delete protocols static route 10.42.1.0/24
&#091;edit]
vyos@vyoslab-vps# set protocols static route 10.42.0.0/16 next-hop 172.24.32.1
&#091;edit]
vyos@vyoslab-vps# commit
&#091;edit]
vyos@vyoslab-vps# save
Saving configuration to '/config/config.boot'...
Done
&#091;edit]
vyos@vyoslab-vps# run show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup

S&gt;* 0.0.0.0/0 &#091;1/0] via 144.202.74.1, eth0, weight 1, 1d00h28m
S&gt;* 10.42.0.0/16 &#091;1/0] via 172.24.32.1, wg0, weight 1, 00:00:09
C&gt;* 144.202.74.0/23 is directly connected, eth0, 1d00h28m
C&gt;* 172.24.32.0/31 is directly connected, wg0, 1d00h28m
</code></pre>



<p>In both cases, a simple ping to either the LAB1 or LAB2 address of <code>edge</code> should work from the VPS:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# run ping 10.42.0.1 count 2
PING 10.42.0.1 (10.42.0.1) 56(84) bytes of data.
64 bytes from 10.42.0.1: icmp_seq=1 ttl=64 time=18.6 ms
64 bytes from 10.42.0.1: icmp_seq=2 ttl=64 time=19.2 ms

--- 10.42.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 3ms
rtt min/avg/max/mdev = 18.624/18.908/19.193/0.315 ms
&#091;edit]
vyos@vyoslab-vps# run ping 10.42.1.1 count 2
PING 10.42.1.1 (10.42.1.1) 56(84) bytes of data.
64 bytes from 10.42.1.1: icmp_seq=1 ttl=64 time=19.5 ms
64 bytes from 10.42.1.1: icmp_seq=2 ttl=64 time=19.2 ms

--- 10.42.1.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 3ms
rtt min/avg/max/mdev = 19.164/19.338/19.512/0.174 ms
&#091;edit]</code></pre>



<p>Now that it&#8217;s working, delete it and get back to a clean slate so we can proceed to the BGP:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# delete protocols static route 10.42.0.0/16 
&#091;edit]
vyos@vyoslab-vps# commit
&#091;edit]
vyos@vyoslab-vps# run show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup

S&gt;* 0.0.0.0/0 &#091;1/0] via 144.202.74.1, eth0, weight 1, 1d00h56m
C&gt;* 144.202.74.0/23 is directly connected, eth0, 1d00h56m
C&gt;* 172.24.32.0/31 is directly connected, wg0, 1d00h56m</code></pre>



<hr class="wp-block-separator"/>



<h4>BGP, The Slightly Less Easy Way Out</h4>



<p>So why not just static routing?  It works right?  Well it does&#8230;  but has a number of notable problems:</p>



<ul><li>Requires planning.  Especially if you want to judiciously use summary routes</li><li>Could potentially require a lot of upkeep as your network grows and morphs.  </li><li>It&#8217;s not BGP, which is just cool.</li></ul>



<p>With the first one, who ever plans?  I know I don&#8217;t.  I&#8217;d rather adjust config on one or two routers than all of them.  </p>



<p>Regardless, we are here to BGP, so let&#8217;s do it.</p>



<p>If you don&#8217;t know what BGP is, you should Google it.  There are 1000 different resources that will explain it better than me. </p>



<p>There are two main types, internal and external (eBGP), and we are going to be focusing on external, because it&#8217;s bit more plug-and-play.  </p>



<p>An ASN, or Autonomous System Number, is an important concept when it comes to eBGP.  When you are announcing public subnets, you need an officially blessed ASN from a place like <a rel="noreferrer noopener" href="https://www.arin.net/resources/guide/asn/" data-type="URL" data-id="https://www.arin.net/resources/guide/asn/" target="_blank">ARIN</a>,  but for our uses, there are a number of for-private ranges we can use:</p>



<ul><li>64512 to 65534 (16 bit)</li><li>4200000000 to 4294967294 (32 bit)</li></ul>



<p>The ASNs are used both for identification and routing decisions.  If I wanted to make a route take a shorter route sometimes and a longer one that others, I could have the ASN PATH in BGP set to &#8220;64512 64512 64512&#8221; on one peer versus just &#8220;64512&#8221; on a second.  This would give preference to the shorter path.  </p>



<p>Does it really matter if you use a non-private one?  Probably not.  And for our cases it will hurt even less than wrongly using non<a rel="noreferrer noopener" href="https://datatracker.ietf.org/doc/html/rfc1918" target="_blank">-RFC1918</a> addresses that people sometimes do in homelabs.  But it&#8217;s still good practice to be a good netizen out of the gate.</p>



<h5>Home Setup</h5>



<p>I&#8217;ll be starting with the Home setup, since that will be kind of the central hub here.  First, start with the basic peering:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show configuration commands
set protocols bgp local-as '4200000000'
set protocols bgp neighbor 172.24.32.0 remote-as '4200000001'
</code></pre>



<p>I&#8217;ll be going with a very basic setup here, just setting up the initial tunnel.</p>



<p>Let&#8217;s walk through here to see what&#8217;s going on:</p>



<ul><li>Set our local ASN.  For <code>edge</code>, I&#8217;ll be using the bottom 32bit private ASN</li><li>Set up our neighbor, this is the <code>vps</code> IP over wireguard, the next available 32bit ASN</li></ul>



<p> </p>



<h5>VPS Setup</h5>



<p>On the VPS, a similarly simple config, with everything swapped. We use the <code>edge</code> side of the WireGuard tunnel, and swap the appropriate local and remote ASN. </p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# run show configuration commands 
set protocols bgp local-as '4200000001'
set protocols bgp neighbor 172.24.32.1 remote-as '4200000000'</code></pre>



<p>With that, the tunnel should be up.  In op-mode:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show bgp summary 

IPv4 Unicast Summary:
BGP router identifier 172.24.32.1, local AS number 4200000000 vrf-id 0
BGP table version 0
RIB entries 0, using 0 bytes of memory
Peers 1, using 21 KiB of memory

Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt
172.24.32.0     4 4200000001        15        15        0    0    0 00:12:27            0        0

Total number of neighbors 1
vyos@vyoslab-edge:~$ 
</code></pre>



<p>and</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# run show bgp summary 

IPv4 Unicast Summary:
BGP router identifier 172.24.32.0, local AS number 4200000001 vrf-id 0
BGP table version 0
RIB entries 0, using 0 bytes of memory
Peers 1, using 21 KiB of memory

Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt
172.24.32.1     4 4200000000        16        16        0    0    0 00:14:00            0        0

Total number of neighbors 1
&#091;edit]
</code></pre>



<p>The important things to note is that the ASN and neighbor IP get swapped on each host.</p>



<hr class="wp-block-separator"/>



<p>Of course, we need a few small modifications to actually get things advertising.</p>



<p>First, we need to tell the home <code>edge</code> to advertise its connected routes. This means that we want to redistribute any routes from this router that are attached to interfaces:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show configuration commands
set protocols bgp address-family ipv4-unicast redistribute connected
</code></pre>



<p>and then on the VPS router to pull any updates instantly:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps# set protocols bgp neighbor 172.24.32.1 address-family ipv4-unicast soft-reconfiguration inbound 
&#091;edit]
vyos@vyoslab-vps# commit
</code></pre>



<p>With that done, if you look on the <code>vps</code> router, you can see stuff happening:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ show bgp summary 

IPv4 Unicast Summary:
BGP router identifier 172.24.32.0, local AS number 4200000001 vrf-id 0
BGP table version 8
RIB entries 9, using 1728 bytes of memory
Peers 1, using 21 KiB of memory

Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt
172.24.32.1     4 4200000000        51        40        0    0    0 00:33:36            5        5

Total number of neighbors 1

</code></pre>



<p>So let&#8217;s look at our routing table on <code>vps</code>:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup

S&gt;* 0.0.0.0/0 &#091;1/0] via 144.202.74.1, eth0, weight 1, 00:37:57
B&gt;* 10.21.21.0/24 &#091;20/0] via 172.24.32.1, wg0, weight 1, 00:13:12
B&gt;* 10.42.0.0/24 &#091;20/0] via 172.24.32.1, wg0, weight 1, 00:13:12
B&gt;* 10.42.1.0/24 &#091;20/0] via 172.24.32.1, wg0, weight 1, 00:13:12
C&gt;* 144.202.74.0/23 is directly connected, eth0, 00:38:03
B   172.24.32.0/31 &#091;20/0] via 172.24.32.1 inactive, weight 1, 00:13:12
C&gt;* 172.24.32.0/31 is directly connected, wg0, 00:38:00
</code></pre>



<p>If everything is working, any route that exists on our <code>edge</code>&#8216;s routing table as &#8220;directly connected&#8221;, should be found on our <code>vps</code>&#8216;s routing table going over the WireGuard tunnel.</p>



<p>You can test this by adding a new dummy interface on the <code>edge</code> router:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge# set interfaces dummy dum0 address 172.22.22.255/32
&#091;edit]
vyos@vyoslab-edge# commit</code></pre>



<p>Almost immediately, you should see it pop up in the routing table on the <code>vps</code>, but it won&#8217;t be pingable because it&#8217;s not part of the <code>allowed-ips</code> of the WireGuard tunnel:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ show ip route 172.22.22.255/32
Routing entry for 172.22.22.255/32
  Known via "bgp", distance 20, metric 0, best
  Last update 00:00:36 ago
  * 172.24.32.1, via wg0, weight 1


vyos@vyoslab-vps:~$ ping 172.22.22.255
PING 172.22.22.255 (172.22.22.255) 56(84) bytes of data.
From 172.24.32.0 icmp_seq=1 Destination Host Unreachable
ping: sendmsg: Required key not available
From 172.24.32.0 icmp_seq=2 Destination Host Unreachable
ping: sendmsg: Required key not available
^C
--- 172.22.22.255 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 54ms
</code></pre>



<p>Now the real fun can start&#8230;.</p>



<hr class="wp-block-separator"/>



<h2>BGeeeeeP All The Things</h2>



<p>So if you&#8217;ve been following along, we&#8217;ve completed the top part of our diagram here:</p>



<figure class="wp-block-image size-large"><img width="776" height="894" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-8.png" alt="" class="wp-image-1131" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-8.png 776w, https://blog.kroy.io/wp-content/uploads/2021/06/image-8-260x300.png 260w, https://blog.kroy.io/wp-content/uploads/2021/06/image-8-260x300@2x.png 520w" sizes="(max-width: 776px) 100vw, 776px" /></figure>



<p>It&#8217;s time to get our LAB1 and LAB2 routers up.  </p>



<hr class="wp-block-separator"/>



<h3>A Pair of Internal-Internal Routers</h3>



<p>The first thing I&#8217;ll be doing is preparing the <code>edge</code> router to connect to <code>lab1</code> and <code>lab2</code>:</p>



<ul><li>Set up a neighbor pointing at <code>lab1</code>.</li><li><code>default-originate</code> tells this router to automatically set the default route for <code>lab1</code> to this router</li><li>As before, pull updates from <code>lab1</code> quickly</li><li>Set the next ASN in line</li><li>Rinse and repeat for <code>lab2</code></li></ul>



<pre class="wp-block-code"><code>set protocols bgp neighbor 10.42.0.2 address-family ipv4-unicast default-originate
set protocols bgp neighbor 10.42.0.2 address-family ipv4-unicast soft-reconfiguration inbound
set protocols bgp neighbor 10.42.0.2 remote-as '4200000002'
set protocols bgp neighbor 10.42.1.2 address-family ipv4-unicast default-originate
set protocols bgp neighbor 10.42.1.2 address-family ipv4-unicast soft-reconfiguration inbound
set protocols bgp neighbor 10.42.1.2 remote-as '4200000003'</code></pre>



<hr class="wp-block-separator"/>



<p>The configs for these two are mostly identical.  Note the changes in IP addresses and ASNs</p>



<ul><li>I&#8217;m using a slightly different method of advertising on <code>lab2</code>.  Instead of redistributing any connected network, I&#8217;m choosing the specific network to spit out.</li><li>I&#8217;ve set up some DHCP Servers.  This is so I can just plug in a client and go for testing</li><li>I&#8217;ve also ignored setting up any source NAT.  This is so I can directly access the 100/101 networks from the VPS.</li><li>Note that both of these are missing the <code>0.0.0.0/0</code> default route/gateway.  This is because they are learning it via BGP.</li></ul>



<p></p>



<h4>LAB1</h4>



<pre class="wp-block-code"><code>vyos@vyoslab-lab1:~$ show configuration commands
set interfaces ethernet eth0 address '10.42.0.2/24'
set interfaces ethernet eth1 address '10.42.100.1/24'
set interfaces loopback lo
<strong>set protocols bgp address-family ipv4-unicast redistribute connected </strong>
set protocols bgp local-as '4200000002'
set protocols bgp neighbor 10.42.0.1 address-family ipv4-unicast soft-reconfiguration inbound
set protocols bgp neighbor 10.42.0.1 remote-as '4200000000'
set service dhcp-server shared-network-name LAB1 subnet 10.42.100.0/24 default-router '10.42.100.1'
set service dhcp-server shared-network-name LAB1 subnet 10.42.100.0/24 dns-server '1.1.1.1'
set service dhcp-server shared-network-name LAB1 subnet 10.42.100.0/24 dns-server '1.0.0.1'
set service dhcp-server shared-network-name LAB1 subnet 10.42.100.0/24 range 0 start '10.42.100.100'
set service dhcp-server shared-network-name LAB1 subnet 10.42.100.0/24 range 0 stop '10.42.100.200'
set service ssh port '22'
set system host-name 'vyoslab-lab1'
</code></pre>



<h4>LAB2</h4>



<pre class="wp-block-code"><code>vyos@vyoslab-lab2:~$ show configuration commands
set interfaces ethernet eth0 address '10.42.1.2/24'
set interfaces ethernet eth1 address '10.42.101.1/24'
set interfaces loopback lo
<strong>set protocols bgp address-family ipv4-unicast network 10.42.101.0/24</strong>
set protocols bgp local-as '4200000003'
set protocols bgp neighbor 10.42.1.1 address-family ipv4-unicast soft-reconfiguration inbound
set protocols bgp neighbor 10.42.1.1 remote-as '4200000000'
set service dhcp-server shared-network-name LAB2 subnet 10.42.101.0/24 default-router '10.42.101.1'
set service dhcp-server shared-network-name LAB2 subnet 10.42.101.0/24 dns-server '1.1.1.1'
set service dhcp-server shared-network-name LAB2 subnet 10.42.101.0/24 dns-server '1.0.0.1'
set service dhcp-server shared-network-name LAB2 subnet 10.42.101.0/24 range 0 start '10.42.101.100'
set service dhcp-server shared-network-name LAB2 subnet 10.42.101.0/24 range 0 stop '10.42.101.200'
set service ssh port '22'
set system host-name 'vyoslab-lab2'
</code></pre>



<p>Assuming everything is set up right, the BGP connections should pop up and be viewable from <code>edge</code>.  Note the different counts in <code>State/PfxRcd</code> between <code>lab1</code> and <code>lab2</code>.  This is due to how I chose to advertise as mentioned above.  </p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show ip bgp summary 

IPv4 Unicast Summary:
BGP router identifier 172.24.32.1, local AS number 4200000000 vrf-id 0
BGP table version 18
RIB entries 11, using 2112 bytes of memory
Peers 3, using 64 KiB of memory

Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt
10.42.0.2       4 4200000002       131       139        0    0    0 01:22:18            <strong>2</strong>        6
10.42.1.2       4 4200000003       129       143        0    0    0 01:21:56            <strong>1</strong>        6
172.24.32.0     4 4200000001       123       122        0    0    0 01:33:50            0        6</code></pre>



<p>And the routing table all the way out on the <code>vps</code> should be populated and pingable with the two new subnets:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup

S&gt;* 0.0.0.0/0 &#091;1/0] via 10.21.21.1, eth0, weight 1, 01:37:31
C&gt;* 10.21.21.0/24 is directly connected, eth0, 01:37:33
C&gt;* 10.42.0.0/24 is directly connected, eth1, 01:37:34
C&gt;* 10.42.1.0/24 is directly connected, eth2, 01:37:33
B&gt;* 10.42.100.0/24 &#091;20/0] via 10.42.0.2, eth1, weight 1, 00:04:04
B&gt;* 10.42.101.0/24 &#091;20/0] via 10.42.1.2, eth2, weight 1, 01:25:05
C&gt;* 172.24.32.0/31 is directly connected, wg0, 01:37:32

------------

vyos@vyoslab-edge:~$ ping 10.42.100.1 count 1
PING 10.42.100.1 (10.42.100.1) 56(84) bytes of data.
64 bytes from 10.42.100.1: icmp_seq=1 ttl=64 time=0.264 ms

--- 10.42.100.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.264/0.264/0.264/0.000 ms

--------------

vyos@vyoslab-edge:~$ ping 10.42.101.1 count 1
PING 10.42.101.1 (10.42.101.1) 56(84) bytes of data.
64 bytes from 10.42.101.1: icmp_seq=1 ttl=64 time=10.7 ms

--- 10.42.101.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 10.711/10.711/10.711/0.000 ms
</code></pre>



<hr class="wp-block-separator"/>



<h2>Playing around with Clients</h2>



<p>Whew&#8230; We&#8217;ve made it this far.  So what can we do?</p>



<p>First off, a pair of basic Ubuntu installs.  One behind <code>lab1</code> and one behind <code>lab2</code>:</p>



<figure class="wp-block-image size-large"><img width="1024" height="338" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-9-1024x338.png" alt="" class="wp-image-1149" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-9-1024x338.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/06/image-9-300x99.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-9-1536x507.png 1536w, https://blog.kroy.io/wp-content/uploads/2021/06/image-9.png 2009w, https://blog.kroy.io/wp-content/uploads/2021/06/image-9-300x99@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>two installs</figcaption></figure>



<p>If we traceroute from one to another:</p>



<pre class="wp-block-code"><code>kroy@vyoslab-enduser1:~$ traceroute 10.42.101.100  &lt;1st Ubuntu&gt;
traceroute to 10.42.101.100 (10.42.101.100), 30 hops max, 60 byte packets
 1  _gateway (10.42.100.1)  0.192 ms  0.168 ms  0.162 ms  &lt;LAB1&gt;
 2  10.42.0.1 (10.42.0.1)  0.719 ms  0.709 ms  0.704 ms  &lt;EDGE&gt;
 3  10.42.1.2 (10.42.1.2)  0.769 ms  0.763 ms  0.759 ms  &lt;LAB2&gt;
 4  10.42.101.100 (10.42.101.100)  1.188 ms  1.183 ms  1.177 ms  &lt;2nd Ubuntu&gt;
</code></pre>



<p>What about if we go from the <code>vps</code> to one of the Ubuntu installs:</p>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ traceroute 10.42.101.100
traceroute to 10.42.101.100 (10.42.101.100), 30 hops max, 60 byte packets
 1  172.24.32.1 (172.24.32.1)  18.453 ms  18.367 ms  18.378 ms   &lt;EDGE via WireGuard&gt;
 2  10.42.1.2 (10.42.1.2)  18.343 ms  18.308 ms  18.275 ms   &lt;LAB2&gt;
 3  10.42.101.100 (10.42.101.100)  18.250 ms  18.211 ms  18.178 ms   &lt;2nd Ubuntu&gt;
</code></pre>



<p>To a well-known site:</p>



<pre class="wp-block-code"><code>kroy@vyoslab-enduser1:~$ traceroute 1.1.1.1
traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets
 1  _gateway (10.42.100.1)  0.220 ms  0.183 ms  0.176 ms   &lt;LAB1&gt;
 2  10.42.0.1 (10.42.0.1)  0.379 ms  0.372 ms  0.362 ms  &lt;EDGE&gt;
 3  10.21.21.3 (10.21.21.3)  1.206 ms  1.200 ms  1.193 ms  &lt;An Internal Router&gt;
 4  10.245.245.9 (10.245.245.9)  1.255 ms  1.249 ms  1.236 ms  &lt;My Edge Router&gt;
 5  xxxxxxxxxxxxxxxxxxxxxxxxxxx 2.658 ms  2.651 ms  2.639 ms
 6  xxxxxxxxxxxxxxxxxxxxxxxxxxx 5.195 ms  3.781 ms  4.081 ms
 7  xxxxxxxxxxxxxxxxxxxxxxxxxxx  4.069 ms  4.646 ms  4.626 ms
 8  xxxxxxxxxxxxxxxxxxxxxxxxxxx.191 ms  4.610 ms  4.600 ms
 9  100ge15-2.core1.mci3.he.net (184.105.65.165)  8.474 ms  9.064 ms  8.443 ms
10  cloudflare.grand1.kcix.net (206.51.7.34)  9.040 ms  10.013 ms  9.385 ms
11  one.one.one.one (1.1.1.1)  9.415 ms  8.984 ms  8.106 ms
</code></pre>



<hr class="wp-block-separator"/>



<h3>A Policy Route</h3>



<p>Of course, all we&#8217;ve really done here is set up basic communication between a number of subnets at multiple locations.  So let&#8217;s toss some PBR (Policy Based Routing) into the mix.  </p>



<p>The first step is to make sure <code>vps</code> is set up to NAT out. This is:</p>



<ul><li>Take all traffic from this subnet</li><li>Masquerade it to the public IP of the VPS</li><li><code>eth0</code> is the WAN interface of the VPS</li></ul>



<pre class="wp-block-code"><code>vyos@vyoslab-vps:~$ show configuration commands 
set nat source rule 10 source address '10.42.100.0/24'
set nat source rule 10 translation address 'masquerade'
set nat source rule 10 outbound-interface 'eth0'</code></pre>



<p>Then, on <code>edge</code> is where all the magic happens.  The goal here is to put all traffic from/to the <code>10.42.100.0/24</code> subnet, into a separate routing table.  That way we can tell all the <code>0.0.0.0/0</code> traffic to leave this router via the WireGuard/VPS connection.</p>



<ul><li>Set up a policy route.  This puts all traffic to and from in a separate routing table, <code>100</code></li><li>Tie a specific route for <code>0.0.0.0/0</code> to that table, and tell it to go out via the <code>vps</code> WireGuard IP</li><li>Allow all traffic through WireGuard on this end.  Otherwise WireGuard will deny traffic to everywhere</li><li>Attach the new policy to the interface the traffic will be coming in on.</li></ul>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show configuration commands        
set policy route OUTGOING-VPS rule 100 set table '100'
set policy route OUTGOING-VPS rule 100 source address '10.42.100.0/24'
set policy route OUTGOING-VPS rule 101 destination address '10.42.100.0/24'
set policy route OUTGOING-VPS rule 101 set table '100'
set protocols static table 100 route 0.0.0.0/0 next-hop 172.24.32.0
set interfaces wireguard wg0 peer VPS-Lab allowed-ips '0.0.0.0/0'
set interfaces ethernet eth1 policy route 'OUTGOING-VPS'
</code></pre>



<p>Once that is complete, you should be accessing the web through the VPS.  Note the VPS IP in the curl, and the dramatically different path than the one it took above.</p>



<pre class="wp-block-code"><code>kroy@vyoslab-enduser1:~$ curl ifconfig.co
144.202.75.103

kroy@vyoslab-enduser1:~$ traceroute 1.1.1.1
traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets
 1  _gateway (10.42.100.1)  0.221 ms  0.195 ms  0.189 ms  &lt;LAB1&gt;
 2  10.42.0.1 (10.42.0.1)  0.421 ms  0.415 ms  0.406 ms    &lt;EDGE&gt;
 3  172.24.32.0 (172.24.32.0)  19.710 ms  20.094 ms  20.088 ms  &lt;VPS WireGuard&gt;
 4  * * *  &lt;VPS Default Gateway&gt;
 5  vl199-ds1-b5-02.05.dal4.constant.com (108.61.111.1)  23.403 ms  26.589 ms  29.625 ms
 6  * * *
 7  * * *
 8  ae-31.a01.dllstx09.us.bb.gin.ntt.net (128.241.219.53)  19.701 ms * 8-1-5.ear1.Dallas3.Level3.net (4.15.38.133)  19.719 ms
 9  ae-31.a01.dllstx09.us.bb.gin.ntt.net (128.241.219.53)  19.682 ms 8-1-5.ear1.Dallas3.Level3.net (4.15.38.133)  19.726 ms  19.721 ms
10  ae11.cr8-dal3.ip4.gtt.net (213.200.115.30)  19.877 ms ip4.gtt.net (208.116.142.210)  19.950 ms ae-6.r10.dllstx09.us.bb.gin.ntt.net (129.250.5.4)  19.623 ms
11  ip4.gtt.net (208.116.142.210)  20.130 ms  20.148 ms cloudflare-ic328260-dls-b23.ip.twelve99-cust.net (62.115.61.243)  20.989 ms
12  one.one.one.one (1.1.1.1)  19.788 ms  20.716 ms  20.428 ms
</code></pre>



<p>Once this is working, you could set up a web server on this IP and access it via the VPS.</p>



<hr class="wp-block-separator"/>



<h4>OOOPS&#8230;</h4>



<p>Unfortunately, we&#8217;ve create a bit of a mistake.  Remember this from above?</p>



<figure class="wp-block-image size-large"><img width="833" height="298" src="https://blog.kroy.io/wp-content/uploads/2021/06/image-10.png" alt="" class="wp-image-1152" srcset="https://blog.kroy.io/wp-content/uploads/2021/06/image-10.png 833w, https://blog.kroy.io/wp-content/uploads/2021/06/image-10-300x107.png 300w, https://blog.kroy.io/wp-content/uploads/2021/06/image-10-300x107@2x.png 600w" sizes="(max-width: 833px) 100vw, 833px" /><figcaption>original traceroute</figcaption></figure>



<p>The path looks waaaay different now:</p>



<pre class="wp-block-code"><code>kroy@vyoslab-enduser1:~$ traceroute 10.42.101.100   &lt;1st Ubuntu&gt;
traceroute to 10.42.101.100 (10.42.101.100), 30 hops max, 60 byte packets
 1  _gateway (10.42.100.1)  0.215 ms  0.201 ms  0.196 ms   &lt;LAB1&gt;
 2  10.42.0.1 (10.42.0.1)  0.357 ms  0.700 ms  0.694 ms  &lt;EDGE&gt;
 3  172.24.32.0 (172.24.32.0)  19.082 ms  19.076 ms  19.142 ms   &lt;VPS???&gt;
 4  172.24.32.1 (172.24.32.1)  19.135 ms  19.129 ms  19.264 ms   &lt;EDGE AGAIN WOT?&gt;
 5  10.42.1.2 (10.42.1.2)  19.504 ms  19.494 ms  19.488 ms  &lt;LAB2&gt;
 6  10.42.101.100 (10.42.101.100)  19.717 ms  19.680 ms  19.654 ms &lt;2nd Ubuntu&gt;
 </code></pre>



<p>The policy based routing has created a bit of a weird path.  In fact, we are a bit lucky it can find a path at all.  </p>



<p>Fortunately, this is easily fixable on <code>edge</code>:</p>



<ul><li>When traffic from our &#8220;re-routed&#8221; network tries to hit anything in the <code>10.0.0.0/8</code> network (another summary route for the networks I use here and in the rest of my lab), put the traffic back in the <code>main</code> routing table.</li></ul>



<pre class="wp-block-code"><code>vyos@vyoslab-edge:~$ show configuration commands  
set policy route OUTGOING-VPS rule 90 destination address '10.0.0.0/8'
set policy route OUTGOING-VPS rule 90 set table 'main'
</code></pre>



<p>And once more the traceroute looks normal AND the rest of the traffic is still being routed though the VPS:</p>



<pre class="wp-block-code"><code>kroy@vyoslab-enduser1:~$ traceroute 10.42.101.100
traceroute to 10.42.101.100 (10.42.101.100), 30 hops max, 60 byte packets
 1  _gateway (10.42.100.1)  0.286 ms  0.233 ms  0.227 ms
 2  10.42.0.1 (10.42.0.1)  0.429 ms  0.423 ms  0.413 ms
 3  10.42.1.2 (10.42.1.2)  0.732 ms  0.726 ms  0.720 ms
 4  10.42.101.100 (10.42.101.100)  0.964 ms  0.949 ms  0.937 ms

kroy@vyoslab-enduser1:~$ curl ifconfig.co
144.202.75.103
</code></pre>



<hr class="wp-block-separator"/>



<h2>Caveats</h2>



<p>Even though I&#8217;m at almost 5000 words on this post already, I fully acknowledge this will end with a LOT of basics missing:</p>



<ul><li>At any point in this whole thing,&#8221;insert security&#8221;.  This is all very wide open and would be a bad idea to implement without some security controls in place.</li><li>You would need to set up access/as-path/communities/prefix -lists and route-maps to fine tune what you are announcing and accepting.  Right now, everything that was built is basically &#8220;Announce Everything and Accept Everything!&#8221;.   This is bad in so many ways, and on the public Internet, has actually broken big parts of the Internet because some network engineer announced or accepted a prefix they shouldn&#8217;t have.  </li><li>None of this even scratches the surface of what BGP can do.  You can build up failover and redundancy, make routing decisions based on tons of factors and more.   </li><li>I could write 20 more posts of equal or more length and still barely demonstrate beyond the basics, especially when it comes to best-practices (of which there weren&#8217;t many here), or capabilities of BGP.</li></ul>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Even with the caveats mentioned, hopefully this post will set some people on the path of learning and enjoying routing.   It&#8217;s been a long one, but I&#8217;ve enjoyed labbing it out.  </p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">1104</post-id>	</item>
		<item>
		<title>BBSing Retro-style with a Wimodem232 on a Mac SE</title>
		<link>https://blog.kroy.io/2021/01/14/bbsing-in-retro-style-with-a-wimodem232-on-a-mac-se/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=bbsing-in-retro-style-with-a-wimodem232-on-a-mac-se</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Fri, 15 Jan 2021 02:39:49 +0000</pubDate>
				<category><![CDATA[Retrolab]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=1036</guid>

					<description><![CDATA[There&#8217;s a simple reality that most people in 2021 probably don&#8217;t even have a concept of what a BBS (bulletin board system) is, but with my recent retro-lab musings, I&#8230;]]></description>
										<content:encoded><![CDATA[
<p>There&#8217;s a simple reality that most people in 2021 probably don&#8217;t even have a concept of what a BBS (bulletin board system) is, but with my recent <a rel="noreferrer noopener" href="https://blog.kroy.io/2020/11/19/scorched-earth-with-the-retro-lab/" data-type="post" data-id="954" target="_blank">retro-lab musings,</a> I discovered that BBSes are alive and well.</p>



<hr class="wp-block-separator"/>



<h2>Introduction</h2>



<p>A huge and defining part of my youth was trolling all the BBSes I could find.  At the time, there was no Internet, so BBSing was my window to the world.  It was basically the only place to find all the new shareware, images, door games, and more.  And later on, it even become possible to exchange messages with BBSes around the world through the use of FidoNet.</p>



<p>In any case, there was nothing more exciting than checking into your favorite BBS and playing a bit of TradeWars, or spotting the newest Commander Keen (4 to be specific), and waiting ALLLLL night for it to download.  Of course it was <em>ONLY</em> 600KB, but that took upwards of 6 hours to download.</p>



<figure class="wp-block-image size-large"><img width="759" height="569" src="https://blog.kroy.io/wp-content/uploads/2021/01/image.png" alt="" class="wp-image-1046" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image.png 759w, https://blog.kroy.io/wp-content/uploads/2021/01/image-300x225.png 300w, https://blog.kroy.io/wp-content/uploads/2021/01/image-300x225@2x.png 600w" sizes="(max-width: 759px) 100vw, 759px" /><figcaption>Commander Keen 4.  This image alone is 60% of the size of the actual game in kilobytes</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>&#8220;Dialing Up&#8221;</h2>



<p>Although I was casually aware that BBSes still existed via telnet, a <a href="https://www.reddit.com/r/VintageApple/comments/koo70p/new_mac_bbs_captains_quarters_ii/" data-type="URL" data-id="https://www.reddit.com/r/VintageApple/comments/koo70p/new_mac_bbs_captains_quarters_ii/">recent post</a> on Reddit&#8217;s <a rel="noreferrer noopener" href="https://reddit.com/r/VintageApple" target="_blank">r/VintageApple</a> subreddit really caught my eye. </p>



<p>It didn&#8217;t take much work to get my PowerMac 7200/75 connected via telnet to the Captain&#8217;s Quarters II, and I was immediately hooked!</p>



<figure class="wp-block-image size-large"><img width="1024" height="948" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-1-1024x948.png" alt="" class="wp-image-1047" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-1-1024x948.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/01/image-1-300x278.png 300w, https://blog.kroy.io/wp-content/uploads/2021/01/image-1.png 1337w, https://blog.kroy.io/wp-content/uploads/2021/01/image-1-300x278@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>glorious ansi color</figcaption></figure>



<p>Of course, that was only the beginning&#8230;</p>



<hr class="wp-block-separator"/>



<h2>Jacking In</h2>



<p>But this wasn&#8217;t enough.  In my original BBS days, i was using either some sort of all-in-one Monochrome Macintosh, or BananaCOM on MS-DOS something on an 8088 Acer, both with some 1200/14.4k/38.4k modems.  </p>



<p>As I&#8217;ve mentioned in the past, when I do something, I do it up big.  So I immediately knew I needed to get my Mac SE connecting to this BBS!</p>



<p>My first attempt was hooking together the Mac SE and PowerMac 7200 via a serial cable, and sharing the PowerMac&#8217;s Internet connection with IPNetRouter.  </p>



<p>Unfortunately, I was never able to get this working, though I did finally get an AppleTalk share set up between the two hosts.</p>



<figure class="wp-block-image size-large"><img width="997" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-3-997x1024.png" alt="" class="wp-image-1049" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-3-997x1024.png 997w, https://blog.kroy.io/wp-content/uploads/2021/01/image-3-292x300.png 292w, https://blog.kroy.io/wp-content/uploads/2021/01/image-3.png 1398w, https://blog.kroy.io/wp-content/uploads/2021/01/image-3-292x300@2x.png 584w" sizes="(max-width: 997px) 100vw, 997px" /><figcaption>Macintosh HD is coming from the PowerMac</figcaption></figure>



<p>But MacTCP failed me&#8230;</p>



<figure class="wp-block-image size-large"><img width="1024" height="766" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-2-1024x766.png" alt="" class="wp-image-1048" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-2-1024x766.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/01/image-2-300x224.png 300w, https://blog.kroy.io/wp-content/uploads/2021/01/image-2.png 1450w, https://blog.kroy.io/wp-content/uploads/2021/01/image-2-300x224@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>failure</figcaption></figure>



<p>I was starting to get a little disappointed, until I decided to get a &#8220;real&#8221; modem.</p>



<hr class="wp-block-separator"/>



<h2>A Real Modem</h2>



<p>Of course, anybody that follows tech knows that modems have been entirely obsolete for a very long time.  Even though I do have some old Mac modems somewhere, the simple fact is I don&#8217;t even have a phone line to plug them into, let alone a number to dial that would be valid in 2021.</p>



<p>That&#8217;s about when I discovered the WiModem232.</p>



<p>To make a long story short, it&#8217;s a device that connects via WiFi and acts like an actual Hayes compatible modem.  Of course, you don&#8217;t dial phone numbers, but in my case, telnet addresses. </p>



<p>It. Was. Perfect.  </p>



<p>I was smart, or so I thought, and ordered up a couple of cables.  One for <a href="https://amzn.to/38Mh33o" target="_blank" rel="noreferrer noopener">my Mac Fleet</a>, and one for my <a href="https://amzn.to/3nN9M7z" target="_blank" rel="noreferrer noopener">486 running DOS</a>.</p>



<p>It arrived quickly and did exactly what it promised to do.</p>



<figure class="wp-block-image size-large"><img width="761" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-5-761x1024.png" alt="" class="wp-image-1051" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-5-761x1024.png 761w, https://blog.kroy.io/wp-content/uploads/2021/01/image-5-223x300.png 223w, https://blog.kroy.io/wp-content/uploads/2021/01/image-5.png 1075w, https://blog.kroy.io/wp-content/uploads/2021/01/image-5-223x300@2x.png 446w" sizes="(max-width: 761px) 100vw, 761px" /><figcaption>connected</figcaption></figure>



<p>Unfortunately, the Mac cable took a few extra days to arrive, so I was forced to &#8220;slum&#8221; it on my 486 and Bananacom.  And Captain&#8217;s Quarters II looks and runs great there too:</p>



<figure class="wp-block-image size-large"><img width="755" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-6-755x1024.png" alt="" class="wp-image-1052" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-6-755x1024.png 755w, https://blog.kroy.io/wp-content/uploads/2021/01/image-6-221x300.png 221w, https://blog.kroy.io/wp-content/uploads/2021/01/image-6.png 810w, https://blog.kroy.io/wp-content/uploads/2021/01/image-6-221x300@2x.png 442w" sizes="(max-width: 755px) 100vw, 755px" /><figcaption>cqII bbs on bananacom</figcaption></figure>



<p>A few days later when the Mac cable arrived, I realized the horrible mistake I had made.</p>



<hr class="wp-block-separator"/>



<h2>The Mac SE goes Online</h2>



<p>The mistake, of course, was that the cable I ordered was for hooking up an ImageWriter printer, and not a modem.  But amazingly, in the never ending treat-bag of old Mac &#8220;stuffs&#8221;, I discovered I had a DIN8-&gt;DB25 cable for hooking up a modem.</p>



<p>It didn&#8217;t take long to hook it up, but unfortunately things were&#8230; not well.</p>



<figure class="wp-block-image size-large"><img width="871" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-7-871x1024.png" alt="" class="wp-image-1053" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-7-871x1024.png 871w, https://blog.kroy.io/wp-content/uploads/2021/01/image-7-255x300.png 255w, https://blog.kroy.io/wp-content/uploads/2021/01/image-7-1307x1536.png 1307w, https://blog.kroy.io/wp-content/uploads/2021/01/image-7.png 1340w, https://blog.kroy.io/wp-content/uploads/2021/01/image-7-255x300@2x.png 510w" sizes="(max-width: 871px) 100vw, 871px" /></figure>



<figure class="wp-block-image size-large"><img width="789" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-8-789x1024.png" alt="" class="wp-image-1054" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-8-789x1024.png 789w, https://blog.kroy.io/wp-content/uploads/2021/01/image-8-231x300.png 231w, https://blog.kroy.io/wp-content/uploads/2021/01/image-8.png 1004w, https://blog.kroy.io/wp-content/uploads/2021/01/image-8-231x300@2x.png 462w" sizes="(max-width: 789px) 100vw, 789px" /></figure>



<p>Fortunately, that was just due to the ANSI colors, which I was able to turn off with a simple checkbox in ZTerm</p>



<figure class="wp-block-image size-large"><img width="1024" height="982" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-9-1024x982.png" alt="" class="wp-image-1055" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-9-1024x982.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/01/image-9-300x288.png 300w, https://blog.kroy.io/wp-content/uploads/2021/01/image-9.png 1039w, https://blog.kroy.io/wp-content/uploads/2021/01/image-9-300x288@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>And everything looks great:</p>



<figure class="wp-block-image size-large"><img width="913" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-10-913x1024.png" alt="" class="wp-image-1056" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-10-913x1024.png 913w, https://blog.kroy.io/wp-content/uploads/2021/01/image-10-267x300.png 267w, https://blog.kroy.io/wp-content/uploads/2021/01/image-10.png 1016w, https://blog.kroy.io/wp-content/uploads/2021/01/image-10-267x300@2x.png 534w" sizes="(max-width: 913px) 100vw, 913px" /><figcaption>looking good</figcaption></figure>



<figure class="wp-block-image size-large"><img width="1024" height="954" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-11-1024x954.png" alt="" class="wp-image-1057" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-11-1024x954.png 1024w, https://blog.kroy.io/wp-content/uploads/2021/01/image-11-300x279.png 300w, https://blog.kroy.io/wp-content/uploads/2021/01/image-11.png 1338w, https://blog.kroy.io/wp-content/uploads/2021/01/image-11-300x279@2x.png 600w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>and better</figcaption></figure>



<p>And in attempting to download an old game, the memories of the dreaded &#8220;CRC Error&#8221; came flooding back to me:</p>



<figure class="wp-block-image size-large"><img width="792" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-12-792x1024.png" alt="" class="wp-image-1058" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-12-792x1024.png 792w, https://blog.kroy.io/wp-content/uploads/2021/01/image-12-232x300.png 232w, https://blog.kroy.io/wp-content/uploads/2021/01/image-12.png 1010w, https://blog.kroy.io/wp-content/uploads/2021/01/image-12-232x300@2x.png 464w" sizes="(max-width: 792px) 100vw, 792px" /><figcaption>CRC error</figcaption></figure>



<p>That&#8217;s what ZModem is for.  </p>



<p>What I discovered is that this old Mac isn&#8217;t particularly stable over the serial port going past 19,200.  Knocking down the baud rate made it download just fine (and slowly):</p>



<figure class="wp-block-image size-large"><img width="848" height="1024" src="https://blog.kroy.io/wp-content/uploads/2021/01/image-13-848x1024.png" alt="" class="wp-image-1059" srcset="https://blog.kroy.io/wp-content/uploads/2021/01/image-13-848x1024.png 848w, https://blog.kroy.io/wp-content/uploads/2021/01/image-13-248x300.png 248w, https://blog.kroy.io/wp-content/uploads/2021/01/image-13.png 1233w, https://blog.kroy.io/wp-content/uploads/2021/01/image-13-248x300@2x.png 496w" sizes="(max-width: 848px) 100vw, 848px" /><figcaption>downloading&#8230; sloooowly</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Of course, what&#8217;s the point here? </p>



<p>I can access Captain&#8217;s Quarters II and other BBSes just fine over telnet from my laptop or workstation.  And since I have a <a rel="noreferrer noopener" href="https://www.bigmessowires.com/floppy-emu/" target="_blank">Floppy EMU</a>, there&#8217;s obviously better ways to transfer files to the Mac SE.</p>



<p>For me, it&#8217;s the nostalgia.  Doing the things I used to do, on the hardware (or similarly enough) to the hardware I used to do it on.  I love this hardware and rediscovering BBSes has opened up a whole new world to me.  </p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">1036</post-id>	</item>
		<item>
		<title>VyOS from Scratch &#8211; BGP Announcement</title>
		<link>https://blog.kroy.io/2020/12/07/vyos-from-scratch-bgp-announcements/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=vyos-from-scratch-bgp-announcements</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 07 Dec 2020 15:45:00 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[bgp]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=1012</guid>

					<description><![CDATA[Something that comes up quite often is &#8220;how do I announce subnets&#8221;. This is when you own at least a /24 IPv4 or /48 in IPv6 (the minimum subnet sizes&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Something that comes up quite often is &#8220;how do I announce subnets&#8221;.  This is when you own at least a /24 IPv4 or /48 in IPv6 (the minimum subnet sizes that can be announced), and want to make it publicly accessible to the rest of the world.  In this edition, we&#8217;ll walk through the logistics of subnet announcement on a basic level.</p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Introduction</h2>



<p>On the Internet, you know you&#8217;ve made it when you have a subnet to announce.  </p>



<p>Either you paid an exorbitant  sum to buy one yourself, or are leasing/borrowing a subnet from a LIR/RIR (local or regional  Internet Registry), having your own subnet in your homelab is definitely a bit of a status symbol.  </p>



<p>Of course, once you have the subnet, what do you do with it?  You announce it with BGP of course!</p>



<hr class="wp-block-separator"/>



<h2>Announcement</h2>



<p>To put simply, announcement is you telling the world where and how to get to your subnet.  Whether you have an IPv4 subnet, IPv6, or both, the procedure is the identical.</p>



<p>If you&#8217;ve got some sort of business-class Internet, you just need to send your ISP the LOA (letter of authorization from your LIR/RIR), and they should begin announcing for you. </p>



<p>Now if you are just a regular homelab user with a conventional residential ISP, congrats!  You are just like me.  </p>



<p>A residential ISP won&#8217;t even talk to you, so you need to trackdown a VPS that will do your announcing for you.  </p>



<p>I prefer <a rel="noreferrer noopener" href="https://www.vultr.com/?ref=7273647" target="_blank">Vultr</a> (this is a referral link or click <a rel="noreferrer noopener" href="https://vultr.com/" target="_blank">HERE</a> for non-referral link).  For $5 a month, you can get a VPS that will have no problem announcing one or many subnets.</p>



<p>I&#8217;m also just going over basics here, as there are TONS of things that go into this to complicate it further.  As mentioned, announcing IPv6 subnets is identical to IPv4.  And different LIR/RIRs have different rules about what you are required to do with the subnet, like multi-homing.</p>



<hr class="wp-block-separator"/>



<h2>VPS Setup</h2>



<p>I don&#8217;t want to waste TOO much time on the non-BGPy parts of VPS.  But if you read my <a href="https://blog.kroy.io/2020/05/04/vyos-from-scratch-edition-1/" data-type="post" data-id="593" target="_blank" rel="noreferrer noopener">first article</a> on this, the basic setup is straightforward:</p>



<pre class="wp-block-code"><code>firewall {
    all-ping enable
    broadcast-ping disable
    config-trap disable
    ipv6-receive-redirects disable
    ipv6-src-route disable
    ip-src-route disable
    log-martians enable
    name WAN-LOCAL {
        rule 10 {
            action accept
            destination {
                port ssh
            }
            protocol tcp
            source {
                address homeIP/32
            }
        }
        rule 20 {
            action drop
        }
    }
    receive-redirects disable
    send-redirects enable
    source-validation disable
    state-policy {
        established {
            action accept
        }
        invalid {
            action drop
        }
        related {
            action accept
        }
    }
    syn-cookies enable
    twa-hazards-protection disable
}
interfaces {
    ethernet eth0 {
        address VultrPublicIP/23
        firewall {
            local {
                name WAN-LOCAL
            }
        }
    }
    loopback lo {
    }
    tunnel tun0 {
        address 172.27.114.1/30
        encapsulation gre
        local-ip VultrPublicIP
        remote-ip HomeIP
    } 
}

protocols {
    static {
        route 0.0.0.0/0 {
            next-hop VultrGateway {
            }
        }
    }
}
service {
    ssh {
        disable-password-authentication
        port 22
    }
}


system {
    config-management {
        commit-revisions 100
    }
    host-name vyos
    login {
        user kroy {
            authentication {
                public-keys kroy@home {
                    key ****************
                    type ssh-ed25519
                }
            }
        }
    }
    name-server 1.1.1.1
    name-server 1.0.0.1
    ntp {
        server 0.pool.ntp.org {
        }
        server 1.pool.ntp.org {
        }
        server 2.pool.ntp.org {
        }
    }
    syslog {
        global {
            facility all {
                level info
            }
            facility protocols {
                level debug
            }
        }
    }
}
</code></pre>



<p>Most of this should be fairly straightforward:</p>



<ol><li>A firewall to drop all packets, except for SSH from my home IP</li><li>My public ethernet setup for the VPS</li><li>A simple GRE tunnel to my Home IP.  This is where the BGP session is going to transit to actually contact the public servers on my homelab.</li><li>A static route to define the default route for the VPS.  Not strictly necessary since I&#8217;ll be BGP peering with Vultr, but it makes it easier to configure everything over SSH.</li><li>Making SSH accessible on port 22 and forcing key-auth.</li><li>Some system-y setup things.  System name-servers, key-based ssh auth, etc.</li></ol>



<hr class="wp-block-separator"/>



<h3>BGP</h3>



<p>The next step is to look up your BGP on Vultr.  After Vultr has accepted your LOA, you&#8217;ll have a new BGP tab in your VPS settings</p>



<figure class="wp-block-image size-large"><img width="895" height="528" src="https://blog.kroy.io/wp-content/uploads/2020/12/image-1.png" alt="" class="wp-image-1014" srcset="https://blog.kroy.io/wp-content/uploads/2020/12/image-1.png 895w, https://blog.kroy.io/wp-content/uploads/2020/12/image-1-300x177.png 300w, https://blog.kroy.io/wp-content/uploads/2020/12/image-1-768x453.png 768w" sizes="(max-width: 895px) 100vw, 895px" /><figcaption>vultr bgp config</figcaption></figure>



<p>These are basically all the things you&#8217;ll need to know to hook up a BGP session to Vultr.</p>



<hr class="wp-block-separator"/>



<blockquote class="wp-block-quote"><p>Throughout this document, I&#8217;m going to pretend to advertise 10.100.0.0/22, even though that&#8217;s a private subnet per RFC1918 and could never be advertised.</p><p>This is all for example and WILL NOT WORK if you try and do this for real.</p></blockquote>



<hr class="wp-block-separator"/>



<p>So what does this look like on the VPS in the <code>protocols bgp</code> config?  </p>



<p>The numbers like 64537 are what are known as ASNs, or Autonomous System Numbers.   In the real world, you&#8217;d get your own individual number that would tie the ASN to you or your company.</p>



<p>If you don&#8217;t have your own ASN, you&#8217;ll be using what are known as &#8220;Private ASN Numbers&#8221;, per RFC6996.  </p>



<p>For my example, I chose at random, while a few of them need to line up to what Vultr provided. </p>



<pre class="wp-block-code"><code>protocols {
    bgp 64537 {
        address-family {
            ipv4-unicast {
                aggregate-address 10.100.0.0/22 {
                }
            }
        }
        neighbor 169.254.169.254 {
            address-family {
                ipv4-unicast {
                    nexthop-self {
                        force
                    }
                    prefix-list {
                        import IPV4DENYALL
                    }
                    remove-private-as
                    route-map {
                        export V4-VULTR-ANNOUNCE
                    }
                }
            }
            ebgp-multihop 255
            local-as 64749 {
            }
            password a1s2d3f4
            remote-as 64515
        }
        parameters {
            router-id VultrPublicIP
        }
    }
</code></pre>



<p>As mentioned, a few of things items are just &#8220;fill in the dots&#8221; to create a session with Vultr.  The <code>ebgp-multihop</code> is just a number that must be &#8220;at most this many hops away&#8221;.  So as long as it&#8217;s <code>&gt;=2</code> that Vultr provided, 255 is fine.  </p>



<p>I chose to advertise a <code>/22</code> here for a reason.  This means I could have a <code>/24</code> from one location, and a <code>/23</code> from a different location, and advertise them both from a single spot.  </p>



<p>The <code>remove-private-as</code> will be important when we set up our connection to home.  Otherwise, Vultr will fail to accept our advertisement, because it sees an ASN in the path that it doesn&#8217;t recognize. </p>



<p>The <code>route-map</code> and <code>prefix-list</code> are part of being a good netizen and only accepting and advertising the prefixes you want.  There have been some MAJOR Internet outages because some network engineer messed up routes it was accepting or advertising somehow.  </p>



<hr class="wp-block-separator"/>



<h3>Route maps and Prefix lists</h3>



<p>It&#8217;s important to focus on what the route maps and prefix lists are doing here.  As mentioned, they control what your in and out announcements are going to be.  It&#8217;s worth noting that someone like Vultr probably won&#8217;t let you do anything too bad, it&#8217;s still good to learn how to set it up somewhat securely first.</p>



<pre class="wp-block-code"><code>policy {
    prefix-list IPV4DENYALL {
        rule 10 {
            action deny
            prefix 0.0.0.0/0
        }
    }
    prefix-list V4-VULTR {
        rule 10 {
            action permit
            prefix 10.100.0.0/22
        }
        rule 20 {
            action deny
            le 32
            prefix 0.0.0.0/0
        }
    }
    prefix-list VULTR {
        rule 10 {
            action permit
            prefix 10.100.0.0/24
        }
        rule 20 {
            action deny
            prefix 0.0.0.0/0
        }
    }
    route-map V4-VULTR {
        rule 10 {
            action permit
            match {
                ip {
                    address {
                        prefix-list V4-VULTR
                    }
                }
            }
        }
    }
}
</code></pre>



<p>Where these are positioned in relation to the <code>export/import</code> in the peer config above, control what happens.  So in this case we want to:</p>



<ol><li>IPV4DenyAll: ignore anything from Vultr.  You can tell them to give you full tables, but unless you have an instance with slightly more RAM, full tables would probably be a bit too much for this VPS.  This would basically be the routes for EVERY network on the Internet.</li><li>VULTR Route maps and prefix lists: Advertise ONLY the subnet we want.  This is for when you want to advertise different subnets to different peers.  It also stops you from leaking your routes in case of a misconfiguration somewhere.  </li></ol>



<p>Now in <code>op-mode</code>, showing the BGP neighbors should give you a bunch of information:</p>



<pre class="wp-block-code"><code>admin@vyos:~$ show ip bgp neighbors 169.254.169.254 </code></pre>



<figure class="wp-block-image size-large"><img width="438" height="223" src="https://blog.kroy.io/wp-content/uploads/2020/12/image-2.png" alt="" class="wp-image-1015" srcset="https://blog.kroy.io/wp-content/uploads/2020/12/image-2.png 438w, https://blog.kroy.io/wp-content/uploads/2020/12/image-2-300x153.png 300w" sizes="(max-width: 438px) 100vw, 438px" /></figure>



<p>and you should see the subnet being advertised:</p>



<pre class="wp-block-code"><code>admin@vyos:~$ show ip bgp neighbors 169.254.169.254 advertised-routes 
BGP table version is 7, local router ID is 45.xx.xx.xx, vrf id 0
Default local pref 100, local AS 64537
Status codes:  s suppressed, d damped, h history, * valid, > best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
*> 10.100.0.0/24   0.0.0.0                       100      0 i

Total number of prefixes 1
</code></pre>



<hr class="wp-block-separator"/>



<h2>BGP at Home</h2>



<p>The final bit of this puzzle is completing the BGP session to your home, and getting up some hosts:</p>



<p>We can add another neighbor, which uses the opposite end of the GRE tunnel for the BGP peer.  Still on the VPS:</p>



<pre class="wp-block-code"><code>protocols {
    bgp 64537 {
        neighbor 172.27.114.2 {
            address-family {
                ipv4-unicast {
                    prefix-list {
                        export IPV4DENYALL
                    }
                    route-map {
                        import V4-VULTR
                    }
                    soft-reconfiguration {
                        inbound
                    }
                }
            }
            remote-as 64537
        }
        
    }
}
</code></pre>



<p>Note that there are a few important things going on here:</p>



<ol><li>The <code>export/import</code> are reversed, so I can reuse the same policies.   That means, I want to make sure I&#8217;m importing only the subnet I want from home, and not exporting anything. </li><li>The <code>soft-reconfiguration inbound</code>.  This is the statement that tells VyOS to accept the routes that the home server is advertising.</li><li>The <code>bgp 64537</code> and <code>remote-as 64537</code> are the same.  This triggers the use of IBGP instead of EBGP (internal vs external).  This becomes important as you add more hosts and want to advertise from more locations, but is beyond the scope of this post.</li></ol>



<p>At this point, all the prep work on the VPS should be done, and once the home router is configured, you should be advertising your subnet.</p>



<hr class="wp-block-separator"/>



<h3>Home</h3>



<p>At home, the first thing is to get the GRE tunnel working.  You can use almost any transport, like WireGuard or an L3 OpenVPN, but for advertising a simple subnet, GRE is about as easy as it gets, plus it avoids some potential MTU shenanigans.  </p>



<p>You might need to add appropriate firewall rules:</p>



<pre class="wp-block-code"><code>WAN->LOCAL firewall:

 rule 2 {
     action accept
     description "GRE to VPS"
     protocol gre
     source {
         address VultrPublicIP
     }
     state {
         invalid enable
         new enable
     }
 }
 
interfaces:
tunnel tun2 {
     address 172.27.114.2/30
     description vultr-gre
     encapsulation gre
     local-ip HomePublicIP
     multicast disable
     remote-ip VultrPublicIP
 }
</code></pre>



<p>Depending on your firewall config, you might want to drop (in my case) <code>tun2</code> in the appropriate zone, Barring any issues, pinging to the other end of the tunnel should immediately start working:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="486" height="163" src="https://blog.kroy.io/wp-content/uploads/2020/12/image-3.png" alt="" class="wp-image-1016" srcset="https://blog.kroy.io/wp-content/uploads/2020/12/image-3.png 486w, https://blog.kroy.io/wp-content/uploads/2020/12/image-3-300x101.png 300w" sizes="(max-width: 486px) 100vw, 486px" /><figcaption>home is 172.27.114.2, vps is 172.27.114.1</figcaption></figure></div>



<h3>Home Config</h3>



<p>Now there are a number of different directions one can take for advertising the subnet from your home to the VPS.  OSPF, static routes, or my favorite, BGP.  </p>



<p>For just running a simple subnet out of your home, you&#8217;ll want to assign an IP in that subnet to your home VyOS install.  In my case, I assign it to a vlan, but you could assign it to a separate interface like <code>eth4</code>:</p>



<pre class="wp-block-code"><code>admin@edge# show interfaces ethernet eth0 vif 146
 address 10.100.0.1/24
 policy {
     route VULTRSTUFF
 }</code></pre>



<p>Now, anything on that VLAN that gets assigned a <code>10.100.0.0/24</code> address can use <code>10.100.0.1</code> for its gateway and have access on the advertised subnet (once we set up BGP at home).</p>



<p>You&#8217;ll also note I have a policy route here.  This is to ensure that the traffic doesn&#8217;t leak out my WAN, which will result in an asymmetric routing situation where my advertised subnet doesn&#8217;t work.</p>



<p>Policy based routing sets up rules that say: &#8220;Take any traffic that matches these rules, and put them in different routing tables to ensure they can&#8217;t go out the wrong interface&#8221;.</p>



<pre class="wp-block-code"><code>policy route VULTRSTUFF {
    rule 9 {
        destination {
            group {
                network-group PRIVATE-NETWORKS
            }
        }
        set {
            table main
        }
        source {
            address 10.100.0.0/24
        }
    }
    rule 10 {
        set {
            table 146
        }
        source {
            address 10.100.0.0/24
        }
    }
    rule 20 {
        destination {
            address 10.100.0.0/24
        }
        set {
            table 146
        }
    }
}
</code></pre>



<p>So with above:</p>



<ol><li>Rule 9:  Any traffic from our announced subnet trying to get to the local private networks, put back in the main routing table.  This is so my announced hosts can access my LAN.  This is known as &#8220;leaking routes&#8221;.</li><li>Take any traffic from my announced subnet and put it in a different table.  The number is arbitrary but in this case <code>146</code>.</li><li>Take any traffic destined TO my announced subnet to put it in the different table.  Again <code>146</code>.</li></ol>



<p>Now that we have traffic in a separate routing table, we need to have a way for the traffic to actually go somewhere useful, namely, our GRE tunnel:</p>



<pre class="wp-block-code"><code>protocols static table 146 {
     interface-route 0.0.0.0/0 {
         next-hop-interface tun2 {
         }
     }
 }</code></pre>



<p>This just tells VyOS to put ALL traffic on table <code>146</code> over the <code>tun2</code> interface, which is the GRE connection to the VPS.  With a recent version of rolling VyOS, this can all be done with some VRF antics as well. </p>



<h3>BGP</h3>



<p>The final piece of this puzzle is setting up BGP on the server at home.  It looks much like the setup on the VPS, just with the opposite neighbor address and reversed route/prefixes, so we are accepting none, and only advertising the appropriate subnet.  This is important because you won&#8217;t always have control of both ends of the BGP link, so you don&#8217;t want to trust someone else&#8217;s work.</p>



<pre class="wp-block-code"><code> bgp 64537 {
     address-family {
         ipv4-unicast {
             network 10.100.1.0/24 {
             }
         }
     }
  neighbor 172.27.114.1 {
         address-family {
             ipv4-unicast {
                 prefix-list {
                     import DENY-ALL-V4 
                 }
                 route-map {
                     export V4-VULTR
                 }
                 route-server-client
             }
         }
         remote-as 64537
         update-source 172.27.112.2
     }
}</code></pre>



<p>As before, we are using IBGP (the 64537 matches both locally and the remote), denying any incoming advertisements, and only allowing our outgoing advertisement:</p>



<pre class="wp-block-code"><code>admin@homeserver# show policy 
 prefix-list DENY-ALL-V4 {
     rule 10 {
         action deny
         le 32
         prefix 0.0.0.0/0
     }
 }
 prefix-list V4-VULTR {
     rule 10 {
         action permit
         prefix 10.100.0.0/24
     }
     rule 20 {
         action deny
         le 32
         prefix 0.0.0.0/0
     }
 }</code></pre>



<p>It&#8217;s also important to note, this server is only advertising <code>10.100.0.0/24</code>.  Meaning you could advertise <code>10.100.1-3.0/24</code> on other hosts or locations, and aggregate at the VPS.   </p>



<p>Once complete, the BGP session should pop up and you should see via <code>advertised-routes</code>:</p>



<pre class="wp-block-code"><code>admin@homeserver:~$ show ip bgp neighbors 172.27.114.1 advertised-routes 
BGP table version is 19601, local router ID is 10.0.20.254, vrf id 0
Default local pref 100, local AS 64537
Status codes:  s suppressed, d damped, h history, * valid, > best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
*> 10.100.0.0/24   0.0.0.0                  0    100  32768 i

Total number of prefixes 1
admin@edge:~$ 
</code></pre>



<p>and on the VPS via <code>received-routes</code> and the <code>show ip route bgp</code></p>



<pre class="wp-block-code"><code>admin@vps:~$ show ip bgp neighbors 172.27.114.2 received-routes 
BGP table version is 0, local router ID is 45.x.x.x.x, vrf id 0
Default local pref 100, local AS 64537
Status codes:  s suppressed, d damped, h history, * valid, > best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
*> 10.100.0.0/24   172.27.114.2             0    100      0 i

Total number of prefixes 1


admin@vps:~$ show ip route bgp 
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, D - SHARP,
       F - PBR, f - OpenFabric,
       > - selected route, * - FIB route, q - queued route, r - rejected route

B>* 10.100.1.0/24 &#091;200/0] via 172.27.114.2, tun0, 2d03h42m</code></pre>



<p>Once all this happens, your subnet should be available from the external world!  At this point you can assign a static host on like <code>10.100.1.100/24</code>, or set up DHCP for that subnet.  </p>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Of course this is VERY quick and dirty. There is plenty of room for improvement, and more importantly, needing things like appropriate firewalls, and potentially more routing.</p>



<p>So where do you go from here?  Of course you don&#8217;t have to use BGP just for announcing a subnet.  You could just it just for distributing private subnets dynamically locally or across geographically diverse sites.  Much of the BGP that happens on my local network, doesn&#8217;t even leave my edge.  </p>



<p>Hopefully this write-up gave you a good head start though.</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">1012</post-id>	</item>
		<item>
		<title>Scorched Earth with the Retro Lab</title>
		<link>https://blog.kroy.io/2020/11/19/scorched-earth-with-the-retro-lab/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=scorched-earth-with-the-retro-lab</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Thu, 19 Nov 2020 18:39:46 +0000</pubDate>
				<category><![CDATA[Retrolab]]></category>
		<category><![CDATA[dos]]></category>
		<category><![CDATA[mac]]></category>
		<category><![CDATA[vintage]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=954</guid>

					<description><![CDATA[Recently, I got into retro labbing. Like everything else, I&#8217;ve probably gone a bit overboard&#8230; Introduction It&#8217;s safe to say that I&#8217;ve gotten extremely nostalgic for some of the computers&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Recently, I got into retro labbing.  Like everything else, I&#8217;ve probably gone a bit overboard&#8230;</p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Introduction</h2>



<p>It&#8217;s safe to say that I&#8217;ve gotten extremely nostalgic for some of the computers of my youth.  Old macs, 486s, and all the games from that time period constantly itched at the back of my head.  </p>



<p>Sure, you can emulate this stuff, but it&#8217;s just not the same.  Especially on a modern 4K screen, you end up looking at a game/emulator/etc that is like 3 inches tall.  And if you try to upscale it, it just doesn&#8217;t look right.  </p>



<p>There&#8217;s also something to be said about a computer where you can&#8217;t just flip away to a web browser, Discord, or other distractions.  </p>



<hr class="wp-block-separator"/>



<h2>The Beginning</h2>



<p>Like so many other things, this all started on YouTube.  I found myself watching a ton of retro YouTubers like <a rel="noreferrer noopener" href="https://www.youtube.com/channel/UCLx053rWZxCiYWsBETgdKrQ" target="_blank">LGR</a> and <a rel="noreferrer noopener" href="https://www.youtube.com/channel/UC8uT9cgJorJPWu7ITLGo9Ww" target="_blank">the 8-Bit Guy</a>. It didn&#8217;t take too long for the nostalgia to kick in hard, and I rearranged my office, and made a trip to the local Goodwill.  </p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0413-1024x768.jpg" alt="" class="wp-image-955" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0413-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0413-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0413-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0413-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0413-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>the first goodwill haul</figcaption></figure>



<p>Unfortunately, I&#8217;m probably a few years too late for the kind of gear I&#8217;m looking for.  All I was able to find was a PS/2 keyboard and mouse, a 4&#215;3 LCD, and a fancy old power &#8220;strip&#8221; to fit the retro theme.</p>



<p>That&#8217;s when I remembered &#8220;the pile&#8221;.  A stack of old computer stuff (mainly Macs), at my parent&#8217;s house.  </p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0411-768x1024.jpg" alt="the mac pile" class="wp-image-957" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0411-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0411-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0411-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0411-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0411-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>the mac pile</figcaption></figure>



<p>So over the course of a few weeks, I brought home almost a dozen different machines.  Unfortunately, these Macs have had a long hard life, and I was lucky to put together a few working machines from the parts of all.  Some had dead PSUs, others had corroded logic boards from batteries/caps.  Some the CD/Floppy drives were dead in various manners.</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0431-1024x768.jpg" alt="" class="wp-image-959" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0431-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0431-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0431-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0431-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0431-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>some performa 6400s</figcaption></figure>



<p>The holy grail of the haul was a 17&#8243; Trinitron Monitor.  It even has the old style BNC connections that I&#8217;ll never use:</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0454-1024x768.jpg" alt="" class="wp-image-958" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0454-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0454-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0454-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0454-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0454-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>back of Trinitron</figcaption></figure>



<p>In the end, the haul from the parents house resulted in:</p>



<ul><li>The 17&#8243; Sony Trinitron Monitor</li><li>512K Mac</li><li>One working Performa 6400/180</li><li>One working Power Macintosh 6400/75</li><li>A Mac SE (the pictured Mac Classic was ruined due to leaky caps)</li><li>An array of parts like serial mice (important for the 486 later), IDE DVD Drive, random PCI cards like a Realtek 8139</li></ul>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0414-1024x768.jpg" alt="" class="wp-image-960" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0414-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0414-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0414-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0414-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0414-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>the initial haul</figcaption></figure>



<h2>Mac Land</h2>



<p>Of course, dealing with old hard drives and floppy drives is a horrible experience, so there were a number of things to make it easier (where I could).  The Macs that have SCSI are a bit more of a pain.</p>



<ul><li><a rel="noreferrer noopener" href="https://amzn.to/36TDC3E" target="_blank">SD Card to IDE adapter</a>.  In the 6400/180.</li><li><a rel="noreferrer noopener" href="https://amzn.to/38WQhpj" target="_blank">Gotek USB Floppy Emulator</a>.  Can&#8217;t be used on the Macs, but for later use.</li><li><a rel="noreferrer noopener" href="https://amzn.to/36UbKMS" target="_blank">IDE to SATA adapter</a> and a $10 cheapo <a rel="noreferrer noopener" href="https://amzn.to/2KpraBp" target="_blank">SSD</a>.  I bought this just in case the SD card didn&#8217;t perform as well as I would have liked.</li><li>A <a rel="noreferrer noopener" href="https://amzn.to/331Qtjj" target="_blank">fancy VGA+Sound switcher</a>.  Not quite as good as an actual KVM switch, but it works great.</li><li>A wide array of cables, adapters, and more.</li></ul>



<p>After getting the 6400 75 and 180 going, I immediately played a few games I loved:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0459-768x1024.jpg" alt="" class="wp-image-961" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0459-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0459-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0459-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0459-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0459-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>simcity 2000</figcaption></figure>



<h3>512K Blues</h3>



<p>Of course, the REALLY old Macs were the ones I wanted.  The 512K in particular was one of my very first computers, and there were a number of games I was itching to play again on that natively.  As mentioned, the Classic II I had was dead from leaky capacitors, so I was on a quest to make the 512K boot.</p>



<p>Unfortunately there was a problem.  The initial rendition of the 512K only supported 400K disks, and you can&#8217;t just turn a double sided high density density into a standard density disk that the 512K can read.   So it was off to BMOW and grabbed one of their <a href="https://www.bigmessowires.com/floppy-emu/">Floppy Emulators</a> for Mac.</p>



<p>As usual, Murphy&#8217;s Law kicked in, and I realized the 512K Mac wasn&#8217;t able to boot from &#8220;HD20&#8221; hard drive images that the Floppy Emulator can support.  But I was in luck, and my Grandpa saved the day. </p>



<p>You see, years ago after he passed, I adopted a box of his random stuff.  And in this box, there were a number of old standard density disks.  So with my Floppy Emulator and one of those random disks, I was able to make an &#8220;HD20&#8221; boot disk.  This basically just allowed the 512K to boot from a floppy and bootstrap into a disk image from the Floppy Emulator.</p>



<figure class="wp-block-image size-large is-resized"><img src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0528-1024x768.jpg" alt="" class="wp-image-962" width="775" height="581" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0528-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0528-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0528-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0528-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0528-2048x1536.jpg 2048w" sizes="(max-width: 775px) 100vw, 775px" /><figcaption>grandpa to the rescue</figcaption></figure>



<h4>Success!!!</h4>



<p>One of the very first games I ever remembered playing was Transylvania on a 512K Mac.  And with the help of Grandpa&#8217;s disk, a hard drive shared out from the Floppy Emu, I was playing Transylvania on a Mac again!</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0471-768x1024.jpg" alt="" class="wp-image-963" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0471-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0471-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0471-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0471-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0471-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>transylvania</figcaption></figure>



<p>Again, Murphy&#8217;s Law kicked in, as this solution was unsustainable.  All the standard density disks that were in Grandpa&#8217;s box were ancient.  I was lucky to get one boot per 5 attempts.  So after a bit of research, I discovered I could replace the ROM chips in the 512K, and it would boot from the HD20 virtual disk image without the boot floppy.</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0506-1024x768.jpg" alt="" class="wp-image-964" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0506-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0506-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0506-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0506-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0506-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>replacing the rom chips</figcaption></figure>



<h3>Mac SE</h3>



<p>Of course, about 18 hours after ordering the replacement ROM chips, I discovered a Mac SE.  Marginally better specs, doesn&#8217;t need any hacking to boot from hard disk images on the Floppy Emu.  The only thing it need was replacing the soldered barrel battery with a button battery:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0492-768x1024.jpg" alt="" class="wp-image-966" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0492-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0492-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0492-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0492-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0492-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>soldering coin battery holder</figcaption></figure>



<p>Using Mini vMac and hooking up the SD card from the floppy emu can help with some initial setup (ignore the SE30 name, didn&#8217;t look at the box when I named the disk)</p>



<figure class="wp-block-image size-large"><img width="667" height="561" src="https://blog.kroy.io/wp-content/uploads/2020/11/unknown.png" alt="" class="wp-image-993" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/unknown.png 667w, https://blog.kroy.io/wp-content/uploads/2020/11/unknown-300x252.png 300w" sizes="(max-width: 667px) 100vw, 667px" /><figcaption>mini vmac</figcaption></figure>



<p>Look ma, no disks!</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0526-768x1024.jpg" alt="" class="wp-image-967" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0526-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0526-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0526-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0526-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0526-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>Mac SE with Floppy Emu</figcaption></figure>



<h2></h2>



<p>Being the banker almost feels like cheating&#8230; but I made it, and only one person died!</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/image0-768x1024.jpg" alt="" class="wp-image-992" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image0-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/image0-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/image0-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/image0-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/image0-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>the Oregon Trail</figcaption></figure>



<p>Unfortunately, the itch was only slightly scratched&#8230;</p>



<hr class="wp-block-separator"/>



<h2>The PC Conversion</h2>



<p>By far, my most nostalgic gaming years were the 80s/90s/00s.  In particular, Classic Sierra and Lucasarts Adventure games are something I adore, and I still didn&#8217;t have a solution for that.  So it was off to eBay for something that I could run old DOS games one.</p>



<h3>The Micron</h3>



<p>The end result was an old Micron tower, with a SE440BX2, PIII 500 MHz, 256MB of RAM, nice video card, and onboard Yamaha audio. The Micron didn&#8217;t come with a drive, so I dropped in my IDE-&gt;SSD adapter. MAN is that FAST.</p>



<figure class="wp-block-image size-large"><img width="1024" height="647" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0473-1024x647.jpg" alt="" class="wp-image-968" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0473-1024x647.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0473-300x190.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0473-768x485.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0473-1536x970.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0473-2048x1294.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>lab midstate with Micron pictured</figcaption></figure>



<p>I initially had Windows 98 installed (now it&#8217;s XP), and was able to play some old classics, like Leisure Suit Larry 1 VGA Edition.</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0457-1024x768.jpg" alt="" class="wp-image-970" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0457-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0457-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0457-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0457-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0457-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>can we get some of those lubbers?</figcaption></figure>



<p>In this image you can see the ugliness of the stock Gotek Floppy Emulator.  More on upgrading this later:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0432-768x1024.jpg" alt="" class="wp-image-972" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0432-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0432-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0432-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0432-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0432-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>floppy emulator</figcaption></figure>



<p>Discord on Windows XP?  Absolutely!!</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0523.heic-1024x768.jpg" alt="" class="wp-image-996" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0523.heic-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0523.heic-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0523.heic-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0523.heic-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0523.heic-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>This is also where I learned the hard lesson of speed-sensitive games, and the mess that old sound cards are.  A lot of the games I wanted to play just didn&#8217;t work, or sounded terrible. So after a bunch more research, it was back to eBay.</p>



<hr class="wp-block-separator"/>



<h3>The Holy Grail</h3>



<p>After a few days of search, I was able to find what, for me, was the holy grail:</p>



<ul><li>A motherboard with a button cell battery.   No leaky barrel batteries allowed!</li><li>Came with a 486dx2.  Fast enough for everything I wanted to play from that era.  Anything else can be done on the Micron.</li><li>Motherboard was full of cache</li><li>Came with some RAM, though I ditched that and upgraded to a whopping 32MB</li><li>PCI and ISA</li></ul>



<p>Because the board came with PCI, I was able to reuse an old S3 Virge Graphics card, and Realtek 8139 card I found at my parents.  </p>



<p>Plus, I found a pre-ATX 1.2 PSU, which supports -5 volts, which some ISA require.  It might not be strictly required and I&#8217;ll probably upgrade it with a modern ATX PSU at a later date. I also just used my old Fractal R5 case that was leftover from other projects.</p>



<p>Not to mention an array of adapters and cables, like a <a rel="noreferrer noopener" href="https://amzn.to/35JTXbP" target="_blank">20 pin ATX to AT </a>cable, <a rel="noreferrer noopener" href="https://amzn.to/3nCBPa7" target="_blank">a CF-&gt;IDE adapter</a>,  a <a rel="noreferrer noopener" href="https://amzn.to/2UFFRBY" target="_blank">PC Speaker</a> (gotta have that sweet tingy sound in some games), some power splitters, and and array of other cables and adapters (a 3.5-&gt;5.25 bay adapter for example).  </p>



<p>The motherboard arrived like a month later (it came from Ukraine), and it was everything I wanted in more.  As a super bonus, from the BIOS, the cache can be disabled, which makes sound like in Indy256 work, and I can even play super speed sensitive games.</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0474-1024x768.jpg" alt="" class="wp-image-974" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0474-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0474-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0474-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0474-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0474-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>486</figcaption></figure>



<p>The assembly was easy, but not very pretty.  All those converters, splitters, and ribbon cables are hell:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0477-768x1024.jpg" alt="" class="wp-image-975" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0477-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0477-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0477-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0477-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0477-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>cablemess</figcaption></figure>



<h3>The Gotek</h3>



<p>This is also when I took the opportunity to flash my Gotek with the <a rel="noreferrer noopener" href="https://github.com/keirf/FlashFloppy" target="_blank">FlashFloppy firmware</a>.  It requires VERY minimal soldering (soldering <a rel="noreferrer noopener" href="https://amzn.to/35IrhQH" target="_blank">header pins</a>, and <a rel="noreferrer noopener" href="https://amzn.to/2UJQjIJ" target="_blank">jumpers</a>), and a <a href="https://amzn.to/331Rubf">USB-A to USB-A</a> cable.  And with a <a rel="noreferrer noopener" href="https://amzn.to/2UHkfFr" target="_blank">cheap OLED screen</a> (soldering a few more header pins and some jumpers), you can have something that&#8217;s INFINITELY more usable.</p>



<p>You just create a fat32 USB stick and drop floppy images on it, or create a floppy as below.  My motherboard BIOS supports 2.88MB disks:</p>



<pre class="wp-block-code"><code>cp rtl8139.img /media/kroy/GOTEK/Drivers/</code></pre>



<p>or</p>



<pre class="wp-block-code"><code>mkfs.msdos -C TRANSFER288.img 2880
sudo mount /media/kroy/GOTEK/TRANSFER/TRANSFER288.img /mnt/disk
cp files /mnt/disk</code></pre>



<figure class="wp-block-image size-large"><img width="1024" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-1024x1024.jpg" alt="" class="wp-image-976" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-1024x1024.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-300x300.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-150x150.jpg 150w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-768x768.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-1536x1536.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0520-2048x2048.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>gotek</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>The 486</h2>



<p>It didn&#8217;t take long for me to track down everything I needed to start installing my system. I chose MS-DOS 7.1, because I had an 8GB CF card and wanted to be able to use it all:</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0478.heic-1024x768.jpg" alt="" class="wp-image-978" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0478.heic-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0478.heic-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0478.heic-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0478.heic-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0478.heic-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>dos7.1</figcaption></figure>



<p>And with QEMMU, I&#8217;m able to get 631K of conventional memory with mouse, DVD, and other drivers all loaded, something 90s me could only dream of:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0480.heic-768x1024.jpg" alt="" class="wp-image-979" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0480.heic-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0480.heic-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0480.heic-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0480.heic-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0480.heic-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /></figure>



<p>Getting on IRC from a 486dx2 and MS-DOS:</p>



<figure class="wp-block-image size-large"><img width="804" height="1022" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-10.png" alt="" class="wp-image-1001" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-10.png 804w, https://blog.kroy.io/wp-content/uploads/2020/11/image-10-236x300.png 236w, https://blog.kroy.io/wp-content/uploads/2020/11/image-10-768x976.png 768w" sizes="(max-width: 804px) 100vw, 804px" /></figure>



<p>and running the disk test.  I love the flatline of the hard drive graph:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0501.heic-768x1024.jpg" alt="" class="wp-image-981" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0501.heic-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0501.heic-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0501.heic-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0501.heic-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0501.heic-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>flatlined disk</figcaption></figure>



<h3>Windows 95</h3>



<p>And because of the CF card, it&#8217;s easy to swap out and install Windows 95.</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0503-768x1024.jpg" alt="" class="wp-image-982" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0503-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0503-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0503-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0503-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0503-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>win95 setup</figcaption></figure>



<p>You know it&#8217;s been a long time when TCP/IP isn&#8217;t installed by default:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0504-768x1024.jpg" alt="" class="wp-image-983" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0504-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0504-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0504-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0504-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0504-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>wot no TCP/IP??</figcaption></figure>



<p>Can you imagine a game in 2020 telling you to do this?</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0499.heic-768x1024.jpg" alt="" class="wp-image-984" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0499.heic-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0499.heic-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0499.heic-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0499.heic-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0499.heic-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /></figure>



<p>Or reminding you that the CD needs to go in &#8220;shiney&#8221; side down (does anybody even know what a CD is in 2020??):</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0524.heic-1024x768.jpg" alt="" class="wp-image-985" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0524.heic-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0524.heic-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0524.heic-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0524.heic-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0524.heic-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>shiney side down</figcaption></figure>



<p>and revisiting Transylvania, the DOS version, in full CGA bliss:</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0507.heic-768x1024.jpg" alt="" class="wp-image-986" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0507.heic-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0507.heic-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0507.heic-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0507.heic-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0507.heic-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>the princess</figcaption></figure>



<h3>The Sound Conundrum</h3>



<p>As mentioned, sounds on DOS are&#8230; interesting.  It didn&#8217;t take me long to realize&#8230; I NEEDED MIDI!!</p>



<p>Back in the last 80s/early 90s, MIDI was the stuff of legends for most people.  Without it, most games just sounded sort of <em>meh</em>.  Soundblasters and compatibles were okay, but not the best.</p>



<p>When I started this process, I had an old S3 PCI soundcard.  It was just terrible on DOS.  So I ordered an ESS1868, which according to Vogons, wasn&#8217;t terrible, especially for the price. </p>



<p>This was fine.  Until I heard the <a rel="noreferrer noopener" href="https://www.youtube.com/watch?v=a324ykKV-7Y" target="_blank">Monkey Island Intro on MIDI</a>&#8230;. life changed.  Sure, the CD Audio version is &#8220;better&#8221;, but there&#8217;s a charm to midi version.  So it was back to eBay for an SC-55 and a card that has a proper MPU-401 out.  I landed on some ISA Yamaha thing, I think an Audician 32 clone, that sounds great.  And somehow in the pile at my parent&#8217;s house, I found a gameport-&gt;5PIN Midi cable.  Who the heck knows why I had that.  At best I probably hooked up an old time electronic keyboard to a soundcard.</p>



<p>With the MIDI hooked up, all I can say is WOW.  WHY DIDN&#8217;T I DO THIS EARLIER!?!? Especially when coupled with an old Technics amp I inherited from gramps (who knew he would be so helpful in this retro build!)</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0518-1024x768.jpg" alt="" class="wp-image-987" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0518-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0518-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0518-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0518-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0518-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>Roland + Technics</figcaption></figure>



<p>Of course, it&#8217;s not exactly perfect.  There are some major changes in the sound between an MT-32 and an SC-55.  But I&#8217;m not exactly ready to give up a kidney for an MT-32 yet, and slightly newer games that can use general midi/SC, sound AMAZING.</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0525.heic-1024x768.jpg" alt="" class="wp-image-988" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0525.heic-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0525.heic-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0525.heic-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0525.heic-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0525.heic-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>WC2 and &#8220;Timpani&#8221;</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Here is the &#8220;final&#8221; retrolab for now.  I say final in quotes, because things are always evolving.  I think I want to upgrade the Micron to 768MB of RAM and a faster processor.  </p>



<ul><li>Mac SE + Floppy Emu</li><li>Power Macintosh 7200/75 with stock everything</li><li>Performa 6400/180, drive replaced with IDE->SD, has ATI PCI Graphics and PCI 10/100 Networking</li><li>Micron PIII 500Mhz, running on IDE->SSD</li><li>486DX2 66, 32MB of RAM,  S3 Virge Graphics, RT8139 networking, Yamaha ISA sound card, IDE->CF card for storage, flashed Gotek for floppy disks.</li></ul>



<p>I did pick up a serial/PS2 Intellimouse that I&#8217;m still not sure if I want to open, since it&#8217;s sealed and new-in-box.  </p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0527.heic-1024x768.jpg" alt="" class="wp-image-990" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0527.heic-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0527.heic-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0527.heic-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0527.heic-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0527.heic-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>&#8220;final&#8221; lab</figcaption></figure>



<p>In all, this has become a new passion for me.  And thanks to some foresight of my parents, I didn&#8217;t end up spending too much.</p>



<figure class="wp-block-image size-large"><img width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0508.heic-768x1024.jpg" alt="" class="wp-image-991" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0508.heic-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0508.heic-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0508.heic-1152x1536.jpg 1152w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0508.heic-1536x2048.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/IMG_0508.heic-scaled.jpg 1920w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>The End</figcaption></figure>



<p></p>



<p></p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">954</post-id>	</item>
		<item>
		<title>ESXi to Libvirt, now with more Terraform.</title>
		<link>https://blog.kroy.io/2020/11/03/esxi-to-libvirt-now-with-more-terraform/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=esxi-to-libvirt-now-with-more-terraform</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Tue, 03 Nov 2020 14:59:57 +0000</pubDate>
				<category><![CDATA[Automation]]></category>
		<category><![CDATA[KVM]]></category>
		<category><![CDATA[Terraform]]></category>
		<category><![CDATA[Ubuntu]]></category>
		<category><![CDATA[Virtualization]]></category>
		<category><![CDATA[ansible]]></category>
		<category><![CDATA[kvm]]></category>
		<category><![CDATA[migration]]></category>
		<category><![CDATA[terraform]]></category>
		<category><![CDATA[vmware]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=894</guid>

					<description><![CDATA[Over the years, my homelab has expanded and contracted multiple times. As I am heavy into automation now and downsizing a bit, it was time to fully ditch VMWare. Introduction&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Over the years, my homelab has expanded and contracted multiple times.  As I am heavy into automation now and downsizing a bit, it was time to fully ditch VMWare.</p>



<hr class="wp-block-separator"/>





<h2>Introduction</h2>



<p>For some reason, it seems I am never happy with my lab.  For years now, I&#8217;ve constantly tore it up, started from scratch, migrated, <a rel="noreferrer noopener" href="https://blog.kroy.io/2017/06/30/migrating-the-lab-back-to-esxi-after-a-proxmox-experiment/" data-type="post" data-id="23" target="_blank">migrated back</a>, and more.  Up until recently, I had ESXi, Proxmox, libvirt, and even some HyperV in another VM for testing.  All these systems played different roles, even if they are just for learning.</p>



<p>By far, I&#8217;ve been running ESXi+vCenter the longest, and it would be considered my &#8220;primary&#8221; cluster.  When you have multiple hosts, heavy networking with stuff like vDS, want HA (high availability), it&#8217;s hard to argue that the vSphere suite doesn&#8217;t automate it and make it somewhat painless. </p>



<p>But now things have changed. I&#8217;m looking to combine and contract my lab, and more tightly integrate LXD/C and automation. I decided it was time to complete the migration completely away from VMWare products, especially since I&#8217;ve already sold/powered down/eliminated 3 out of the original 5 hosts in my cluster.   </p>



<p>Don&#8217;t get me wrong, with VMUG, VMWare is great and affordable, but I&#8217;m more interested in automation now than I am with HA, so a single host or two with a ton of CPU and RAM is a better fit.</p>



<figure class="wp-block-image size-large"><img width="1024" height="169" src="https://blog.kroy.io/wp-content/uploads/2020/10/image-1024x169.png" alt="" class="wp-image-896" srcset="https://blog.kroy.io/wp-content/uploads/2020/10/image-1024x169.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/10/image-300x49.png 300w, https://blog.kroy.io/wp-content/uploads/2020/10/image-768x127.png 768w, https://blog.kroy.io/wp-content/uploads/2020/10/image-1536x253.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/10/image-2048x337.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>The fat host</figcaption></figure>



<h2>Automation</h2>



<p>Automation has always been something that has been near and dear to my heart.  Put quite frankly, manually installing VMs, configuring to my liking, realizing I messed something up and starting over, is absolutely not fun.  </p>



<p>I&#8217;ve also focused heavily on making all my VMs &#8220;pure compute&#8221;.  This means something like Ansible or Docker, with all data stored on an NFS share or iSCSI export. The end result is being able completely nuke a VM, hit a button, and have it back up and running exactly where it left off within a few minutes.  It also means you don&#8217;t need to back up individual VMs, just a few basic text files, the main NAS, etc.  I&#8217;ve talked about some pieces of how I accomplish this in an older post <a rel="noreferrer noopener" href="https://blog.kroy.io/2017/08/14/fully-embracing-docker/" data-type="post" data-id="25" target="_blank">here</a>.  I just now deploy a similar config with Ansible.</p>



<h3>Prior Automation</h3>



<p>I&#8217;ve actually done a lot of automation in the past. Chef, Salt, but my first serious implementation was Foreman + Puppet.</p>



<p>Does Foreman work?  Absolutely.  It gives you the ability to automatically create and deploy fresh VMs with PXE and Puppet.  Is Foreman nice to use?  Absolutely not.   It&#8217;s just an absolute disaster to set up and maintain.  And forget trying to upgrade even minor versions.  I was religious about regularly snapshotting and backing up that Foreman virtual machine because usually an upgrade would require me to completely start from scratch.</p>



<h3>Current Automation</h3>



<p>For at least a year now, my main automation has been a combination of Terraform and Ansible.  Terraform talked to the vCenter API and cloned &#8220;gold master&#8221; VMs, and Ansible configured them to my liking.  I also have MAAS integrated for deploying the bare metal hosts, but that&#8217;s beyond the scope of this post.</p>



<p>This really has been a great solution, but I dislike needing to use &#8220;gold master&#8221; VMs, since they are something that I have to go back and renew and update every once in a while.  And like mentioned, I&#8217;m really wanting to get away from VMWare completely.</p>



<p>So I killed one of my ESXi hosts, and fired up Ubuntu.</p>



<h2>The Hypervisor</h2>



<p>Since this post will probably end up getting pretty long and with lots of code examples, I don&#8217;t want to waste too much time on describing the host setup. But I&#8217;ll try and give the important pieces:</p>



<ul><li>Ubuntu 20.04 Server.  Why Ubuntu?  Mostly because the driver support isn&#8217;t horrible.  At the time of this writing, I tried 20.10, but the communication between 20.10 virtio guest tools and Terraform is broken.</li><li>Setting up SSH key auth.  If you are using virsh, virt-manager remotely, it&#8217;s easiest to use SSH to communicate with libvirt.  Also, I store all my terraform configs on my workstation and terraform and ansible communicates via SSH.</li><li>Installing libvirt and other important stuff .</li></ul>



<pre class="wp-block-code"><code>sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils</code></pre>



<ul><li>Installing Network Manager.  On my hypervisors, I trunk everything, so nmcli is just a WAAAAY easier method of configuring a bunch of bridges.  I&#8217;ve provided working examples of my configuration of the <code>/etc/NetworkManager/system-connections</code> directory in a <a rel="noreferrer noopener" href="https://github.com/kroy-the-rabbit/esxitolibvirt-blog/tree/master/nmcli-examples/system-connections" target="_blank">github repo</a>.<ul><li>Note that the main interface (the slave), the main bridge (vmbr0), and the VLAN5 bridge all have the MTU set to 9000.  I use VLAN5  as my storage network, and this setup allows me to easily pass a 9000 MTU link into a VM.</li><li>Installing Network Manager requires you to change netplan and re-configure your networking.  The changing of Netplan involves removing the existing <code>yaml</code> file, creating a new one that looks like<a rel="noreferrer noopener" href="https://raw.githubusercontent.com/kroy-the-rabbit/esxitolibvirt-blog/master/nmcli-examples/netplan.yml" target="_blank"> this example from github</a>, and doing a <code>sudo netplan apply</code>.</li></ul></li><li>Both my central ISO storage and main VM storage happen via NFS.  So with Ubuntu, first I need to  <code>sudo apt install nfs-common</code>, and then add them as storage pools.  <ul><li>Even on systems without selinux, libvirt enforces it.  So if you add a new storage pool and get weird errors like &#8220;permission denied&#8221;, adding <code>security_driver = "none"</code> to your <code>/etc/libvirt/qemu.conf</code> file and restarting libvirt is a quick fix, though probably not the best fix from a security perspective.</li></ul><ul><li>This is easiest done with <code>virt-manager</code> on your local PC, and then connecting via SSH to the libvirt host.  Then just add pools</li></ul></li></ul>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img src="https://blog.kroy.io/wp-content/uploads/2020/11/image.png" alt="" class="wp-image-902" width="373" height="323" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image.png 373w, https://blog.kroy.io/wp-content/uploads/2020/11/image-300x260.png 300w" sizes="(max-width: 373px) 100vw, 373px" /></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="489" height="493" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-1.png" alt="" class="wp-image-903" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-1.png 489w, https://blog.kroy.io/wp-content/uploads/2020/11/image-1-298x300.png 298w, https://blog.kroy.io/wp-content/uploads/2020/11/image-1-150x150.png 150w" sizes="(max-width: 489px) 100vw, 489px" /></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img width="470" height="477" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-2.png" alt="" class="wp-image-904" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-2.png 470w, https://blog.kroy.io/wp-content/uploads/2020/11/image-2-296x300.png 296w" sizes="(max-width: 470px) 100vw, 470px" /></figure></div>



<hr class="wp-block-separator"/>



<h2>Terraform/Grunt</h2>



<p>The two main tools I want to talk about here are <code>terraform</code> and <code>terragrunt</code>.  A layperson&#8217;s definition of <code>terraform</code> is to define &#8220;infrastructure as code&#8221;.  That means, instead of clicking buttons to make a VM, choosing the amount of RAM, etc, you define it in the terraform domain specific language or DSL outlined <a rel="noreferrer noopener" href="https://www.terraform.io/docs/configuration/syntax.html" target="_blank">here</a>.  With <code>terraform</code>, you create a directory and put text files in it that define resources.  </p>



<p>Of course that&#8217;s a pretty dry definition, so all the examples that follow will outline how all this fits together.</p>



<p><code>terragrunt</code> is just a minor wrapper to <code>terraform</code> that extends it in a few nice ways.  You can drop different projects in different folders and apply changes to all or none, plus have pre/post hooks to run things.  I&#8217;ll have examples of this as well.  </p>



<blockquote class="wp-block-quote"><p>It&#8217;s very important to note that ALLLL terraform is concerned with is state.  If something is out of state, it does its best to non-destructively move it, but that depends on the module you are using.  </p><p>Most of the time it&#8217;s just as happy to just delete everything and start over.   Plans and applies will inform/warn you, but it&#8217;s really easy to get cocky and purge some data.</p><p>Keep that in mind as you begin your terraform journey.</p></blockquote>



<p>All of this is just happening on my local Linux workstation.  As <code>terragrunt</code> and <code>terraform</code> are both just <code>Go</code> programs, that means to install them you just download and run.  </p>



<h3>Install Terraform</h3>



<p>With <code>terraform</code>, there were some MAJOR changes in the <code>.13</code> version, and that&#8217;s the version I&#8217;ll be using.  Something like this can be used to install it on Linux:</p>



<pre class="wp-block-code"><code>wget https://releases.hashicorp.com/terraform/0.13.5/terraform_0.13.5_linux_amd64.zip | unzip terraform_0.13.5_linux_amd64.zip  &amp;&amp; sudo mv terraform /usr/local/bin &amp;&amp; rm terraform_0.13.5_linux_amd64.zip </code></pre>



<figure class="wp-block-image size-large"><img width="1024" height="184" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1024x184.png" alt="" class="wp-image-909" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1024x184.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3-300x54.png 300w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3-768x138.png 768w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1536x276.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3.png 1593w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>terraform install</figcaption></figure>



<p>Similar methodology can be used to install <code>terragrunt</code></p>



<h3>Basic Layout</h3>



<p>As mentioned, I&#8217;m doing all this on my Linux workstation.  This will later allow me to easily shove this all into a git repo, make available from anywhere, etc.</p>



<figure class="wp-block-pullquote alignleft"><blockquote><p>Note that I&#8217;m not trying to make a comprehensive terraform guide here.</p><p>So I probably won&#8217;t be touching much on stuff like .tfvars files, which act sort of like env files, and things will be overly verbose so as to demonstrate what I&#8217;m doing. </p><p>There are plenty of opportunities for code reuse and further templating. Also, you can lay things out however you like. There&#8217;s not really any specific rules on how things need to be mapped out</p></blockquote></figure>



<p></p>



<p>Lets look at the basic layout for my infra:</p>



<pre class="wp-block-code"><code> terraformroot                               
 diskimages
  focal-server-cloudimg-amd64.img
 terragrunt.hcl
 vms
     terragrunt.hcl

3 directories, 3 files</code></pre>



<p>This layout leverages the best of terraform and terragrunt.  It allows me to separate out different types of resources (VMs, and in the future LXC and networking), and access them separately (with normal terraform), or globally (with terragrunt).</p>



<p>The base directory <code>terragrunt.hcl</code> file is just empty.  It&#8217;s just a placeholder to allow you to use terragrunt from that level, meaning everything below it, like in <code>vms</code> would work on a <code>terragrunt apply-all</code>.</p>



<p>I also have a <code>diskimages</code> directory with the Ubuntu 20.04 cloud-init enabled image, found <a href="https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img" data-type="URL" data-id="https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img">at this link</a>. You can download this from Ubuntu every time, but it&#8217;s much quicker to store a copy locally and just use that, plus you are being a better netizen.    </p>



<p>The <code>vms</code>directory <code>terragrunt.hcl</code> contains a &#8220;post hook&#8221;.  This updates my DNS via a script whenever VMs are added, updated, or deleted.  This is a file that you may or may not need and may want to remove or skip creating.</p>



<hr class="wp-block-separator"/>



<h3>Setting up a VM</h3>



<p>Let&#8217;s start by creating a simple VM.</p>



<p>The first layout we are working on ends up looking like this:</p>



<pre class="wp-block-code"><code>vms
 terragrunt.hcl
 testvm.lan.kroy.io
     cloud_init.cfg
     global.tf
     network_config.cfg
     terragrunt.hcl
     vm.tf

1 directory, 6 files</code></pre>



<p>Here I&#8217;ve created a directory named after the destination VM for organization, and put the files <code>main.tf</code> and <code>terragrunt.hcl</code> in it.</p>



<p>You can name the actual terraform files whatever you want as long as it ends with <code>.tf</code>, but they are processed in alphabetical order.  Usually this won&#8217;t make too much of a difference, but in some scenarios it can.</p>



<hr class="wp-block-separator"/>



<h4>The Config Files</h4>



<ul><li>The first file is the <code>global.tf</code>.  This defines some of the basic pieces of our resource.</li></ul>



<pre class="wp-block-code"><code> terraform {
    required_version = ">= 0.13"
    required_providers {
        libvirt = {
            source  = "dmacvicar/libvirt"
            version = "0.6.2"
        }
        mikrotik = {
          source = "ddelnano/mikrotik"
          version = "0.3.6"
        }
    }
}

# instance the providers

provider "libvirt" {
    uri = "qemu+ssh://kroy@jack.lan.kroy.io/system"
}

provider "mikrotik" {
    host = "crs354.lan.kroy.io:8728"
    username = "admin"
    password = ""
}

resource "libvirt_volume" "os_tmpl" {
  name = "focal_os_tmpl"
  pool = "VM"
  source = "file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img"
  format = "qcow2"
}
</code></pre>



<p>Breaking this down:</p>



<ol><li>The <code>terraform</code> section describes the module versions I want to pull.  In this case, I&#8217;m pulling the <code>libvirt</code> and <code>mikrotik</code> modules.   The <code>mikrotik</code> module is used to automatically set a static DHCP lease on my CRS.  This versioning is a the major change in terraform .13 I mentioned earlier. </li><li>The <code>libvirt</code> &#8220;provider&#8221; section sets up the connection via ssh to the host running libvirt.  User <code>kroy</code> is in the libvirt group on the host.</li><li>The <code>mikrotik</code> provider section connects via the Mikrotik API to my switch that runs my DHCP.</li><li>The final block set up a template disk image using the cloud-init enabled image that was downloaded earlier.</li></ol>



<hr class="wp-block-separator"/>



<ul><li>The next file is the <code>cloud_init.cfg</code>.  This file runs some &#8220;initial setup&#8221; tasks in the new VM.</li></ul>



<pre class="wp-block-code"><code>#cloud-config
hostname: ${hostname}
fqdn: ${fqdn}
manage_etc_hosts: true
users:
  - name: root
    ssh-authorized-keys:
      - ${file("/home/kroy/.ssh/id_ed25519.pub")}
      - ${file("/home/kroy/Documents/infra/terraform/keys/id_ansible.pub")}
  - name: kroy
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/kroy
    shell: /bin/bash
    lock_passwd: false
    ssh-authorized-keys:
      - ${file("/home/kroy/.ssh/id_ed25519.pub")}
      - ${file("/home/kroy/Documents/infra/terraform/keys/id_ansible.pub")}
# only cert auth via ssh (console access can still login)
ssh_pwauth: false
disable_root: false
chpasswd:
  list: |
     kroy:test
  expire: False
packages:
  - qemu-guest-agent

growpart:
  mode: auto
  devices: &#091;'/']
  ignore_growroot_disabled: false

runcmd:
  - &#091; systemctl, daemon-reload ]
  - &#091; systemctl, enable, qemu-guest-agent.service ]
  - &#091; systemctl, start, --no-block, qemu-guest-agent.service ]
</code></pre>



<p>If you&#8217;ve got any sort of familiarity with Linux, most of what happens in this file should be somewhat self-explanatory, even if you are unfamiliar with the layout and formatting. </p>



<ul><li>Set up hostname, fqdn from variables that will be set from <code>vm.tf</code>.</li><li>Make the <code>/etc/hosts</code> file match the proper config.</li><li>Setup ssh keys and a separate user.  Set the ssh keys to my local ssh keys and ansible keys on my workstation</li><li>Change the password on the <code>kroy</code> user</li><li>Install the QEMU Guest Agent.  This is what allows the host and the VM to communicate.</li><li>Grow the partition to the max size possible.  This makes it so you can easily create a 5GB or 500GB VM from your <code>vm.tf</code>.</li><li>Make sure the guest agent is running.  I was having an issue with it not autostarting, but this series of <code>runcmd</code> allows it to work.</li></ul>



<hr class="wp-block-separator"/>



<ul><li>The <code>network_config.cfg</code> file.  Somewhat self-documenting. There are other ways to do this, but I&#8217;ve found this is easiest for my setup:</li></ul>



<pre class="wp-block-code"><code>version: 2
ethernets:
  ens3:
     dhcp4: true</code></pre>



<p>This is just a standard <code>netplan</code> config that gets dropped on the new VM.</p>



<hr class="wp-block-separator"/>



<ul><li>The final piece is the <code>vm.tf</code>. As my naming here suggests, this is the actual config for the VM.</li></ul>



<pre class="wp-block-code"><code># variables that can be overriden
variable "hostname" { default = "bgp" }
variable "domain" { default = "lan.kroy.io" }
variable "memoryGB" { default = 2 }
variable "cpu" { default = 2 }
variable "network" { default = "vibr20" }
variable "disksizeGB" { default = 20 }



resource "libvirt_volume" "os_image" {
  name = "${var.hostname}-os_image"
  pool   = "VM"
  base_volume_id = libvirt_volume.os_tmpl.id
  size = var.disksizeGB * 1024 * 1024 * 1024
}

# Use CloudInit ISO to add ssh-key to the instance
resource "libvirt_cloudinit_disk" "commoninit" {
  name = "${var.hostname}-commoninit.iso"
  pool = "VM"
  user_data = data.template_file.user_data.rendered
  network_config = data.template_file.network_config.rendered
}


data "template_file" "user_data" {
  template = file("${path.module}/cloud_init.cfg")
  vars = {
    hostname = var.hostname
    fqdn = "${var.hostname}.${var.domain}"
  }
}

data "template_file" "network_config" {
  template = file("${path.module}/network_config.cfg")
}


# Create the machine
resource "libvirt_domain" "domain-vm" {
  qemu_agent = true
  name = "${var.hostname}.${var.domain}"
  memory = var.memoryGB * 1024
  vcpu = var.cpu
  cloudinit = libvirt_cloudinit_disk.commoninit.id

  disk {
       volume_id = libvirt_volume.os_image.id
  }
  network_interface {
       wait_for_lease = true
       bridge = var.network
  }

  graphics {
    type = "spice"
    listen_type = "address"
    autoport = "true"
  }
  provisioner "local-exec" {
    environment = {
        IP = join("",slice(&#091;for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == "10.20.20"],0,1))
    }
    command = "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i $IP, --key-file=~/Documents/infra/terraform/keys/id_ansible -u root ~/Documents/infra/terraform/ansible/docker/deploy-docker_ubuntu.yml"

  }

}


resource "mikrotik_dhcp_lease" "dhcp" {
  address = join("",slice(&#091;for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == "10.20.20"],0,1))
  macaddress = upper(join("",libvirt_domain.domain-vm.*.network_interface.0.mac))
  comment = "${var.hostname}.${var.domain}"
  hostname = var.hostname
}

</code></pre>



<p>There&#8217;s obviously a lot going on here, but the short of it is I&#8217;ll be creating multiple resources.  A cloud-init &#8220;boot disk&#8221;, some templates for passing into the cloud-init disk, the actual VM, and the DHCP record on my Mikrotik, which will read the IP of the created VM, and turn it into a static DHCP lease.</p>



<ol><li>The first part of this config is just some variables.  As I create a new VM, assuming I just want a fairly basic VM, all I need to do is change some things here.  To create a new VM, this is all that needs to be changed.  Note that these can be stored in a <code>.tfvars</code> file too for further separation.</li><li>The first resource is the actual VM disk.  Note that the size is multipled by 1024*1024*1024 to translate the size from bytes to gigabytes, for ease of use.</li><li>The next resource and following templates resources pulls in the cloud-init and network configs to build a cloud init image for initial booting and setup. </li><li>The next resource defines the VM.  Most of it should be self-explanatory.  Things like making sure the guest agent is enabled, setting up the hostname and fqdn from the variables, vcpus, memory, disk.  When you want to use data from a different resource, the format is &#8220;resource_type.resource_name.id&#8221;.  So to later refer to this VM, you&#8217;d used <code>libvirt_domain.domain-vm.id</code>.<ol><li>We set up a spice console, important for connecting to it via something like <code>virt-manager</code>.</li><li>The <code>network_interface</code> resource here tells it to wait for a lease.  This is necessary since I want my Mikrotik resource below to be have access to the IP that the VM was issued via DHCP.  This saves me from having to hard-code IPs.</li><li>I have a <code>local-exec</code> provisioner here.  This is how I call Ansible to configure the VM.  In this case I&#8217;ll be setting this host up as one of my Docker VMs.  Note that I&#8217;m doing some severe hacky stuff to make sure I only grab the IP in the subnet that I want.  </li></ol></li><li>Finally, the Mikrotik resource. As mentioned a few times, this sets a static DHCP lease on my main DHCP server, using the same hacky IP pulling code as above.</li></ol>



<hr class="wp-block-separator"/>



<h4>Terraforming the Virtual Machine</h4>



<p>Now that all the resources and config are declared, it&#8217;s time to actually create the VM.</p>



<p>The first step is to <code>initialize</code> the terraform repo here.  This causes it to pull the required modules and prepare for deployment.</p>



<pre class="wp-block-code"><code> terraform init

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/template...
- Finding dmacvicar/libvirt versions matching "0.6.2"...
- Finding ddelnano/mikrotik versions matching "0.3.6"...
- Installing hashicorp/template v2.2.0...
- Installed hashicorp/template v2.2.0 (signed by HashiCorp)
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)
- Installing ddelnano/mikrotik v0.3.6...
- Installed ddelnano/mikrotik v0.3.6 (self-signed, key ID DDBA1674AA3EA0EE)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https:&#47;&#47;www.terraform.io/docs/plugins/signing.html

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, we recommend adding version constraints in a required_providers block
in your configuration, with the constraint strings suggested below.

* hashicorp/template: version = "~> 2.2.0"

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary. terraform init

Initializing the backend...

Initializing provider plugins...
- Finding dmacvicar/libvirt versions matching "0.6.2"...
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre>



<p>Assuming you get a success message there and some green text, you can proceed to <code>plan</code> or even <code>apply</code>.</p>



<p><code>plan</code> shows you want it&#8217;s going to do.  <code>apply</code> will do it (with confirmation by default, but it can be overridden).</p>



<pre class="wp-block-code"><code> terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.network_config: Refreshing state...
data.template_file.user_data: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # libvirt_cloudinit_disk.commoninit will be created
  + resource "libvirt_cloudinit_disk" "commoninit" {
      + id             = (known after apply)
      + name           = "testvm-commoninit.iso"
      + network_config = &lt;&lt;~EOT
            version: 2
            ethernets:
              ens3:
                 dhcp4: true
        EOT
      + pool           = "VM"
      + user_data      = &lt;&lt;~EOT
            #cloud-config
            hostname: testvm
            fqdn: testvm.lan.kroy.io
            manage_etc_hosts: true
            users:
              - name: root
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
              - name: kroy
                sudo: ALL=(ALL) NOPASSWD:ALL
                groups: users, admin
                home: /home/kroy
                shell: /bin/bash
                lock_passwd: false
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
            # only cert auth via ssh (console access can still login)
            ssh_pwauth: false
            disable_root: false
            chpasswd:
              list: |
                 kroy:test
              expire: False
            packages:
              - qemu-guest-agent
            
            growpart:
              mode: auto
              devices: &#091;'/']
              ignore_growroot_disabled: false
            
            runcmd:
              - &#091; systemctl, daemon-reload ]
              - &#091; systemctl, enable, qemu-guest-agent.service ]
              - &#091; systemctl, start, --no-block, qemu-guest-agent.service ]
        EOT
    }

  # libvirt_domain.domain-vm will be created
  + resource "libvirt_domain" "domain-vm" {
      + arch        = (known after apply)
      + cloudinit   = (known after apply)
      + disk        = &#091;
          + {
              + block_device = null
              + file         = null
              + scsi         = null
              + url          = null
              + volume_id    = (known after apply)
              + wwn          = null
            },
        ]
      + emulator    = (known after apply)
      + fw_cfg_name = "opt/com.coreos/config"
      + id          = (known after apply)
      + machine     = (known after apply)
      + memory      = 2048
      + name        = "testvm.lan.kroy.io"
      + qemu_agent  = true
      + running     = true
      + vcpu        = 2

      + graphics {
          + autoport       = true
          + listen_address = "127.0.0.1"
          + listen_type    = "address"
          + type           = "spice"
        }

      + network_interface {
          + addresses      = (known after apply)
          + bridge         = "vibr20"
          + hostname       = (known after apply)
          + mac            = (known after apply)
          + network_id     = (known after apply)
          + network_name   = (known after apply)
          + wait_for_lease = true
        }
    }

  # libvirt_volume.os_image will be created
  + resource "libvirt_volume" "os_image" {
      + base_volume_id = (known after apply)
      + format         = (known after apply)
      + id             = (known after apply)
      + name           = "testvm-os_image"
      + pool           = "VM"
      + size           = 21474836480
    }

  # libvirt_volume.os_tmpl will be created
  + resource "libvirt_volume" "os_tmpl" {
      + format = "qcow2"
      + id     = (known after apply)
      + name   = "focal_os_tmpl"
      + pool   = "VM"
      + size   = (known after apply)
      + source = "file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img"
    }

  # mikrotik_dhcp_lease.dhcp will be created
  + resource "mikrotik_dhcp_lease" "dhcp" {
      + address    = (known after apply)
      + blocked    = "false"
      + comment    = "testvm.lan.kroy.io"
      + dynamic    = false
      + hostname   = "testvm"
      + id         = (known after apply)
      + macaddress = (known after apply)
    }

Plan: 5 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an "-out" parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
"terraform apply" is subsequently run.
</code></pre>



<p>Note the bottom line where is says it&#8217;s going to add 5, change 0, destroy 0.  </p>



<p>Keep remembering that all terraform is concerned with is state.  So it will happily delete and nuke everything to get it to make the state that you want.  So if a <code>plan</code> or <code>apply</code> says it&#8217;s going to delete a bunch of stuff and that&#8217;s not what you wanted, escape now!</p>



<p>Finally, <code>terraform apply</code> looks much like the plan above, and adds a few extra lines to confirm the operation (if you haven&#8217;t passed the option to skip it).</p>



<pre class="wp-block-code"><code>Plan: 5 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

...

Apply complete! Resources: 5 added, 0 changed, 0 destroyed
</code></pre>



<p>This should hopefully complete without error, and if you do a <code>virsh list</code> on the libvirt host, you&#8217;ll see something like:</p>



<pre class="wp-block-code"><code># virsh list 
 Id   Name                 State
------------------------------------
 1    testvm.lan.kroy.io   running
</code></pre>



<p>In my <code>terraform apply</code> output, I have <code>libvirt_domain.domain-vm (local-exec): ok: [10.20.20.79]</code>, which means I should be able to ssh there</p>



<pre class="wp-block-code"><code> ssh kroy@10.20.20.79
Warning: Permanently added '10.20.20.79' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-51-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Nov  2 17:55:54 UTC 2020

  System load:              0.0
  Usage of /:               11.0% of 19.21GB
  Memory usage:             15%
  Swap usage:               0%
  Processes:                121
  Users logged in:          0
  IPv4 address for docker0: 172.17.0.1
  IPv4 address for ens3:    10.20.20.79
 

41 updates can be installed immediately.
15 of these updates are security updates.
To see these additional updates run: apt list --upgradable



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo &lt;command>".
See "man sudo_root" for details.

kroy@testvm:~$</code></pre>



<p>SUCCESS!</p>



<hr class="wp-block-separator"/>



<h3>Terragrunt</h3>



<p>Even though we&#8217;ve only got a single resource so far, I want to touch on what <code>terragrunt</code> accomplishes for you.  </p>



<p>Terraform only works on single directories.  So say I wanted to add a second VM.  </p>



<p>I would do something like:</p>



<pre class="wp-block-code"><code>cd terraformroot
cp -pr vms/testvm.lan.kroy.io vms/doubletest.lan.kroy.io
rm vms/doubletest.lan.kroy.io/terraform.tfstate*
sed -i -e 's/testvm/doubletest/' vms/doubletest.lan.kroy.io/vm.tf</code></pre>



<p>Hopefully that is mostly self-explanatory:</p>



<ul><li>Change into our terraform directory.</li><li>Copying the existing config to a new VM directory.</li><li>Remove all the old terraform state files.  This is <em>VERY</em> important if you are going to be using terraform like this.  This is basically the main &#8220;database&#8221; for terraform and if you want to create a new resource, you don&#8217;t want the old database in the new resource directory.</li><li>A not-so-fancy one-liner to change the hostname of the new VM.</li></ul>



<p>Now you would have a few options to determine how you want to apply this configuration:</p>



<ol><li>Switch to <code>terraformroot/vms/doubletest.lan.kroy.io</code>, do a <code>terraform apply</code>.   This would only apply the state for this VM.</li><li>Switch to <code>terraformroot/vms</code>, do a <code>terragrunt apply-all</code>.  This would apply the state for <code>testvm.lan.kroy.io </code> and <code>doubletest.lan.kroy.io</code>.</li><li>Switch to <code>terraformroot</code>, and again, <code>terragrunt apply-all</code>.  This would apply the state for all resources under <code>vms</code>, and any future projects, like networking configs, LXC, etc.</li></ol>



<p>In all that, you can also do <code>plan-all</code> on terragrunt to see what it&#8217;s going to change.</p>



<p>In the directory for these VMs resources, I&#8217;ve got a <code>terragrunt.hcl</code>.  The contents of this are simply:</p>



<pre class="wp-block-code"><code>include {
  path = find_in_parent_folders()
}</code></pre>



<p>This says &#8220;look in any parent folders, and execute the actions of their <code>terragrunt.hcl</code>.&#8221;</p>



<p>This is powerful because you can have specific actions for just the <code>vms</code> directory or everything. That&#8217;s why the content of my <code>terragrunt.hcl</code> in the <code>vms</code> directory contains:</p>



<pre class="wp-block-code"><code>terraform {
  after_hook "after_hook" {
    commands     = &#091;"apply"]
    execute      = &#091;"/bin/bash","/home/kroy/Documents/infra/terraform/updatedns.sh"]
    run_on_error = true
  }
}
</code></pre>



<p>As is implied, this runs after you type <code>terragrunt apply</code> or <code>apply-all</code>. </p>



<p>Being in the <code>vms</code> sub-directory, when would this run?</p>



<ol><li>In the individual VM resource directory due to the <code>find_in_parent_folders</code> when you run terragrunt with apply or apply-all.</li><li>In the <code>vms</code> sub-directory when running apply all. You can&#8217;t run apply because that only looks in the current directory.</li><li>In the main <code>terraformroot</code> directory.    </li></ol>



<p>So running a <code>terragrunt apply-all</code> in the <code>vms</code> directory:</p>



<pre class="wp-block-code"><code>&#091;terragrunt] 2020/11/02 12:13:11 Stack at /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms:
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/doubletest.lan.kroy.io (excluded: false, dependencies: &#091;])
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io (excluded: false, dependencies: &#091;])
&#091;terragrunt] 2020/11/02 12:13:11 &#091;terragrunt]  Are you sure you want to run 'terragrunt apply' in each folder of the stack described above? (y/n) </code></pre>



<p>The output of this shows that the new VM was created (and the original VM was at least looked at), and my post-hook is run once:</p>



<pre class="wp-block-code"><code>Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Detected 1 Hooks
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Executing hook: after_hook
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Running command: /bin/bash /home/kroy/Documents/infra/terraform/updatedns.sh
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io has finished successfully!</code></pre>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Well, there you have it.   Is this the perfect layout?  Probably not.  Is there room for improvement?  Absolutely.</p>



<p>I have put up a git repo <a rel="noreferrer noopener" href="https://github.com/kroy-the-rabbit/esxitolibvirt-blog" data-type="URL" data-id="https://github.com/kroy-the-rabbit/esxitolibvirt-blog" target="_blank">HERE</a>, containing all of the examples from above.</p>



<p>Of course this is far from complete.  With this setup, all you have are fairly blank and basic VMs.  You&#8217;d want to hit them with Ansible or something to finish configuring them.  But that&#8217;s a post for another day.</p>



<p>Enjoy!</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">894</post-id>	</item>
		<item>
		<title>VyOS from Scratch &#8211; Edition 1</title>
		<link>https://blog.kroy.io/2020/05/04/vyos-from-scratch-edition-1/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=vyos-from-scratch-edition-1</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 04 May 2020 05:28:47 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[vyos]]></category>
		<category><![CDATA[vyosfromscratch]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=593</guid>

					<description><![CDATA[As a VyOS evangelist, maintainer, and more, I&#8217;ve been meaning to write a simple series of &#8220;how-to&#8221; guides for VyOS for a while. Sure, there are plenty of guides out&#8230;]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>As a VyOS evangelist, maintainer, and more, I&#8217;ve been meaning to write a simple series of &#8220;how-to&#8221; guides for VyOS for a while.  Sure, there are plenty of guides out there, but I think a lot of them fall short in demonstrating WHY you are entering specific commands.  </p>



<p>VyOS is capable, but it&#8217;s much more helpful if you can fully understand what it&#8217;s doing.  </p>



<p>This initial guide will walk through the basic setup steps in replacing something like pfSense or some other consumer router with a simple and secure system running VyOS.  </p>



<p>This is also going to be a very very long post, so buckle in!</p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Who is this For</h2>



<p>Anybody that wants to use VyOS of course!  </p>



<p>The nice thing about running VyOS is that if you set up it, and understand <strong><em>WHAT</em></strong> it&#8217;s doing, then you&#8217;ve actually learned something about networking.  </p>



<p>Does something like pfSense work?  </p>



<p>Sure, but it also doesn&#8217;t teach you much about what&#8217;s actually going on.  And the knowledge learned in VyOS will easily translate to almost any other vendor like Cisco, Arista, and more.  At that point, the concepts are the same, you are just learning the different dialects. </p>



<hr class="wp-block-separator"/>



<h2>Environment</h2>



<p>VyOS really doesn&#8217;t take much in resources.  </p>



<p>8GB of storage and 2-4GB of RAM will be overkill for most basic setups.  </p>



<p>CPU-wise, even small Pentium Silver CPUs can handle gigabit and beyond, even over VPN .  Anything like an i3/i5 or a Xeon won&#8217;t break a sweat except in all but the most demanding scenarios.</p>



<p>If you virtualize, it can be helpful to set up a test environment.  This could consist of a simple:</p>



<ul><li>WAN Network.  For testing this could be your existing LAN network.</li><li>A new &#8220;LAN&#8221; Network. For testing this could just be a separate port group or bridge, and it wouldn&#8217;t even need an uplink.</li><li>A simple VM with a GUI (or without), to run some testing. </li></ul>



<p>If virtualization isn&#8217;t an option, VyOS can run on almost any device that is x86_64.  I&#8217;ve run it on everything from:</p>



<ul><li>NUCs with single NICs and USB/USB-C NICs.</li><li><a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/" target="_blank" rel="noreferrer noopener">WYSE 5070/3040 Thin Clients</a>.</li><li>A variety of Dells, including R710s/R620s/R630s.</li><li>Anything Supermicro from 1U to 4U devices.</li></ul>



<p>Finally, for this guide, I&#8217;ll be working with two NICs.  </p>



<p>One is a WAN, connected to my current LAN.  I&#8217;ll be creating a &#8220;network inside a network&#8221;.  The second will be our new &#8220;LAN&#8221;.  This is separate from my existing LAN so I can pretend like it&#8217;s a second private network.  These interfaces can be anything:</p>



<ul><li>Physical NICs.</li><li>VLANs.</li><li>Virtual NICs from ESXi, Proxmox, etc.</li></ul>



<hr class="wp-block-separator"/>



<h1>Install</h1>



<p>The first step is to grab yourself a copy of the installer ISO.  </p>



<p>Most people will want the <a href="https://www.vyos.io/rolling-release/" target="_blank" rel="noreferrer noopener">Rolling Release</a>.  You can also build it yourself, via the <a href="https://docs.vyos.io/en/latest/contributing/build-vyos.html" target="_blank" rel="noreferrer noopener">Docker image</a>, which is helpful if there are some extra packages you want to add.</p>



<p>If you want access to the LTS version, it requires self-building (an easy process), contributing, or a subscription. I <a href="https://blog.vyos.io/vyos-access-subscriptions-for-documentation" target="_blank" rel="noreferrer noopener">highly recommend contributing</a>, as even writing or cleaning up some documentation will get you access to the LTS prebuilt versions.  </p>



<p>You can also support and get access via <a href="https://www.patreon.com/vyos" target="_blank" rel="noreferrer noopener">Patreon</a> or <a href="https://www.buymeacoffee.com/kUa78LT" target="_blank" rel="noreferrer noopener">BuyMeACoffee</a>.</p>



<hr class="wp-block-separator"/>



<p>Note that for these guides, I will be using a recent version of rolling.  This is important as some configuration nodes have changed locations and format between 1.3+ and the existing LTS versions (DHCP and IPv6 RAs are two things that come to mind).</p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Rolling Stability</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
It&#8217;s important to note that the rolling releases are generally completely stable.  I would say 95% of them or more are functional without any major bugs.</p>
<p>Every once in a while, some broken functionality is pushed, but it is almost always fixed quickly. A broken upgrade is not a show-stopper and it is trivial to boot back into the working version with the built-in <a href="https://docs.vyos.io/en/latest/image-mgmt.html" target="_blank" rel="noopener noreferrer">Image Management</a>.</p>
<p>I have no issues running rolling releases in many production locations.<br />
</div></div>



<h2>Install Steps</h2>



<p>Installation is trivial:</p>



<ul><li>Burn ISO to CD/DVD/USB stick, or boot ISO via remote management (iDrac, iLo, IPMI)</li><li>Login with <code><em>vyos</em></code>/<code><em>vyos</em></code></li><li>Type <code><em>install image</em></code></li><li>Answer the install steps</li><li>Reboot and remove installation media</li></ul>


<div class="su-box su-box-style-default" id="" style="border-color:#cc8700;border-radius:3px"><div class="su-box-title" style="background-color:#ffba00;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Installation Gotchas</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<ul>
<li> The installer ISO is a fully functional VyOS image.  That means if you skip the <em>install image</em> step, you can configure the system, and it will work as intended&#8230; until you reboot.  Don&#8217;t be me.  Make sure to install if you want a permanent installation.
<li> Some systems that lack a serial port get stuck on a black screen on the installer ISO.  The simple fix is to edit the grub boot option line and remove the <em>console=ttyS0,115200</em> option from the kernel boot arguments.  Then just boot with <em>CTRL-X</em> as directed.
</ul>
</div></div>



<figure class="wp-block-image size-large"><img width="720" height="404" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-2.png" alt="" class="wp-image-609" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-2.png 720w, https://blog.kroy.io/wp-content/uploads/2020/04/image-2-300x168.png 300w" sizes="(max-width: 720px) 100vw, 720px" /></figure>



<figure class="wp-block-image size-large"><img width="726" height="400" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-1.png" alt="" class="wp-image-608" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-1.png 726w, https://blog.kroy.io/wp-content/uploads/2020/04/image-1-300x165.png 300w" sizes="(max-width: 726px) 100vw, 726px" /></figure>



<hr class="wp-block-separator"/>



<h1>Basic Configuration</h1>



<p>Once installed, you&#8217;ll be staring at the login screen.  Login with <code>vyos</code> and the password you set up during install:</p>



<figure class="wp-block-image size-large"><img width="723" height="408" src="https://blog.kroy.io/wp-content/uploads/2020/04/image.png" alt="" class="wp-image-607" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image.png 723w, https://blog.kroy.io/wp-content/uploads/2020/04/image-300x169.png 300w" sizes="(max-width: 723px) 100vw, 723px" /></figure>



<hr class="wp-block-separator"/>



<h3>Decision Time!</h3>



<p>Before you go any further, you need to make a decision.  You need to pick out the subnet (or later subnets) where your network will live.  Or, if you are converting over your existing network, just reuse it.</p>



<p>These should be <a href="https://en.wikipedia.org/wiki/Private_network">RFC1918 addresses</a>.  You generally want a /24, which is 254 usable addresses.</p>



<p>So, there are three main groups of these private addresses you can choose from:</p>



<ul><li><code>10.X.Y.1-254</code>, where <code>X</code> and <code>Y</code> are any number between 0 and 255.  For the last number, 0 would be your &#8220;network&#8221; address, and 255 would be your broadcast address.  You could then assign all your hosts to 1-254.</li><li><code>172.X.Y.1-254</code>, in this case <code>X</code> would be between 16 and 31, and <code>Y</code> could be 0 to 255. </li><li><code>192.168.X.1-254</code>, where <code>X</code> is between 0 and 255.  </li></ul>



<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Subnetting Pro-tips</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>Many routers around the world off-the-shelf use a subnet like 10.0.0.0/24 or 192.168.0.0/24.</p>
<p>
While you can use these subnets, future-you will hate yourself if you ever want to access your network remotely or access other networks when both sides are using the same subnet.
</p>
<p>
I would highly recommend:
<ul>
 	<li>Choose a subnet away from the norm.  For example, 10.32.47.0/24.</li>
 	<li>If you want to plan ahead and are planning to break things out on VLANs, use a subnet like 10.32.X.0/24.  That way, in the future, X can represent your VLAN number, and you can do a summary route like 10.32.0.0/16.  I&#8217;ll be showing some examples of where this can be used later on in this post.</ul>
</p>
</div></div>



<hr class="wp-block-separator"/>



<h3>Configuring the LAN and Remote access</h3>



<p>After the subnet is chosen, the first step is to get the router on the LAN and accessible via SSH.  This makes it much easier to configure, as you are no longer tethered to a keyboard/monitor, VM console, can copy/paste, etc.  </p>



<h4>LAN IP</h4>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configure mode</li><li>Add address to the correct interface</li><li>Commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>The first step is to enter configure mode.  This allows you to make changes to the system configuration.  Type <code>configure</code>.  VyOS also supports shortcuts and tab completion, so typing <code>conf</code> or <code>conf&lt;TAB&gt;</code> will do the same thing.</p>



<figure class="wp-block-image size-large"><img width="336" height="135" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-5.png" alt="" class="wp-image-626" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-5.png 336w, https://blog.kroy.io/wp-content/uploads/2020/04/image-5-300x121.png 300w" sizes="(max-width: 336px) 100vw, 336px" /></figure>



<p>The prompt will change to include <code>#</code>, and the <code>[edit]</code> line will appear to designate that you are in configure mode.</p>



<p>Next, you need to add your LAN IP.  You can check your interfaces by typing <code>run show interfaces</code>.  This tells VyOS to show all the interfaces in operational mode (the mode you were in before you typed <code>conf</code>).</p>



<figure class="wp-block-image size-large is-resized"><img src="https://blog.kroy.io/wp-content/uploads/2020/04/image-4.png" alt="" class="wp-image-625" width="580" height="98" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-4.png 600w, https://blog.kroy.io/wp-content/uploads/2020/04/image-4-300x51.png 300w" sizes="(max-width: 580px) 100vw, 580px" /></figure>



<p>In my case, <code>eth1</code> is attached to my LAN here.  I&#8217;m going to use the subnet from above, <code>10.32.0.0/24</code>.  I prefer to use <code>.1</code> for my routers, but you can use any IP in that range.</p>



<p>There are two methods to assign it once in <code>conf</code> mode.  Either with the full path, or by drilling-down.</p>



<p>Full path:</p>



<pre class="wp-block-code"><code>configure
set interfaces ethernet eth1 address 10.32.0.1/24
set interfaces ethernet eth1 description LAN
commit
save</code></pre>



<p>Drill down:</p>



<pre class="wp-block-code"><code>configure
edit interfaces ethernet eth1
set address 10.32.0.1/24
set description LAN
commit
save</code></pre>



<p>Committing makes the configuration active, and saving saves it to disk so it will persist on a reboot.</p>



<figure class="wp-block-image size-large"><img width="1024" height="225" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1024x225.png" alt="" class="wp-image-657" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1024x225.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-300x66.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-768x169.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1536x337.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-2048x450.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Or:</p>



<figure class="wp-block-image size-large"><img width="1024" height="293" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1024x293.png" alt="" class="wp-image-658" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1024x293.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-300x86.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-768x220.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1536x439.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19.png 1994w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>You can show your work with <code>show interfaces</code> and <code>run show interfaces</code></p>



<figure class="wp-block-image size-large"><img width="1024" height="693" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-20-1024x693.png" alt="" class="wp-image-659" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-20-1024x693.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20-300x203.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20-768x520.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20.png 1034w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h4>Set up DHCP</h4>



<p>Now that that router has a LAN IP, it&#8217;s time to connect your laptop/desktop/etc up to it.  </p>



<p>You can assign it a static IP in the chosen subnet (<code>10.32.0.10/24</code> for example), but I imagine you are also going to want to assign a DHCP range for automatic configuration of clients.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configure mode</li><li>Set up DHCP ranges</li><li>commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>Let&#8217;s talk about the following config.  </p>



<p>We are going to make two DHCP ranges, and leave some holes.  This would allow us to assign the IP addresses between <code>.2</code> and <code>.49</code> for static or other uses, as well as <code>.126-199</code> and <code>.251-254</code>.</p>



<p>While this is a non-standard usage, it demonstrates the capabilities. Many people would just have a single range. </p>



<pre class="wp-block-code"><code>set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 0 start 10.32.0.50
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 0 stop 10.32.0.125
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 1 start 10.32.0.200
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 1 stop 10.32.0.250</code></pre>



<p>Some other important config options follow.   </p>



<p>You want to tell the DHCP server to hand out the router&#8217;s IP address as the default gateway and DNS.  This will make it so (eventually), your LAN devices will have DNS and routing to the Internet:</p>



<pre class="wp-block-code"><code>set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 dns-server 10.32.0.1
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 default-router 10.32.0.1</code></pre>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">DNS Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>This would also be the place to insert something like your pi-hole or active directory DNS server.  In the above example, your pi-hole/ADDNS address or addresses would be where the dns-server option is. </p>
</div></div>



<p></p>



<figure class="wp-block-image size-large is-resized"><img src="https://blog.kroy.io/wp-content/uploads/2020/04/image-8.png" alt="" class="wp-image-630" width="580" height="230" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-8.png 781w, https://blog.kroy.io/wp-content/uploads/2020/04/image-8-300x119.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-8-768x305.png 768w" sizes="(max-width: 580px) 100vw, 580px" /></figure>



<figure class="wp-block-image size-large"><img width="760" height="208" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-10.png" alt="" class="wp-image-632" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-10.png 760w, https://blog.kroy.io/wp-content/uploads/2020/04/image-10-300x82.png 300w" sizes="(max-width: 760px) 100vw, 760px" /></figure>



<hr class="wp-block-separator"/>



<h4>SSH</h4>



<p>The final step before we can access the router over SSH is to actually enable SSH:</p>



<pre class="wp-block-code"><code>set service ssh port 22
commit
save</code></pre>



<p>At this point you ought to be able to hook up a LAN client, and verify that you have an IP, gateway, and DNS.  </p>



<p>This is a fairly stock Debian VM I set up.  As you can see, my IP is in one of my DHCP ranges, and my DNS and default route are the router&#8217;s IP. </p>



<p>This is on Linux, but the same thing could be confirmed on Windows or MacOS:</p>



<figure class="wp-block-image size-large"><img width="736" height="472" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-16.png" alt="" class="wp-image-640" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-16.png 736w, https://blog.kroy.io/wp-content/uploads/2020/04/image-16-300x192.png 300w" sizes="(max-width: 736px) 100vw, 736px" /></figure>



<p>From there, you should be able to ssh into the router with the username <code>vyos</code> and password you set up during install:<br></p>



<figure class="wp-block-image size-large"><img width="541" height="191" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-13.png" alt="" class="wp-image-637" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-13.png 541w, https://blog.kroy.io/wp-content/uploads/2020/04/image-13-300x106.png 300w" sizes="(max-width: 541px) 100vw, 541px" /></figure>



<p>And typing <code>show configuration</code> (in op mode), should show you the work done so far.  VyOS also comes with a few defaults, like NTP servers configured.</p>



<figure class="wp-block-image size-large"><img width="414" height="990" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-14.png" alt="" class="wp-image-638" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-14.png 414w, https://blog.kroy.io/wp-content/uploads/2020/04/image-14-125x300.png 125w" sizes="(max-width: 414px) 100vw, 414px" /></figure>



<hr class="wp-block-separator"/>



<h1>NAT &amp; DNS</h1>



<h3>NAT</h3>



<p>The next important duty for a router and firewall is to be able to NAT.  NAT allows all your private LAN devices to access the Internet.  </p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Information Dump</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Back when the Internet started, every device had a unique IP address. </p>
<p>Unfortunately, because of the numbering scheme used, there are only 4.2 billion of these address, at least in IPv4, and the transition to IPv6 is far from complete.</p>
<p>Because of this, every device on your network needs to be able to &#8220;pretend&#8221; that it is your router to access the Internet.  Your router keeps track of which requests belong to which device.  </p>
<p>Source NAT is what allows you to do this.</p>
<p>This is also where the above mentioned &#8220;summary route&#8221; can come into play.  Instead of creating three separate NAT rules for 10.32.1.0/24, 10.32.2.0/24, and 10.32.3.0/24, you can create a single rule for 10.32.0.0/16.<br />
</div></div>



<p>For this setup, it&#8217;s important to identify which network interface will eventually be your WAN interface, even though it&#8217;s not configured yet.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>As before, enter configuration mode.</li><li>Set up a source NAT rule to target our LAN or LAN subnets.</li><li>Define the outgoing WAN interface on the rule.</li><li>Set the translation type of the rule to <code>masquerade</code>. </li></ul>



<hr class="wp-block-separator"/>



<p>The type of NAT we will be using is called <code>SOURCE NAT</code>.  This type of NAT is going to have three components:</p>



<ul><li>Target all traffic from our LAN or LANs&#8230;</li><li>&#8230; when the traffic is going out to the Internet through this outgoing interface&#8230;</li><li>&#8230; Change the IP address from the LAN IP to the WAN IP</li></ul>



<p>To do this:</p>



<pre class="wp-block-code"><code>set nat source rule 100 source address '10.32.0.0/24'
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 translation address masquerade
commit
save</code></pre>



<p>In the above example, the <code>100</code> is an arbitrary number (between 1-9999).  The <code>eth0</code> is my eventual WAN interface.  <code>masquerade</code> translates the internal LAN IP to your public WAN IP.  </p>



<p></p>



<figure class="wp-block-image size-large"><img width="962" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-21.png" alt="" class="wp-image-660" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-21.png 962w, https://blog.kroy.io/wp-content/uploads/2020/04/image-21-300x240.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-21-768x613.png 768w" sizes="(max-width: 962px) 100vw, 962px" /></figure>



<p>Once we set up our WAN interface, we&#8217;ll be able to type <code>show nat source rules</code> in op mode, or <code>run show nat source rules</code> in conf mode to run the op mode command, it will be clear what&#8217;s happening.</p>



<hr class="wp-block-separator"/>



<h3>DNS</h3>



<p>The next step is to set up our VyOS instance as for DNS.  This will allow you to use local DNS and caching instead of your ISP&#8217;s, but also eventually will allow you run custom DNS and hosts. </p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter config mode</li><li>Set the DNS Listen Address</li><li>Set the subnets we are allowing from</li><li>Set the cache size to 0</li><li>commit and save</li></ul>



<hr class="wp-block-separator"/>



<pre class="wp-block-code"><code>set service dns forwarding listen-address '10.32.0.1'
set service dns forwarding allow-from '10.32.0.0/24'
set service dns forwarding cache-size '0'
commit
save</code></pre>



<p>As mentioned, this accomplishes three things.  </p>



<ul><li>It tells VyOS to listen for DNS requests on its LAN IP, <code>10.32.0.1</code>.  </li><li>It limits requests from your LAN subnet.  </li><li>Finally, it sets the cache size to 0.  This is good to start out with to make sure everything is working, but later you can bump it up to speed up multiple requests for the same sites. </li></ul>



<hr class="wp-block-separator"/>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Opportunity Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
This is another opportunity to use the &#8220;summary&#8221; route that I&#8217;ve mentioned a few times.  </p>
<p>Instead of allowing &#8220;10.32.0.0/24&#8221;, you would allow &#8220;10.32.0.0/16&#8221;.  This would ensure that as you add VLANs and subnets, your DNS will just work without adding a long list of /24s.<br />
</div></div>



<hr class="wp-block-separator"/>



<figure class="wp-block-image size-large"><img width="508" height="212" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-22.png" alt="" class="wp-image-678" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-22.png 508w, https://blog.kroy.io/wp-content/uploads/2020/04/image-22-300x125.png 300w" sizes="(max-width: 508px) 100vw, 508px" /></figure>



<hr class="wp-block-separator"/>



<h4>DNS Forwarding</h4>



<p>There is one more consideration to be made.  As configured, your DNS server will run in &#8220;recursor&#8221; mode.  This means it will take responsibility for fully resolving DNS on its own.  This may be a bad thing for a number of reasons:</p>



<ul><li>It leaks your IP to potential undesirables.  </li><li>It&#8217;s almost always slower, as you don&#8217;t get to benefit from the caches of a large service like CloudFlare or Google.  </li></ul>



<p>It&#8217;s quite simple to set up in forwarding mode, meaning when you make a DNS request, you end up asking an upstream resolver.  </p>



<p>In the following example, we&#8217;ll be using CloudFlare and Google:</p>



<pre class="wp-block-code"><code>set service dns forwarding name-server 1.1.1.1
set service dns forwarding name-server 1.0.0.1
set service dns forwarding name-server 8.8.8.8
set service dns forwarding name-server 8.8.4.4
commit
save</code></pre>



<figure class="wp-block-image size-large"><img width="564" height="399" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-23.png" alt="" class="wp-image-680" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-23.png 564w, https://blog.kroy.io/wp-content/uploads/2020/04/image-23-300x212.png 300w" sizes="(max-width: 564px) 100vw, 564px" /></figure>



<hr class="wp-block-separator"/>



<h4>System DNS</h4>



<p>One final step is to set the DNS for VyOS itself.  Everything we&#8217;ve done so far has just set up VyOS to be a DNS server for your clients.</p>



<p>This will be the DNS that is used, for example, when you do a VyOS update, ping or traceroute from VyOS, etc.</p>



<p>The easiest thing to do if you&#8217;ve been following this guide, is just to use the DNS server you set up above:</p>



<pre class="wp-block-code"><code>set system name-server 10.32.0.1
commit
save</code></pre>



<p>This is also another spot where if you wanted to use Google, CloudFlare, or AD-DNS, you could plug in that IP:</p>



<figure class="wp-block-image size-large is-resized"><img src="https://blog.kroy.io/wp-content/uploads/2020/05/image-13.png" alt="" class="wp-image-779" width="760" height="276" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-13.png 760w, https://blog.kroy.io/wp-content/uploads/2020/05/image-13-300x109.png 300w" sizes="(max-width: 760px) 100vw, 760px" /></figure>



<p>Alternatively, you call tell VyOS to use the DNS servers that it received from your WAN DHCP server with:</p>



<pre class="wp-block-code"><code>set system name-servers-dhcp eth0</code></pre>



<p></p>



<hr class="wp-block-separator"/>



<h1>Firewall</h1>



<p>If you&#8217;ve made it this far, congrats!  We are almost there! </p>



<p>This section will cover the creation of a zone-based firewall, which is far superior to the default method of attaching firewalls to interfaces.  </p>



<p>The reason it is superior is simple.  It&#8217;s a bit more hassle to set up, but it&#8217;s far easier to manage on an ongoing basis, plus, you start thinking about firewalling as flows of information from interface to interface.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configuration mode</li><li>Create a firewall to allow all LAN traffic.</li><li>Create firewall to allow all LAN traffic to access VyOS itself.</li><li>Create a firewall to protect the router itself from WAN.</li><li>Create a firewall to protect LAN devices from WAN.</li><li>Commit</li><li>Create LOCAL/LAN zones.</li><li>Assign appropriate interfaces to zones.</li><li>Commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>For as complex as firewalling seems, it&#8217;s actually pretty simple when you break it down.  </p>



<p>A firewall tracks connection &#8220;states&#8221; to determine what is and is not allowed.  This is where packets are originating and going to, ports involved, types of traffic like TCP/UDP/ICMP, and more.  </p>



<p>We are going to build a very simple firewall that assumes that we want to block everything externally, and allow everything from LAN.</p>



<p>So let&#8217;s dig right into it.</p>



<hr class="wp-block-separator"/>



<h2>LAN</h2>



<p>First, create a firewall that will allow our LAN to access everything. This is a setup that would mimic what most consumer routers do:</p>



<pre class="wp-block-code"><code>conf
set firewall name LAN-WAN default-action accept
set firewall name LAN-LOCAL default-action accept
commit
save</code></pre>



<p>The <code>LAN-WAN</code> and the <code>LAN-LOCAL</code> can be arbitrarily named anything.  I use this naming scheme because as mentioned above, it&#8217;s better to think about firewalls as controlling the flow of information through the router, and these names are self-documenting.</p>



<p><code>LOCAL</code> is a specific VyOS designation that means &#8220;this router&#8221;.  When you are attaching the firewall in the zones, LOCAL will be what you use to control traffic destined to the firewall itself.  </p>



<p>As should be obvious, we are just allowing everything.  But you can set whatever rules you wanted.  <code>LAN-WAN</code> would generally remain pretty open as it would be uncommon to block your own access to the Internet, but <code>LAN-LOCAL</code> might contain rules to maybe allow only specific devices access to manage the VyOS router.</p>



<p>Also note that we are just creating the firewalls here.  They don&#8217;t become active until you attach them to the zones.</p>



<figure class="wp-block-image size-large"><img width="894" height="376" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-24.png" alt="" class="wp-image-740" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-24.png 894w, https://blog.kroy.io/wp-content/uploads/2020/04/image-24-300x126.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-24-768x323.png 768w" sizes="(max-width: 894px) 100vw, 894px" /></figure>



<hr class="wp-block-separator"/>



<h2>LOCAL</h2>



<p>As mentioned, the <code>LOCAL</code> zone is traffic destined for the VyOS router itself.  </p>



<p>In most cases, it will have a similar ruleset to the LAN one above, as most people want their router to have full access to the Internet and their LAN devices:</p>



<pre class="wp-block-code"><code>conf
set firewall name LOCAL-WAN default-action accept
set firewall name LOCAL-LAN default-action accept
commit
save</code></pre>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Food for Thought</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>While I might be getting a little ahead of myself here, it&#8217;s important to note that you could use the same firewall instead of creating four different firewalls as we&#8217;ve done here.  The firewalls are just attached to interfaces or zones by names, so there&#8217;s nothing really stopping you from creating a single firewall and attaching it to four different places.</p>
<p>As a bit of a pro-tip though, I would recommend not doing this.  Eventually you&#8217;ll want them broken out, and it&#8217;s far more of a hassle to do it later than to just do it during initial setup.<br />
</div></div>



<figure class="wp-block-image size-large"><img width="988" height="280" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-26.png" alt="" class="wp-image-743" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-26.png 988w, https://blog.kroy.io/wp-content/uploads/2020/04/image-26-300x85.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-26-768x218.png 768w" sizes="(max-width: 988px) 100vw, 988px" /></figure>



<hr class="wp-block-separator"/>



<h2>WAN</h2>



<p>The <code>WAN</code> zone is where we are actually going to do most of our work.  </p>



<p>The basic goal here will be two things.  To block all access to the router itself, and to provide basic setup and template for future things like port forwarding to our LAN.  </p>



<p>When you start moving data to and from the Internet, that&#8217;s when you need to start worrying about the state tracking I mentioned before.  </p>



<p>For both LOCAL and LAN traffic, we&#8217;ll be setting up what&#8217;s known as a &#8220;stateful firewall&#8221;.  </p>



<p>In stateful firewalling, there are three main states to worry about:</p>



<ul><li>New &#8211; Traffic in a <code>NEW</code> state is the first packet from a destination to a source.  Allowing or denying this packet ultimately determines whether the traffic will be allowed.</li><li>Established &#8211; Once traffic from <code>NEW</code> has been allowed, the subsequent packets are marked as <code>ESTABLISHED</code>.  This is essentially traffic that has already been allowed by other rules.  This is another basic requirement for a working stateful firewall.</li><li>Related &#8211; This means that this is traffic that is somehow related to already allowed traffic.  Also required.</li></ul>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">A note about rule numbers</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
As with the NAT rule numbers, the rule numbers you use for firewall are arbitrary.</p>
<p>With that said, it doesn&#8217;t mean you shouldn&#8217;t plan ahead a bit:</p>
<ul>
<li>Rules are processed numerically, so for fastest firewalling and routing, you definitely want your ESTABLISHED/RELATED rule at the top.  That ensures that existing traffic, which is going to be the bulk of the traffic your firewall processes, only has to look at a single rule.</li>
<li>Leave yourself some gaps for future rules.  You&#8217;ll appreciate it later if you want to insert a new rule before an existing one, though you can always rename and move around.</li>
</div></div>



<hr class="wp-block-separator"/>



<h3>WAN-LOCAL</h3>



<p>As mentioned, the <code>WAN-LOCAL</code> firewall is traffic destined for the VyOS router itself.  In the future, this will be where you allow traffic, say to your WireGuard port for VPN.</p>



<p>The first rule we want to build is to allow all <code>ESTABLISHED</code> and <code>RELATED</code> traffic.  So we&#8217;ll:</p>



<ul><li>Create the WAN-LOCAL firewall.  </li><li>Set the default policy on the firewall to drop everything.  </li><li>Create a rule to accept specific traffic for rule.</li><li>Set the match for the rule to our established and related states.</li><li>Set a description for ease of use later.</li></ul>



<p></p>



<pre class="wp-block-code"><code>set firewall name WAN-LOCAL default-action drop
set firewall name WAN-LOCAL rule 5 action accept
set firewall name WAN-LOCAL rule 5 state established enable
set firewall name WAN-LOCAL rule 5 state related enable
set firewall name WAN-LOCAL rule 5 description "Allow EST/Related Traffic"
commit
save</code></pre>



<figure class="wp-block-image size-large"><img width="1024" height="660" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-1024x660.png" alt="" class="wp-image-753" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-1024x660.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-300x193.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-768x495.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image.png 1232w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>The next rule we want on is to allow ICMP.  Many people like to block this, but not me.  I&#8217;ll defer to <a href="http://shouldiblockicmp.com/">ShouldIBlockICMP.com</a> on this.</p>



<ul><li>Create a new rule matching ICMP</li><li>Match the state of <code>NEW</code>. This is what actually matches the unknown traffic to allow</li><li>Allow the traffic</li><li>Commit and save</li></ul>



<pre class="wp-block-code"><code>set firewall name WAN-LOCAL rule 20 protocol icmp
set firewall name WAN-LOCAL rule 20 state new enable
set firewall name WAN-LOCAL rule 20 action accept
commit
save</code></pre>



<p>And you can see that the firewall is created (but still not attached to any interfaces), by doing the <code>op mode</code> command <code>show interfaces</code>.</p>



<figure class="wp-block-image size-large"><img width="1024" height="900" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-1-1024x900.png" alt="" class="wp-image-759" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-1-1024x900.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1-300x264.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1-768x675.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1.png 1176w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h3>WAN-LAN</h3>



<p>For now, the <code>WAN-LAN</code> firewall is identical to the <code>WAN-LOCAL</code>.  In the future, this is where you will allow your port forward rules, or other traffic you want to send to your LAN devices, so it&#8217;s helpful to break it out beforehand.</p>



<p>As before, we create the firewall, set it to drop by default, allowed EST/RELATED, and allow ICMP, which won&#8217;t do anything now, but could be helpful in the future:</p>



<pre class="wp-block-code"><code>set firewall name WAN-LAN default-action drop
set firewall name WAN-LAN rule 5 action accept
set firewall name WAN-LAN rule 5 state established enable
set firewall name WAN-LAN rule 5 state related enable
set firewall name WAN-LAN rule 5 description "Allow EST/Related Traffic"
set firewall name WAN-LAN rule 20 protocol icmp
set firewall name WAN-LAN rule 20 state new enable
set firewall name WAN-LAN rule 20 action accept</code></pre>



<p>Don&#8217;t forget you can dive down into levels as in the following example:</p>



<figure class="wp-block-image size-large"><img width="1002" height="672" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-2.png" alt="" class="wp-image-760" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-2.png 1002w, https://blog.kroy.io/wp-content/uploads/2020/05/image-2-300x201.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-2-768x515.png 768w" sizes="(max-width: 1002px) 100vw, 1002px" /></figure>



<hr class="wp-block-separator"/>



<p>Finally!  We have our firewalls set up and ready to deploy.  </p>



<hr class="wp-block-separator"/>



<h1>WAN and Zones</h1>



<p>If you&#8217;ve been paying attention, we still don&#8217;t have one <em>VERY</em> important piece to this puzzle. We still don&#8217;t have WAN access!</p>



<p>Of course I did this to protect your router during the initial setup phase.  Until you have firewalls ready to deploy, you probably don&#8217;t want to be kicking your brand new VyOS install out on the open Internet.  </p>



<hr class="wp-block-separator"/>



<h2>Zones</h2>



<p>Zones are easily one of my favorite parts of VyOS, and something that in my opinion, puts it lightyears ahead of other firewall solutions.</p>



<p>Especially as your firewalling needs grow, zones just make it so <em>EASY</em>.  As I sort of touched on, zones are a bit more work initially, but save you <em>MUCH</em> more time in the future.</p>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Lockout Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Be careful and pay attention here.  </p>
<p>If you mistype something and are still configuring VyOS over SSH, you can potentially lock yourself out.<br />
</div></div>



<p>The naming scheme as I&#8217;ve outlined above should be helpful here when creating our firewall zones.  It basically says <code>FROMZONE-&gt;TOZONE</code></p>



<p>So let&#8217;s run through the whole thing.  </p>



<p>Goals:</p>



<ul><li>Set the default action for the zone.  This should always be drop to cover yourself in case you miss something.</li><li>Apply the &#8220;For traffic from X zone to current zone, attach Y firewall&#8221;</li><li>Add the interfaces that are part of this zone</li><li>Repeat for all zones</li><li>commit</li><li>save</li></ul>



<hr class="wp-block-separator"/>



<p>So what does this look like for the LAN:</p>



<ul><li>In this example we are working on the LAN zone</li><li>We drop everything by default</li><li>We assign the <code>WAN-LAN</code> firewall to traffic from any interface in the below <code>WAN</code> zone</li><li>Similarly for the <code>LOCAL-LAN</code>.  This is traffic from the VyOS instance itself to LAN hosts.</li><li>We put <code>eth1</code> in our LAN zone.</li></ul>



<pre class="wp-block-code"><code>set zone-policy zone LAN default-action drop
set zone-policy zone LAN from WAN firewall name WAN-LAN
set zone-policy zone LAN from LOCAL firewall name LOCAL-LAN
set zone-policy zone LAN interface eth1


</code></pre>



<hr class="wp-block-separator"/>



<p>Repeat all steps for the <code>LOCAL</code> zone.  The major difference here is the <code>local-zone</code> designation.  As I&#8217;ve mentioned a few times, <code>LOCAL</code> is a special designation that means &#8220;this firewall&#8221;, so you don&#8217;t attach interfaces:</p>



<pre class="wp-block-code"><code>set zone-policy zone LOCAL local-zone
set zone-policy zone LOCAL from LAN firewall name LAN-LOCAL
set zone-policy zone LOCAL from WAN firewall name WAN-LOCAL
set zone-policy zone LOCAL default-action drop
</code></pre>



<hr class="wp-block-separator"/>



<p>Finally, the WAN zone is basically the same as the LAN zone. The only major change you should notice is that I just changed the firewall names and interface name:</p>



<pre class="wp-block-code"><code>set zone-policy zone WAN from LAN firewall name LAN-WAN
set zone-policy zone WAN from LOCAL firewall name LOCAL-WAN
set zone-policy zone WAN interface eth0
set zone-policy zone WAN default-action drop</code></pre>



<figure class="wp-block-image size-large"><img width="1024" height="676" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-4-1024x676.png" alt="" class="wp-image-766" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-4-1024x676.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4-300x198.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4-768x507.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4.png 1176w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>If you were like me, you might have tried committing between steps.  Unfortunately, if you don&#8217;t set up everything at once, you&#8217;ll quickly discover that zones are interdependent on one another.  This happens because I&#8217;ve created the LAN zone, but the referenced WAN and LOCAL zones don&#8217;t exist yet.</p>



<figure class="wp-block-image size-large"><img width="1024" height="528" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-3-1024x528.png" alt="" class="wp-image-765" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-3-1024x528.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3-300x155.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3-768x396.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3.png 1168w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h3>Show your work</h3>



<p>Hopefully, if you&#8217;ve done everything correctly, you should see all your zone policies set up under the <code>op mode</code> command <code>run show zone-policy</code>.  This view should make it obvious which traffic is flowing through what firewall:</p>



<figure class="wp-block-image size-large"><img width="838" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-6-838x1024.png" alt="" class="wp-image-768" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-6-838x1024.png 838w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6-245x300.png 245w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6-768x939.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6.png 872w" sizes="(max-width: 838px) 100vw, 838px" /></figure>



<hr class="wp-block-separator"/>



<h2>WAN Setup</h2>



<p>Finally, here we are.  </p>



<p>Setting up your WAN. If you&#8217;ve made it this far, congrats.  You are basically 1 or 2 commands away from having a working router and firewall!</p>



<p>There are multiple ways to get a WAN address.  For simplicity&#8217;s sake, I&#8217;ll just cover two of them here, static and DHCP assignment.  For something like PPPoE, you&#8217;ll need a few more steps.</p>



<h3>DHCP Assignment</h3>



<p>DHCP is when your router asks your ISP&#8217;s servers for what it should use for its IP address and routing information.  This is accomplished with one simple command (well, four if you add a description to the interface, and commit and save):</p>



<pre class="wp-block-code"><code>set interfaces ethernet eth0 address dhcp
set interfaces ethernet eth0 description WAN
commit
save</code></pre>



<p>You can verify that the setup is complete with the <code>op mode</code> commands <code>run show interfaces</code> and <code>run show ip route</code>.  (I have some debug variables set, so ignore the extra output:</p>



<figure class="wp-block-image size-large"><img width="988" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-8-988x1024.png" alt="" class="wp-image-773" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-8-988x1024.png 988w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-290x300.png 290w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-768x796.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-1482x1536.png 1482w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8.png 1490w" sizes="(max-width: 988px) 100vw, 988px" /></figure>



<p>In the above output, <code>10.21.21.57</code> is the IP address I was assigned via DHCP.  The <code>show ip route</code> verifies that I have a default route.</p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Information Dump</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Your &#8220;gateway&#8221; or default route, is the router your devices ask when they encounter an IP address that they don&#8217;t know how to get to.</p>
<p>In the networking world, this is represented by <em>0.0.0.0/0</em>, which is a shortcut for <strong><em>the entire Internet</em></strong></p>
<p>So in the above example, this VyOS knows how to talk directly to anything in the 10.21.21.0/24 or 10.32.0.0/24 subnets because they are directly connected.  Anything outside of that, it needs to ask 10.21.21.1 for a route to it.<br />
</div></div>



<h3>Static IP</h3>



<p>Static IPs just skip the automatic configuration.  It&#8217;s up to your ISP how this is configured, but usually it&#8217;s an extra step, manually applying your default route.</p>



<p>So to duplicate my above DHCP configuration:</p>



<pre class="wp-block-code"><code>set interfaces ethernet eth0 address 10.21.21.57/24
set protocols static route 0.0.0.0/0 next-hop 10.21.21.1
commit
save</code></pre>



<p>As you can see in the following screenshot, I forgot the exact format, so I hit my <code>&lt;TAB&gt;</code> button to get hints:</p>



<figure class="wp-block-image size-large"><img width="881" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-12-881x1024.png" alt="" class="wp-image-778" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-12-881x1024.png 881w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12-258x300.png 258w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12-768x893.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12.png 1106w" sizes="(max-width: 881px) 100vw, 881px" /></figure>



<h3>Check your work</h3>



<p>Assuming nothing has gone wrong, you should be able to verify everything with the <code>op mode</code> command <code>ping</code>.  So let&#8217;s hit Google with 4 pings:</p>



<p><code>run ping www.google.com count 4</code></p>



<p>If all goes well, you should see a response:</p>



<figure class="wp-block-image size-large"><img width="1024" height="264" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-9-1024x264.png" alt="" class="wp-image-774" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-9-1024x264.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9-300x77.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9-768x198.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9.png 1290w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h1>Conclusion</h1>



<p>So wow, this post turned into a bit of a novel.  Hopefully if you&#8217;ve made it this far, your LAN clients now have accessible Internet. From a client, you should be able to ping google:</p>



<figure class="wp-block-image size-large"><img width="1024" height="402" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-14-1024x402.png" alt="" class="wp-image-783" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-14-1024x402.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14-300x118.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14-768x302.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14.png 1416w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>Obviously there are a lot of basic topics I haven&#8217;t covered yet.  But I wanted to lay out and explain the basic setup first.  </p>



<p>Future editions will feature:</p>



<ul><li>Port Forwarding.</li><li>Hairpin NAT (this goes hand-in-hand with the first).</li><li>VPNs, especially WireGuard</li><li>How routing works when you have VPNs.</li><li>Some potential hardening tactics.</li><li>Other advanced topics like BGP/OSPF.</li></ul>



<p>Cheers!</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">593</post-id>	</item>
		<item>
		<title>A Baby WYSE, the 3040</title>
		<link>https://blog.kroy.io/2020/01/17/the-baby-wyse-the-dell-3040/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-baby-wyse-the-dell-3040</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Fri, 17 Jan 2020 17:30:58 +0000</pubDate>
				<category><![CDATA[Hardware]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[dell]]></category>
		<category><![CDATA[wireguard]]></category>
		<category><![CDATA[wysebaby]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=539</guid>

					<description><![CDATA[Ever since my successful adventure with the WYSE J5005, I fell in love with these little thin clients. So when the opportunity arose to pick up a baby one for&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Ever since my successful adventure with the <a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/">WYSE J5005</a>, I fell in love with these little thin clients.  So when the opportunity arose to pick up a baby one for $30, I pounced on it.</p>





<h2>The Path to Another WYSE</h2>



<p>I love my <a href="https://amzn.to/2tjOisW">WYSE 5070</a>.  That little box is so much power stuffed into a tiny little form factor.  And as I outlined in my <a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/">last review</a>, it sips power, averaging about 7.5 watts under normal load.</p>



<p>Although I initially threw <a href="https://vyos.io/">VyOS</a> on it, I don&#8217;t really have a need for another dedicated router right now.  So the duties of the box shifted, and it became the charter member of a newly minted Proxmox cluster, where it&#8217;s actually running a backup routing VyOS instance:</p>



<figure class="wp-block-image size-large"><img width="1024" height="443" src="https://blog.kroy.io/wp-content/uploads/2020/01/j5005-1024x443.png" alt="" class="wp-image-547" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/j5005-1024x443.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-300x130.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-768x332.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-1536x664.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-850x368.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005.png 1949w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>wyse5070 running primary DC, backup routing, and random Debian instance</figcaption></figure>



<p>When the opportunity came to pick up a WYSE3040, I absolutely jumped on it.  Especially when it was less than a cost of a Raspberry Pi.  </p>



<hr class="wp-block-separator"/>



<h2>Dell WYSE 3040</h2>



<p>So when I got the 3040, I didn&#8217;t realize how SMALL it would be.  I mean, this thing is downright <strong><em>TINY</em></strong>:</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-1024x768.jpg" alt="" class="wp-image-542" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>I didn&#8217;t have a banana, so this is the size compared to an SSD.</figcaption></figure>



<p>As pictured, the thing has a footprint that&#8217;s only slightly bigger than an SSD. </p>



<p>Even at that size, it has a surprising amount of ports:</p>



<figure class="wp-block-image size-large"><img width="1024" height="494" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-5-1024x494.png" alt="" class="wp-image-552" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-5-1024x494.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5-300x145.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5-768x371.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5-850x410.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5.png 1481w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>headphone jack, usb2, usb3</figcaption></figure>



<figure class="wp-block-image size-large"><img width="1024" height="498" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-4-1024x498.png" alt="" class="wp-image-551" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-4-1024x498.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4-300x146.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4-768x374.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4-850x414.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4.png 1519w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>power, dual displayport, USB2, ethernet</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>The Guts</h2>



<p>I don&#8217;t know why, but I alway feel a driving <em>NEED</em> to open up my new toys.  It&#8217;s a disease. And this thing was no exception.</p>



<p>With the bottom of the case off, it has an open spot for a WiFi card.  With the limited storage space in this sucker, at some point I&#8217;m going to research if I can drop an M2 SSD in there:</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-1024x768.jpg" alt="" class="wp-image-541" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>bottom of case off</figcaption></figure>



<p>Once the device is fully extricated from its case, there&#8217;s really not much to look at.  Just a huge heatsink that covers most of the top of the motherboard:</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-1024x768.jpg" alt="" class="wp-image-540" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>fully out</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>The Specs</h2>



<p>While the WYSE5070 is a powerhouse in a tiny form-factor, this 3040 is a bit more&#8230; modest. </p>



<ul><li>Atom x5-Z8350 Processor</li><li>2GB of DDR3L RAM (soldered on)</li><li>8GB of eMMC (soldered on)</li><li>Gigabit Realtek NIC (RTL8111/8168/8411)</li></ul>



<figure class="wp-block-image size-large"><img width="896" height="516" src="https://blog.kroy.io/wp-content/uploads/2020/01/image.png" alt="" class="wp-image-545" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image.png 896w, https://blog.kroy.io/wp-content/uploads/2020/01/image-300x173.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-768x442.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-850x490.png 850w" sizes="(max-width: 896px) 100vw, 896px" /><figcaption>system stats</figcaption></figure>



<p>Like I said.  Pretty modest specs. And the small RAM and storage space somewhat limit the options.  The eMMC is particularly painful as that kind of flash is REALLY not designed for general usage.  I&#8217;ll probably end up using a SATA SSD over a sata-wire. </p>



<hr class="wp-block-separator"/>



<h2>VyOS</h2>



<p>So one of the first things I usually do with a new device is toss VyOS on it.  I&#8217;m a huge VyOS enthustiast, evangelist, and as mentioned recently, now maintainer.</p>



<p> Unfortunately on this device, the VyOS installer died on a black screen.  But during the course of doing this write-up, I took another look at it, and  discovered the reason for this. GRUB tries to pass the output to a non-existent serial port.  While I&#8217;ve had other devices that lacked serial ports that installer didn&#8217;t care about, on this one it refused to boot.  So I just had to edit the grub boot line to remove the serial information. </p>



<p>Also, the 1.3 line of VyOS had a broken UEFI installer since release due to a change in Debian Buster, but I recently fixed that as well.  </p>



<p>So expect a VyOS write-up on this forthwith.</p>



<hr class="wp-block-separator"/>



<h2>Testing</h2>



<p>For testing, I just installed Ubuntu 18.04 or 19.10 I think.  Whatever ISO I had stuck on a USB at the time. </p>



<p>The space on the device is obviously a very real concern.  Not to mention, as I said, the eMMC probably wouldn&#8217;t stand up very long to even minor usage without some hacks.  2.1G available with a fairly minimal install + WireGuard.</p>



<pre class="wp-block-code"><code>Filesystem      Size  Used Avail Use% Mounted on
udev            909M     0  909M   0% /dev
tmpfs           190M  1.4M  189M   1% /run
/dev/mmcblk0p2  6.7G  4.2G  2.1G  68% /
tmpfs           950M     0  950M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           950M     0  950M   0% /sys/fs/cgroup
/dev/loop0       90M   90M     0 100% /snap/core/8268
/dev/mmcblk0p1  511M  7.8M  504M   2% /boot/efi
/dev/loop1       55M   55M     0 100% /snap/lxd/12211
/dev/loop2       90M   90M     0 100% /snap/core/7917
/dev/loop3       55M   55M     0 100% /snap/lxd/12631
tmpfs           190M     0  190M   0% /run/user/1000
</code></pre>



<p>Obviously I could probably get that a lot leaner if I went with something like Alpine or Arch.</p>



<p>A basic iperf3 to a different host on my network shows gigabit speeds:</p>



<pre class="wp-block-code"><code>&#091;SUM]   0.00-10.00  sec  1.09 GBytes   934 Mbits/sec    0             sender
&#091;SUM]   0.00-10.00  sec  1.08 GBytes   931 Mbits/sec                  receiver
</code></pre>



<p>with moderate CPU usage:</p>



<figure class="wp-block-image size-large"><img width="1024" height="96" src="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-1024x96.png" alt="" class="wp-image-556" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-1024x96.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-300x28.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-768x72.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-850x80.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg.png 1200w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>cpu usage during iperf3</figcaption></figure>



<p>And firing up WireGuard and running an iperf3, show slightly less speed</p>



<pre class="wp-block-code"><code>&#091;SUM]   0.00-10.00  sec   991 MBytes   831 Mbits/sec    0             sender
&#091;SUM]   0.00-10.01  sec   988 MBytes   828 Mbits/sec                  receiver
</code></pre>



<p>And lots more CPU:</p>



<figure class="wp-block-image size-large"><img width="1024" height="101" src="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-1024x101.png" alt="" class="wp-image-557" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-1024x101.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-300x30.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-768x76.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-850x84.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg.png 1375w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>cpu usage during WireGuard iperf3</figcaption></figure>



<p></p>



<hr class="wp-block-separator"/>



<h2>Power Consumption</h2>



<p>The power consumption is where this thing really shines.  Again, sorry for the potato pic, I just have a terrible time getting a decent picture of my kill-a-watt with a dying screen.  4.1 watts at idle:</p>



<figure class="wp-block-image size-large"><img width="1024" height="779" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-1-1024x779.png" alt="" class="wp-image-548" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-1-1024x779.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1-300x228.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1-768x584.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1-850x646.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1.png 1164w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>potato pic, idle power consumption 4.1 watts</figcaption></figure>



<p>And 7.3 watts under WireGuard:</p>



<figure class="wp-block-image size-large"><img width="1024" height="733" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-2-1024x733.png" alt="" class="wp-image-549" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-2-1024x733.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2-300x215.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2-768x550.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2-850x608.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2.png 1266w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>potato pic, WireGuard at full speed, 7.3 watts</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>In all, this is a great little device for projects.  I might turn it into a DNS server or something.  For a lower speed network, I can also see it making a great little router.  I could see the CPU crumbling under heavy load that was coming from more than just a handful of streams.</p>



<p>For the $30 I paid for it, it can definitely replace a Raspberry Pi for me.  And it will be even more useful if I can drop an M2 SSD into that WiFi slot.</p>



<p></p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">539</post-id>	</item>
		<item>
		<title>The WYSE 5070, a perfect little VyOS device</title>
		<link>https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-wyse-5070-a-perfect-little-vyos-device</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Sun, 08 Dec 2019 16:34:04 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[dell]]></category>
		<category><![CDATA[wireguard]]></category>
		<category><![CDATA[wysebaby]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=497</guid>

					<description><![CDATA[As a bit of a networking nerd, I&#8217;m always on the hunt for cheap and powerful hardware that I can toss VyOS on. The WYSE 5070 thin client is my&#8230;]]></description>
										<content:encoded><![CDATA[
<p>As a bit of a networking nerd, I&#8217;m always on the hunt for cheap and powerful hardware  that I can toss VyOS on.  The WYSE 5070 thin client is my latest find.  </p>



<hr class="wp-block-separator"/>





<p>For a while now, I&#8217;ve been looking for a replacement to a <a href="https://amzn.to/350TPC0">Supermicro E200-9B</a> that I had an &#8220;accident&#8221; with.  By &#8220;accident&#8221;, I mean I killed the box by messing around on it with a FlashCat.  </p>



<p>I wanted something that was similarly low power usage, and I wasn&#8217;t really looking to spend too much, especially since it was my own silliness that killed the last one.</p>



<h2>The Hardware</h2>



<p>After a bit of hunting, I found the Dell WYSE 5070.  </p>



<p>This is a Intel Pentium Silver DDR4 platform based on the J5005.  There are two versions, the thin and the thick version, with the latter having room for a PCIe card.  I found some for $60 locally, but they can easily be found online for only a little more.  </p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-1024x768.jpg" alt="" class="wp-image-500" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>front</figcaption></figure>



<p>The versions I bought were the thin version, which only have a single Realtek NIC.  But they have USB-C on the front, which means a second gigabit NIC can easily be added.  And as I&#8217;m running VyOS, Realtek NICs aren&#8217;t a problem at all.</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-1024x768.jpg" alt="" class="wp-image-501" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>rear</figcaption></figure>



<h4>The Goods</h4>



<p>Inside, the version I have came with:</p>



<ul><li>A single Realtek NIC.  This isn&#8217;t a problem for me because I have a managed switch for router-on-a-stick.</li><li>Three DisplayPorts</li><li>A variety of USB ports.  Don&#8217;t ask me about revisions as that USB naming scheme is a mess that I can&#8217;t be bothered to look up.  I do know there is a USB-C port at 5Gbps.  The other USB ports are blue, meaning better than USB2.0.</li><li>Serial port.  It would have been nice to turn this into a console redirection port for a sort of out-of-band access, but I couldn&#8217;t figure it out.</li><li>16GB eMMC storage.  I&#8217;m pretty sure I could just install straight to this, but for now I wanted to leave it intact in case I wanted to play with ThinOS. Though I do know that it&#8217;s generally recommended to skip eMMC storage for anything that might do lots of writes, like a firewall logging a bunch.</li><li>4GB of DDR4 RAM.  Officially these only support 8GB, but I added another 8GB for a total of 12GB.  <s>Apparently 16GB and even possible 32GB will work, which I have sticks for, but I haven&#8217;t had a chance to rearrange things to test.</s> Confirmed.  Currently running 32GB in it without an issue. </li><li>To further revise, it looks like it might be picky about 16GB chips.  I currently have <a href="https://amzn.to/31tosRm">CT16G4SFD8213</a> in mine.</li><li>An M.2 storage slot.  I tossed a Crucial MX500 in here because eventually this thing might become a tiny VM Host. Plus, I got it cheap on Black Friday.</li></ul>



<p>A peek inside and this thing is surprisingly expandable.  </p>



<ul><li>Towards the left, you see the blue USB internal header that could be used for an internal USB drive.</li><li>The top has the unused M.2 WiFi slot.</li><li>Above the battery, you can see the PCIe header which would be populated if this was the thick version of the box.</li><li>And then of course the M.2 SSD and extra RAM that I added.</li></ul>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-1024x768.jpg" alt="" class="wp-image-502" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>the guts</figcaption></figure>



<h4>Power Consumption</h4>



<p>The idle power consumption on this device is amazing:</p>



<figure class="wp-block-image size-large"><img width="1324" height="1300" src="https://i1.wp.com/blog.kroy.io/wp-content/uploads/2019/12/image.png?fit=640%2C628&amp;ssl=1" alt="" class="wp-image-505" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/image.png 1324w, https://blog.kroy.io/wp-content/uploads/2019/12/image-300x295.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1024x1005.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/image-768x754.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/image-850x835.png 850w" sizes="(max-width: 1324px) 100vw, 1324px" /><figcaption>killawatt</figcaption></figure>



<p>The highest usage I saw was during boot where it hit a whopping 15 watts.  Oh, and I&#8217;m dangling an additional SSD off a <a href="https://amzn.to/2RsiI5W">SATA wire</a> to use temporarily as a boot drive since I was doing other testing with this server, so that 5.7 watts includes this guy:</p>



<figure class="wp-block-image size-large"><img width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-1024x768.jpg" alt="" class="wp-image-506" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>sata wire</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>VyOS</h2>



<p>Installing VyOS is pretty standard.  In this case, I just used Etcher to put the latest <a href="https://downloads.vyos.io/?dir=rolling/current/amd64">VyOS Rolling ISO</a> on a USB, and ran through the quick install.  </p>



<p>As mentioned above, I&#8217;m just doing a <a href="https://en.wikipedia.org/wiki/One-armed_router">router-on-a-stick</a> setup with the single onboard NIC, but I also tested out a <a href="https://amzn.to/2YoMABk">USB-C Gigabit Ethernet adapter</a> and it worked identically.</p>



<h4>Config</h4>



<p>The config I used was almost verbatim from the <a href="https://vyos.readthedocs.io/en/latest/quick-start.html">VyOS Quick Start Guide</a>, except I&#8217;m using VLANs and a static WAN IP. In my case, VLAN10 is the &#8220;WAN&#8221; and VLAN2222 is my test LAN here.  </p>



<pre class="wp-block-code"><code>firewall {
    all-ping enable
    broadcast-ping disable
    config-trap disable
    ipv6-receive-redirects disable
    ipv6-src-route disable
    ip-src-route disable
    log-martians enable
    name OUTSIDE-IN {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
    }
    name OUTSIDE-LOCAL {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
        rule 20 {
            action accept
            icmp {
                type-name echo-request
            }
            protocol icmp
            state {
                new enable
            }
        }
        rule 30 {
            action drop
            destination {
                port 22
            }
            protocol tcp
            recent {
                count 4
                time 60
            }
            state {
                new enable
            }
        }
        rule 31 {
            action accept
            destination {
                port 22
            }
            protocol tcp
            state {
                new enable
            }
        }
    }
    receive-redirects disable
    send-redirects enable
    source-validation disable
    syn-cookies enable
    twa-hazards-protection disable
}
interfaces {
    ethernet eth0 {
        duplex auto
        hw-id 6c:2b:59:3c:f7:4e
        smp-affinity auto
        speed auto
        vif 10 {
            address 10.0.10.234/24
            firewall {
                in {
                    name OUTSIDE-IN
                }
                local {
                    name OUTSIDE-LOCAL
                }
            }
        }
        vif 2222 {
            address 10.222.222.1/24
        }
    }
    loopback lo {
    }
    wireguard wg0 {
        address 10.172.24.60/24
        peer edge {
            allowed-ips 10.172.24.1/32
            endpoint 10.0.10.1:2224
            pubkey ****************
        }
    }
}
nat {
    source {
        rule 100 {
            outbound-interface eth0.10
            source {
                address 10.222.222.0/24
            }
            translation {
                address masquerade
            }
        }
    }
}
protocols {
    static {
        route 0.0.0.0/0 {
            next-hop 10.0.10.1 {
            }
        }
    }
}
service {
    dhcp-server {
        shared-network-name LAN {
            subnet 10.222.222.0/24 {
                default-router 10.222.222.1
                dns-server 10.53.53.53
                domain-name internal-network
                lease 86400
                range 0 {
                    start 10.222.222.98
                    stop 10.222.222.200
                }
            }
        }
    }
    ssh {
        port 22
    }
}
system {
    config-management {
        commit-revisions 100
    }
    console {
        device ttyS0 {
            speed 9600
        }
    }
    host-name vyos
    login {
        user vyos {
            authentication {
                encrypted-password ****************
                plaintext-password ****************
            }
            level admin
        }
    }
    name-server 10.53.53.53
    ntp {
        server 0.pool.ntp.org {
        }
        server 1.pool.ntp.org {
        }
        server 2.pool.ntp.org {
        }
    }
    syslog {
        global {
            facility all {
                level info
            }
            facility protocols {
                level debug
            }
        }
    }
    time-zone UTC
}
</code></pre>



<hr class="wp-block-separator"/>



<h3>Tests</h3>



<p>I ran a number of different tests to try and show how this thing might perform in real world usage.  </p>



<h4>Speedtest</h4>



<p>The first test was just a normal speedtest.  If someone were going to install this for their primary firewall and router, this is probably the first thing they would do:</p>



<figure class="wp-block-image size-large"><img width="576" height="126" src="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest.png" alt="" class="wp-image-513" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest.png 576w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-300x66.png 300w" sizes="(max-width: 576px) 100vw, 576px" /><figcaption>basically gigabit speedtest</figcaption></figure>



<p>As I&#8217;ve mentioned a <a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/">few other times</a>, this is basically gigabit on my network.  And what was the CPU doing during this?</p>



<figure class="wp-block-image size-large"><img width="1024" height="215" src="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-1024x215.png" alt="" class="wp-image-512" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-1024x215.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-300x63.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-768x161.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-850x179.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu.png 1446w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>70% on a single core with a speedtest</figcaption></figure>



<p>With about ~70% usage on a single core out of four, this little J5005 doesn&#8217;t do too terribly.</p>



<h4>File Copy &#8211; CIFS</h4>



<p>For this test, I copied a single large file from a fileserver elsewhere on my network over an CIFS mounted share.</p>



<figure class="wp-block-image size-large"><img width="933" height="276" src="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy.png" alt="" class="wp-image-510" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy.png 933w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-300x89.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-768x227.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-850x251.png 850w" sizes="(max-width: 933px) 100vw, 933px" /><figcaption>copying at over 750Mbps</figcaption></figure>



<p>97.2MB/s or 777Mbps is pretty admirable for a simple file copy.</p>



<p>And the CPU usage on the WYSE 5070 during the copy:</p>



<figure class="wp-block-image size-large"><img width="1024" height="143" src="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-1024x143.png" alt="" class="wp-image-509" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-1024x143.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-300x42.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-768x107.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-850x118.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu.png 1529w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Again, with only 60% usage of a single core, I think that shows this thing has lots of room for growth.</p>



<h4>Simple iperf3</h4>



<p>A simple <code>iperf3</code> gives us gigabit performance:</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ iperf3 -c 10.0.10.1 -P2
Connecting to host 10.0.10.1, port 5201
&#091;  4] local 10.0.10.234 port 32910 connected to 10.0.10.1 port 5201
&#091;  6] local 10.0.10.234 port 32912 connected to 10.0.10.1 port 5201
&#091; ID] Interval           Transfer     Bandwidth       Retr  Cwnd
&#091;  4]   0.00-1.00   sec  57.2 MBytes   480 Mbits/sec    0    209 KBytes
&#091;  6]   0.00-1.00   sec  56.9 MBytes   478 Mbits/sec    0    198 KBytes
&#091;SUM]   0.00-1.00   sec   114 MBytes   958 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   1.00-2.00   sec  55.9 MBytes   469 Mbits/sec    0    209 KBytes
&#091;  6]   1.00-2.00   sec  55.7 MBytes   467 Mbits/sec    0    198 KBytes
&#091;SUM]   1.00-2.00   sec   112 MBytes   936 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   2.00-3.00   sec  56.1 MBytes   471 Mbits/sec    0    209 KBytes
&#091;  6]   2.00-3.00   sec  56.1 MBytes   471 Mbits/sec    0    198 KBytes
&#091;SUM]   2.00-3.00   sec   112 MBytes   941 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   3.00-4.00   sec  55.7 MBytes   467 Mbits/sec    0    209 KBytes
&#091;  6]   3.00-4.00   sec  56.1 MBytes   471 Mbits/sec    0    223 KBytes
&#091;SUM]   3.00-4.00   sec   112 MBytes   938 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   4.00-5.00   sec  54.3 MBytes   456 Mbits/sec    1    228 KBytes
&#091;  6]   4.00-5.00   sec  58.2 MBytes   488 Mbits/sec    0    240 KBytes
&#091;SUM]   4.00-5.00   sec   113 MBytes   944 Mbits/sec    1
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   5.00-6.00   sec  54.7 MBytes   459 Mbits/sec    0    228 KBytes
&#091;  6]   5.00-6.00   sec  56.9 MBytes   477 Mbits/sec   45    240 KBytes
&#091;SUM]   5.00-6.00   sec   112 MBytes   936 Mbits/sec   45
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   6.00-7.00   sec  53.8 MBytes   451 Mbits/sec    0    228 KBytes
&#091;  6]   6.00-7.00   sec  57.7 MBytes   484 Mbits/sec    0    240 KBytes
&#091;SUM]   6.00-7.00   sec   111 MBytes   935 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   7.00-8.00   sec  54.2 MBytes   455 Mbits/sec    0    228 KBytes
&#091;  6]   7.00-8.00   sec  58.2 MBytes   488 Mbits/sec    0    240 KBytes
&#091;SUM]   7.00-8.00   sec   112 MBytes   942 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   8.00-9.00   sec  52.2 MBytes   438 Mbits/sec    0    230 KBytes
&#091;  6]   8.00-9.00   sec  59.8 MBytes   502 Mbits/sec    0    247 KBytes
&#091;SUM]   8.00-9.00   sec   112 MBytes   940 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   9.00-10.00  sec  51.7 MBytes   434 Mbits/sec    0    230 KBytes
&#091;  6]   9.00-10.00  sec  59.8 MBytes   501 Mbits/sec    0    247 KBytes
&#091;SUM]   9.00-10.00  sec   111 MBytes   935 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091; ID] Interval           Transfer     Bandwidth       Retr
&#091;  4]   0.00-10.00  sec   546 MBytes   458 Mbits/sec    1             sender
&#091;  4]   0.00-10.00  sec   545 MBytes   457 Mbits/sec                  receiver
&#091;  6]   0.00-10.00  sec   575 MBytes   483 Mbits/sec   45             sender
&#091;  6]   0.00-10.00  sec   574 MBytes   482 Mbits/sec                  receiver
&#091;SUM]   0.00-10.00  sec  1.09 GBytes   941 Mbits/sec   46             sender
&#091;SUM]   0.00-10.00  sec  1.09 GBytes   939 Mbits/sec                  receiver
</code></pre>



<p>And similar CPU usage to the other tests, 50% usage on a single core:</p>



<figure class="wp-block-image size-large"><img width="1024" height="157" src="https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-1024x157.png" alt="" class="wp-image-511" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-1024x157.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-300x46.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-768x117.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-850x130.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu.png 1518w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>50% usage on a single core</figcaption></figure>



<h4>WireGuard</h4>



<p>If you read through the config above, you&#8217;ll notice I dropped in the config for a WireGuard tunnel to my main router.</p>



<p>Even though WireGuard isn&#8217;t 100% vetted yet, it&#8217;s enough that I believe it will be officially part of the Linux kernel soon.   And hopefully these results will demonstrate why:</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ iperf3 -c 10.172.24.1 -P2
Connecting to host 10.172.24.1, port 5201
&#091;  4] local 10.172.24.60 port 36752 connected to 10.172.24.1 port 5201
&#091;  6] local 10.172.24.60 port 36754 connected to 10.172.24.1 port 5201
&#091; ID] Interval           Transfer     Bandwidth       Retr  Cwnd
&#091;  4]   0.00-1.00   sec  54.3 MBytes   456 Mbits/sec    0    281 KBytes
&#091;  6]   0.00-1.00   sec  53.9 MBytes   452 Mbits/sec    0    283 KBytes
&#091;SUM]   0.00-1.00   sec   108 MBytes   908 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   1.00-2.00   sec  53.5 MBytes   449 Mbits/sec    0    281 KBytes
&#091;  6]   1.00-2.00   sec  53.5 MBytes   449 Mbits/sec    0    283 KBytes
&#091;SUM]   1.00-2.00   sec   107 MBytes   898 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   2.00-3.00   sec  53.5 MBytes   449 Mbits/sec    0    293 KBytes
&#091;  6]   2.00-3.00   sec  53.5 MBytes   449 Mbits/sec    0    283 KBytes
&#091;SUM]   2.00-3.00   sec   107 MBytes   898 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   3.00-4.00   sec  53.7 MBytes   451 Mbits/sec    0    293 KBytes
&#091;  6]   3.00-4.00   sec  53.7 MBytes   450 Mbits/sec    0    283 KBytes
&#091;SUM]   3.00-4.00   sec   107 MBytes   901 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   4.00-5.00   sec  53.3 MBytes   447 Mbits/sec    0    293 KBytes
&#091;  6]   4.00-5.00   sec  53.4 MBytes   448 Mbits/sec    0    310 KBytes
&#091;SUM]   4.00-5.00   sec   107 MBytes   895 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   5.00-6.00   sec  53.3 MBytes   448 Mbits/sec    0    293 KBytes
&#091;  6]   5.00-6.00   sec  53.3 MBytes   447 Mbits/sec    0    310 KBytes
&#091;SUM]   5.00-6.00   sec   107 MBytes   895 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   6.00-7.00   sec  53.7 MBytes   451 Mbits/sec    0    293 KBytes
&#091;  6]   6.00-7.00   sec  53.6 MBytes   450 Mbits/sec    0    310 KBytes
&#091;SUM]   6.00-7.00   sec   107 MBytes   900 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   7.00-8.00   sec  53.0 MBytes   444 Mbits/sec    0    293 KBytes
&#091;  6]   7.00-8.00   sec  53.0 MBytes   444 Mbits/sec    0    310 KBytes
&#091;SUM]   7.00-8.00   sec   106 MBytes   889 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   8.00-9.00   sec  54.0 MBytes   453 Mbits/sec    0    415 KBytes
&#091;  6]   8.00-9.00   sec  53.8 MBytes   451 Mbits/sec    0    415 KBytes
&#091;SUM]   8.00-9.00   sec   108 MBytes   904 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091;  4]   9.00-10.00  sec  53.5 MBytes   449 Mbits/sec    0    415 KBytes
&#091;  6]   9.00-10.00  sec  54.0 MBytes   453 Mbits/sec    0    415 KBytes
&#091;SUM]   9.00-10.00  sec   107 MBytes   902 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
&#091; ID] Interval           Transfer     Bandwidth       Retr
&#091;  4]   0.00-10.00  sec   536 MBytes   450 Mbits/sec    0             sender
&#091;  4]   0.00-10.00  sec   535 MBytes   449 Mbits/sec                  receiver
&#091;  6]   0.00-10.00  sec   536 MBytes   449 Mbits/sec    0             sender
&#091;  6]   0.00-10.00  sec   534 MBytes   448 Mbits/sec                  receiver
&#091;SUM]   0.00-10.00  sec  1.05 GBytes   899 Mbits/sec    0             sender
&#091;SUM]   0.00-10.00  sec  1.04 GBytes   897 Mbits/sec                  receiver
</code></pre>



<p>Getting 900Mbps on a $60 thin client?  That&#8217;s pretty amazing in my book.  </p>



<p>Finally we are stressing the CPU a bit, 60%, 35%, 25%, 25% on the various cores:</p>



<figure class="wp-block-image size-large"><img width="1024" height="154" src="https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-1024x154.png" alt="" class="wp-image-514" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-1024x154.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-300x45.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-768x116.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-850x128.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu.png 1476w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>all core usage</figcaption></figure>



<p>I think the screen on my kill-a-watt is dying as I&#8217;m having a heck of a time photographing it.  But this 12.7 watts is the power usage when testing WireGuard, which is about the most amount of stress I was able to put on this little server:</p>



<figure class="wp-block-image size-large"><img width="1394" height="1152" src="https://i2.wp.com/blog.kroy.io/wp-content/uploads/2019/12/image-1.png?fit=640%2C529&amp;ssl=1" alt="" class="wp-image-515" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/image-1.png 1394w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-300x248.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-1024x846.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-768x635.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-850x702.png 850w" sizes="(max-width: 1394px) 100vw, 1394px" /><figcaption>12.7 watts</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>It&#8217;s amazing that these things are going for only <strong><em>$60</em></strong>. Well, a bit more since I added the extra drive and RAM.  And this is for hardware that according to Dell, was manufactured in March of 2019.  Practically brand new!</p>



<p>For the price and feature set, I would <em><strong>DEFINITELY</strong></em> recommend this device for anyone looking for a capable VyOS host.  I&#8217;m really tempted to try and source a thick version now so I can toss a 10 gigabit NIC in one and see how it performs.</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">497</post-id>	</item>
	</channel>
</rss>
