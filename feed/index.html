<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>blog.kroy.io</title>
	<atom:link href="https://blog.kroy.io/feed/" rel="self" type="application/rss+xml" />
	<link>https://blog.kroy.io/</link>
	<description>computers, tech, and whatever other random stuff crosses my mind.</description>
	<lastBuildDate>Tue, 03 Nov 2020 15:00:02 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.5.3</generator>

<image>
	<url>https://blog.kroy.io/wp-content/uploads/2020/04/cropped-android-chrome-512x512-3-32x32.png</url>
	<title>blog.kroy.io</title>
	<link>https://blog.kroy.io/</link>
	<width>32</width>
	<height>32</height>
</image> 
<site xmlns="com-wordpress:feed-additions:1">166765678</site>	<item>
		<title>ESXi to Libvirt, now with more Terraform.</title>
		<link>https://blog.kroy.io/2020/11/03/esxi-to-libvirt-now-with-more-terraform/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=esxi-to-libvirt-now-with-more-terraform</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Tue, 03 Nov 2020 14:59:57 +0000</pubDate>
				<category><![CDATA[Automation]]></category>
		<category><![CDATA[KVM]]></category>
		<category><![CDATA[Terraform]]></category>
		<category><![CDATA[Ubuntu]]></category>
		<category><![CDATA[Virtualization]]></category>
		<category><![CDATA[ansible]]></category>
		<category><![CDATA[kvm]]></category>
		<category><![CDATA[migration]]></category>
		<category><![CDATA[terraform]]></category>
		<category><![CDATA[vmware]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=894</guid>

					<description><![CDATA[Over the years, my homelab has expanded and contracted multiple times. As I am heavy into automation now and downsizing a bit, it was time to fully ditch VMWare. Introduction&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Over the years, my homelab has expanded and contracted multiple times.  As I am heavy into automation now and downsizing a bit, it was time to fully ditch VMWare.</p>



<hr class="wp-block-separator"/>





<h2>Introduction</h2>



<p>For some reason, it seems I am never happy with my lab.  For years now, I&#8217;ve constantly tore it up, started from scratch, migrated, <a rel="noreferrer noopener" href="https://blog.kroy.io/2017/06/30/migrating-the-lab-back-to-esxi-after-a-proxmox-experiment/" data-type="post" data-id="23" target="_blank">migrated back</a>, and more.  Up until recently, I had ESXi, Proxmox, libvirt, and even some HyperV in another VM for testing.  All these systems played different roles, even if they are just for learning.</p>



<p>By far, I&#8217;ve been running ESXi+vCenter the longest, and it would be considered my &#8220;primary&#8221; cluster.  When you have multiple hosts, heavy networking with stuff like vDS, want HA (high availability), it&#8217;s hard to argue that the vSphere suite doesn&#8217;t automate it and make it somewhat painless. </p>



<p>But now things have changed. I&#8217;m looking to combine and contract my lab, and more tightly integrate LXD/C and automation. I decided it was time to complete the migration completely away from VMWare products, especially since I&#8217;ve already sold/powered down/eliminated 3 out of the original 5 hosts in my cluster.   </p>



<p>Don&#8217;t get me wrong, with VMUG, VMWare is great and affordable, but I&#8217;m more interested in automation now than I am with HA, so a single host or two with a ton of CPU and RAM is a better fit.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="169" src="https://blog.kroy.io/wp-content/uploads/2020/10/image-1024x169.png" alt="" class="wp-image-896" srcset="https://blog.kroy.io/wp-content/uploads/2020/10/image-1024x169.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/10/image-300x49.png 300w, https://blog.kroy.io/wp-content/uploads/2020/10/image-768x127.png 768w, https://blog.kroy.io/wp-content/uploads/2020/10/image-1536x253.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/10/image-2048x337.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>The fat host</figcaption></figure>



<h2>Automation</h2>



<p>Automation has always been something that has been near and dear to my heart.  Put quite frankly, manually installing VMs, configuring to my liking, realizing I messed something up and starting over, is absolutely not fun.  </p>



<p>I&#8217;ve also focused heavily on making all my VMs &#8220;pure compute&#8221;.  This means something like Ansible or Docker, with all data stored on an NFS share or iSCSI export. The end result is being able completely nuke a VM, hit a button, and have it back up and running exactly where it left off within a few minutes.  It also means you don&#8217;t need to back up individual VMs, just a few basic text files, the main NAS, etc.  I&#8217;ve talked about some pieces of how I accomplish this in an older post <a rel="noreferrer noopener" href="https://blog.kroy.io/2017/08/14/fully-embracing-docker/" data-type="post" data-id="25" target="_blank">here</a>.  I just now deploy a similar config with Ansible.</p>



<h3>Prior Automation</h3>



<p>I&#8217;ve actually done a lot of automation in the past. Chef, Salt, but my first serious implementation was Foreman + Puppet.</p>



<p>Does Foreman work?  Absolutely.  It gives you the ability to automatically create and deploy fresh VMs with PXE and Puppet.  Is Foreman nice to use?  Absolutely not.   It&#8217;s just an absolute disaster to set up and maintain.  And forget trying to upgrade even minor versions.  I was religious about regularly snapshotting and backing up that Foreman virtual machine because usually an upgrade would require me to completely start from scratch.</p>



<h3>Current Automation</h3>



<p>For at least a year now, my main automation has been a combination of Terraform and Ansible.  Terraform talked to the vCenter API and cloned &#8220;gold master&#8221; VMs, and Ansible configured them to my liking.  I also have MAAS integrated for deploying the bare metal hosts, but that&#8217;s beyond the scope of this post.</p>



<p>This really has been a great solution, but I dislike needing to use &#8220;gold master&#8221; VMs, since they are something that I have to go back and renew and update every once in a while.  And like mentioned, I&#8217;m really wanting to get away from VMWare completely.</p>



<p>So I killed one of my ESXi hosts, and fired up Ubuntu.</p>



<h2>The Hypervisor</h2>



<p>Since this post will probably end up getting pretty long and with lots of code examples, I don&#8217;t want to waste too much time on describing the host setup. But I&#8217;ll try and give the important pieces:</p>



<ul><li>Ubuntu 20.04 Server.  Why Ubuntu?  Mostly because the driver support isn&#8217;t horrible.  At the time of this writing, I tried 20.10, but the communication between 20.10 virtio guest tools and Terraform is broken.</li><li>Setting up SSH key auth.  If you are using virsh, virt-manager remotely, it&#8217;s easiest to use SSH to communicate with libvirt.  Also, I store all my terraform configs on my workstation and terraform and ansible communicates via SSH.</li><li>Installing libvirt and other important stuff .</li></ul>



<pre class="wp-block-code"><code>sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils</code></pre>



<ul><li>Installing Network Manager.  On my hypervisors, I trunk everything, so nmcli is just a WAAAAY easier method of configuring a bunch of bridges.  I&#8217;ve provided working examples of my configuration of the <code>/etc/NetworkManager/system-connections</code> directory in a <a rel="noreferrer noopener" href="https://github.com/kroy-the-rabbit/esxitolibvirt-blog/tree/master/nmcli-examples/system-connections" target="_blank">github repo</a>.<ul><li>Note that the main interface (the slave), the main bridge (vmbr0), and the VLAN5 bridge all have the MTU set to 9000.  I use VLAN5  as my storage network, and this setup allows me to easily pass a 9000 MTU link into a VM.</li><li>Installing Network Manager requires you to change netplan and re-configure your networking.  The changing of Netplan involves removing the existing <code>yaml</code> file, creating a new one that looks like<a rel="noreferrer noopener" href="https://raw.githubusercontent.com/kroy-the-rabbit/esxitolibvirt-blog/master/nmcli-examples/netplan.yml" target="_blank"> this example from github</a>, and doing a <code>sudo netplan apply</code>.</li></ul></li><li>Both my central ISO storage and main VM storage happen via NFS.  So with Ubuntu, first I need to  <code>sudo apt install nfs-common</code>, and then add them as storage pools.  <ul><li>Even on systems without selinux, libvirt enforces it.  So if you add a new storage pool and get weird errors like &#8220;permission denied&#8221;, adding <code>security_driver = "none"</code> to your <code>/etc/libvirt/qemu.conf</code> file and restarting libvirt is a quick fix, though probably not the best fix from a security perspective.</li></ul><ul><li>This is easiest done with <code>virt-manager</code> on your local PC, and then connecting via SSH to the libvirt host.  Then just add pools</li></ul></li></ul>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/11/image.png" alt="" class="wp-image-902" width="373" height="323" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image.png 373w, https://blog.kroy.io/wp-content/uploads/2020/11/image-300x260.png 300w" sizes="(max-width: 373px) 100vw, 373px" /></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="489" height="493" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-1.png" alt="" class="wp-image-903" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-1.png 489w, https://blog.kroy.io/wp-content/uploads/2020/11/image-1-298x300.png 298w, https://blog.kroy.io/wp-content/uploads/2020/11/image-1-150x150.png 150w" sizes="(max-width: 489px) 100vw, 489px" /></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="470" height="477" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-2.png" alt="" class="wp-image-904" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-2.png 470w, https://blog.kroy.io/wp-content/uploads/2020/11/image-2-296x300.png 296w" sizes="(max-width: 470px) 100vw, 470px" /></figure></div>



<hr class="wp-block-separator"/>



<h2>Terraform/Grunt</h2>



<p>The two main tools I want to talk about here are <code>terraform</code> and <code>terragrunt</code>.  A layperson&#8217;s definition of <code>terraform</code> is to define &#8220;infrastructure as code&#8221;.  That means, instead of clicking buttons to make a VM, choosing the amount of RAM, etc, you define it in the terraform domain specific language or DSL outlined <a rel="noreferrer noopener" href="https://www.terraform.io/docs/configuration/syntax.html" target="_blank">here</a>.  With <code>terraform</code>, you create a directory and put text files in it that define resources.  </p>



<p>Of course that&#8217;s a pretty dry definition, so all the examples that follow will outline how all this fits together.</p>



<p><code>terragrunt</code> is just a minor wrapper to <code>terraform</code> that extends it in a few nice ways.  You can drop different projects in different folders and apply changes to all or none, plus have pre/post hooks to run things.  I&#8217;ll have examples of this as well.  </p>



<blockquote class="wp-block-quote"><p>It&#8217;s very important to note that ALLLL terraform is concerned with is state.  If something is out of state, it does its best to non-destructively move it, but that depends on the module you are using.  </p><p>Most of the time it&#8217;s just as happy to just delete everything and start over.   Plans and applies will inform/warn you, but it&#8217;s really easy to get cocky and purge some data.</p><p>Keep that in mind as you begin your terraform journey.</p></blockquote>



<p>All of this is just happening on my local Linux workstation.  As <code>terragrunt</code> and <code>terraform</code> are both just <code>Go</code> programs, that means to install them you just download and run.  </p>



<h3>Install Terraform</h3>



<p>With <code>terraform</code>, there were some MAJOR changes in the <code>.13</code> version, and that&#8217;s the version I&#8217;ll be using.  Something like this can be used to install it on Linux:</p>



<pre class="wp-block-code"><code>wget https://releases.hashicorp.com/terraform/0.13.5/terraform_0.13.5_linux_amd64.zip | unzip terraform_0.13.5_linux_amd64.zip  &amp;&amp; sudo mv terraform /usr/local/bin &amp;&amp; rm terraform_0.13.5_linux_amd64.zip </code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="184" src="https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1024x184.png" alt="" class="wp-image-909" srcset="https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1024x184.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3-300x54.png 300w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3-768x138.png 768w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3-1536x276.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/11/image-3.png 1593w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>terraform install</figcaption></figure>



<p>Similar methodology can be used to install <code>terragrunt</code></p>



<h3>Basic Layout</h3>



<p>As mentioned, I&#8217;m doing all this on my Linux workstation.  This will later allow me to easily shove this all into a git repo, make available from anywhere, etc.</p>



<figure class="wp-block-pullquote alignleft"><blockquote><p>Note that I&#8217;m not trying to make a comprehensive terraform guide here.</p><p>So I probably won&#8217;t be touching much on stuff like .tfvars files, which act sort of like env files, and things will be overly verbose so as to demonstrate what I&#8217;m doing. </p><p>There are plenty of opportunities for code reuse and further templating. Also, you can lay things out however you like. There&#8217;s not really any specific rules on how things need to be mapped out</p></blockquote></figure>



<p></p>



<p>Lets look at the basic layout for my infra:</p>



<pre class="wp-block-code"><code>❯ terraformroot                               
├── diskimages
│   └── focal-server-cloudimg-amd64.img
├── terragrunt.hcl
└── vms
    └── terragrunt.hcl

3 directories, 3 files</code></pre>



<p>This layout leverages the best of terraform and terragrunt.  It allows me to separate out different types of resources (VMs, and in the future LXC and networking), and access them separately (with normal terraform), or globally (with terragrunt).</p>



<p>The base directory <code>terragrunt.hcl</code> file is just empty.  It&#8217;s just a placeholder to allow you to use terragrunt from that level, meaning everything below it, like in <code>vms</code> would work on a <code>terragrunt apply-all</code>.</p>



<p>I also have a <code>diskimages</code> directory with the Ubuntu 20.04 cloud-init enabled image, found <a href="https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img" data-type="URL" data-id="https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img">at this link</a>. You can download this from Ubuntu every time, but it&#8217;s much quicker to store a copy locally and just use that, plus you are being a better netizen.    </p>



<p>The <code>vms</code>directory <code>terragrunt.hcl</code> contains a &#8220;post hook&#8221;.  This updates my DNS via a script whenever VMs are added, updated, or deleted.  This is a file that you may or may not need and may want to remove or skip creating.</p>



<hr class="wp-block-separator"/>



<h3>Setting up a VM</h3>



<p>Let&#8217;s start by creating a simple VM.</p>



<p>The first layout we are working on ends up looking like this:</p>



<pre class="wp-block-code"><code>vms
├── terragrunt.hcl
└── testvm.lan.kroy.io
    ├── cloud_init.cfg
    ├── global.tf
    ├── network_config.cfg
    ├── terragrunt.hcl
    └── vm.tf

1 directory, 6 files</code></pre>



<p>Here I&#8217;ve created a directory named after the destination VM for organization, and put the files <code>main.tf</code> and <code>terragrunt.hcl</code> in it.</p>



<p>You can name the actual terraform files whatever you want as long as it ends with <code>.tf</code>, but they are processed in alphabetical order.  Usually this won&#8217;t make too much of a difference, but in some scenarios it can.</p>



<hr class="wp-block-separator"/>



<h4>The Config Files</h4>



<ul><li>The first file is the <code>global.tf</code>.  This defines some of the basic pieces of our resource.</li></ul>



<pre class="wp-block-code"><code> terraform {
    required_version = ">= 0.13"
    required_providers {
        libvirt = {
            source  = "dmacvicar/libvirt"
            version = "0.6.2"
        }
        mikrotik = {
          source = "ddelnano/mikrotik"
          version = "0.3.6"
        }
    }
}

# instance the providers

provider "libvirt" {
    uri = "qemu+ssh://kroy@jack.lan.kroy.io/system"
}

provider "mikrotik" {
    host = "crs354.lan.kroy.io:8728"
    username = "admin"
    password = ""
}

resource "libvirt_volume" "os_tmpl" {
  name = "focal_os_tmpl"
  pool = "VM"
  source = "file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img"
  format = "qcow2"
}
</code></pre>



<p>Breaking this down:</p>



<ol><li>The <code>terraform</code> section describes the module versions I want to pull.  In this case, I&#8217;m pulling the <code>libvirt</code> and <code>mikrotik</code> modules.   The <code>mikrotik</code> module is used to automatically set a static DHCP lease on my CRS.  This versioning is a the major change in terraform .13 I mentioned earlier. </li><li>The <code>libvirt</code> &#8220;provider&#8221; section sets up the connection via ssh to the host running libvirt.  User <code>kroy</code> is in the libvirt group on the host.</li><li>The <code>mikrotik</code> provider section connects via the Mikrotik API to my switch that runs my DHCP.</li><li>The final block set up a template disk image using the cloud-init enabled image that was downloaded earlier.</li></ol>



<hr class="wp-block-separator"/>



<ul><li>The next file is the <code>cloud_init.cfg</code>.  This file runs some &#8220;initial setup&#8221; tasks in the new VM.</li></ul>



<pre class="wp-block-code"><code>#cloud-config
hostname: ${hostname}
fqdn: ${fqdn}
manage_etc_hosts: true
users:
  - name: root
    ssh-authorized-keys:
      - ${file("/home/kroy/.ssh/id_ed25519.pub")}
      - ${file("/home/kroy/Documents/infra/terraform/keys/id_ansible.pub")}
  - name: kroy
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/kroy
    shell: /bin/bash
    lock_passwd: false
    ssh-authorized-keys:
      - ${file("/home/kroy/.ssh/id_ed25519.pub")}
      - ${file("/home/kroy/Documents/infra/terraform/keys/id_ansible.pub")}
# only cert auth via ssh (console access can still login)
ssh_pwauth: false
disable_root: false
chpasswd:
  list: |
     kroy:test
  expire: False
packages:
  - qemu-guest-agent

growpart:
  mode: auto
  devices: &#091;'/']
  ignore_growroot_disabled: false

runcmd:
  - &#091; systemctl, daemon-reload ]
  - &#091; systemctl, enable, qemu-guest-agent.service ]
  - &#091; systemctl, start, --no-block, qemu-guest-agent.service ]
</code></pre>



<p>If you&#8217;ve got any sort of familiarity with Linux, most of what happens in this file should be somewhat self-explanatory, even if you are unfamiliar with the layout and formatting. </p>



<ul><li>Set up hostname, fqdn from variables that will be set from <code>vm.tf</code>.</li><li>Make the <code>/etc/hosts</code> file match the proper config.</li><li>Setup ssh keys and a separate user.  Set the ssh keys to my local ssh keys and ansible keys on my workstation</li><li>Change the password on the <code>kroy</code> user</li><li>Install the QEMU Guest Agent.  This is what allows the host and the VM to communicate.</li><li>Grow the partition to the max size possible.  This makes it so you can easily create a 5GB or 500GB VM from your <code>vm.tf</code>.</li><li>Make sure the guest agent is running.  I was having an issue with it not autostarting, but this series of <code>runcmd</code> allows it to work.</li></ul>



<hr class="wp-block-separator"/>



<ul><li>The <code>network_config.cfg</code> file.  Somewhat self-documenting. There are other ways to do this, but I&#8217;ve found this is easiest for my setup:</li></ul>



<pre class="wp-block-code"><code>version: 2
ethernets:
  ens3:
     dhcp4: true</code></pre>



<p>This is just a standard <code>netplan</code> config that gets dropped on the new VM.</p>



<hr class="wp-block-separator"/>



<ul><li>The final piece is the <code>vm.tf</code>. As my naming here suggests, this is the actual config for the VM.</li></ul>



<pre class="wp-block-code"><code># variables that can be overriden
variable "hostname" { default = "bgp" }
variable "domain" { default = "lan.kroy.io" }
variable "memoryGB" { default = 2 }
variable "cpu" { default = 2 }
variable "network" { default = "vibr20" }
variable "disksizeGB" { default = 20 }



resource "libvirt_volume" "os_image" {
  name = "${var.hostname}-os_image"
  pool   = "VM"
  base_volume_id = libvirt_volume.os_tmpl.id
  size = var.disksize * 1024 * 1024 * 1024
}

# Use CloudInit ISO to add ssh-key to the instance
resource "libvirt_cloudinit_disk" "commoninit" {
  name = "${var.hostname}-commoninit.iso"
  pool = "VM"
  user_data = data.template_file.user_data.rendered
  network_config = data.template_file.network_config.rendered
}


data "template_file" "user_data" {
  template = file("${path.module}/cloud_init.cfg")
  vars = {
    hostname = var.hostname
    fqdn = "${var.hostname}.${var.domain}"
  }
}

data "template_file" "network_config" {
  template = file("${path.module}/network_config.cfg")
}


# Create the machine
resource "libvirt_domain" "domain-vm" {
  qemu_agent = true
  name = "${var.hostname}.${var.domain}"
  memory = var.memoryGB * 1024
  vcpu = var.cpu
  cloudinit = libvirt_cloudinit_disk.commoninit.id

  disk {
       volume_id = libvirt_volume.os_image.id
  }
  network_interface {
       wait_for_lease = true
       bridge = var.network
  }

  graphics {
    type = "spice"
    listen_type = "address"
    autoport = "true"
  }
  provisioner "local-exec" {
    environment = {
        IP = join("",slice(&#091;for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == "10.20.20"],0,1))
    }
    command = "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i $IP, --key-file=~/Documents/infra/terraform/keys/id_ansible -u root ~/Documents/infra/terraform/ansible/docker/deploy-docker_ubuntu.yml"

  }

}


resource "mikrotik_dhcp_lease" "dhcp" {
  address = join("",slice(&#091;for ip in flatten(libvirt_domain.domain-vm.*.network_interface.0.addresses) : ip if substr(ip,0,8) == "10.20.20"],0,1))
  macaddress = upper(join("",libvirt_domain.domain-vm.*.network_interface.0.mac))
  comment = "${var.hostname}.${var.domain}"
  hostname = var.hostname
}

</code></pre>



<p>There&#8217;s obviously a lot going on here, but the short of it is I&#8217;ll be creating multiple resources.  A cloud-init &#8220;boot disk&#8221;, some templates for passing into the cloud-init disk, the actual VM, and the DHCP record on my Mikrotik, which will read the IP of the created VM, and turn it into a static DHCP lease.</p>



<ol><li>The first part of this config is just some variables.  As I create a new VM, assuming I just want a fairly basic VM, all I need to do is change some things here.  To create a new VM, this is all that needs to be changed.  Note that these can be stored in a <code>.tfvars</code> file too for further separation.</li><li>The first resource is the actual VM disk.  Note that the size is multipled by 1024*1024*1024 to translate the size from bytes to gigabytes, for ease of use.</li><li>The next resource and following templates resources pulls in the cloud-init and network configs to build a cloud init image for initial booting and setup. </li><li>The next resource defines the VM.  Most of it should be self-explanatory.  Things like making sure the guest agent is enabled, setting up the hostname and fqdn from the variables, vcpus, memory, disk.  When you want to use data from a different resource, the format is &#8220;resource_type.resource_name.id&#8221;.  So to later refer to this VM, you&#8217;d used <code>libvirt_domain.domain-vm.id</code>.<ol><li>We set up a spice console, important for connecting to it via something like <code>virt-manager</code>.</li><li>The <code>network_interface</code> resource here tells it to wait for a lease.  This is necessary since I want my Mikrotik resource below to be have access to the IP that the VM was issued via DHCP.  This saves me from having to hard-code IPs.</li><li>I have a <code>local-exec</code> provisioner here.  This is how I call Ansible to configure the VM.  In this case I&#8217;ll be setting this host up as one of my Docker VMs.  Note that I&#8217;m doing some severe hacky stuff to make sure I only grab the IP in the subnet that I want.  </li></ol></li><li>Finally, the Mikrotik resource. As mentioned a few times, this sets a static DHCP lease on my main DHCP server, using the same hacky IP pulling code as above.</li></ol>



<hr class="wp-block-separator"/>



<h4>Terraforming the Virtual Machine</h4>



<p>Now that all the resources and config are declared, it&#8217;s time to actually create the VM.</p>



<p>The first step is to <code>initialize</code> the terraform repo here.  This causes it to pull the required modules and prepare for deployment.</p>



<pre class="wp-block-code"><code>❯ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/template...
- Finding dmacvicar/libvirt versions matching "0.6.2"...
- Finding ddelnano/mikrotik versions matching "0.3.6"...
- Installing hashicorp/template v2.2.0...
- Installed hashicorp/template v2.2.0 (signed by HashiCorp)
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)
- Installing ddelnano/mikrotik v0.3.6...
- Installed ddelnano/mikrotik v0.3.6 (self-signed, key ID DDBA1674AA3EA0EE)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https:&#47;&#47;www.terraform.io/docs/plugins/signing.html

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, we recommend adding version constraints in a required_providers block
in your configuration, with the constraint strings suggested below.

* hashicorp/template: version = "~> 2.2.0"

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.❯ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding dmacvicar/libvirt versions matching "0.6.2"...
- Installing dmacvicar/libvirt v0.6.2...
- Installed dmacvicar/libvirt v0.6.2 (unauthenticated)

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre>



<p>Assuming you get a success message there and some green text, you can proceed to <code>plan</code> or even <code>apply</code>.</p>



<p><code>plan</code> shows you want it&#8217;s going to do.  <code>apply</code> will do it (with confirmation by default, but it can be overridden).</p>



<pre class="wp-block-code"><code>❯ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.network_config: Refreshing state...
data.template_file.user_data: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # libvirt_cloudinit_disk.commoninit will be created
  + resource "libvirt_cloudinit_disk" "commoninit" {
      + id             = (known after apply)
      + name           = "testvm-commoninit.iso"
      + network_config = &lt;&lt;~EOT
            version: 2
            ethernets:
              ens3:
                 dhcp4: true
        EOT
      + pool           = "VM"
      + user_data      = &lt;&lt;~EOT
            #cloud-config
            hostname: testvm
            fqdn: testvm.lan.kroy.io
            manage_etc_hosts: true
            users:
              - name: root
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
              - name: kroy
                sudo: ALL=(ALL) NOPASSWD:ALL
                groups: users, admin
                home: /home/kroy
                shell: /bin/bash
                lock_passwd: false
                ssh-authorized-keys:
                  - ssh-ed25519 key key1
                  - ssh-ed25519 key ansible
            
            # only cert auth via ssh (console access can still login)
            ssh_pwauth: false
            disable_root: false
            chpasswd:
              list: |
                 kroy:test
              expire: False
            packages:
              - qemu-guest-agent
            
            growpart:
              mode: auto
              devices: &#091;'/']
              ignore_growroot_disabled: false
            
            runcmd:
              - &#091; systemctl, daemon-reload ]
              - &#091; systemctl, enable, qemu-guest-agent.service ]
              - &#091; systemctl, start, --no-block, qemu-guest-agent.service ]
        EOT
    }

  # libvirt_domain.domain-vm will be created
  + resource "libvirt_domain" "domain-vm" {
      + arch        = (known after apply)
      + cloudinit   = (known after apply)
      + disk        = &#091;
          + {
              + block_device = null
              + file         = null
              + scsi         = null
              + url          = null
              + volume_id    = (known after apply)
              + wwn          = null
            },
        ]
      + emulator    = (known after apply)
      + fw_cfg_name = "opt/com.coreos/config"
      + id          = (known after apply)
      + machine     = (known after apply)
      + memory      = 2048
      + name        = "testvm.lan.kroy.io"
      + qemu_agent  = true
      + running     = true
      + vcpu        = 2

      + graphics {
          + autoport       = true
          + listen_address = "127.0.0.1"
          + listen_type    = "address"
          + type           = "spice"
        }

      + network_interface {
          + addresses      = (known after apply)
          + bridge         = "vibr20"
          + hostname       = (known after apply)
          + mac            = (known after apply)
          + network_id     = (known after apply)
          + network_name   = (known after apply)
          + wait_for_lease = true
        }
    }

  # libvirt_volume.os_image will be created
  + resource "libvirt_volume" "os_image" {
      + base_volume_id = (known after apply)
      + format         = (known after apply)
      + id             = (known after apply)
      + name           = "testvm-os_image"
      + pool           = "VM"
      + size           = 21474836480
    }

  # libvirt_volume.os_tmpl will be created
  + resource "libvirt_volume" "os_tmpl" {
      + format = "qcow2"
      + id     = (known after apply)
      + name   = "focal_os_tmpl"
      + pool   = "VM"
      + size   = (known after apply)
      + source = "file:///home/kroy/Documents/infra/terraform/libvirt/diskimages/focal-server-cloudimg-amd64.img"
    }

  # mikrotik_dhcp_lease.dhcp will be created
  + resource "mikrotik_dhcp_lease" "dhcp" {
      + address    = (known after apply)
      + blocked    = "false"
      + comment    = "testvm.lan.kroy.io"
      + dynamic    = false
      + hostname   = "testvm"
      + id         = (known after apply)
      + macaddress = (known after apply)
    }

Plan: 5 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an "-out" parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
"terraform apply" is subsequently run.
</code></pre>



<p>Note the bottom line where is says it&#8217;s going to add 5, change 0, destroy 0.  </p>



<p>Keep remembering that all terraform is concerned with is state.  So it will happily delete and nuke everything to get it to make the state that you want.  So if a <code>plan</code> or <code>apply</code> says it&#8217;s going to delete a bunch of stuff and that&#8217;s not what you wanted, escape now!</p>



<p>Finally, <code>terraform apply</code> looks much like the plan above, and adds a few extra lines to confirm the operation (if you haven&#8217;t passed the option to skip it).</p>



<pre class="wp-block-code"><code>Plan: 5 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

...

Apply complete! Resources: 5 added, 0 changed, 0 destroyed
</code></pre>



<p>This should hopefully complete without error, and if you do a <code>virsh list</code> on the libvirt host, you&#8217;ll see something like:</p>



<pre class="wp-block-code"><code># virsh list 
 Id   Name                 State
------------------------------------
 1    testvm.lan.kroy.io   running
</code></pre>



<p>In my <code>terraform apply</code> output, I have <code>libvirt_domain.domain-vm (local-exec): ok: [10.20.20.79]</code>, which means I should be able to ssh there</p>



<pre class="wp-block-code"><code>❯ ssh kroy@10.20.20.79
Warning: Permanently added '10.20.20.79' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-51-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Nov  2 17:55:54 UTC 2020

  System load:              0.0
  Usage of /:               11.0% of 19.21GB
  Memory usage:             15%
  Swap usage:               0%
  Processes:                121
  Users logged in:          0
  IPv4 address for docker0: 172.17.0.1
  IPv4 address for ens3:    10.20.20.79
 

41 updates can be installed immediately.
15 of these updates are security updates.
To see these additional updates run: apt list --upgradable



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo &lt;command>".
See "man sudo_root" for details.

kroy@testvm:~$</code></pre>



<p>SUCCESS!</p>



<hr class="wp-block-separator"/>



<h3>Terragrunt</h3>



<p>Even though we&#8217;ve only got a single resource so far, I want to touch on what <code>terragrunt</code> accomplishes for you.  </p>



<p>Terraform only works on single directories.  So say I wanted to add a second VM.  </p>



<p>I would do something like:</p>



<pre class="wp-block-code"><code>cd terraformroot
cp -pr vms/testvm.lan.kroy.io vms/doubletest.lan.kroy.io
rm vms/doubletest.lan.kroy.io/terraform.tfstate*
sed -i -e 's/testvm/doubletest/' vms/doubletest.lan.kroy.io/vm.tf</code></pre>



<p>Hopefully that is mostly self-explanatory:</p>



<ul><li>Change into our terraform directory.</li><li>Copying the existing config to a new VM directory.</li><li>Remove all the old terraform state files.  This is <em>VERY</em> important if you are going to be using terraform like this.  This is basically the main &#8220;database&#8221; for terraform and if you want to create a new resource, you don&#8217;t want the old database in the new resource directory.</li><li>A not-so-fancy one-liner to change the hostname of the new VM.</li></ul>



<p>Now you would have a few options to determine how you want to apply this configuration:</p>



<ol><li>Switch to <code>terraformroot/vms/doubletest.lan.kroy.io</code>, do a <code>terraform apply</code>.   This would only apply the state for this VM.</li><li>Switch to <code>terraformroot/vms</code>, do a <code>terragrunt apply-all</code>.  This would apply the state for <code>testvm.lan.kroy.io </code> and <code>doubletest.lan.kroy.io</code>.</li><li>Switch to <code>terraformroot</code>, and again, <code>terragrunt apply-all</code>.  This would apply the state for all resources under <code>vms</code>, and any future projects, like networking configs, LXC, etc.</li></ol>



<p>In all that, you can also do <code>plan-all</code> on terragrunt to see what it&#8217;s going to change.</p>



<p>In the directory for these VMs resources, I&#8217;ve got a <code>terragrunt.hcl</code>.  The contents of this are simply:</p>



<pre class="wp-block-code"><code>include {
  path = find_in_parent_folders()
}</code></pre>



<p>This says &#8220;look in any parent folders, and execute the actions of their <code>terragrunt.hcl</code>.&#8221;</p>



<p>This is powerful because you can have specific actions for just the <code>vms</code> directory or everything. That&#8217;s why the content of my <code>terragrunt.hcl</code> in the <code>vms</code> directory contains:</p>



<pre class="wp-block-code"><code>terraform {
  after_hook "after_hook" {
    commands     = &#091;"apply"]
    execute      = &#091;"/bin/bash","/home/kroy/Documents/infra/terraform/updatedns.sh"]
    run_on_error = true
  }
}
</code></pre>



<p>As is implied, this runs after you type <code>terragrunt apply</code> or <code>apply-all</code>. </p>



<p>Being in the <code>vms</code> sub-directory, when would this run?</p>



<ol><li>In the individual VM resource directory due to the <code>find_in_parent_folders</code> when you run terragrunt with apply or apply-all.</li><li>In the <code>vms</code> sub-directory when running apply all. You can&#8217;t run apply because that only looks in the current directory.</li><li>In the main <code>terraformroot</code> directory.    </li></ol>



<p>So running a <code>terragrunt apply-all</code> in the <code>vms</code> directory:</p>



<pre class="wp-block-code"><code>&#091;terragrunt] 2020/11/02 12:13:11 Stack at /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms:
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/doubletest.lan.kroy.io (excluded: false, dependencies: &#091;])
  => Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io (excluded: false, dependencies: &#091;])
&#091;terragrunt] 2020/11/02 12:13:11 &#091;terragrunt]  Are you sure you want to run 'terragrunt apply' in each folder of the stack described above? (y/n) </code></pre>



<p>The output of this shows that the new VM was created (and the original VM was at least looked at), and my post-hook is run once:</p>



<pre class="wp-block-code"><code>Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Detected 1 Hooks
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Executing hook: after_hook
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Running command: /bin/bash /home/kroy/Documents/infra/terraform/updatedns.sh
&#091;terragrunt] &#091;/home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io] 2020/11/02 12:14:52 Module /home/kroy/Desktop/esxitolibvirt-blog/terraform/vms/testvm.lan.kroy.io has finished successfully!</code></pre>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>Well, there you have it.   Is this the perfect layout?  Probably not.  Is there room for improvement?  Absolutely.</p>



<p>I have put up a git repo <a rel="noreferrer noopener" href="https://github.com/kroy-the-rabbit/esxitolibvirt-blog" data-type="URL" data-id="https://github.com/kroy-the-rabbit/esxitolibvirt-blog" target="_blank">HERE</a>, containing all of the examples from above.</p>



<p>Of course this is far from complete.  With this setup, all you have are fairly blank and basic VMs.  You&#8217;d want to hit them with Ansible or something to finish configuring them.  But that&#8217;s a post for another day.</p>



<p>Enjoy!</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">894</post-id>	</item>
		<item>
		<title>VyOS from Scratch &#8211; Edition 1</title>
		<link>https://blog.kroy.io/2020/05/04/vyos-from-scratch-edition-1/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=vyos-from-scratch-edition-1</link>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 04 May 2020 05:28:47 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[vyos]]></category>
		<category><![CDATA[vyosfromscratch]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=593</guid>

					<description><![CDATA[As a VyOS evangelist, maintainer, and more, I&#8217;ve been meaning to write a simple series of &#8220;how-to&#8221; guides for VyOS for a while. Sure, there are plenty of guides out&#8230;]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>As a VyOS evangelist, maintainer, and more, I&#8217;ve been meaning to write a simple series of &#8220;how-to&#8221; guides for VyOS for a while.  Sure, there are plenty of guides out there, but I think a lot of them fall short in demonstrating WHY you are entering specific commands.  </p>



<p>VyOS is capable, but it&#8217;s much more helpful if you can fully understand what it&#8217;s doing.  </p>



<p>This initial guide will walk through the basic setup steps in replacing something like pfSense or some other consumer router with a simple and secure system running VyOS.  </p>



<p>This is also going to be a very very long post, so buckle in!</p>



<hr class="wp-block-separator"/>





<hr class="wp-block-separator"/>



<h2>Who is this For</h2>



<p>Anybody that wants to use VyOS of course!  </p>



<p>The nice thing about running VyOS is that if you set up it, and understand <strong><em>WHAT</em></strong> it&#8217;s doing, then you&#8217;ve actually learned something about networking.  </p>



<p>Does something like pfSense work?  </p>



<p>Sure, but it also doesn&#8217;t teach you much about what&#8217;s actually going on.  And the knowledge learned in VyOS will easily translate to almost any other vendor like Cisco, Arista, and more.  At that point, the concepts are the same, you are just learning the different dialects. </p>



<hr class="wp-block-separator"/>



<h2>Environment</h2>



<p>VyOS really doesn&#8217;t take much in resources.  </p>



<p>8GB of storage and 2-4GB of RAM will be overkill for most basic setups.  </p>



<p>CPU-wise, even small Pentium Silver CPUs can handle gigabit and beyond, even over VPN .  Anything like an i3/i5 or a Xeon won&#8217;t break a sweat except in all but the most demanding scenarios.</p>



<p>If you virtualize, it can be helpful to set up a test environment.  This could consist of a simple:</p>



<ul><li>WAN Network.  For testing this could be your existing LAN network.</li><li>A new &#8220;LAN&#8221; Network. For testing this could just be a separate port group or bridge, and it wouldn&#8217;t even need an uplink.</li><li>A simple VM with a GUI (or without), to run some testing. </li></ul>



<p>If virtualization isn&#8217;t an option, VyOS can run on almost any device that is x86_64.  I&#8217;ve run it on everything from:</p>



<ul><li>NUCs with single NICs and USB/USB-C NICs.</li><li><a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/" target="_blank" rel="noreferrer noopener">WYSE 5070/3040 Thin Clients</a>.</li><li>A variety of Dells, including R710s/R620s/R630s.</li><li>Anything Supermicro from 1U to 4U devices.</li></ul>



<p>Finally, for this guide, I&#8217;ll be working with two NICs.  </p>



<p>One is a WAN, connected to my current LAN.  I&#8217;ll be creating a &#8220;network inside a network&#8221;.  The second will be our new &#8220;LAN&#8221;.  This is separate from my existing LAN so I can pretend like it&#8217;s a second private network.  These interfaces can be anything:</p>



<ul><li>Physical NICs.</li><li>VLANs.</li><li>Virtual NICs from ESXi, Proxmox, etc.</li></ul>



<hr class="wp-block-separator"/>



<h1>Install</h1>



<p>The first step is to grab yourself a copy of the installer ISO.  </p>



<p>Most people will want the <a href="https://www.vyos.io/rolling-release/" target="_blank" rel="noreferrer noopener">Rolling Release</a>.  You can also build it yourself, via the <a href="https://docs.vyos.io/en/latest/contributing/build-vyos.html" target="_blank" rel="noreferrer noopener">Docker image</a>, which is helpful if there are some extra packages you want to add.</p>



<p>If you want access to the LTS version, it requires self-building (an easy process), contributing, or a subscription. I <a href="https://blog.vyos.io/vyos-access-subscriptions-for-documentation" target="_blank" rel="noreferrer noopener">highly recommend contributing</a>, as even writing or cleaning up some documentation will get you access to the LTS prebuilt versions.  </p>



<p>You can also support and get access via <a href="https://www.patreon.com/vyos" target="_blank" rel="noreferrer noopener">Patreon</a> or <a href="https://www.buymeacoffee.com/kUa78LT" target="_blank" rel="noreferrer noopener">BuyMeACoffee</a>.</p>



<hr class="wp-block-separator"/>



<p>Note that for these guides, I will be using a recent version of rolling.  This is important as some configuration nodes have changed locations and format between 1.3+ and the existing LTS versions (DHCP and IPv6 RAs are two things that come to mind).</p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Rolling Stability</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
It&#8217;s important to note that the rolling releases are generally completely stable.  I would say 95% of them or more are functional without any major bugs.</p>
<p>Every once in a while, some broken functionality is pushed, but it is almost always fixed quickly. A broken upgrade is not a show-stopper and it is trivial to boot back into the working version with the built-in <a href="https://docs.vyos.io/en/latest/image-mgmt.html" target="_blank" rel="noopener noreferrer">Image Management</a>.</p>
<p>I have no issues running rolling releases in many production locations.<br />
</div></div>



<h2>Install Steps</h2>



<p>Installation is trivial:</p>



<ul><li>Burn ISO to CD/DVD/USB stick, or boot ISO via remote management (iDrac, iLo, IPMI)</li><li>Login with <code><em>vyos</em></code>/<code><em>vyos</em></code></li><li>Type <code><em>install image</em></code></li><li>Answer the install steps</li><li>Reboot and remove installation media</li></ul>


<div class="su-box su-box-style-default" id="" style="border-color:#cc8700;border-radius:3px"><div class="su-box-title" style="background-color:#ffba00;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Installation Gotchas</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<ul>
<li> The installer ISO is a fully functional VyOS image.  That means if you skip the <em>install image</em> step, you can configure the system, and it will work as intended&#8230; until you reboot.  Don&#8217;t be me.  Make sure to install if you want a permanent installation.
<li> Some systems that lack a serial port get stuck on a black screen on the installer ISO.  The simple fix is to edit the grub boot option line and remove the <em>console=ttyS0,115200</em> option from the kernel boot arguments.  Then just boot with <em>CTRL-X</em> as directed.
</ul>
</div></div>



<figure class="wp-block-image size-large"><img loading="lazy" width="720" height="404" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-2.png" alt="" class="wp-image-609" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-2.png 720w, https://blog.kroy.io/wp-content/uploads/2020/04/image-2-300x168.png 300w" sizes="(max-width: 720px) 100vw, 720px" /></figure>



<figure class="wp-block-image size-large"><img loading="lazy" width="726" height="400" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-1.png" alt="" class="wp-image-608" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-1.png 726w, https://blog.kroy.io/wp-content/uploads/2020/04/image-1-300x165.png 300w" sizes="(max-width: 726px) 100vw, 726px" /></figure>



<hr class="wp-block-separator"/>



<h1>Basic Configuration</h1>



<p>Once installed, you&#8217;ll be staring at the login screen.  Login with <code>vyos</code> and the password you set up during install:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="723" height="408" src="https://blog.kroy.io/wp-content/uploads/2020/04/image.png" alt="" class="wp-image-607" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image.png 723w, https://blog.kroy.io/wp-content/uploads/2020/04/image-300x169.png 300w" sizes="(max-width: 723px) 100vw, 723px" /></figure>



<hr class="wp-block-separator"/>



<h3>Decision Time!</h3>



<p>Before you go any further, you need to make a decision.  You need to pick out the subnet (or later subnets) where your network will live.  Or, if you are converting over your existing network, just reuse it.</p>



<p>These should be <a href="https://en.wikipedia.org/wiki/Private_network">RFC1918 addresses</a>.  You generally want a /24, which is 254 usable addresses.</p>



<p>So, there are three main groups of these private addresses you can choose from:</p>



<ul><li><code>10.X.Y.1-254</code>, where <code>X</code> and <code>Y</code> are any number between 0 and 255.  For the last number, 0 would be your &#8220;network&#8221; address, and 255 would be your broadcast address.  You could then assign all your hosts to 1-254.</li><li><code>172.X.Y.1-254</code>, in this case <code>X</code> would be between 16 and 31, and <code>Y</code> could be 0 to 255. </li><li><code>192.168.X.1-254</code>, where <code>X</code> is between 0 and 255.  </li></ul>



<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Subnetting Pro-tips</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>Many routers around the world off-the-shelf use a subnet like 10.0.0.0/24 or 192.168.0.0/24.</p>
<p>
While you can use these subnets, future-you will hate yourself if you ever want to access your network remotely or access other networks when both sides are using the same subnet.
</p>
<p>
I would highly recommend:
<ul>
 	<li>Choose a subnet away from the norm.  For example, 10.32.47.0/24.</li>
 	<li>If you want to plan ahead and are planning to break things out on VLANs, use a subnet like 10.32.X.0/24.  That way, in the future, X can represent your VLAN number, and you can do a summary route like 10.32.0.0/16.  I&#8217;ll be showing some examples of where this can be used later on in this post.</ul>
</p>
</div></div>



<hr class="wp-block-separator"/>



<h3>Configuring the LAN and Remote access</h3>



<p>After the subnet is chosen, the first step is to get the router on the LAN and accessible via SSH.  This makes it much easier to configure, as you are no longer tethered to a keyboard/monitor, VM console, can copy/paste, etc.  </p>



<h4>LAN IP</h4>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configure mode</li><li>Add address to the correct interface</li><li>Commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>The first step is to enter configure mode.  This allows you to make changes to the system configuration.  Type <code>configure</code>.  VyOS also supports shortcuts and tab completion, so typing <code>conf</code> or <code>conf&lt;TAB&gt;</code> will do the same thing.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="336" height="135" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-5.png" alt="" class="wp-image-626" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-5.png 336w, https://blog.kroy.io/wp-content/uploads/2020/04/image-5-300x121.png 300w" sizes="(max-width: 336px) 100vw, 336px" /></figure>



<p>The prompt will change to include <code>#</code>, and the <code>[edit]</code> line will appear to designate that you are in configure mode.</p>



<p>Next, you need to add your LAN IP.  You can check your interfaces by typing <code>run show interfaces</code>.  This tells VyOS to show all the interfaces in operational mode (the mode you were in before you typed <code>conf</code>).</p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-4.png" alt="" class="wp-image-625" width="580" height="98" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-4.png 600w, https://blog.kroy.io/wp-content/uploads/2020/04/image-4-300x51.png 300w" sizes="(max-width: 580px) 100vw, 580px" /></figure>



<p>In my case, <code>eth1</code> is attached to my LAN here.  I&#8217;m going to use the subnet from above, <code>10.32.0.0/24</code>.  I prefer to use <code>.1</code> for my routers, but you can use any IP in that range.</p>



<p>There are two methods to assign it once in <code>conf</code> mode.  Either with the full path, or by drilling-down.</p>



<p>Full path:</p>



<pre class="wp-block-code"><code>configure
set interfaces ethernet eth1 address 10.32.0.1/24
set interfaces ethernet eth1 description LAN
commit
save</code></pre>



<p>Drill down:</p>



<pre class="wp-block-code"><code>configure
edit interfaces ethernet eth1
set address 10.32.0.1/24
set description LAN
commit
save</code></pre>



<p>Committing makes the configuration active, and saving saves it to disk so it will persist on a reboot.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="225" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1024x225.png" alt="" class="wp-image-657" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1024x225.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-300x66.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-768x169.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-1536x337.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/04/image-18-2048x450.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Or:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="293" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1024x293.png" alt="" class="wp-image-658" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1024x293.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-300x86.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-768x220.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19-1536x439.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/04/image-19.png 1994w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>You can show your work with <code>show interfaces</code> and <code>run show interfaces</code></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="693" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-20-1024x693.png" alt="" class="wp-image-659" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-20-1024x693.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20-300x203.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20-768x520.png 768w, https://blog.kroy.io/wp-content/uploads/2020/04/image-20.png 1034w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h4>Set up DHCP</h4>



<p>Now that that router has a LAN IP, it&#8217;s time to connect your laptop/desktop/etc up to it.  </p>



<p>You can assign it a static IP in the chosen subnet (<code>10.32.0.10/24</code> for example), but I imagine you are also going to want to assign a DHCP range for automatic configuration of clients.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configure mode</li><li>Set up DHCP ranges</li><li>commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>Let&#8217;s talk about the following config.  </p>



<p>We are going to make two DHCP ranges, and leave some holes.  This would allow us to assign the IP addresses between <code>.2</code> and <code>.49</code> for static or other uses, as well as <code>.126-199</code> and <code>.251-254</code>.</p>



<p>While this is a non-standard usage, it demonstrates the capabilities. Many people would just have a single range. </p>



<pre class="wp-block-code"><code>set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 0 start 10.32.0.50
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 0 stop 10.32.0.125
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 1 start 10.32.0.200
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 range 1 stop 10.32.0.250</code></pre>



<p>Some other important config options follow.   </p>



<p>You want to tell the DHCP server to hand out the router&#8217;s IP address as the default gateway and DNS.  This will make it so (eventually), your LAN devices will have DNS and routing to the Internet:</p>



<pre class="wp-block-code"><code>set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 dns-server 10.32.0.1
set service dhcp-server shared-network-name LAN subnet 10.32.0.0/24 default-router 10.32.0.1</code></pre>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">DNS Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>This would also be the place to insert something like your pi-hole or active directory DNS server.  In the above example, your pi-hole/ADDNS address or addresses would be where the dns-server option is. </p>
</div></div>



<p></p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-8.png" alt="" class="wp-image-630" width="580" height="230" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-8.png 781w, https://blog.kroy.io/wp-content/uploads/2020/04/image-8-300x119.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-8-768x305.png 768w" sizes="(max-width: 580px) 100vw, 580px" /></figure>



<figure class="wp-block-image size-large"><img loading="lazy" width="760" height="208" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-10.png" alt="" class="wp-image-632" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-10.png 760w, https://blog.kroy.io/wp-content/uploads/2020/04/image-10-300x82.png 300w" sizes="(max-width: 760px) 100vw, 760px" /></figure>



<hr class="wp-block-separator"/>



<h4>SSH</h4>



<p>The final step before we can access the router over SSH is to actually enable SSH:</p>



<pre class="wp-block-code"><code>set service ssh port 22
commit
save</code></pre>



<p>At this point you ought to be able to hook up a LAN client, and verify that you have an IP, gateway, and DNS.  </p>



<p>This is a fairly stock Debian VM I set up.  As you can see, my IP is in one of my DHCP ranges, and my DNS and default route are the router&#8217;s IP. </p>



<p>This is on Linux, but the same thing could be confirmed on Windows or MacOS:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="736" height="472" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-16.png" alt="" class="wp-image-640" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-16.png 736w, https://blog.kroy.io/wp-content/uploads/2020/04/image-16-300x192.png 300w" sizes="(max-width: 736px) 100vw, 736px" /></figure>



<p>From there, you should be able to ssh into the router with the username <code>vyos</code> and password you set up during install:<br></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="541" height="191" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-13.png" alt="" class="wp-image-637" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-13.png 541w, https://blog.kroy.io/wp-content/uploads/2020/04/image-13-300x106.png 300w" sizes="(max-width: 541px) 100vw, 541px" /></figure>



<p>And typing <code>show configuration</code> (in op mode), should show you the work done so far.  VyOS also comes with a few defaults, like NTP servers configured.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="414" height="990" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-14.png" alt="" class="wp-image-638" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-14.png 414w, https://blog.kroy.io/wp-content/uploads/2020/04/image-14-125x300.png 125w" sizes="(max-width: 414px) 100vw, 414px" /></figure>



<hr class="wp-block-separator"/>



<h1>NAT &amp; DNS</h1>



<h3>NAT</h3>



<p>The next important duty for a router and firewall is to be able to NAT.  NAT allows all your private LAN devices to access the Internet.  </p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Information Dump</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Back when the Internet started, every device had a unique IP address. </p>
<p>Unfortunately, because of the numbering scheme used, there are only 4.2 billion of these address, at least in IPv4, and the transition to IPv6 is far from complete.</p>
<p>Because of this, every device on your network needs to be able to &#8220;pretend&#8221; that it is your router to access the Internet.  Your router keeps track of which requests belong to which device.  </p>
<p>Source NAT is what allows you to do this.</p>
<p>This is also where the above mentioned &#8220;summary route&#8221; can come into play.  Instead of creating three separate NAT rules for 10.32.1.0/24, 10.32.2.0/24, and 10.32.3.0/24, you can create a single rule for 10.32.0.0/16.<br />
</div></div>



<p>For this setup, it&#8217;s important to identify which network interface will eventually be your WAN interface, even though it&#8217;s not configured yet.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>As before, enter configuration mode.</li><li>Set up a source NAT rule to target our LAN or LAN subnets.</li><li>Define the outgoing WAN interface on the rule.</li><li>Set the translation type of the rule to <code>masquerade</code>. </li></ul>



<hr class="wp-block-separator"/>



<p>The type of NAT we will be using is called <code>SOURCE NAT</code>.  This type of NAT is going to have three components:</p>



<ul><li>Target all traffic from our LAN or LANs&#8230;</li><li>&#8230; when the traffic is going out to the Internet through this outgoing interface&#8230;</li><li>&#8230; Change the IP address from the LAN IP to the WAN IP</li></ul>



<p>To do this:</p>



<pre class="wp-block-code"><code>set nat source rule 100 source address '10.32.0.0/24'
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 translation address masquerade
commit
save</code></pre>



<p>In the above example, the <code>100</code> is an arbitrary number (between 1-9999).  The <code>eth0</code> is my eventual WAN interface.  <code>masquerade</code> translates the internal LAN IP to your public WAN IP.  </p>



<p></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="962" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-21.png" alt="" class="wp-image-660" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-21.png 962w, https://blog.kroy.io/wp-content/uploads/2020/04/image-21-300x240.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-21-768x613.png 768w" sizes="(max-width: 962px) 100vw, 962px" /></figure>



<p>Once we set up our WAN interface, we&#8217;ll be able to type <code>show nat source rules</code> in op mode, or <code>run show nat source rules</code> in conf mode to run the op mode command, it will be clear what&#8217;s happening.</p>



<hr class="wp-block-separator"/>



<h3>DNS</h3>



<p>The next step is to set up our VyOS instance as for DNS.  This will allow you to use local DNS and caching instead of your ISP&#8217;s, but also eventually will allow you run custom DNS and hosts. </p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter config mode</li><li>Set the DNS Listen Address</li><li>Set the subnets we are allowing from</li><li>Set the cache size to 0</li><li>commit and save</li></ul>



<hr class="wp-block-separator"/>



<pre class="wp-block-code"><code>set service dns forwarding listen-address '10.32.0.1'
set service dns forwarding allow-from '10.32.0.0/24'
set service dns forwarding cache-size '0'
commit
save</code></pre>



<p>As mentioned, this accomplishes three things.  </p>



<ul><li>It tells VyOS to listen for DNS requests on its LAN IP, <code>10.32.0.1</code>.  </li><li>It limits requests from your LAN subnet.  </li><li>Finally, it sets the cache size to 0.  This is good to start out with to make sure everything is working, but later you can bump it up to speed up multiple requests for the same sites. </li></ul>



<hr class="wp-block-separator"/>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Opportunity Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
This is another opportunity to use the &#8220;summary&#8221; route that I&#8217;ve mentioned a few times.  </p>
<p>Instead of allowing &#8220;10.32.0.0/24&#8221;, you would allow &#8220;10.32.0.0/16&#8221;.  This would ensure that as you add VLANs and subnets, your DNS will just work without adding a long list of /24s.<br />
</div></div>



<hr class="wp-block-separator"/>



<figure class="wp-block-image size-large"><img loading="lazy" width="508" height="212" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-22.png" alt="" class="wp-image-678" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-22.png 508w, https://blog.kroy.io/wp-content/uploads/2020/04/image-22-300x125.png 300w" sizes="(max-width: 508px) 100vw, 508px" /></figure>



<hr class="wp-block-separator"/>



<h4>DNS Forwarding</h4>



<p>There is one more consideration to be made.  As configured, your DNS server will run in &#8220;recursor&#8221; mode.  This means it will take responsibility for fully resolving DNS on its own.  This may be a bad thing for a number of reasons:</p>



<ul><li>It leaks your IP to potential undesirables.  </li><li>It&#8217;s almost always slower, as you don&#8217;t get to benefit from the caches of a large service like CloudFlare or Google.  </li></ul>



<p>It&#8217;s quite simple to set up in forwarding mode, meaning when you make a DNS request, you end up asking an upstream resolver.  </p>



<p>In the following example, we&#8217;ll be using CloudFlare and Google:</p>



<pre class="wp-block-code"><code>set service dns forwarding name-server 1.1.1.1
set service dns forwarding name-server 1.0.0.1
set service dns forwarding name-server 8.8.8.8
set service dns forwarding name-server 8.8.4.4
commit
save</code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="564" height="399" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-23.png" alt="" class="wp-image-680" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-23.png 564w, https://blog.kroy.io/wp-content/uploads/2020/04/image-23-300x212.png 300w" sizes="(max-width: 564px) 100vw, 564px" /></figure>



<hr class="wp-block-separator"/>



<h4>System DNS</h4>



<p>One final step is to set the DNS for VyOS itself.  Everything we&#8217;ve done so far has just set up VyOS to be a DNS server for your clients.</p>



<p>This will be the DNS that is used, for example, when you do a VyOS update, ping or traceroute from VyOS, etc.</p>



<p>The easiest thing to do if you&#8217;ve been following this guide, is just to use the DNS server you set up above:</p>



<pre class="wp-block-code"><code>set system name-server 10.32.0.1
commit
save</code></pre>



<p>This is also another spot where if you wanted to use Google, CloudFlare, or AD-DNS, you could plug in that IP:</p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-13.png" alt="" class="wp-image-779" width="760" height="276" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-13.png 760w, https://blog.kroy.io/wp-content/uploads/2020/05/image-13-300x109.png 300w" sizes="(max-width: 760px) 100vw, 760px" /></figure>



<p>Alternatively, you call tell VyOS to use the DNS servers that it received from your WAN DHCP server with:</p>



<pre class="wp-block-code"><code>set system name-servers-dhcp eth0</code></pre>



<p></p>



<hr class="wp-block-separator"/>



<h1>Firewall</h1>



<p>If you&#8217;ve made it this far, congrats!  We are almost there! </p>



<p>This section will cover the creation of a zone-based firewall, which is far superior to the default method of attaching firewalls to interfaces.  </p>



<p>The reason it is superior is simple.  It&#8217;s a bit more hassle to set up, but it&#8217;s far easier to manage on an ongoing basis, plus, you start thinking about firewalling as flows of information from interface to interface.</p>



<hr class="wp-block-separator"/>



<p>Goals:</p>



<ul><li>Enter configuration mode</li><li>Create a firewall to allow all LAN traffic.</li><li>Create firewall to allow all LAN traffic to access VyOS itself.</li><li>Create a firewall to protect the router itself from WAN.</li><li>Create a firewall to protect LAN devices from WAN.</li><li>Commit</li><li>Create LOCAL/LAN zones.</li><li>Assign appropriate interfaces to zones.</li><li>Commit and save</li></ul>



<hr class="wp-block-separator"/>



<p>For as complex as firewalling seems, it&#8217;s actually pretty simple when you break it down.  </p>



<p>A firewall tracks connection &#8220;states&#8221; to determine what is and is not allowed.  This is where packets are originating and going to, ports involved, types of traffic like TCP/UDP/ICMP, and more.  </p>



<p>We are going to build a very simple firewall that assumes that we want to block everything externally, and allow everything from LAN.</p>



<p>So let&#8217;s dig right into it.</p>



<hr class="wp-block-separator"/>



<h2>LAN</h2>



<p>First, create a firewall that will allow our LAN to access everything. This is a setup that would mimic what most consumer routers do:</p>



<pre class="wp-block-code"><code>conf
set firewall name LAN-WAN default-action accept
set firewall name LAN-LOCAL default-action accept
commit
save</code></pre>



<p>The <code>LAN-WAN</code> and the <code>LAN-LOCAL</code> can be arbitrarily named anything.  I use this naming scheme because as mentioned above, it&#8217;s better to think about firewalls as controlling the flow of information through the router, and these names are self-documenting.</p>



<p><code>LOCAL</code> is a specific VyOS designation that means &#8220;this router&#8221;.  When you are attaching the firewall in the zones, LOCAL will be what you use to control traffic destined to the firewall itself.  </p>



<p>As should be obvious, we are just allowing everything.  But you can set whatever rules you wanted.  <code>LAN-WAN</code> would generally remain pretty open as it would be uncommon to block your own access to the Internet, but <code>LAN-LOCAL</code> might contain rules to maybe allow only specific devices access to manage the VyOS router.</p>



<p>Also note that we are just creating the firewalls here.  They don&#8217;t become active until you attach them to the zones.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="894" height="376" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-24.png" alt="" class="wp-image-740" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-24.png 894w, https://blog.kroy.io/wp-content/uploads/2020/04/image-24-300x126.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-24-768x323.png 768w" sizes="(max-width: 894px) 100vw, 894px" /></figure>



<hr class="wp-block-separator"/>



<h2>LOCAL</h2>



<p>As mentioned, the <code>LOCAL</code> zone is traffic destined for the VyOS router itself.  </p>



<p>In most cases, it will have a similar ruleset to the LAN one above, as most people want their router to have full access to the Internet and their LAN devices:</p>



<pre class="wp-block-code"><code>conf
set firewall name LOCAL-WAN default-action accept
set firewall name LOCAL-LAN default-action accept
commit
save</code></pre>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Food for Thought</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
<p>While I might be getting a little ahead of myself here, it&#8217;s important to note that you could use the same firewall instead of creating four different firewalls as we&#8217;ve done here.  The firewalls are just attached to interfaces or zones by names, so there&#8217;s nothing really stopping you from creating a single firewall and attaching it to four different places.</p>
<p>As a bit of a pro-tip though, I would recommend not doing this.  Eventually you&#8217;ll want them broken out, and it&#8217;s far more of a hassle to do it later than to just do it during initial setup.<br />
</div></div>



<figure class="wp-block-image size-large"><img loading="lazy" width="988" height="280" src="https://blog.kroy.io/wp-content/uploads/2020/04/image-26.png" alt="" class="wp-image-743" srcset="https://blog.kroy.io/wp-content/uploads/2020/04/image-26.png 988w, https://blog.kroy.io/wp-content/uploads/2020/04/image-26-300x85.png 300w, https://blog.kroy.io/wp-content/uploads/2020/04/image-26-768x218.png 768w" sizes="(max-width: 988px) 100vw, 988px" /></figure>



<hr class="wp-block-separator"/>



<h2>WAN</h2>



<p>The <code>WAN</code> zone is where we are actually going to do most of our work.  </p>



<p>The basic goal here will be two things.  To block all access to the router itself, and to provide basic setup and template for future things like port forwarding to our LAN.  </p>



<p>When you start moving data to and from the Internet, that&#8217;s when you need to start worrying about the state tracking I mentioned before.  </p>



<p>For both LOCAL and LAN traffic, we&#8217;ll be setting up what&#8217;s known as a &#8220;stateful firewall&#8221;.  </p>



<p>In stateful firewalling, there are three main states to worry about:</p>



<ul><li>New &#8211; Traffic in a <code>NEW</code> state is the first packet from a destination to a source.  Allowing or denying this packet ultimately determines whether the traffic will be allowed.</li><li>Established &#8211; Once traffic from <code>NEW</code> has been allowed, the subsequent packets are marked as <code>ESTABLISHED</code>.  This is essentially traffic that has already been allowed by other rules.  This is another basic requirement for a working stateful firewall.</li><li>Related &#8211; This means that this is traffic that is somehow related to already allowed traffic.  Also required.</li></ul>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">A note about rule numbers</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
As with the NAT rule numbers, the rule numbers you use for firewall are arbitrary.</p>
<p>With that said, it doesn&#8217;t mean you shouldn&#8217;t plan ahead a bit:</p>
<ul>
<li>Rules are processed numerically, so for fastest firewalling and routing, you definitely want your ESTABLISHED/RELATED rule at the top.  That ensures that existing traffic, which is going to be the bulk of the traffic your firewall processes, only has to look at a single rule.</li>
<li>Leave yourself some gaps for future rules.  You&#8217;ll appreciate it later if you want to insert a new rule before an existing one, though you can always rename and move around.</li>
</div></div>



<hr class="wp-block-separator"/>



<h3>WAN-LOCAL</h3>



<p>As mentioned, the <code>WAN-LOCAL</code> firewall is traffic destined for the VyOS router itself.  In the future, this will be where you allow traffic, say to your WireGuard port for VPN.</p>



<p>The first rule we want to build is to allow all <code>ESTABLISHED</code> and <code>RELATED</code> traffic.  So we&#8217;ll:</p>



<ul><li>Create the WAN-LOCAL firewall.  </li><li>Set the default policy on the firewall to drop everything.  </li><li>Create a rule to accept specific traffic for rule.</li><li>Set the match for the rule to our established and related states.</li><li>Set a description for ease of use later.</li></ul>



<p></p>



<pre class="wp-block-code"><code>set firewall name WAN-LOCAL default-action drop
set firewall name WAN-LOCAL rule 5 action accept
set firewall name WAN-LOCAL rule 5 state established enable
set firewall name WAN-LOCAL rule 5 state related enable
set firewall name WAN-LOCAL rule 5 description "Allow EST/Related Traffic"
commit
save</code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="660" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-1024x660.png" alt="" class="wp-image-753" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-1024x660.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-300x193.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-768x495.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image.png 1232w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>The next rule we want on is to allow ICMP.  Many people like to block this, but not me.  I&#8217;ll defer to <a href="http://shouldiblockicmp.com/">ShouldIBlockICMP.com</a> on this.</p>



<ul><li>Create a new rule matching ICMP</li><li>Match the state of <code>NEW</code>. This is what actually matches the unknown traffic to allow</li><li>Allow the traffic</li><li>Commit and save</li></ul>



<pre class="wp-block-code"><code>set firewall name WAN-LOCAL rule 20 protocol icmp
set firewall name WAN-LOCAL rule 20 state new enable
set firewall name WAN-LOCAL rule 20 action accept
commit
save</code></pre>



<p>And you can see that the firewall is created (but still not attached to any interfaces), by doing the <code>op mode</code> command <code>show interfaces</code>.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="900" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-1-1024x900.png" alt="" class="wp-image-759" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-1-1024x900.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1-300x264.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1-768x675.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-1.png 1176w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h3>WAN-LAN</h3>



<p>For now, the <code>WAN-LAN</code> firewall is identical to the <code>WAN-LOCAL</code>.  In the future, this is where you will allow your port forward rules, or other traffic you want to send to your LAN devices, so it&#8217;s helpful to break it out beforehand.</p>



<p>As before, we create the firewall, set it to drop by default, allowed EST/RELATED, and allow ICMP, which won&#8217;t do anything now, but could be helpful in the future:</p>



<pre class="wp-block-code"><code>set firewall name WAN-LAN default-action drop
set firewall name WAN-LAN rule 5 action accept
set firewall name WAN-LAN rule 5 state established enable
set firewall name WAN-LAN rule 5 state related enable
set firewall name WAN-LAN rule 5 description "Allow EST/Related Traffic"
set firewall name WAN-LAN rule 20 protocol icmp
set firewall name WAN-LAN rule 20 state new enable
set firewall name WAN-LAN rule 20 action accept</code></pre>



<p>Don&#8217;t forget you can dive down into levels as in the following example:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1002" height="672" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-2.png" alt="" class="wp-image-760" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-2.png 1002w, https://blog.kroy.io/wp-content/uploads/2020/05/image-2-300x201.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-2-768x515.png 768w" sizes="(max-width: 1002px) 100vw, 1002px" /></figure>



<hr class="wp-block-separator"/>



<p>Finally!  We have our firewalls set up and ready to deploy.  </p>



<hr class="wp-block-separator"/>



<h1>WAN and Zones</h1>



<p>If you&#8217;ve been paying attention, we still don&#8217;t have one <em>VERY</em> important piece to this puzzle. We still don&#8217;t have WAN access!</p>



<p>Of course I did this to protect your router during the initial setup phase.  Until you have firewalls ready to deploy, you probably don&#8217;t want to be kicking your brand new VyOS install out on the open Internet.  </p>



<hr class="wp-block-separator"/>



<h2>Zones</h2>



<p>Zones are easily one of my favorite parts of VyOS, and something that in my opinion, puts it lightyears ahead of other firewall solutions.</p>



<p>Especially as your firewalling needs grow, zones just make it so <em>EASY</em>.  As I sort of touched on, zones are a bit more work initially, but save you <em>MUCH</em> more time in the future.</p>


<div class="su-box su-box-style-default" id="" style="border-color:#ccaaaa;border-radius:3px"><div class="su-box-title" style="background-color:#ffdddd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Lockout Alert</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Be careful and pay attention here.  </p>
<p>If you mistype something and are still configuring VyOS over SSH, you can potentially lock yourself out.<br />
</div></div>



<p>The naming scheme as I&#8217;ve outlined above should be helpful here when creating our firewall zones.  It basically says <code>FROMZONE-&gt;TOZONE</code></p>



<p>So let&#8217;s run through the whole thing.  </p>



<p>Goals:</p>



<ul><li>Set the default action for the zone.  This should always be drop to cover yourself in case you miss something.</li><li>Apply the &#8220;For traffic from X zone to current zone, attach Y firewall&#8221;</li><li>Add the interfaces that are part of this zone</li><li>Repeat for all zones</li><li>commit</li><li>save</li></ul>



<hr class="wp-block-separator"/>



<p>So what does this look like for the LAN:</p>



<ul><li>In this example we are working on the LAN zone</li><li>We drop everything by default</li><li>We assign the <code>WAN-LAN</code> firewall to traffic from any interface in the below <code>WAN</code> zone</li><li>Similarly for the <code>LOCAL-LAN</code>.  This is traffic from the VyOS instance itself to LAN hosts.</li><li>We put <code>eth1</code> in our LAN zone.</li></ul>



<pre class="wp-block-code"><code>set zone-policy zone LAN default-action drop
set zone-policy zone LAN from WAN firewall name WAN-LAN
set zone-policy zone LAN from LOCAL firewall name LOCAL-LAN
set zone-policy zone LAN interface eth1


</code></pre>



<hr class="wp-block-separator"/>



<p>Repeat all steps for the <code>LOCAL</code> zone.  The major difference here is the <code>local-zone</code> designation.  As I&#8217;ve mentioned a few times, <code>LOCAL</code> is a special designation that means &#8220;this firewall&#8221;, so you don&#8217;t attach interfaces:</p>



<pre class="wp-block-code"><code>set zone-policy zone LOCAL local-zone
set zone-policy zone LOCAL from LAN firewall name LAN-LOCAL
set zone-policy zone LOCAL from WAN firewall name WAN-LOCAL
set zone-policy zone LOCAL default-action drop
</code></pre>



<hr class="wp-block-separator"/>



<p>Finally, the WAN zone is basically the same as the LAN zone. The only major change you should notice is that I just changed the firewall names and interface name:</p>



<pre class="wp-block-code"><code>set zone-policy zone WAN from LAN firewall name LAN-WAN
set zone-policy zone WAN from LOCAL firewall name LOCAL-WAN
set zone-policy zone WAN interface eth0
set zone-policy zone WAN default-action drop</code></pre>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="676" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-4-1024x676.png" alt="" class="wp-image-766" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-4-1024x676.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4-300x198.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4-768x507.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-4.png 1176w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>If you were like me, you might have tried committing between steps.  Unfortunately, if you don&#8217;t set up everything at once, you&#8217;ll quickly discover that zones are interdependent on one another.  This happens because I&#8217;ve created the LAN zone, but the referenced WAN and LOCAL zones don&#8217;t exist yet.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="528" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-3-1024x528.png" alt="" class="wp-image-765" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-3-1024x528.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3-300x155.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3-768x396.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-3.png 1168w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h3>Show your work</h3>



<p>Hopefully, if you&#8217;ve done everything correctly, you should see all your zone policies set up under the <code>op mode</code> command <code>run show zone-policy</code>.  This view should make it obvious which traffic is flowing through what firewall:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="838" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-6-838x1024.png" alt="" class="wp-image-768" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-6-838x1024.png 838w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6-245x300.png 245w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6-768x939.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-6.png 872w" sizes="(max-width: 838px) 100vw, 838px" /></figure>



<hr class="wp-block-separator"/>



<h2>WAN Setup</h2>



<p>Finally, here we are.  </p>



<p>Setting up your WAN. If you&#8217;ve made it this far, congrats.  You are basically 1 or 2 commands away from having a working router and firewall!</p>



<p>There are multiple ways to get a WAN address.  For simplicity&#8217;s sake, I&#8217;ll just cover two of them here, static and DHCP assignment.  For something like PPPoE, you&#8217;ll need a few more steps.</p>



<h3>DHCP Assignment</h3>



<p>DHCP is when your router asks your ISP&#8217;s servers for what it should use for its IP address and routing information.  This is accomplished with one simple command (well, four if you add a description to the interface, and commit and save):</p>



<pre class="wp-block-code"><code>set interfaces ethernet eth0 address dhcp
set interfaces ethernet eth0 description WAN
commit
save</code></pre>



<p>You can verify that the setup is complete with the <code>op mode</code> commands <code>run show interfaces</code> and <code>run show ip route</code>.  (I have some debug variables set, so ignore the extra output:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="988" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-8-988x1024.png" alt="" class="wp-image-773" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-8-988x1024.png 988w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-290x300.png 290w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-768x796.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8-1482x1536.png 1482w, https://blog.kroy.io/wp-content/uploads/2020/05/image-8.png 1490w" sizes="(max-width: 988px) 100vw, 988px" /></figure>



<p>In the above output, <code>10.21.21.57</code> is the IP address I was assigned via DHCP.  The <code>show ip route</code> verifies that I have a default route.</p>


<div class="su-box su-box-style-default" id="" style="border-color:#aaccaa;border-radius:3px"><div class="su-box-title" style="background-color:#ddffdd;color:#000000;border-top-left-radius:1px;border-top-right-radius:1px">Information Dump</div><div class="su-box-content su-u-clearfix su-u-trim" style="border-bottom-left-radius:1px;border-bottom-right-radius:1px">
Your &#8220;gateway&#8221; or default route, is the router your devices ask when they encounter an IP address that they don&#8217;t know how to get to.</p>
<p>In the networking world, this is represented by <em>0.0.0.0/0</em>, which is a shortcut for <strong><em>the entire Internet</em></strong></p>
<p>So in the above example, this VyOS knows how to talk directly to anything in the 10.21.21.0/24 or 10.32.0.0/24 subnets because they are directly connected.  Anything outside of that, it needs to ask 10.21.21.1 for a route to it.<br />
</div></div>



<h3>Static IP</h3>



<p>Static IPs just skip the automatic configuration.  It&#8217;s up to your ISP how this is configured, but usually it&#8217;s an extra step, manually applying your default route.</p>



<p>So to duplicate my above DHCP configuration:</p>



<pre class="wp-block-code"><code>set interfaces ethernet eth0 address 10.21.21.57/24
set protocols static route 0.0.0.0/0 next-hop 10.21.21.1
commit
save</code></pre>



<p>As you can see in the following screenshot, I forgot the exact format, so I hit my <code>&lt;TAB&gt;</code> button to get hints:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="881" height="1024" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-12-881x1024.png" alt="" class="wp-image-778" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-12-881x1024.png 881w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12-258x300.png 258w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12-768x893.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-12.png 1106w" sizes="(max-width: 881px) 100vw, 881px" /></figure>



<h3>Check your work</h3>



<p>Assuming nothing has gone wrong, you should be able to verify everything with the <code>op mode</code> command <code>ping</code>.  So let&#8217;s hit Google with 4 pings:</p>



<p><code>run ping www.google.com count 4</code></p>



<p>If all goes well, you should see a response:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="264" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-9-1024x264.png" alt="" class="wp-image-774" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-9-1024x264.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9-300x77.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9-768x198.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-9.png 1290w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h1>Conclusion</h1>



<p>So wow, this post turned into a bit of a novel.  Hopefully if you&#8217;ve made it this far, your LAN clients now have accessible Internet. From a client, you should be able to ping google:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="402" src="https://blog.kroy.io/wp-content/uploads/2020/05/image-14-1024x402.png" alt="" class="wp-image-783" srcset="https://blog.kroy.io/wp-content/uploads/2020/05/image-14-1024x402.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14-300x118.png 300w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14-768x302.png 768w, https://blog.kroy.io/wp-content/uploads/2020/05/image-14.png 1416w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>Obviously there are a lot of basic topics I haven&#8217;t covered yet.  But I wanted to lay out and explain the basic setup first.  </p>



<p>Future editions will feature:</p>



<ul><li>Port Forwarding.</li><li>Hairpin NAT (this goes hand-in-hand with the first).</li><li>VPNs, especially WireGuard</li><li>How routing works when you have VPNs.</li><li>Some potential hardening tactics.</li><li>Other advanced topics like BGP/OSPF.</li></ul>



<p>Cheers!</p>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">593</post-id>	</item>
		<item>
		<title>A Baby WYSE, the 3040</title>
		<link>https://blog.kroy.io/2020/01/17/the-baby-wyse-the-dell-3040/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-baby-wyse-the-dell-3040</link>
					<comments>https://blog.kroy.io/2020/01/17/the-baby-wyse-the-dell-3040/#comments</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Fri, 17 Jan 2020 17:30:58 +0000</pubDate>
				<category><![CDATA[Hardware]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[dell]]></category>
		<category><![CDATA[wireguard]]></category>
		<category><![CDATA[wysebaby]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=539</guid>

					<description><![CDATA[Ever since my successful adventure with the WYSE J5005, I fell in love with these little thin clients. So when the opportunity arose to pick up a baby one for&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Ever since my successful adventure with the <a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/">WYSE J5005</a>, I fell in love with these little thin clients.  So when the opportunity arose to pick up a baby one for $30, I pounced on it.</p>





<h2>The Path to Another WYSE</h2>



<p>I love my <a href="https://amzn.to/2tjOisW">WYSE 5070</a>.  That little box is so much power stuffed into a tiny little form factor.  And as I outlined in my <a href="https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/">last review</a>, it sips power, averaging about 7.5 watts under normal load.</p>



<p>Although I initially threw <a href="https://vyos.io/">VyOS</a> on it, I don&#8217;t really have a need for another dedicated router right now.  So the duties of the box shifted, and it became the charter member of a newly minted Proxmox cluster, where it&#8217;s actually running a backup routing VyOS instance:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="443" src="https://blog.kroy.io/wp-content/uploads/2020/01/j5005-1024x443.png" alt="" class="wp-image-547" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/j5005-1024x443.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-300x130.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-768x332.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-1536x664.png 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005-850x368.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/j5005.png 1949w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>wyse5070 running primary DC, backup routing, and random Debian instance</figcaption></figure>



<p>When the opportunity came to pick up a WYSE3040, I absolutely jumped on it.  Especially when it was less than a cost of a Raspberry Pi.  </p>



<hr class="wp-block-separator"/>



<h2>Dell WYSE 3040</h2>



<p>So when I got the 3040, I didn&#8217;t realize how SMALL it would be.  I mean, this thing is downright <strong><em>TINY</em></strong>:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-1024x768.jpg" alt="" class="wp-image-542" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0623-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>I didn&#8217;t have a banana, so this is the size compared to an SSD.</figcaption></figure>



<p>As pictured, the thing has a footprint that&#8217;s only slightly bigger than an SSD. </p>



<p>Even at that size, it has a surprising amount of ports:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="494" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-5-1024x494.png" alt="" class="wp-image-552" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-5-1024x494.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5-300x145.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5-768x371.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5-850x410.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-5.png 1481w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>headphone jack, usb2, usb3</figcaption></figure>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="498" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-4-1024x498.png" alt="" class="wp-image-551" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-4-1024x498.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4-300x146.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4-768x374.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4-850x414.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-4.png 1519w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>power, dual displayport, USB2, ethernet</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>The Guts</h2>



<p>I don&#8217;t know why, but I alway feel a driving <em>NEED</em> to open up my new toys.  It&#8217;s a disease. And this thing was no exception.</p>



<p>With the bottom of the case off, it has an open spot for a WiFi card.  With the limited storage space in this sucker, at some point I&#8217;m going to research if I can drop an M2 SSD in there:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-1024x768.jpg" alt="" class="wp-image-541" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0624-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>bottom of case off</figcaption></figure>



<p>Once the device is fully extricated from its case, there&#8217;s really not much to look at.  Just a huge heatsink that covers most of the top of the motherboard:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-1024x768.jpg" alt="" class="wp-image-540" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2020/01/IMG_0625-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>fully out</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>The Specs</h2>



<p>While the WYSE5070 is a powerhouse in a tiny form-factor, this 3040 is a bit more&#8230; modest. </p>



<ul><li>Atom x5-Z8350 Processor</li><li>2GB of DDR3L RAM (soldered on)</li><li>8GB of eMMC (soldered on)</li><li>Gigabit Realtek NIC (RTL8111/8168/8411)</li></ul>



<figure class="wp-block-image size-large"><img loading="lazy" width="896" height="516" src="https://blog.kroy.io/wp-content/uploads/2020/01/image.png" alt="" class="wp-image-545" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image.png 896w, https://blog.kroy.io/wp-content/uploads/2020/01/image-300x173.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-768x442.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-850x490.png 850w" sizes="(max-width: 896px) 100vw, 896px" /><figcaption>system stats</figcaption></figure>



<p>Like I said.  Pretty modest specs. And the small RAM and storage space somewhat limit the options.  The eMMC is particularly painful as that kind of flash is REALLY not designed for general usage.  I&#8217;ll probably end up using a SATA SSD over a sata-wire. </p>



<hr class="wp-block-separator"/>



<h2>VyOS</h2>



<p>So one of the first things I usually do with a new device is toss VyOS on it.  I&#8217;m a huge VyOS enthustiast, evangelist, and as mentioned recently, now maintainer.</p>



<p> Unfortunately on this device, the VyOS installer died on a black screen.  But during the course of doing this write-up, I took another look at it, and  discovered the reason for this. GRUB tries to pass the output to a non-existent serial port.  While I&#8217;ve had other devices that lacked serial ports that installer didn&#8217;t care about, on this one it refused to boot.  So I just had to edit the grub boot line to remove the serial information. </p>



<p>Also, the 1.3 line of VyOS had a broken UEFI installer since release due to a change in Debian Buster, but I recently fixed that as well.  </p>



<p>So expect a VyOS write-up on this forthwith.</p>



<hr class="wp-block-separator"/>



<h2>Testing</h2>



<p>For testing, I just installed Ubuntu 18.04 or 19.10 I think.  Whatever ISO I had stuck on a USB at the time. </p>



<p>The space on the device is obviously a very real concern.  Not to mention, as I said, the eMMC probably wouldn&#8217;t stand up very long to even minor usage without some hacks.  2.1G available with a fairly minimal install + WireGuard.</p>



<pre class="wp-block-code"><code>Filesystem      Size  Used Avail Use% Mounted on
udev            909M     0  909M   0% /dev
tmpfs           190M  1.4M  189M   1% /run
/dev/mmcblk0p2  6.7G  4.2G  2.1G  68% /
tmpfs           950M     0  950M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           950M     0  950M   0% /sys/fs/cgroup
/dev/loop0       90M   90M     0 100% /snap/core/8268
/dev/mmcblk0p1  511M  7.8M  504M   2% /boot/efi
/dev/loop1       55M   55M     0 100% /snap/lxd/12211
/dev/loop2       90M   90M     0 100% /snap/core/7917
/dev/loop3       55M   55M     0 100% /snap/lxd/12631
tmpfs           190M     0  190M   0% /run/user/1000
</code></pre>



<p>Obviously I could probably get that a lot leaner if I went with something like Alpine or Arch.</p>



<p>A basic iperf3 to a different host on my network shows gigabit speeds:</p>



<pre class="wp-block-code"><code>&#091;SUM]   0.00-10.00  sec  1.09 GBytes   934 Mbits/sec    0             sender
&#091;SUM]   0.00-10.00  sec  1.08 GBytes   931 Mbits/sec                  receiver
</code></pre>



<p>with moderate CPU usage:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="96" src="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-1024x96.png" alt="" class="wp-image-556" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-1024x96.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-300x28.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-768x72.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg-850x80.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-no-wg.png 1200w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>cpu usage during iperf3</figcaption></figure>



<p>And firing up WireGuard and running an iperf3, show slightly less speed</p>



<pre class="wp-block-code"><code>&#091;SUM]   0.00-10.00  sec   991 MBytes   831 Mbits/sec    0             sender
&#091;SUM]   0.00-10.01  sec   988 MBytes   828 Mbits/sec                  receiver
</code></pre>



<p>And lots more CPU:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="101" src="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-1024x101.png" alt="" class="wp-image-557" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-1024x101.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-300x30.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-768x76.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg-850x84.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/w3040-cpu-wg.png 1375w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>cpu usage during WireGuard iperf3</figcaption></figure>



<p></p>



<hr class="wp-block-separator"/>



<h2>Power Consumption</h2>



<p>The power consumption is where this thing really shines.  Again, sorry for the potato pic, I just have a terrible time getting a decent picture of my kill-a-watt with a dying screen.  4.1 watts at idle:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="779" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-1-1024x779.png" alt="" class="wp-image-548" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-1-1024x779.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1-300x228.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1-768x584.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1-850x646.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-1.png 1164w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>potato pic, idle power consumption 4.1 watts</figcaption></figure>



<p>And 7.3 watts under WireGuard:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="733" src="https://blog.kroy.io/wp-content/uploads/2020/01/image-2-1024x733.png" alt="" class="wp-image-549" srcset="https://blog.kroy.io/wp-content/uploads/2020/01/image-2-1024x733.png 1024w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2-300x215.png 300w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2-768x550.png 768w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2-850x608.png 850w, https://blog.kroy.io/wp-content/uploads/2020/01/image-2.png 1266w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>potato pic, WireGuard at full speed, 7.3 watts</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>In all, this is a great little device for projects.  I might turn it into a DNS server or something.  For a lower speed network, I can also see it making a great little router.  I could see the CPU crumbling under heavy load that was coming from more than just a handful of streams.</p>



<p>For the $30 I paid for it, it can definitely replace a Raspberry Pi for me.  And it will be even more useful if I can drop an M2 SSD into that WiFi slot.</p>



<p></p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2020/01/17/the-baby-wyse-the-dell-3040/feed/</wfw:commentRss>
			<slash:comments>4</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">539</post-id>	</item>
		<item>
		<title>The WYSE 5070, a perfect little VyOS device</title>
		<link>https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-wyse-5070-a-perfect-little-vyos-device</link>
					<comments>https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Sun, 08 Dec 2019 16:34:04 +0000</pubDate>
				<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<category><![CDATA[dell]]></category>
		<category><![CDATA[wireguard]]></category>
		<category><![CDATA[wysebaby]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=497</guid>

					<description><![CDATA[As a bit of a networking nerd, I&#8217;m always on the hunt for cheap and powerful hardware that I can toss VyOS on. The WYSE 5070 thin client is my&#8230;]]></description>
										<content:encoded><![CDATA[
<p>As a bit of a networking nerd, I&#8217;m always on the hunt for cheap and powerful hardware  that I can toss VyOS on.  The WYSE 5070 thin client is my latest find.  </p>



<hr class="wp-block-separator"/>





<p>For a while now, I&#8217;ve been looking for a replacement to a <a href="https://amzn.to/350TPC0">Supermicro E200-9B</a> that I had an &#8220;accident&#8221; with.  By accident, I mean I killed the box by messing around on it with a FlashCat.  </p>



<p>I wanted something that was similarly low power usage, and I wasn&#8217;t really looking to spend too much, especially since it was my own silliness that killed the last one.</p>



<h2>The Hardware</h2>



<p>After a bit of hunting, I found the Dell WYSE 5070.  </p>



<p>This is a Intel Pentium Silver DDR4 platform based on the J5005.  There are two versions, the thin and the thick version, with the latter having room for a PCIe card.  I found some for $60 locally, but they can easily be found online for only a little more.  </p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-1024x768.jpg" alt="" class="wp-image-500" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0584-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>front</figcaption></figure>



<p>The versions I bought were the thin version, which only have a single Realtek NIC.  But they have USB-C on the front, which means a second gigabit NIC can easily be added.  And as I&#8217;m running VyOS, Realtek NICs aren&#8217;t a problem at all.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-1024x768.jpg" alt="" class="wp-image-501" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0585-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>rear</figcaption></figure>



<h4>The Goods</h4>



<p>Inside, the version I have came with:</p>



<ul><li>A single Realtek NIC.  This isn&#8217;t a problem for me because I have a managed switch for router-on-a-stick.</li><li>Three DisplayPorts</li><li>A variety of USB ports.  Don&#8217;t ask me about revisions as that USB naming scheme is a mess that I can&#8217;t be bothered to look up.  I do know there is a USB-C port at 5Gbps.  The other USB ports are blue, meaning better than USB2.0.</li><li>Serial port.  It would have been nice to turn this into a console redirection port for a sort of out-of-band access, but I couldn&#8217;t figure it out.</li><li>16GB eMMC storage.  I&#8217;m pretty sure I could just install straight to this, but for now I wanted to leave it intact in case I wanted to play with ThinOS. Though I do know that it&#8217;s generally recommended to skip eMMC storage for anything that might do lots of writes, like a firewall logging a bunch.</li><li>4GB of DDR4 RAM.  Officially these only support 8GB, but I added another 8GB for a total of 12GB.  <s>Apparently 16GB and even possible 32GB will work, which I have sticks for, but I haven&#8217;t had a chance to rearrange things to test.</s> Confirmed.  Currently running 32GB in it without an issue. </li><li>To further revise, it looks like it might be picky about 16GB chips.  I currently have <a href="https://amzn.to/31tosRm">CT16G4SFD8213</a> in mine.</li><li>An M.2 storage slot.  I tossed a Crucial MX500 in here because eventually this thing might become a tiny VM Host. Plus, I got it cheap on Black Friday.</li></ul>



<p>A peek inside and this thing is surprisingly expandable.  </p>



<ul><li>Towards the left, you see the blue USB internal header that could be used for an internal USB drive.</li><li>The top has the unused M.2 WiFi slot.</li><li>Above the battery, you can see the PCIe header which would be populated if this was the thick version of the box.</li><li>And then of course the M.2 SSD and extra RAM that I added.</li></ul>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-1024x768.jpg" alt="" class="wp-image-502" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0587-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>the guts</figcaption></figure>



<h4>Power Consumption</h4>



<p>The idle power consumption on this device is amazing:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1324" height="1300" src="https://i1.wp.com/blog.kroy.io/wp-content/uploads/2019/12/image.png?fit=640%2C628&amp;ssl=1" alt="" class="wp-image-505" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/image.png 1324w, https://blog.kroy.io/wp-content/uploads/2019/12/image-300x295.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1024x1005.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/image-768x754.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/image-850x835.png 850w" sizes="(max-width: 1324px) 100vw, 1324px" /><figcaption>killawatt</figcaption></figure>



<p>The highest usage I saw was during boot where it hit a whopping 15 watts.  Oh, and I&#8217;m dangling an additional SSD off a <a href="https://amzn.to/2RsiI5W">SATA wire</a> to use temporarily as a boot drive since I was doing other testing with this server, so that 5.7 watts includes this guy:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-1024x768.jpg" alt="" class="wp-image-506" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-1536x1152.jpg 1536w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-2048x1536.jpg 2048w, https://blog.kroy.io/wp-content/uploads/2019/12/IMG_0598-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>sata wire</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>VyOS</h2>



<p>Installing VyOS is pretty standard.  In this case, I just used Etcher to put the latest <a href="https://downloads.vyos.io/?dir=rolling/current/amd64">VyOS Rolling ISO</a> on a USB, and ran through the quick install.  </p>



<p>As mentioned above, I&#8217;m just doing a <a href="https://en.wikipedia.org/wiki/One-armed_router">router-on-a-stick</a> setup with the single onboard NIC, but I also tested out a <a href="https://amzn.to/2YoMABk">USB-C Gigabit Ethernet adapter</a> and it worked identically.</p>



<h4>Config</h4>



<p>The config I used was almost verbatim from the <a href="https://vyos.readthedocs.io/en/latest/quick-start.html">VyOS Quick Start Guide</a>, except I&#8217;m using VLANs and a static WAN IP. In my case, VLAN10 is the &#8220;WAN&#8221; and VLAN2222 is my test LAN here.  </p>



<pre class="wp-block-code"><code>firewall {
    all-ping enable
    broadcast-ping disable
    config-trap disable
    ipv6-receive-redirects disable
    ipv6-src-route disable
    ip-src-route disable
    log-martians enable
    name OUTSIDE-IN {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
    }
    name OUTSIDE-LOCAL {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
        rule 20 {
            action accept
            icmp {
                type-name echo-request
            }
            protocol icmp
            state {
                new enable
            }
        }
        rule 30 {
            action drop
            destination {
                port 22
            }
            protocol tcp
            recent {
                count 4
                time 60
            }
            state {
                new enable
            }
        }
        rule 31 {
            action accept
            destination {
                port 22
            }
            protocol tcp
            state {
                new enable
            }
        }
    }
    receive-redirects disable
    send-redirects enable
    source-validation disable
    syn-cookies enable
    twa-hazards-protection disable
}
interfaces {
    ethernet eth0 {
        duplex auto
        hw-id 6c:2b:59:3c:f7:4e
        smp-affinity auto
        speed auto
        vif 10 {
            address 10.0.10.234/24
            firewall {
                in {
                    name OUTSIDE-IN
                }
                local {
                    name OUTSIDE-LOCAL
                }
            }
        }
        vif 2222 {
            address 10.222.222.1/24
        }
    }
    loopback lo {
    }
    wireguard wg0 {
        address 10.172.24.60/24
        peer edge {
            allowed-ips 10.172.24.1/32
            endpoint 10.0.10.1:2224
            pubkey ****************
        }
    }
}
nat {
    source {
        rule 100 {
            outbound-interface eth0.10
            source {
                address 10.222.222.0/24
            }
            translation {
                address masquerade
            }
        }
    }
}
protocols {
    static {
        route 0.0.0.0/0 {
            next-hop 10.0.10.1 {
            }
        }
    }
}
service {
    dhcp-server {
        shared-network-name LAN {
            subnet 10.222.222.0/24 {
                default-router 10.222.222.1
                dns-server 10.53.53.53
                domain-name internal-network
                lease 86400
                range 0 {
                    start 10.222.222.98
                    stop 10.222.222.200
                }
            }
        }
    }
    ssh {
        port 22
    }
}
system {
    config-management {
        commit-revisions 100
    }
    console {
        device ttyS0 {
            speed 9600
        }
    }
    host-name vyos
    login {
        user vyos {
            authentication {
                encrypted-password ****************
                plaintext-password ****************
            }
            level admin
        }
    }
    name-server 10.53.53.53
    ntp {
        server 0.pool.ntp.org {
        }
        server 1.pool.ntp.org {
        }
        server 2.pool.ntp.org {
        }
    }
    syslog {
        global {
            facility all {
                level info
            }
            facility protocols {
                level debug
            }
        }
    }
    time-zone UTC
}
</code></pre>



<hr class="wp-block-separator"/>



<h3>Tests</h3>



<p>I ran a number of different tests to try and show how this thing might perform in real world usage.  </p>



<h4>Speedtest</h4>



<p>The first test was just a normal speedtest.  If someone were going to install this for their primary firewall and router, this is probably the first thing they would do:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="576" height="126" src="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest.png" alt="" class="wp-image-513" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest.png 576w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-300x66.png 300w" sizes="(max-width: 576px) 100vw, 576px" /><figcaption>basically gigabit speedtest</figcaption></figure>



<p>As I&#8217;ve mentioned a <a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/">few other times</a>, this is basically gigabit on my network.  And what was the CPU doing during this?</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="215" src="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-1024x215.png" alt="" class="wp-image-512" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-1024x215.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-300x63.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-768x161.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu-850x179.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/speedtest-cpu.png 1446w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>70% on a single core with a speedtest</figcaption></figure>



<p>With about ~70% usage on a single core out of four, this little J5005 doesn&#8217;t do too terribly.</p>



<h4>File Copy &#8211; CIFS</h4>



<p>For this test, I copied a single large file from a fileserver elsewhere on my network over an CIFS mounted share.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="933" height="276" src="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy.png" alt="" class="wp-image-510" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy.png 933w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-300x89.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-768x227.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-850x251.png 850w" sizes="(max-width: 933px) 100vw, 933px" /><figcaption>copying at over 750Mbps</figcaption></figure>



<p>97.2MB/s or 777Mbps is pretty admirable for a simple file copy.</p>



<p>And the CPU usage on the WYSE 5070 during the copy:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="143" src="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-1024x143.png" alt="" class="wp-image-509" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-1024x143.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-300x42.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-768x107.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu-850x118.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/filecopy-cpu.png 1529w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Again, with only 60% usage of a single core, I think that shows this thing has lots of room for growth.</p>



<h4>Simple iperf3</h4>



<p>A simple <code>iperf3</code> gives us gigabit performance:</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ iperf3 -c 10.0.10.1 -P2
Connecting to host 10.0.10.1, port 5201
[  4] local 10.0.10.234 port 32910 connected to 10.0.10.1 port 5201
[  6] local 10.0.10.234 port 32912 connected to 10.0.10.1 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.00   sec  57.2 MBytes   480 Mbits/sec    0    209 KBytes
[  6]   0.00-1.00   sec  56.9 MBytes   478 Mbits/sec    0    198 KBytes
[SUM]   0.00-1.00   sec   114 MBytes   958 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   1.00-2.00   sec  55.9 MBytes   469 Mbits/sec    0    209 KBytes
[  6]   1.00-2.00   sec  55.7 MBytes   467 Mbits/sec    0    198 KBytes
[SUM]   1.00-2.00   sec   112 MBytes   936 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   2.00-3.00   sec  56.1 MBytes   471 Mbits/sec    0    209 KBytes
[  6]   2.00-3.00   sec  56.1 MBytes   471 Mbits/sec    0    198 KBytes
[SUM]   2.00-3.00   sec   112 MBytes   941 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   3.00-4.00   sec  55.7 MBytes   467 Mbits/sec    0    209 KBytes
[  6]   3.00-4.00   sec  56.1 MBytes   471 Mbits/sec    0    223 KBytes
[SUM]   3.00-4.00   sec   112 MBytes   938 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   4.00-5.00   sec  54.3 MBytes   456 Mbits/sec    1    228 KBytes
[  6]   4.00-5.00   sec  58.2 MBytes   488 Mbits/sec    0    240 KBytes
[SUM]   4.00-5.00   sec   113 MBytes   944 Mbits/sec    1
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   5.00-6.00   sec  54.7 MBytes   459 Mbits/sec    0    228 KBytes
[  6]   5.00-6.00   sec  56.9 MBytes   477 Mbits/sec   45    240 KBytes
[SUM]   5.00-6.00   sec   112 MBytes   936 Mbits/sec   45
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   6.00-7.00   sec  53.8 MBytes   451 Mbits/sec    0    228 KBytes
[  6]   6.00-7.00   sec  57.7 MBytes   484 Mbits/sec    0    240 KBytes
[SUM]   6.00-7.00   sec   111 MBytes   935 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   7.00-8.00   sec  54.2 MBytes   455 Mbits/sec    0    228 KBytes
[  6]   7.00-8.00   sec  58.2 MBytes   488 Mbits/sec    0    240 KBytes
[SUM]   7.00-8.00   sec   112 MBytes   942 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   8.00-9.00   sec  52.2 MBytes   438 Mbits/sec    0    230 KBytes
[  6]   8.00-9.00   sec  59.8 MBytes   502 Mbits/sec    0    247 KBytes
[SUM]   8.00-9.00   sec   112 MBytes   940 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   9.00-10.00  sec  51.7 MBytes   434 Mbits/sec    0    230 KBytes
[  6]   9.00-10.00  sec  59.8 MBytes   501 Mbits/sec    0    247 KBytes
[SUM]   9.00-10.00  sec   111 MBytes   935 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec   546 MBytes   458 Mbits/sec    1             sender
[  4]   0.00-10.00  sec   545 MBytes   457 Mbits/sec                  receiver
[  6]   0.00-10.00  sec   575 MBytes   483 Mbits/sec   45             sender
[  6]   0.00-10.00  sec   574 MBytes   482 Mbits/sec                  receiver
[SUM]   0.00-10.00  sec  1.09 GBytes   941 Mbits/sec   46             sender
[SUM]   0.00-10.00  sec  1.09 GBytes   939 Mbits/sec                  receiver
</code></pre>



<p>And similar CPU usage to the other tests, 50% usage on a single core:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="157" src="https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-1024x157.png" alt="" class="wp-image-511" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-1024x157.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-300x46.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-768x117.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu-850x130.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/iperf3-cpu.png 1518w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>50% usage on a single core</figcaption></figure>



<h4>WireGuard</h4>



<p>If you read through the config above, you&#8217;ll notice I dropped in the config for a WireGuard tunnel to my main router.</p>



<p>Even though WireGuard isn&#8217;t 100% vetted yet, it&#8217;s enough that I believe it will be officially part of the Linux kernel soon.   And hopefully these results will demonstrate why:</p>



<pre class="wp-block-code"><code>vyos@vyos:~$ iperf3 -c 10.172.24.1 -P2
Connecting to host 10.172.24.1, port 5201
[  4] local 10.172.24.60 port 36752 connected to 10.172.24.1 port 5201
[  6] local 10.172.24.60 port 36754 connected to 10.172.24.1 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.00   sec  54.3 MBytes   456 Mbits/sec    0    281 KBytes
[  6]   0.00-1.00   sec  53.9 MBytes   452 Mbits/sec    0    283 KBytes
[SUM]   0.00-1.00   sec   108 MBytes   908 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   1.00-2.00   sec  53.5 MBytes   449 Mbits/sec    0    281 KBytes
[  6]   1.00-2.00   sec  53.5 MBytes   449 Mbits/sec    0    283 KBytes
[SUM]   1.00-2.00   sec   107 MBytes   898 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   2.00-3.00   sec  53.5 MBytes   449 Mbits/sec    0    293 KBytes
[  6]   2.00-3.00   sec  53.5 MBytes   449 Mbits/sec    0    283 KBytes
[SUM]   2.00-3.00   sec   107 MBytes   898 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   3.00-4.00   sec  53.7 MBytes   451 Mbits/sec    0    293 KBytes
[  6]   3.00-4.00   sec  53.7 MBytes   450 Mbits/sec    0    283 KBytes
[SUM]   3.00-4.00   sec   107 MBytes   901 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   4.00-5.00   sec  53.3 MBytes   447 Mbits/sec    0    293 KBytes
[  6]   4.00-5.00   sec  53.4 MBytes   448 Mbits/sec    0    310 KBytes
[SUM]   4.00-5.00   sec   107 MBytes   895 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   5.00-6.00   sec  53.3 MBytes   448 Mbits/sec    0    293 KBytes
[  6]   5.00-6.00   sec  53.3 MBytes   447 Mbits/sec    0    310 KBytes
[SUM]   5.00-6.00   sec   107 MBytes   895 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   6.00-7.00   sec  53.7 MBytes   451 Mbits/sec    0    293 KBytes
[  6]   6.00-7.00   sec  53.6 MBytes   450 Mbits/sec    0    310 KBytes
[SUM]   6.00-7.00   sec   107 MBytes   900 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   7.00-8.00   sec  53.0 MBytes   444 Mbits/sec    0    293 KBytes
[  6]   7.00-8.00   sec  53.0 MBytes   444 Mbits/sec    0    310 KBytes
[SUM]   7.00-8.00   sec   106 MBytes   889 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   8.00-9.00   sec  54.0 MBytes   453 Mbits/sec    0    415 KBytes
[  6]   8.00-9.00   sec  53.8 MBytes   451 Mbits/sec    0    415 KBytes
[SUM]   8.00-9.00   sec   108 MBytes   904 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[  4]   9.00-10.00  sec  53.5 MBytes   449 Mbits/sec    0    415 KBytes
[  6]   9.00-10.00  sec  54.0 MBytes   453 Mbits/sec    0    415 KBytes
[SUM]   9.00-10.00  sec   107 MBytes   902 Mbits/sec    0
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec   536 MBytes   450 Mbits/sec    0             sender
[  4]   0.00-10.00  sec   535 MBytes   449 Mbits/sec                  receiver
[  6]   0.00-10.00  sec   536 MBytes   449 Mbits/sec    0             sender
[  6]   0.00-10.00  sec   534 MBytes   448 Mbits/sec                  receiver
[SUM]   0.00-10.00  sec  1.05 GBytes   899 Mbits/sec    0             sender
[SUM]   0.00-10.00  sec  1.04 GBytes   897 Mbits/sec                  receiver
</code></pre>



<p>Getting 900Mbps on a $60 thin client?  That&#8217;s pretty amazing in my book.  </p>



<p>Finally we are stressing the CPU a bit, 60%, 35%, 25%, 25% on the various cores:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="154" src="https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-1024x154.png" alt="" class="wp-image-514" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-1024x154.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-300x45.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-768x116.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu-850x128.png 850w, https://blog.kroy.io/wp-content/uploads/2019/12/wireguard-cpu.png 1476w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>all core usage</figcaption></figure>



<p>I think the screen on my kill-a-watt is dying as I&#8217;m having a heck of a time photographing it.  But this 12.7 watts is the power usage when testing WireGuard, which is about the most amount of stress I was able to put on this little server:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1394" height="1152" src="https://i2.wp.com/blog.kroy.io/wp-content/uploads/2019/12/image-1.png?fit=640%2C529&amp;ssl=1" alt="" class="wp-image-515" srcset="https://blog.kroy.io/wp-content/uploads/2019/12/image-1.png 1394w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-300x248.png 300w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-1024x846.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-768x635.png 768w, https://blog.kroy.io/wp-content/uploads/2019/12/image-1-850x702.png 850w" sizes="(max-width: 1394px) 100vw, 1394px" /><figcaption>12.7 watts</figcaption></figure>



<hr class="wp-block-separator"/>



<h2>Conclusion</h2>



<p>It&#8217;s amazing that these things are going for only <strong><em>$60</em></strong>. Well, a bit more since I added the extra drive and RAM.  And this is for hardware that according to Dell, was manufactured in March of 2019.  Practically brand new!</p>



<p>For the price and feature set, I would <em><strong>DEFINITELY</strong></em> recommend this device for anyone looking for a capable VyOS host.  I&#8217;m really tempted to try and source a thick version now so I can toss a 10 gigabit NIC in one and see how it performs.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/12/08/the-wyse-5070-a-perfect-little-vyos-device/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">497</post-id>	</item>
		<item>
		<title>Battle of the Bare Metal Routers</title>
		<link>https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=battle-of-the-bare-metal-routers</link>
					<comments>https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Thu, 21 Nov 2019 20:32:30 +0000</pubDate>
				<category><![CDATA[Hardware]]></category>
		<category><![CDATA[pfsense]]></category>
		<category><![CDATA[Routing]]></category>
		<category><![CDATA[VyOS]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=449</guid>

					<description><![CDATA[Continuing from my previous post, I wanted to see how a variety of software routing and firewall platforms performed when put to the test on an equal playing field. As&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Continuing from my <a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/">previous post</a>, I wanted to see how a variety of software routing and firewall platforms performed when put to the test on an equal playing field.</p>



<hr class="wp-block-separator"/>



<p>As before, these tests were all run on my <a href="https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1521/">Xeon D-1521</a>. This server is running 10Gb links to the rest of my network via the onboard Intel X550/552 chipset, 32GB of RAM, and an SSD boot drive.</p>



<p>The final results are <a href="#finalresults">HERE</a> if this is all TLDR.</p>



<p>Here is the server dangling halfway out of the rack while I was doing these tests:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-1024x768.jpg" alt="" class="wp-image-359" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h4>Network Layout</h4>



<p>The network layout is identical to virtual routing tests, though in this case, I just used DHCP to get the &#8220;WAN&#8221; address, since I wanted to test NAT performance too.</p>



<figure class="wp-block-image"><img loading="lazy" width="812" height="788" src="https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram.png" alt="" class="wp-image-37" srcset="https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram.png 812w, https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram-300x291.png 300w, https://blog.kroy.io/wp-content/uploads/2019/08/network-diagram-768x745.png 768w" sizes="(max-width: 812px) 100vw, 812px" /></figure>



<hr class="wp-block-separator"/>



<h2>The Victims</h2>



<p>For these tests, I wanted to avoid wasting time on duplicated results.  So for example, I&#8217;ll just be testing pfSense instead of pfSense and OPNSense.  Similarly just VyOS instead of Debian.  Also, based on feedback on my prior post, there were people that felt like I missed a few platforms.  So for these tests, the platforms will be:</p>



<ul><li>VyOS 1.2.3</li><li>pfSense 2.4.4-p3</li><li>Sophos XG SFOS v17.5.8&nbsp;(not fully sure how the versioning works, but that was the ISO)</li><li>Untangle 14.2.2</li></ul>



<p>The goal of these tests is to show how these platforms perform when installed bare metal to this D-1521.  So they will be configured mostly out of box in a basic WAN/LAN Firewall/Router setup.</p>



<hr class="wp-block-separator"/>



<h3>VyOS</h3>



<p>I use a lot of VyOS, and I&#8217;m pretty familiar with how it performs.  It&#8217;s worth mentioning that I&#8217;m also a VyOS maintainer now. </p>



<p>Basic Config:</p>



<pre class="wp-block-code"><code>firewall {
    name OUTSIDE-IN {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
    }
    name OUTSIDE-LOCAL {
        default-action drop
        rule 10 {
            action accept
            state {
                established enable
                related enable
            }
        }
        rule 20 {
            action accept
            icmp {
                type-name echo-request
            }
            protocol icmp
            state {
                new enable
            }
        }
        rule 31 {
            action accept
            destination {
                port 22
            }
            protocol tcp
            state {
                new enable
            }
        }
    }
}
interfaces {
    ethernet eth0 {
        address dhcp
        firewall {
            in {
                name OUTSIDE-IN
            }
            local {
                name OUTSIDE-LOCAL
            }
        }
    }
    ethernet eth1 {
        vif 2222 {
            address 10.222.222.1/24
        }
        vif 2223 {
            address 10.223.223.1/24
        }
    }
    loopback lo {
    }
}
nat {
    source {
        rule 10 {
            outbound-interface eth0
            source {
                address 10.0.0.0/8
            }
            translation {
                address masquerade
            }
        }
    }
}
service {
    dhcp-server {
        shared-network-name vlan2222 {
            authoritative
            subnet 10.222.222.0/24 {
                default-router 10.222.222.1
                dns-server 10.53.53.53
                lease 1200
                range 0 {
                    start 10.222.222.10
                    stop 10.222.222.100
                }
            }
        }
        shared-network-name vlan2223 {
            authoritative
            subnet 10.223.223.0/24 {
                default-router 10.223.223.1
                dns-server 10.53.53.53
                lease 1200
                range 0 {
                    start 10.223.223.10
                    stop 10.223.223.100
                }
            }
        }
    }
    ssh {
        port 22
    }
}

</code></pre>



<h4>Results</h4>



<p>In this setup, the results were &#8220;basically 10Gb&#8221;, whether for inter-vlan or LAN-&gt;WAN with NAT.</p>



<p><strong>Inter-vlan (9.19 Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="593" height="42" src="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-intervlan-simple.png" alt="" class="wp-image-450" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-intervlan-simple.png 593w, https://blog.kroy.io/wp-content/uploads/2019/11/vyos-intervlan-simple-300x21.png 300w" sizes="(max-width: 593px) 100vw, 593px" /></figure>



<p><strong>NAT (9.17 Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="591" height="43" src="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-simple.png" alt="" class="wp-image-451" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-simple.png 591w, https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-simple-300x22.png 300w" sizes="(max-width: 591px) 100vw, 591px" /></figure>



<p>While I was testing it, I was curious to see if using a simple firewall was any different than using zone-based firewalls.  </p>



<p>So adding the zone config:</p>



<pre class="wp-block-code"><code>zone LAN {
    default-action drop
    from LOCAL {
        firewall {
            name LOCAL-LAN
        }
    }
    from WAN {
        firewall {
            name WAN-LAN
        }
    }
    interface eth1.2222
    interface eth1.2223
}
zone LOCAL {
    from LAN {
        firewall {
            name LAN-LOCAL
        }
    }
    from WAN {
        firewall {
            name WAN-LOCAL
        }
    }
    local-zone
}
zone WAN {
    from LAN {
        firewall {
            name LAN-WAN
        }
    }
    from LOCAL {
        firewall {
            name LOCAL-WAN
        }
    }
    interface eth0
}

zone LAN {
    default-action drop
    from LOCAL {
        firewall {
            name LOCAL-LAN
        }
    }
    from WAN {
        firewall {
            name WAN-LAN
        }
    }
    interface eth1.2222
    interface eth1.2223
}
zone LOCAL {
    from LAN {
        firewall {
            name LAN-LOCAL
        }
    }
    from WAN {
        firewall {
            name WAN-LOCAL
        }
    }
    local-zone
}
zone WAN {
    from LAN {
        firewall {
            name LAN-WAN
        }
    }
    from LOCAL {
        firewall {
            name LOCAL-WAN
        }
    }
    interface eth0
}
</code></pre>



<p>The results were pretty much identical.</p>



<p><strong>NAT zone firewall (9.12Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="593" height="50" src="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-zone.png" alt="" class="wp-image-452" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-zone.png 593w, https://blog.kroy.io/wp-content/uploads/2019/11/vyos-wanlan-zone-300x25.png 300w" sizes="(max-width: 593px) 100vw, 593px" /></figure>



<hr class="wp-block-separator"/>



<h3>pfSense</h3>



<p>In my <a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/">previous post</a>, I caught a surprising amount of flak saying that my review of pfSense was somehow unfair and biased, despite feeling like I was <em>OVERLY</em> fair.  Hopefully the results here will vindicate me. </p>



<p>With pfSense, I didn&#8217;t really make any changes beyond the stock install.  I added an <code>OPT</code> interface for the second LAN, and opened up the firewall rules for that interface.</p>



<h4>Results</h4>



<p>First, I tested some inter-vlan routing with all hardware offload disabled.  This is a common troubleshooting step as virtual pfSense and a lot of network cards don&#8217;t properly support the functionality under FreeBSD.</p>



<p><strong>Inter-vlan, disabled hardware offload (7.58Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="56" src="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-1024x56.png" alt="" class="wp-image-454" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-1024x56.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-300x16.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-768x42.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload-850x47.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-NoHWOffload.png 1202w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>But guess what.  All those hardware offloading checkboxes exist for a reason, and enabling it can have some dramatic results if the NICs actually support it (and the drivers aren&#8217;t broken).</p>



<p><strong>Inter-vlan, hardware offload (9.19Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="71" src="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-1024x71.png" alt="" class="wp-image-455" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-1024x71.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-300x21.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-768x53.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload-850x59.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-intervlan-HWOffload.png 1208w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>pfSense does slightly less better when it is NATing, though still pretty close to 10Gb.</p>



<p><strong>NAT, hardware offload (8.71Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="57" src="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-1024x57.png" alt="" class="wp-image-456" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-1024x57.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-300x17.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-768x42.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT-850x47.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/pfsense-wanlan-NAT.png 1266w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Now this is where I need to eat some crow.  </p>



<p>For literally <em>YEARS</em> I&#8217;ve been preaching that pfSense won&#8217;t go 10 gigabit.  As these results show, that was way wrong. Though in my defense, this was also a sentiment echoed by the pfSense devs themselves. But I’ll take my medicine and admit that I was wrong. <br></p>



<p>I think are a few reasons that in my all extensive testing, I never saw 10Gb. </p>



<ul><li>When I was running pfSense on bare metal (2.3.x and 2.4.0 beta days), the Xeon Ds were <em>REALLY</em> new.  To make a long story short, they were not very stable and I don&#8217;t think the drivers were fully compatible.  As the results show, enabling the hardware offload features can make a fairly large difference.</li><li>Ever since, every pfSense install I&#8217;ve done has generally been virtualized, either on KVM or ESXi.  As my prior post shows, it just doesn&#8217;t do well virtualized. </li></ul>



<p>So yes, pfSense will do 10Gb assuming you have NICs that support hardware offload correctly.  </p>



<hr class="wp-block-separator"/>



<h3>Sophos XG</h3>



<p>After my last post, a few people specifically mentioned that I should have done tests with Sophos XG.  </p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="736" src="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-1024x736.png" alt="" class="wp-image-457" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-1024x736.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-300x216.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-768x552.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard-850x611.png 850w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-dashboard.png 1173w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>I&#8217;m not going to lie.  Sophos XG is actually quite fancy looking.  It was enough with all the options and lack of familiarity, my head spun a bit trying to set it up.  </p>



<p>My first impression wasn&#8217;t very good.  Sophos makes it VERY difficult to position the WAN/LAN where I wanted it. It wanted the first NIC port to be LAN or something like that.  I think I eventually had to just swap the VLANs on the switch the server is plugged into.  </p>



<h4>Results</h4>



<p>I imagine if I used Sophos more, I would become more comfortable with it.  But for the few hours I had it spun up for testing, I felt a little like:</p>



<figure class="wp-block-image"><img loading="lazy" width="1004" height="565" src="https://blog.kroy.io/wp-content/uploads/2019/11/ihave.jpg" alt="" class="wp-image-458" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/ihave.jpg 1004w, https://blog.kroy.io/wp-content/uploads/2019/11/ihave-300x169.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/11/ihave-768x432.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/11/ihave-850x478.jpg 850w" sizes="(max-width: 1004px) 100vw, 1004px" /><figcaption><a href="https://knowyourmeme.com/photos/234739-i-have-no-idea-what-im-doing">https://knowyourmeme.com/photos/234739-i-have-no-idea-what-im-doing</a></figcaption></figure>



<p>I&#8217;m pretty sure I got all the security and stuff configured, and the results were pretty straightforward, full 10 gigabit.</p>



<p><strong>Inter-vlan (9.27Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="625" height="57" src="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-intervlan.png" alt="" class="wp-image-459" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-intervlan.png 625w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-intervlan-300x27.png 300w" sizes="(max-width: 625px) 100vw, 625px" /></figure>



<p><strong>NAT (9.24Gbps):</strong></p>



<figure class="wp-block-image"><img loading="lazy" width="622" height="51" src="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-nat.png" alt="" class="wp-image-460" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/sophos-nat.png 622w, https://blog.kroy.io/wp-content/uploads/2019/11/sophos-nat-300x25.png 300w" sizes="(max-width: 622px) 100vw, 622px" /></figure>



<p>Outwardly, the results were marginally better than pfSense or VyOS, but I&#8217;m not sure I would want to use Sophos on a regular basis.  It was just confusing and non-intuitive.</p>



<hr class="wp-block-separator"/>



<h3>Untangle</h3>



<p>This was another suggestion in response to my last post.  As with Sophos, it&#8217;s another platform that I have basically no familiarity with.  </p>



<p>It didn&#8217;t take much to get installed, and unlike Sophos, the initial interface configuration  was a breeze.</p>



<figure class="wp-block-image"><img loading="lazy" width="1002" height="665" src="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard.png" alt="" class="wp-image-461" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard.png 1002w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard-300x199.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard-768x510.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-dashboard-850x564.png 850w" sizes="(max-width: 1002px) 100vw, 1002px" /></figure>



<p>I&#8217;m not going to lie, even though I&#8217;m completely a CLI junkie, using Untangle is <em>NICE</em>.  Everything was intuitive, and the various graphs and reporting make complete sense from the perspective of a new user.</p>



<figure class="wp-block-image"><img loading="lazy" width="1016" height="684" src="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces.png" alt="" class="wp-image-462" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces.png 1016w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces-300x202.png 300w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces-768x517.png 768w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-interfaces-850x572.png 850w" sizes="(max-width: 1016px) 100vw, 1016px" /></figure>



<h4>Results</h4>



<p>Unfortunately, the performance was comparatively abysmal compared to the other platforms here.  NAT and inter-vlan results were identical.</p>



<p>NAT/inter-vlan (2.7Gbps):</p>



<figure class="wp-block-image"><img loading="lazy" width="595" height="45" src="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-nat.png" alt="" class="wp-image-463" srcset="https://blog.kroy.io/wp-content/uploads/2019/11/untangle-nat.png 595w, https://blog.kroy.io/wp-content/uploads/2019/11/untangle-nat-300x23.png 300w" sizes="(max-width: 595px) 100vw, 595px" /></figure>



<p>I have to believe there was some performance tuning I could do to get better performance, but I wasn&#8217;t able to track down anything specific.  </p>



<p>Despite the lackluster performance, I really enjoyed setting up and playing with Untangle and it&#8217;s a platform I might use again in the future.</p>



<hr class="wp-block-separator"/>



<a name="finalresults"></a>



<h3>Final Results</h3>



<p>In conclusion, most platforms came out fairly even.  The outlier was Untangle, but I suspect with some tuning it could be brought up to the level of the other platforms.</p>



<table class="wp-block-table is-style-regular"><tbody><tr><th><strong>Router</strong></th><th><strong>Inter-vlan</strong></th><th><strong>NAT</strong></th></tr><tr><td>VyOS</td><td>9.19 Gbps</td><td>9.17 Gbps regular firewall<br>9.12 Gbps zone firewall</td></tr><tr><td>pfSense</td><td>9.19 Gbps hardware offload<br>7.58 Gbps no hardware offload</td><td>8.71 Gbps</td></tr><tr><td>Sophos XG</td><td>9.27 Gbps</td><td>9.24 Gbps</td></tr><tr><td>Untangle</td><td>2.70 Gbps</td><td>2.70 Gbps</td></tr></tbody></table>



<p>The takeaway here is that almost any platform can be an extremely performant firewall and router.  I think with pfSense, the right hardware selection could potentially impact results if you are interested higher speeds.  Whereas with VyOS and probably the other two, the hardware selection would matter a bit less due to better driver support.</p>



<p>As far as Untangle is concerned, it&#8217;s a platform I might be taking another crack at and see if I can figure out why the performance was so low.  Given that the tests were <em>IDENTICAL</em>, there was almost certainly some artificial limitation occurring somewhere.  </p>



<p></p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/11/21/battle-of-the-bare-metal-routers/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">449</post-id>	</item>
		<item>
		<title>Migrating an EFI Linux Install to a new Server</title>
		<link>https://blog.kroy.io/2019/10/28/migrating-a-efi-linux-install-to-a-new-server/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=migrating-a-efi-linux-install-to-a-new-server</link>
					<comments>https://blog.kroy.io/2019/10/28/migrating-a-efi-linux-install-to-a-new-server/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 28 Oct 2019 19:50:51 +0000</pubDate>
				<category><![CDATA[Debian]]></category>
		<category><![CDATA[Storage]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=394</guid>

					<description><![CDATA[Recently, during my Great Rack Migration madness, I migrated the system drive for my main NAS to a new Supermicro 846. One of the hurdles I ran into was that&#8230;]]></description>
										<content:encoded><![CDATA[
<p>Recently, during my Great Rack Migration madness, I migrated the system drive for my <a href="https://blog.kroy.io/2019/10/28/the-great-rack-migration-dell-r420/">main NAS to a new Supermicro 846</a>. </p>



<hr class="wp-block-separator"/>



<p>One of the hurdles I ran into was that my system refused to boot after I moved the drive.  The install was EFI based, and the new system didn&#8217;t have the appropriate NVRAM variables to determine which OS to boot.</p>



<p>Fortunately, EFI provides the EFI shell, and that shell makes this problem extremely simple to fix.</p>



<p>First off, to replicate the setup, I create a new small Debian VM on ESXi and installed Buster.  An important step to take if you want to experiment in the EFI shell, is to make sure the VM actually boots via EFI, which the Debian template doesn&#8217;t do automatically:</p>



<figure class="wp-block-image"><img loading="lazy" width="845" height="990" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-19.png" alt="" class="wp-image-431" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-19.png 845w, https://blog.kroy.io/wp-content/uploads/2019/10/image-19-256x300.png 256w, https://blog.kroy.io/wp-content/uploads/2019/10/image-19-768x900.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-19-300x351.png 300w" sizes="(max-width: 845px) 100vw, 845px" /></figure>



<p>For this experiment, it is important to make this change before installing the VM.</p>



<hr class="wp-block-separator"/>



<p>Within a VM in ESXi for EFI, it&#8217;s fairly trivial to replicate what would happen if you moved a boot drive from one system to another.  The NVRAM file just needs to be deleted (preferably while the VM is powered down).</p>



<p>This involves manually browsing the datastore and deleting the <code>vmname.nvram</code> file that&#8217;s in the VM Folder on the datastore.</p>



<figure class="wp-block-image"><img loading="lazy" width="995" height="567" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-21.png" alt="" class="wp-image-433" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-21.png 995w, https://blog.kroy.io/wp-content/uploads/2019/10/image-21-300x171.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-21-768x438.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-21-850x484.png 850w" sizes="(max-width: 995px) 100vw, 995px" /></figure>



<p>Once the nvram file is deleted, the VM will refuse to boot:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="565" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-22-1024x565.png" alt="" class="wp-image-434" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-22-1024x565.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/image-22-300x165.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-22-768x423.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-22-850x469.png 850w, https://blog.kroy.io/wp-content/uploads/2019/10/image-22.png 1333w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>But reseting and tapping ESC quickly gets the the boot manager menu, which allows entering an EFI shell.  Some servers boot straight into the EFI shell if they can&#8217;t find what to boot:</p>



<figure class="wp-block-image"><img loading="lazy" width="1022" height="806" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-24.png" alt="" class="wp-image-436" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-24.png 1022w, https://blog.kroy.io/wp-content/uploads/2019/10/image-24-300x237.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-24-768x606.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-24-850x670.png 850w" sizes="(max-width: 1022px) 100vw, 1022px" /></figure>



<p>Which leads to:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="715" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-25-1024x715.png" alt="" class="wp-image-437" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-25-1024x715.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/image-25-300x209.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-25-768x536.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-25-850x593.png 850w, https://blog.kroy.io/wp-content/uploads/2019/10/image-25.png 1047w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<p>In the EFI shell, available drives are enumerated as <code>fs0:</code>, <code>fs1:</code>, etc.</p>



<p>Switch to a drive and see if it&#8217;s a drive that has EFI stuff on it (dir or ls works):</p>



<pre class="wp-block-code"><code>fs0:
dir</code></pre>



<p>If the <code>EFI</code> folder exists, that&#8217;s the right spot. </p>



<figure class="wp-block-image"><img loading="lazy" width="662" height="269" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-26.png" alt="" class="wp-image-438" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-26.png 662w, https://blog.kroy.io/wp-content/uploads/2019/10/image-26-300x122.png 300w" sizes="(max-width: 662px) 100vw, 662px" /></figure>



<pre class="wp-block-code"><code>cd EFI
dir
cd debian
dir</code></pre>



<figure class="wp-block-image"><img loading="lazy" width="801" height="509" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-27.png" alt="" class="wp-image-439" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-27.png 801w, https://blog.kroy.io/wp-content/uploads/2019/10/image-27-300x191.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-27-768x488.png 768w" sizes="(max-width: 801px) 100vw, 801px" /></figure>



<p>The relevant file should be named <code>grubx64.efi</code>.  Typing that (or using tab completion to select it), will boot your system:</p>



<figure class="wp-block-image"><img loading="lazy" width="809" height="462" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-29.png" alt="" class="wp-image-441" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-29.png 809w, https://blog.kroy.io/wp-content/uploads/2019/10/image-29-300x171.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-29-768x439.png 768w" sizes="(max-width: 809px) 100vw, 809px" /></figure>



<p>Once your system is booted, you just need to rerun and update grub to restore your system&#8217;s ability to boot without the EFI shell.</p>



<p>It&#8217;s important that your EFI partition is properly mounted, which should happen, but you might need to mount it manually:</p>



<figure class="wp-block-image"><img loading="lazy" width="906" height="276" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-30.png" alt="" class="wp-image-442" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-30.png 906w, https://blog.kroy.io/wp-content/uploads/2019/10/image-30-300x91.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-30-768x234.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-30-850x259.png 850w" sizes="(max-width: 906px) 100vw, 906px" /></figure>



<p>Once you confirm your EFI partition is mounted, reinstall grub:</p>



<pre class="wp-block-code"><code>sudo grub-install /dev/sda
sudo update-grub</code></pre>



<figure class="wp-block-image"><img loading="lazy" width="914" height="288" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-20.png" alt="" class="wp-image-432" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-20.png 914w, https://blog.kroy.io/wp-content/uploads/2019/10/image-20-300x95.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-20-768x242.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-20-850x268.png 850w" sizes="(max-width: 914px) 100vw, 914px" /></figure>



<p>That&#8217;s it!  The system should be booting again.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/10/28/migrating-a-efi-linux-install-to-a-new-server/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">394</post-id>	</item>
		<item>
		<title>The Great Rack Migration &#8211; Dell R420</title>
		<link>https://blog.kroy.io/2019/10/28/the-great-rack-migration-dell-r420/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-great-rack-migration-dell-r420</link>
					<comments>https://blog.kroy.io/2019/10/28/the-great-rack-migration-dell-r420/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 28 Oct 2019 18:51:24 +0000</pubDate>
				<category><![CDATA[HomeLab]]></category>
		<category><![CDATA[Rack Migration]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=415</guid>

					<description><![CDATA[This post continues my migration into my new rack. After migrating the X10SRH, I really thought I was done. Everything was now in the rack and working like it should.&#8230;]]></description>
										<content:encoded><![CDATA[
<p>This post continues my migration into my new rack.</p>



<hr class="wp-block-separator"/>



<figure class="wp-block-image"><img loading="lazy" width="658" height="159" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-13.png" alt="" class="wp-image-416" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-13.png 658w, https://blog.kroy.io/wp-content/uploads/2019/10/image-13-300x72.png 300w" sizes="(max-width: 658px) 100vw, 658px" /></figure>



<p>After migrating the <a href="https://blog.kroy.io/2019/10/28/the-great-rack-migration-x10srh-clnf/">X10SRH</a>, I really thought I was done.  Everything was now in the rack and working like it should.</p>



<p>My Dell PowerEdge R420 acts as my primary NAS.  It&#8217;s a dual E5-2620v2, 256GB of RAM, an SFF-8088 HBA, with a 10Gb NIC.  This runs Debian and stores many terabytes of data on top of ZFS.</p>



<p>The problem was this device bottlenecks me and many of my future plans.  With room for only one PCIe card, I am forced to use SAS uplinks on shelves to connect all the drives.  This creates a serious performance bottleneck.  In the future, I also want to add 40Gb networking, and the lack of PCIe slots limits me there too.  </p>



<hr class="wp-block-separator"/>



<p>The Server Store has quickly become my new go-to for buying hardware, and this time was no exception.  For $349, I could get a dual CPU Supermicro X9DRI board, a Supermicro 846 (24 bay) case and a pair of low TDP E5 v2 Xeons on one of their <a rel="noreferrer noopener" aria-label="specials (opens in a new tab)" href="https://www.theserverstore.com/SuperMicro-4U-CSE-846-24-Bay-SAS2-BP-w-X9DRi-F2x-6-Core-E5-2630Lv2-24Ghz-16GB-IT-MODE-W-Rails_p_925.html" target="_blank">specials</a>.  Consider I could reuse my pile of RAM <em>AND</em> it included a SAS2 HBA, it didn&#8217;t take too long to hit the button on that one.</p>



<hr class="wp-block-separator"/>



<h3>Let&#8217;s do it</h3>



<p>This was a pretty simple build.  90% of the work was done for me as the system was already built.  All I had to do is pull some RAM:</p>



<figure class="wp-block-image"><img loading="lazy" width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0448-768x1024.jpg" alt="" class="wp-image-423" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0448-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0448-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0448-300x400.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0448-850x1133.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0448.jpg 914w" sizes="(max-width: 768px) 100vw, 768px" /></figure>



<p>Well, now that was a lie.  The <em>ACTUAL</em> hard part was migrating drives.</p>



<p>So. Many. Drives.</p>



<figure class="wp-block-image"><img loading="lazy" width="894" height="804" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-15.png" alt="" class="wp-image-424" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-15.png 894w, https://blog.kroy.io/wp-content/uploads/2019/10/image-15-300x270.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-15-768x691.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-15-850x764.png 850w" sizes="(max-width: 894px) 100vw, 894px" /></figure>



<p>and more:</p>



<figure class="wp-block-image"><img loading="lazy" width="854" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-16-854x1024.png" alt="" class="wp-image-425" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-16-854x1024.png 854w, https://blog.kroy.io/wp-content/uploads/2019/10/image-16-250x300.png 250w, https://blog.kroy.io/wp-content/uploads/2019/10/image-16-768x921.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-16-300x360.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-16-850x1019.png 850w, https://blog.kroy.io/wp-content/uploads/2019/10/image-16.png 876w" sizes="(max-width: 854px) 100vw, 854px" /></figure>



<p>I also had a few SSDs to mount up.  Note that this is an HP drive, in a Dell 2.5-&gt;3.5 adapter, into a Supermicro drive tray:</p>



<figure class="wp-block-image"><img loading="lazy" width="1000" height="766" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-17.png" alt="" class="wp-image-426" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-17.png 1000w, https://blog.kroy.io/wp-content/uploads/2019/10/image-17-300x230.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-17-768x588.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-17-850x651.png 850w" sizes="(max-width: 1000px) 100vw, 1000px" /></figure>



<hr class="wp-block-separator"/>



<h3>Conclusion</h3>



<p>The only issue I had was that the boot drive wouldn&#8217;t boot due to missing EFI NVRAM.  I covered how to fix <a href="https://blog.kroy.io/2019/10/28/migrating-a-efi-linux-install-to-a-new-server/">HERE</a>.</p>



<p>Welp, that&#8217;s it.  I&#8217;ve migrated all my servers to a rack.  If you&#8217;ve been following this so far, I hope you have enjoyed the ride!</p>



<figure class="wp-block-image"><img loading="lazy" width="488" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-18-488x1024.png" alt="" class="wp-image-427" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-18-488x1024.png 488w, https://blog.kroy.io/wp-content/uploads/2019/10/image-18-143x300.png 143w, https://blog.kroy.io/wp-content/uploads/2019/10/image-18-300x630.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-18.png 558w" sizes="(max-width: 488px) 100vw, 488px" /></figure>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/10/28/the-great-rack-migration-dell-r420/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">415</post-id>	</item>
		<item>
		<title>The Great Rack Migration – X10SRH-CLNF</title>
		<link>https://blog.kroy.io/2019/10/28/the-great-rack-migration-x10srh-clnf/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-great-rack-migration-x10srh-clnf</link>
					<comments>https://blog.kroy.io/2019/10/28/the-great-rack-migration-x10srh-clnf/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 28 Oct 2019 18:13:31 +0000</pubDate>
				<category><![CDATA[HomeLab]]></category>
		<category><![CDATA[Rack Migration]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=396</guid>

					<description><![CDATA[This post continues my migration into my new rack. The X10SRH is my primary hypervisor. It holds a Xeon E5-2640v4 and is full of 32 gigabyte sticks of RAM. It&#8217;s&#8230;]]></description>
										<content:encoded><![CDATA[
<p>This post continues my migration into my new rack.</p>



<hr class="wp-block-separator"/>



<p>The <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://amzn.to/2PsS8Z5" target="_blank">X10SRH</a> is my primary hypervisor.  It holds a <a rel="noreferrer noopener" aria-label="Xeon E5-2640v4 (opens in a new tab)" href="https://amzn.to/2PsS8Z5" target="_blank">Xeon E5-2640v4</a> and is full of 32 gigabyte sticks of RAM.  </p>



<p></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/1-Q6LuXIt-1024x768.jpg" alt="" class="wp-image-397" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/1-Q6LuXIt-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/1-Q6LuXIt-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/1-Q6LuXIt-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/1-Q6LuXIt-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption><a href="https://amzn.to/2Ps7GMM" target="_blank" rel="noreferrer noopener" aria-label="Fractal Design R4 (opens in a new tab)">Fractal Design R4</a></figcaption></figure>



<p>It&#8217;s lived in a <a rel="noreferrer noopener" aria-label="Fractal Design R4  (opens in a new tab)" href="https://amzn.to/2Ps7GMM" target="_blank">Fractal Design R4 </a>case for years, and I love that case.  When packed full of 140mm fans, it&#8217;s got the room for 10 3.5&#8243; HDDs, a few SSDs, and an insanely large cooler.  Once the fan on that cooler died and the temps still never went above 31C at full load.</p>



<figure class="wp-block-image"><img loading="lazy" width="512" height="607" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-12.png" alt="" class="wp-image-401" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-12.png 512w, https://blog.kroy.io/wp-content/uploads/2019/10/image-12-253x300.png 253w, https://blog.kroy.io/wp-content/uploads/2019/10/image-12-300x356.png 300w" sizes="(max-width: 512px) 100vw, 512px" /></figure>



<p>The case also make it so all the PCIe slots are available.  So I&#8217;ve got an HBA (9201-16e), a nVidia Quadro P2000 for Plex transcoding, extra space for additional networking cards, and the ability to add more if necessary.</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/2-ezst7Ug-1024x768.jpg" alt="" class="wp-image-398" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/2-ezst7Ug-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/2-ezst7Ug-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/2-ezst7Ug-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/2-ezst7Ug-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>\</figcaption></figure>



<hr class="wp-block-separator"/>



<p>So when on the hunt for a replacement case, the obvious option seemed like some kind of 4U.  The Supermicro 846 seemed like a no-brainer:</p>



<figure class="wp-block-image"><img loading="lazy" width="250" height="220" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-10.png" alt="" class="wp-image-399"/></figure>



<p>It would allow me to keep my <a rel="noreferrer noopener" aria-label="current i4 CPU cooler (opens in a new tab)" href="https://amzn.to/2WjG6To" target="_blank">current i4 CPU cooler</a> and all my PCIe cards would plug in without any hassle.</p>



<p>So I ordered an empty case from TheServerStore.com, and waited a week or so.  </p>



<p>Even though it *SHOULD* have fit, before the new case arrived, I started to suspect that the existing cooler would not fit based on some rough measurements.  Because I didn&#8217;t want to get stuck, I just ordered the new <a rel="noreferrer noopener" aria-label="3U cooler (opens in a new tab)" href="https://amzn.to/36cPCfO" target="_blank">3U cooler</a> just to be safe.</p>



<figure class="wp-block-image"><img loading="lazy" width="482" height="540" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-11.png" alt="" class="wp-image-400" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-11.png 482w, https://blog.kroy.io/wp-content/uploads/2019/10/image-11-268x300.png 268w, https://blog.kroy.io/wp-content/uploads/2019/10/image-11-300x336.png 300w" sizes="(max-width: 482px) 100vw, 482px" /></figure>



<p>Although buying a cooler should be simple, it took some hunting as my board only supports narrow ILM.</p>



<hr class="wp-block-separator"/>



<h2>The Build</h2>



<p>The actual migration went smoothly.  All the PCIe cards came out:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/3-wwsed8I-1024x768.jpg" alt="" class="wp-image-402" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/3-wwsed8I-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/3-wwsed8I-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/3-wwsed8I-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/3-wwsed8I-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>The board got installed:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/4-p7LBhNk-1024x768.jpg" alt="" class="wp-image-403" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/4-p7LBhNk-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/4-p7LBhNk-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/4-p7LBhNk-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/4-p7LBhNk-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>And I tried to put the top on the case.  As expected, the fit was *VERY* tight.  I suspect it might have worked because the difference was only a few millimeters, but:</p>



<ul><li>It would have put pressure on the CPU.</li><li>The orientation for airflow was wrong anyway.</li></ul>



<p>So I pulled the old cooler:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/6-w8F2tkU-1024x768.jpg" alt="" class="wp-image-405" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/6-w8F2tkU-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/6-w8F2tkU-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/6-w8F2tkU-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/6-w8F2tkU-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>Cleaned up the CPU with some alcohol and coffee filters</p>



<figure class="wp-block-image"><img loading="lazy" width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/7-lOW1wxD-768x1024.jpg" alt="" class="wp-image-404" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/7-lOW1wxD-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/7-lOW1wxD-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2019/10/7-lOW1wxD-300x400.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/7-lOW1wxD-850x1133.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/7-lOW1wxD.jpg 1966w" sizes="(max-width: 768px) 100vw, 768px" /></figure>



<p>The new cooler installed and mounted:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/8-3KWKfEi-1024x768.jpg" alt="" class="wp-image-406" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/8-3KWKfEi-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/8-3KWKfEi-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/8-3KWKfEi-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/8-3KWKfEi-850x638.jpg 850w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h3>Finishing it up</h3>



<p>All that remained was to hook up the fans, and wire up the SSD.  Because the case I ordered has a SAS2 expander backplane, and that backplane is getting passed through to a different server via a <a rel="noreferrer noopener" aria-label="SFF-8088 to SFF-8087 adapter (opens in a new tab)" href="https://amzn.to/2Wn9XdS" target="_blank">SFF-8088 to SFF-8087 adapter</a>, the SSD needed to be inside the case connected to onboard SATA.</p>



<figure class="wp-block-image"><img loading="lazy" width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/9-JqI95AF-768x1024.jpg" alt="" class="wp-image-407" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/9-JqI95AF-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/9-JqI95AF-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2019/10/9-JqI95AF-300x400.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/9-JqI95AF-850x1133.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/9-JqI95AF.jpg 1966w" sizes="(max-width: 768px) 100vw, 768px" /></figure>



<p>At this point, the sharp-eyed might notice a PCIe placeholder shoved in between the fan banks and the backplane.  Yep, that&#8217;s still there, because I didn&#8217;t notice that until I was looking through pictures.<br></p>



<p>The final picture, with the SFF adapter wired into the backplane.  Once again, the PCIe blank is there.  I just haven&#8217;t had a reason to derack it and pull it.  </p>



<figure class="wp-block-image"><img loading="lazy" width="594" height="792" src="https://blog.kroy.io/wp-content/uploads/2019/10/10-VovEUwy.jpg" alt="" class="wp-image-408" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/10-VovEUwy.jpg 594w, https://blog.kroy.io/wp-content/uploads/2019/10/10-VovEUwy-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2019/10/10-VovEUwy-300x400.jpg 300w" sizes="(max-width: 594px) 100vw, 594px" /></figure>



<p>And finally, all racked up (this is the one with yellow tabs):</p>



<figure class="wp-block-image"><img loading="lazy" width="568" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM-568x1024.jpg" alt="" class="wp-image-409" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM-568x1024.jpg 568w, https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM-166x300.jpg 166w, https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM-768x1385.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM-300x541.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM-850x1533.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/11-0pWRvfM.jpg 1340w" sizes="(max-width: 568px) 100vw, 568px" /></figure>



<p>One more to go with the R420&#8230;</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/10/28/the-great-rack-migration-x10srh-clnf/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">396</post-id>	</item>
		<item>
		<title>The Great Rack Migration &#8211; D1541</title>
		<link>https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1541/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-great-rack-migration-d1541</link>
					<comments>https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1541/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 07 Oct 2019 18:52:34 +0000</pubDate>
				<category><![CDATA[ESXi]]></category>
		<category><![CDATA[Hardware]]></category>
		<category><![CDATA[HomeLab]]></category>
		<category><![CDATA[Rack Migration]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=376</guid>

					<description><![CDATA[This post continues my migration into my new rack. As more and more parts arrived, it became time to migrate my Supermicro 5028D-TN4T. This tiny little server packs quite the&#8230;]]></description>
										<content:encoded><![CDATA[
<p>This post continues my migration into my new rack.</p>



<hr class="wp-block-separator"/>



<p>As more and more parts arrived, it became time to migrate my <a href="https://amzn.to/2OrEViX">Supermicro 5028D-TN4T</a>.  This tiny little server packs quite the punch, with an 8c16t Supermicro D1541 and plays a role of one of my ESXi servers.</p>



<p>Again, as before with my <a href="https://blog.kroy.io/2017/03/13/whiteboxing-a-1u/">Whiteboxing a 1U series</a>, I knew pretty much all the parts that I needed to get, except this time I got the <a href="https://amzn.to/2Ooa9HL">rear I/O version of the 1U short depth case</a>.</p>



<p>The parts list is pretty extensive.  Fortunately, because Supermicro sells a server like this, I can use the parts list for the <a href="https://amzn.to/33lc2t5">Supermicro 5018D-FN4T</a>.  </p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="771" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-6-1024x771.png" alt="" class="wp-image-377" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-6-1024x771.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/image-6-300x226.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-6-768x579.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-6-850x640.png 850w, https://blog.kroy.io/wp-content/uploads/2019/10/image-6.png 1026w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>parts list</figcaption></figure>



<p>The short list:</p>



<ul><li>The case</li><li>Riser card bracket</li><li>x16 Riser card</li><li>some fans and brackets</li><li>an I/O shield</li><li>an 2.5&#8243; SSD/HDD Bracket</li></ul>



<p>Sheesh.  It&#8217;s a long list, some of the parts were a bit hard to find, so it took a few weeks for everything to arrive.</p>



<h2>The build</h2>



<p>Once everything arrived, I dug the old bird out of the corner, and started disassembly.  It was VERY dusty:</p>



<figure class="wp-block-image"><img loading="lazy" width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0376-768x1024.jpg" alt="" class="wp-image-378" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0376-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0376-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0376-300x400.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0376-850x1134.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0376.jpg 872w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>dusty</figcaption></figure>



<p>And a terrible picture of the inside:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0377-1024x768.jpg" alt="" class="wp-image-379" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0377-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0377-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0377-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0377-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0377.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>inside</figcaption></figure>



<p>And the board is extricated:</p>



<figure class="wp-block-image"><img loading="lazy" width="768" height="1024" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0378-768x1024.jpg" alt="" class="wp-image-380" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0378-768x1024.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0378-225x300.jpg 225w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0378-300x400.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0378-850x1134.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0378.jpg 872w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption>extricated</figcaption></figure>



<h2>The new home</h2>



<p>The new case is SOOOO much better than the rear I/O version.  There&#8217;s actually room for all the cables from the PSU.  </p>



<p>On the front I/O version, you usually just end up with an ugly bulge in the front:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0379-1024x768.jpg" alt="" class="wp-image-382" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0379-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0379-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0379-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0379-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0379.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>new case</figcaption></figure>



<p>The top-left corner of the following image definitely demonstrates what I&#8217;m talking about with front vs rear I/O:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0380-2-1024x768.jpg" alt="" class="wp-image-383" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0380-2-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0380-2-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0380-2-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0380-2-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0380-2.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>rear io cleanliness</figcaption></figure>



<p>vs the mess in the front I/O version:</p>



<figure class="wp-block-image"><img loading="lazy" width="656" height="811" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-7.png" alt="" class="wp-image-384" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-7.png 656w, https://blog.kroy.io/wp-content/uploads/2019/10/image-7-243x300.png 243w, https://blog.kroy.io/wp-content/uploads/2019/10/image-7-300x371.png 300w" sizes="(max-width: 656px) 100vw, 656px" /><figcaption>front io mess</figcaption></figure>



<p>Everything installed.  I reused the fan brackets from my old SYS-E300-8D, and tracked down an internal USB header that fit.  The pictured one was too tall:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0381-1-1024x768.jpg" alt="" class="wp-image-385" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0381-1-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0381-1-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0381-1-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0381-1-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0381-1.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>all installed</figcaption></figure>



<p>I installed two fans as eventually this board will be receiving a 40Gb upgrade. As with the <a href="/2019/10/07/the-great-rack-migration-d1521/">D1521 build</a>, it was LOUD.  I installed a pair low-noise adapters, and the problem was fixed, and the server stays nice and cool:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="166" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-8-1024x166.png" alt="" class="wp-image-386" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-8-1024x166.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/image-8-300x49.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-8-768x125.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-8-850x138.png 850w, https://blog.kroy.io/wp-content/uploads/2019/10/image-8.png 1385w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>All things considered, this build went very smoothly. </p>



<figure class="wp-block-image"><img loading="lazy" width="633" height="150" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-9.png" alt="" class="wp-image-387" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-9.png 633w, https://blog.kroy.io/wp-content/uploads/2019/10/image-9-300x71.png 300w" sizes="(max-width: 633px) 100vw, 633px" /><figcaption>racked</figcaption></figure>



<p> The case looks nice all racked up and is basically dead silent.  I might even consider replacing the <a href="https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1521/">D1521 build</a> with the rear I/O version if they weren&#8217;t so expensive.</p>



<p>Continued in the <a href="/2019/10/28/the-great-rack-migration-x10srh-clnf/">X10SRH migration</a>.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1541/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">376</post-id>	</item>
		<item>
		<title>The Great Rack Migration &#8211; D1521</title>
		<link>https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1521/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=the-great-rack-migration-d1521</link>
					<comments>https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1521/#respond</comments>
		
		<dc:creator><![CDATA[Kroy]]></dc:creator>
		<pubDate>Mon, 07 Oct 2019 16:43:37 +0000</pubDate>
				<category><![CDATA[ESXi]]></category>
		<category><![CDATA[Hardware]]></category>
		<category><![CDATA[HomeLab]]></category>
		<category><![CDATA[Proxmox]]></category>
		<category><![CDATA[Rack Migration]]></category>
		<category><![CDATA[Routing]]></category>
		<guid isPermaLink="false">https://blog.kroy.io/?p=352</guid>

					<description><![CDATA[As part of my continued rack migration, it was time to move the D1521. My Supermicro D-1521 host is my &#8220;whatever I need it to be&#8221; server. As I test&#8230;]]></description>
										<content:encoded><![CDATA[
<p>As part of my continued rack migration, it was time to move the D1521.</p>



<hr class="wp-block-separator"/>



<p>My Supermicro D-1521 host is my &#8220;whatever I need it to be&#8221; server.  As I test and lab different topics, it becomes a Proxmox host, ESXi host, KVM, router, etc.  Whatever I need it to be basically.  <br></p>



<p>Fortunately, this migration is just reusing parts from my <a href="https://blog.kroy.io/2017/03/13/whiteboxing-a-1u/">Whiteboxing a 1U series</a>. Which meant I had mostly already gone through the pain and had all parts on hand.</p>



<hr class="wp-block-separator"/>



<h2>The original home<br></h2>



<p>The &#8220;original&#8221; home for this server was a solid <a href="https://www.amazon.com/gp/product/B00DU6RVK8/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B00DU6RVK8&amp;linkCode=as2&amp;tag=blogkroyio10-20&amp;linkId=10d8e867e5c30bbd8e0c428b64f0b77a">Silverstone HTPC Case</a>. </p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0301-1024x768.jpg" alt="" class="wp-image-353" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0301-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0301-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0301-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0301-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0301.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>For a tiny case, the airflow is very decent, probably due to the huge fan that floats over the main board.  Though the PCIe slot needs a bit of extra love:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0300-1024x768.jpg" alt="" class="wp-image-355" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0300-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0300-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0300-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0300-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0300.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p></p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0298-1024x768.jpg" alt="" class="wp-image-356" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0298-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0298-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0298-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0298-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0298.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<hr class="wp-block-separator"/>



<h2>The final home</h2>



<p>I reused the old <a href="https://www.amazon.com/gp/product/B0093HNUD0/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B0093HNUD0&amp;linkCode=as2&amp;tag=blogkroyio10-20&amp;linkId=cff5dd63646471670d9f6ede771d735e&quot;>Supermicro Rack Mount Server Chassis CSE-505-203B</a><img src=&quot;//ir-na.amazon-adsystem.com/e/ir?t=blogkroyio10-20&amp;l=am2&amp;o=1&amp;a=B0093HNUD0">1U short depth Supermicro case</a> from my prior build.  </p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0382-1024x768.jpg" alt="" class="wp-image-358" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0382-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0382-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0382-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0382-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0382.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>1u installed</figcaption></figure>



<p>And what it looks like when I&#8217;m in labbing mode and changing things around:</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="768" src="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-1024x768.jpg" alt="" class="wp-image-359" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-1024x768.jpg 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-300x225.jpg 300w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-768x576.jpg 768w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393-850x637.jpg 850w, https://blog.kroy.io/wp-content/uploads/2019/10/IMG_0393.jpg 1551w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>You might notice some electrical tape holding down the fan.  The stock fan placement in this case is inefficient for these XeonD boards.  The fan ends up missing the CPU almost completely. </p>



<p>My original setup incorporated a lack rack, so the front facing I/O was okay.  In the rack setup, it&#8217;s just means I need an extra <a href="https://www.amazon.com/gp/product/B00BTRD4Y2/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B00BTRD4Y2&amp;linkCode=as2&amp;tag=blogkroyio10-20&amp;linkId=b41df4dd8754780fcfe06415aa30f631">1U brush panel</a>:</p>



<figure class="wp-block-image"><img loading="lazy" width="662" height="149" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-2.png" alt="" class="wp-image-357" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-2.png 662w, https://blog.kroy.io/wp-content/uploads/2019/10/image-2-300x68.png 300w" sizes="(max-width: 662px) 100vw, 662px" /></figure>



<p>The final piece that I need to add was a <a href="https://amzn.to/2Ot30Gc">low-noise adapter</a> for the fan.  Considering the D1541 was going into a similar case, a three pack was good enough.</p>



<p>This server was by FAR the most loud thing in my rack, and even on optimal settings the fan was too loud.  With the adapter, it&#8217;s nice and cool (and silent):</p>



<figure class="wp-block-image"><img loading="lazy" width="1024" height="69" src="https://blog.kroy.io/wp-content/uploads/2019/10/image-3-1024x69.png" alt="" class="wp-image-360" srcset="https://blog.kroy.io/wp-content/uploads/2019/10/image-3-1024x69.png 1024w, https://blog.kroy.io/wp-content/uploads/2019/10/image-3-300x20.png 300w, https://blog.kroy.io/wp-content/uploads/2019/10/image-3-768x52.png 768w, https://blog.kroy.io/wp-content/uploads/2019/10/image-3-850x58.png 850w, https://blog.kroy.io/wp-content/uploads/2019/10/image-3.png 1415w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>To be continued on <a href="/2019/10/07/the-great-rack-migration-d1541/">the D1541</a>.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.kroy.io/2019/10/07/the-great-rack-migration-d1521/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">352</post-id>	</item>
	</channel>
</rss>
